# CRM Sales Bot

Чат-бот для продажи CRM-системы Wipon. Ведёт клиента от приветствия до закрытия сделки.

## Быстрый старт

```bash
source venv/bin/activate
cd src && python bot.py
```

## Архитектура

```
Сообщение клиента
       │
       ▼
┌─────────────────┐
│   Classifier    │  ← Определяет интент + извлекает данные (company_size, pain_point)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  State Machine  │  ← Решает какое действие выполнить и куда перейти
└────────┬────────┘
         │
         ▼
┌─────────────────┐      ┌─────────────────┐
│   Generator     │ ───► │ Knowledge Base  │  ← Факты о продуктах Wipon
│                 │ ◄─── │   (Retriever)   │    (тарифы, функции, интеграции)
└────────┬────────┘      └─────────────────┘
         │
         ▼
┌─────────────────┐
│   LLM (Ollama)  │  ← Qwen2.5 генерирует финальный ответ
└────────┬────────┘
         │
         ▼
    Ответ бота
```

## Структура файлов

```
src/
├── bot.py              # Главный класс, координирует компоненты
├── classifier.py       # Классификация интентов + извлечение данных (1873 строки)
├── state_machine.py    # Управление состояниями диалога
├── generator.py        # Генерация ответов через LLM
├── config.py           # Интенты, состояния, промпт-шаблоны
├── llm.py              # Интеграция с Ollama
└── knowledge/
    ├── data.py         # База знаний о продуктах Wipon
    ├── retriever.py    # Гибридный поиск (keywords + embeddings)
    └── base.py         # Структуры данных
```

## Состояния диалога

```
greeting → qualification → presentation → close → success
                │                │
                └── rejection ───┴──→ soft_close
```

| Состояние | Цель | Собираемые данные |
|-----------|------|-------------------|
| `greeting` | Поздороваться | - |
| `qualification` | Понять клиента | `company_size`, `pain_point` |
| `presentation` | Показать ценность | - |
| `handle_objection` | Отработать "дорого" | - |
| `close` | Получить контакт | - |

## Ключевые интенты

**Вопросы (приоритет 0):**
- `price_question` — сколько стоит?
- `question_features` — какие функции?
- `question_integrations` — с чем интегрируется?

**Данные:**
- `info_provided` — клиент дал информацию о себе

**Решения:**
- `agreement` — клиент согласен
- `rejection` — клиент отказывается
- `objection_price` — дорого

## Промпт-шаблоны (config.py)

Все шаблоны следуют принципу: **сначала услышь клиента, потом действуй**.

| Шаблон | Когда используется |
|--------|-------------------|
| `greet_back` | Ответ на приветствие |
| `qualification` | Переход в квалификацию |
| `continue_current_goal` | Сбор недостающих данных |
| `deflect_and_continue` | Уход от цены к размеру команды |
| `presentation` | Презентация решения |
| `handle_objection` | Возражение "дорого" |
| `answer_question` | Ответ на вопрос клиента |
| `soft_close` | Вежливое завершение при отказе |
| `close` | Запрос контакта |

## Classifier (classifier.py)

Гибридная классификация:
1. **Быстрый поиск по корням слов** — основной метод
2. **Fallback на pymorphy2** — если корни не сработали

Извлечение данных:
- `company_size` — regex паттерны для чисел ("нас 10", "команда из 5")
- `pain_point` — 50+ паттернов проблем ("теряем клиентов", "низкие продажи")

## База знаний (knowledge/)

- **data.py** — факты о продуктах Wipon (CRM, Kassa, мобильное приложение, тарифы)
- **retriever.py** — гибридный поиск:
  1. Keyword search по категориям
  2. Fallback на RuBERT embeddings

## Тестирование

```bash
# Юнит-тесты
pytest tests/

# Стресс-тест бота
python scripts/full_bot_stress_test.py

# Тест базы знаний
python scripts/stress_test_knowledge.py
```

## Отладка

В интерактивном режиме:
- `/status` — текущее состояние и собранные данные
- `/reset` — сброс диалога
- `/quit` — выход

## Зависимости

- `ollama` + модель `qwen2.5:7b`
- `pymorphy2` — морфология русского языка
- `sentence-transformers` — embeddings для базы знаний
