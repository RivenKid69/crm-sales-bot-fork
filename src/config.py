"""
Конфигурация: состояния, интенты, база знаний, шаблоны
"""

from settings import settings

# =============================================================================
# ИНТЕНТЫ: КОРНИ СЛОВ (быстрая проверка)
# =============================================================================

INTENT_ROOTS = {
    "greeting": [
        # Стандартные приветствия
        "привет", "здравств", "добр", "хай", "приветств", "салют", "хелло", "хэлло",
        # Разговорные варианты
        "прив", "здаров", "здарова", "дарова", "даров", "йо", "хаюшки", "хаю",
        "приветик", "привки", "ку", "здрасьте", "здрасте", "здасте",
        # Формальные
        "доброго", "приветствую",
        # Дополнительные разговорные
        "дратути", "превед", "приф", "прива", "здоров", "хеллоу", "хело",
        "приветос", "приветули", "здравия", "бонжур", "хола",
        # Время суток
        "утречк", "вечерочек", "денечек", "денёчек",
        # Казахские/мусульманские приветствия
        "салам", "ассалам", "салем", "сәлем",
        # Дополнительные варианты с опечатками
        "здраствуй", "здраствуйт", "здравтвуйте", "привте", "привт",
        "приет", "прювет", "хэй", "хей", "хэлоу", "хэллоу", "алоха",
        # Региональные (СНГ)
        "саламалейк", "ассаламу", "шалом", "мархаба", "сайн", "сайн уу",
        # Неформальные/молодёжные
        "хаюш", "здаров братан", "куку", "йоу", "ёу", "эй", "здорова",
        "приветос бандитос", "хеллоу ворлд", "хай пипл",
    ],
    "price_question": [
        # Стандартные
        "цен", "стоим", "стоит", "прайс", "почём", "тариф", "расценк", "ценник",
        "бюджет", "деньг", "рубл", "₽", "руб",
        # Разговорные и опечатки
        "почом", "скока", "скольк", "ценик", "прайслист", "прайс-лист",
        "денюжк", "финанс", "оплат", "платёж", "платеж",
        # Косвенные
        "выйдет", "обойд", "потрат", "влет", "затрат",
        # Дополнительные разговорные
        "чё почём", "чо почем", "ценочка", "ценовая", "прайсик", "тарифчик",
        "скоко", "сколь", "скок", "денежк", "деняг", "бабл", "бабок",
        "за сколько", "какой прайс", "скинь прайс", "скинь цен",
        # Сленг
        "чек", "чеков", "влетит", "влетает", "встанет", "встаёт",
        "потянет", "тянет на", "выливает", "стоимост",
        # Вопросы об условиях
        "подешевле", "дешевле можн", "скидос", "скидон",
        # Дополнительные ценовые варианты
        "тенге", "₸", "тг", "тенгушк", "долларов", "$", "usd", "кзт",
        "прайсец", "ценочк", "сумм", "какая сумма", "общая сумм",
        "калькулятор", "посчитай", "рассчита", "калькуляц",
        "минималк", "минимальн", "максимальн", "средн цен",
        # Вопросы о способах оплаты
        "безнал", "наличк", "картой", "переводом", "счёт", "счет",
        "рассрочк", "кредит", "в долг", "частями", "помесячн",
        # Сравнительные ценовые
        "дороже", "выгодн", "экономн", "бюджетн", "премиум",
    ],
    "objection_price": [
        # Стандартные
        "дорог", "дешевл", "скидк", "бесплатн", "денег нет", "не потянем",
        # Разговорные и сленг
        "дороговат", "недёшев", "недешев", "кусает", "кусач", "по карман",
        "накладн", "неподъём", "неподъемн", "не по карман", "жирно",
        # Сравнения
        "конкурент дешевл", "дешевле есть", "у других дешев",
        # Бюджет
        "нет бюджет", "бюджет не позвол", "финансов не хват", "не выдел",
        "не заложен", "ограничен бюджет", "урезали бюджет",
        # Дополнительные
        "дорга", "дорага", "дешивле", "прайс кусает", "жирноват",
        "перебор", "много хотите", "много просите", "завышен",
        "неоправдан", "не стоит таких", "переплат", "не окуп",
        "не отобь", "экономим", "не тянем", "не вытянем",
        "режем расход", "сокращаем затрат", "оптимизируем бюджет",
        # Дополнительные ценовые возражения
        "неподъёмн", "грабёж", "грабительск", "космическ цен", "заоблачн",
        "астрономическ", "золот", "конск", "негуманн", "нереальн цен",
        "за такие деньги", "таких денег не стоит", "цена завышен",
        "ценник лютый", "ценник конский", "ценник космос",
        # Финансовые трудности
        "кризис", "тяжёлые времена", "сложн период", "финансов труд",
        "касса пустая", "оборотки нет", "выручк упала", "продажи упали",
        "нечем платить", "не из чего", "на хлеб не хватает",
        # Сравнение с ценами
        "у вас дороже", "в два раза дороже", "вдвое дороже", "втрое",
        "нашёл дешевле", "видел за меньше", "предлагали дешевле",
    ],
    "objection_no_time": [
        # Стандартные
        "нет времен", "занят", "не сейчас", "позж", "потом", "перезвон",
        # Разговорные
        "некогда", "завал", "запар", "аврал", "горит", "дедлайн",
        "в другой раз", "на днях", "через недел", "через месяц",
        "не до этого", "голова забит", "руки не доход",
        # Вежливые отказы
        "давайте позж", "может потом", "сейчас не могу", "напишите позж",
        # Дополнительные
        "времени нет", "не успеваю", "загружен", "зашиваюсь", "зашива",
        "конец квартал", "конец год", "конец месяц", "отчётност",
        "после праздник", "после отпуск", "после нового год",
        "сезон", "высокий сезон", "несезон", "пик нагрузк",
        "разгребу дела", "разгребём", "освобожусь", "освободимся",
        "следующий квартал", "в новом году",
        # Дополнительные временные отказы
        "в ближайшее время не получится", "на этой неделе никак",
        "совещания весь день", "митинги", "встречи расписан",
        "командировка", "в поездке", "в отъезде", "в разъездах",
        "проект горит", "релиз", "дедлайны горят", "сдача проекта",
        "инвентаризац", "проверк", "аудит", "ревизия",
        "выходные скоро", "после выходных", "на следующей",
        "давайте в понедельник", "давайте во вторник", "на след недел",
        # Сленг временной
        "щас не до этого", "ща не могу", "не ща", "попозже",
        "как-нибудь потом", "когда-нибудь", "не в это время",
        "времечка нет", "ни минутки", "ни секунды", "загруз полный",
    ],
    "objection_competitor": [
        # CRM-системы
        "битрикс", "амо", "amocrm", "amo crm", "мегаплан", "salesforce",
        "pipedrive", "hubspot", "zoho", "freshsales", "1с:crm", "1c:crm",
        "retailcrm", "envybox", "клиентикс", "простой бизнес",
        # POS/ресторанные системы
        "iiko", "ийко", "айко", "poster", "постер", "r_keeper", "r-keeper",
        "quick resto", "quickresto", "frontpad", "фронтпад",
        # Общие фразы
        "уже есть", "уже пользу", "используем", "работаем в",
        "внедрили", "перешли на", "купили", "подключили",
        # Сравнения
        "у нас своя", "самописн", "написали сам", "своя разработк",
        # Дополнительные CRM
        "террасофт", "terrasoft", "creatio", "s2", "planfix", "планфикс",
        "yclients", "iклиент", "yclients", "мегаплан", "wirecrm",
        "insightly", "monday", "notion", "trello", "asana", "jira",
        # Дополнительные фразы
        "сидим на", "работаем на", "юзаем", "пользуем",
        "устраивает текущ", "менять не хотим", "привыкли", "обучены",
        "вложили деньги", "мигрировать дорого", "переносить данные",
        # Дополнительные CRM и системы
        "kommo", "комо", "коммо", "roistat", "ройстат", "calltouch",
        "carrotquest", "carrot", "chatra", "чатра", "jivosite", "живосайт",
        "usedesk", "юздеск", "omnidesk", "омнидеск", "helpdesk", "хелпдеск",
        "mango office", "mango", "манго офис", "манго", "oktell", "октел",
        # Бухгалтерские/ERP
        "1с бухгалтер", "1с предприят", "1с торговл", "эльба", "контур",
        "сбис", "sbis", "мой склад", "мойсклад", "складской учёт",
        # Дополнительные POS
        "rkeeper", "ркипер", "р-кипер", "атол", "атолл", "эвотор", "evotor",
        "сбербизнес", "sber бизнес", "дримкас", "dreamkas", "модуль касс",
        # Общие возражения о конкурентах
        "всё настроено", "всё налажено", "система работает", "нет смысла менять",
        "перенос будет стоить", "переучив", "переобучат", "обучать заново",
        "только внедрили", "недавно купили", "договор заключ", "контракт",
    ],
    "question_features": [
        # Стандартные
        "функци", "возможност", "умеет", "может", "интеграц", "что делает",
        "как работает", "что включ", "что такое", "что это", "что за",
        "расскажи о", "расскажите о", "расскажи про", "расскажите про",
        # Расширенные
        "фичи", "фича", "опции", "опция", "способн", "позволя",
        "поддержива", "предоставля", "обеспечива", "реализова",
        "есть ли", "можно ли", "поддержка", "функционал",
        # Сравнительные
        "отличи", "преимущ", "выгод", "плюс", "минус", "особенност",
        "чем лучше", "чем хуже", "в чём разниц",
        # Дополнительные
        "расскаж про", "расскажите про", "покажите как",
        "что умеет", "что может", "что позволяет", "на что способ",
        "фишки", "фишка", "киллер фич", "уникальн",
        "автоматизац", "автоматич", "триггер", "сценари",
        "шаблон", "конструктор", "настройк", "кастомизац",
        "гибкость", "масштабиру", "безопасност", "надёжност",
        # Технические вопросы
        "api", "апи", "webhook", "вебхук", "rest", "soap", "json",
        "выгрузка", "импорт", "экспорт", "бэкап", "резервн копи",
        "облачн", "cloud", "saas", "сервер", "хостинг", "локальн",
        "мобильн приложен", "ios", "android", "андроид", "айфон",
        # Вопросы о процессах
        "воронк", "лид", "сделк", "конверсия", "конверси",
        "аналитик", "отчёт", "отчет", "дашборд", "dashboard", "статистик",
        "автодейств", "автоответ", "автоназначен", "распределен",
        # Дополнительные вопросы
        "как устроен", "как организован", "как построен", "архитектур",
        "ограничен", "лимит", "квота", "сколько можно",
        "права доступ", "роли", "ролевая", "разграничен прав",
        "история измен", "логирован", "журнал", "аудит действ",
        "уведомлен", "оповещен", "алерт", "напоминан",
    ],
    "question_integrations": [
        # Стандартные
        "интеграц", "подключ", "связ", "синхрониз", "1с", "телефон", "почт",
        "whatsapp", "telegram", "битрикс24",
        # Kaspi и банки
        "kaspi", "каспи", "каспий", "банк", "банков", "эквайринг",
        # Расширенные сервисы
        "viber", "вотсап", "вацап", "телеграм", "инстаграм", "instagram",
        "вконтакте", "vk", "facebook", "фейсбук", "avito", "авито",
        "юла", "циан", "domclick", "яндекс", "yandex", "google", "гугл",
        # Системы и API
        "api", "апи", "webhook", "вебхук", "zapier", "albato", "make",
        "ip-телефон", "sip", "сип", "asterisk", "манго", "mango",
        "мегафон", "билайн", "мтс", "tele2", "теле2", "ростелеком",
        # Бухгалтерия и учёт
        "1с", "мой склад", "мойсклад", "эльба", "контур", "сбис", "sbis",
        # Дополнительные
        "ватсапп", "воцап", "тг", "телега", "инста", "вк", "фб",
        "озон", "ozon", "wildberries", "вайлдберриз", "wb",
        "amo", "битрикс", "бит24", "б24",
        "comagic", "roistat", "ройстат", "calltouch", "колтач",
        "jivosite", "живосайт", "carrot", "чатра", "chatra",
        "sendpulse", "unisender", "mailchimp", "getresponse",
        "tilda", "тильда", "wordpress", "вордпресс", "битрикс сайт",
        # Дополнительные интеграции
        "халык", "halyk", "халык банк", "каспи gold", "каспи ред",
        "forte", "форте", "jusan", "жусан", "bereke", "береке",
        # Маркетплейсы и доставка
        "kaspi магазин", "каспи магазин", "alibaba", "алибаба",
        "cdek", "сдэк", "boxberry", "боксберри", "почта росси",
        "яндекс доставк", "яндекс маркет", "яндекс еда",
        "glovo", "глово", "wolt", "волт", "bolt", "болт",
        # Телефония расширенная
        "sipuni", "сипуни", "voximplant", "вокимплант", "twilio",
        "телфин", "telfin", "novofon", "новофон", "zadarma", "задарма",
        "onlinepbx", "онлайнпбкс", "gravitel", "гравител",
        # Чат-боты и мессенджеры
        "waba", "вааба", "whatsapp business", "бизнес ватсап",
        "botmother", "ботмазер", "salebot", "сейлбот", "smartbot",
        # Email-сервисы
        "sendsay", "сендсей", "dashamail", "дашамейл", "notisend",
        "mailerlite", "мейлерлайт", "email рассылк", "емейл рассыл",
        # Дополнительные сервисы
        "amo виджет", "bitrix маркет", "1с коннектор", "прямая интеграц",
    ],
    "agreement": [
        # Стандартные
        "интересн", "давайте", "расскажите", "хочу", "готов", "согласен",
        "подходит", "нравится", "да,", "да!", "ок", "хорошо", "годится",
        # Разговорные
        "окей", "ладно", "договорились", "идёт", "идет", "пойдёт", "пойдет",
        "замётано", "заметано", "супер", "класс", "отлично", "круто",
        # Активный интерес
        "покажите", "продемонстрир", "демо", "попробова", "тест", "пробн",
        "запишите", "оформ", "подключ", "начн", "старт",
        # Оставить заявку
        "оставлю заявк", "оставить заявк", "оформить заявк", "подать заявк",
        # Уточняющий интерес
        "поподробн", "подробн", "детальн", "конкретн", "расскаж ещё",
        "а как", "а что", "а можно",
        # Дополнительные
        "океюшки", "лады", "ладушки", "добро", "принято", "понял",
        "го", "погнали", "поехали", "стартуем", "начинаем",
        "в деле", "зайду", "гляну", "посмотрю", "попробую",
        "заинтересов", "заинтриговал", "звучит интересн", "звучит неплох",
        "любопытн", "хочется попробова", "было бы интересн",
        "почему бы и нет", "можно попробова", "давай попробу",
        "запиши", "записывай", "бронируй", "бронирую",
        # Дополнительные позитивные сигналы
        "топ", "огонь", "бомба", "зашибись", "вау", "wow", "кайф", "найс", "nice",
        "классно", "здорово", "прикольно", "интересненько", "норм", "норма",
        "чётко", "четко", "збс", "ништяк", "ок, ок", "ага", "угу", "ммм",
        # Деловое согласие
        "готовы обсудить", "готов рассмотр", "можем обсудить", "давайте обсудим",
        "берём", "берем", "оформляем", "оформляй", "заключаем", "подписыва",
        "выставляйте счёт", "счёт выставляй", "выставь счёт", "пришлите счёт",
        "высылайте договор", "пришлите договор", "оплачиваем", "оплачу",
        # Мягкое согласие
        "почему нет", "не против", "согласен попробова", "можно попробова",
        "попробуем", "рискнём", "рискнем", "а давайте", "а почему бы",
        "склоняюсь", "больше склон", "скорее да", "наверн да",
        # Вопросы как согласие
        "как записаться", "как начать", "как подключиться", "куда платить",
        "какие документы", "что нужно для", "как оформить",
    ],
    "rejection": [
        # Стандартные - FIX: удалены "не интересн", "не нужн", "не хочу", "не буд", "отказ"
        # Они вызывали false positives типа "мне нужна" → rejection
        # Эти случаи теперь корректно обрабатываются priority_patterns в patterns.py
        " не надо", "нет,", "нет!", "отстань", "пока не",
        # Разговорные и резкие
        "отвали", "отвяжи", "достал", "хватит", "прекрат", "стоп",
        "не пиши", "не звони", "заблокир", "в бан", "спам",
        # Вежливые отказы
        "спасибо не надо", "благодарю но", "пожалуй нет", "воздерж",
        "обойдусь", "обойдёмся", "справимся сами", "сами разбер",
        # Скептицизм
        "не верю", "сомнева", "вряд ли", "навряд", "не уверен",
        # Дополнительные
        "неинтересн", "ненужн", "ненадо", "нихачу", "нибуду",
        "без вас обойд", "без вас справ", "пас", "пасс",
        "отписыва", "удали", "убери", "исключи",
        "надоел", "утомил", "замучил", "задолбал",
        "не актуальн", "неактуальн", "не релевантн", "мимо",
        "не наш формат", "не наша тема", "не по адресу",
        # Категоричные отказы
        "никогда", "ни за что", "ни при каких", "категорическ",
        "абсолютн нет", "точно нет", "однозначн нет", "определённо нет",
        "ни в коем случае", "ни в коем", "ни под каким",
        # Грубые отказы (для распознавания)
        "пошёл", "пошли вы", "идите лесом", "идите нафиг", "отвянь",
        "от*бись", "отстаньте", "достали уже", "задолбали",
        "сколько можно", "снова вы", "опять вы", "да сколько раз",
        # Мягкие отказы
        "не сейчас", "не в этот раз", "может быть потом", "возможно позже",
        "пока воздерж", "пока откаж", "на данный момент нет",
        "сейчас не готов", "сейчас не актуальн",
        # Отказ по причине
        "не подходит", "не для нас", "не наше", "не наш профиль",
        "мы не ваша целевая", "не ваш клиент", "не целевая аудитор",
        "закрыт бизнес", "закрываемся", "банкрот", "ликвидац",
        # Технические причины
        "нет компьютер", "нет интернет", "не пользуемся", "работаем офлайн",
    ],
    "contact_provided": [
        # Email
        "@", "mail", "почта", "gmail", "yandex", "inbox", "outlook", "rambler",
        "емейл", "имейл", "мейл", "email", "e-mail",
        # Телефон
        "телефон", "позвон", "номер", "мобильн", "сотов", "трубк",
        "набер", "звякн", "созвон", "ватсап пиши", "в телегу пиши",
        # Дополнительные
        "мой номер", "напишите на", "пишите на", "звоните на",
        "вот контакт", "вот телефон", "вот почта", "скину номер",
        "запиши мой", "запишите мой", "записывай",
        "вотсап", "телеграм", "тг", "телега",
        # Дополнительные контактные данные
        "mail.ru", "bk.ru", "list.ru", "internet.ru", "yahoo", "icloud",
        "protonmail", "hotmail", "live.com", "корпоративн почт",
        # Телефонные форматы
        "+7", "8-", "87", "+77", "7 7", "восем", "плюс сем",
        "городск номер", "рабочий телефон", "личный телефон",
        "директ", "direct", "личк", "лс", "pm", "дм",
        # Мессенджеры расширенные
        "signal", "сигнал", "discord", "дискорд", "skype", "скайп",
        "zoom", "зум", "teams", "тимс", "meet", "мит",
        # Соцсети
        "инста ник", "тг ник", "вк ид", "fb id", "linkedin",
    ],

    # =================================================================
    # SPIN-ИНТЕНТЫ (для методологии SPIN Selling)
    # =================================================================

    # Ответы на S-вопросы (Situation - текущая ситуация)
    "situation_provided": [
        # Размер команды
        "человек", "сотрудн", "команд", "штат", "коллектив", "персонал",
        # Тип бизнеса
        "магазин", "точк", "точек", "ресторан", "кафе", "опт", "розниц",
        "склад", "офис", "салон", "клиник", "агентств", "студия",
        "производств", "завод", "фабрик", "сервис", "служб",
        # Текущие инструменты
        "excel", "эксел", "табли", "1с", "битрикс", "на бумаг", "блокнот",
        "вручную", "руками", "менеджер", "продавц", "в голов",
        "гугл табли", "гугл докс", "notion", "trello",
        # Текущий процесс
        "ведём", "ведем", "используем", "работаем", "пользуемся",
        # Дополнительные типы бизнеса
        "франшиз", "сеть", "филиал", "отделен", "представительств",
        "интернет-магазин", "онлайн-магазин", "маркетплейс", "e-commerce",
        "бар", "пекарн", "столов", "кондитерск", "кофейн", "пиццер",
        "автосервис", "автомойк", "шиномонтаж", "сто",
        "парикмахерск", "барбершоп", "spa", "спа", "массажн", "фитнес",
        "стоматолог", "мед центр", "лаборатор", "аптек",
        # Дополнительные инструменты
        "airtable", "эйртейбл", "smartsheet", "смартшит", "monday", "мандей",
        "asana", "асана", "basecamp", "бейскемп", "clickup", "кликап",
        "тетрадк", "ежедневник", "стикер", "записк", "напоминалк",
        # Размеры и масштаб
        "малый бизнес", "средний бизнес", "крупный бизнес", "микробизнес",
        "стартап", "ип", "ооо", "тоо", "индивидуальн предприниматель",
    ],

    # Ответы на P-вопросы (Problem - выявление проблем)
    "problem_revealed": [
        # Потери и ошибки
        "теря", "упуск", "забыва", "путаниц", "ошибк", "неразберих",
        "не успева", "долго", "много времен", "вручную", "рутин",
        # Отсутствие контроля
        "нет контрол", "не знаю", "не вижу", "не понима", "непонятн",
        "не отслежива", "не фиксир",
        # Проблемы
        "проблем", "сложн", "неудобн", "бардак", "хаос", "беспорядок",
        "головн бол", "боль", "мучает", "надоел", "достал",
        # Негативные последствия
        "уход", "сбега", "недовольн", "жалу", "ругают",
        # Дополнительные проблемы
        "дублир", "дубликат", "повтор", "пересечен", "конфликт",
        "нет единой", "разрозненн", "разбросан", "несогласован",
        "просрочк", "опоздан", "задержк", "срыв срок", "дедлайн проваливаем",
        "текучк", "увольня", "уходят люди", "кадры бегут",
        # Коммуникационные проблемы
        "не доходит", "теряется информац", "не передают", "забыли сказать",
        "каждый по-своему", "нет единых стандарт", "самодеятельност",
        "клиент жалуется", "клиент ругается", "негатив от клиент",
        # Технические проблемы
        "тормозит", "виснет", "падает", "глючит", "баг", "ошибки система",
        "не синхронизир", "данные расход", "потеря данных",
    ],

    # Ответы на I-вопросы (Implication - осознание последствий)
    "implication_acknowledged": [
        # Количественные потери
        "потер", "убытк", "недополуч", "упущен", "стоит", "обходит",
        "тысяч", "миллион", "рубл", "тенге", "процент", "клиент уход",
        # Временные затраты
        "час", "день", "недел", "тратим", "уходит", "занимает",
        # Признание серьёзности
        "критичн", "серьёзн", "важн", "да, это", "согласен", "верно",
        "да уж", "к сожалению", "увы", "к сожелению", "точно",
        "примерно", "около", "наверное", "где-то",
    ],

    # Ответы на N-вопросы (Need-Payoff - ценность решения)
    "need_expressed": [
        # Желания
        "хоте", "нуж", "надо", "было бы", "если бы", "идеальн",
        # Решения
        "автоматиз", "контрол", "видеть", "понима", "экономить", "сберечь",
        "упрост", "ускор", "наладить", "систематиз", "организ",
        # Признание ценности
        "помогло бы", "решило бы", "избавило", "спасло",
        "было бы отлично", "было бы супер", "было бы здорово",
        "да, это", "конечно", "естественно", "определённо",
    ],

    # Отрицание проблемы (ответ на P-вопросы)
    "no_problem": [
        # Прямое отрицание проблемы
        "нет проблем", "проблем нет", "всё хорошо", "все хорошо",
        "всё нормально", "все нормально", "нас устраивает", "нас всё устраивает",
        "справляемся", "справляемся сами", "у нас всё ок", "у нас все ок",
        "у нас нет таких", "с этим всё в порядке", "с этим все в порядке",
        "всё работает", "все работает", "не жалуемся", "нет такого",
        "это не про нас", "у нас иначе", "нам это не грозит",
        "нет никаких", "ничего подобного", "таких нет",
        # Косвенное отрицание
        "нет не теряем", "нет не забыва", "нет всё фиксиру", "нет контролиру",
        "с этим порядок", "тут всё ок", "тут все ок", "здесь норм",
    ],

    # Отрицание потребности (ответ на N-вопросы)
    "no_need": [
        # Прямое отрицание потребности
        "не нужно", "нам не нужно", "нам это не нужно", "не надо",
        "нам не надо", "не требуется", "нам не требуется",
        "обойдёмся", "обойдемся", "обходимся", "обойдусь",
        "и так справляемся", "и так справимся", "справимся сами",
        "пока не нужно", "сейчас не нужно", "в этом нет необходимости",
        "без этого обойдёмся", "без этого обойдемся", "без этого проживём",
        "нет необходимости", "не видим необходимости", "не вижу смысла",
        "нам это ни к чему", "это лишнее", "не актуально",
        # Косвенное отрицание
        "текущего хватает", "хватает того что есть", "нас устраивает как есть",
        "менять не хотим", "ничего менять не надо", "оставим как есть",
    ],

    # =================================================================
    # НОВЫЕ ИНТЕНТЫ (добавлены для полноты классификации)
    # =================================================================

    # Запрос обратного звонка
    "callback_request": [
        "перезвон", "позвон", "свяжи", "связаться", "набери", "наберите",
        "жду звонк", "ожидаю звонк", "вот номер", "вот телефон", "вот контакт",
        "запиши номер", "запишите номер", "мой телефон", "мой номер",
        "созвонимся", "созвониться", "пообщаться", "поговорить",
        "на связи", "выйти на связь", "контакт для связи",
        # Дополнительные
        "брось звоночек", "кинь звонок", "стукни", "черкани",
        "напиши в ватсап", "напиши в телегу", "кинь в тг",
        "пинганите", "тукните", "тыкните", "постучитесь",
        "когда удобно позвонить", "во сколько звонить", "в какое время",
        "утром позвоните", "вечером позвоните", "после обеда",
        "завтра перезвоните", "в понедельник", "на неделе",
    ],

    # Запрос демо
    "demo_request": [
        "демо", "демонстрац", "показать", "покажите", "попробова", "потестир",
        "тестов", "пробн", "триал", "trial", "бесплатн период", "бесплатн доступ",
        "посмотреть как работает", "в действии", "на примере", "живой пример",
        "тест драйв", "тест-драйв", "ознакомительн", "презентац",
        # Дополнительные
        "freemium", "фримиум", "free trial", "фри триал", "пилот", "пилотн",
        "poc", "proof of concept", "пруф оф концепт", "демка", "демоверсия",
        "тестовый аккаунт", "тестовая учётк", "песочниц", "sandbox",
        "покрутить", "пощупать", "поюзать", "потыкать", "поклацать",
        "хочу глянуть", "хочу посмотреть", "хочу увидеть", "покажи",
        "устроить демо", "назначить демо", "забукать демо", "забронировать демо",
        "онлайн показ", "вебинар", "скринкаст", "screen share", "шаринг экрана",
    ],

    # Запрос консультации
    "consultation_request": [
        "консультац", "проконсультир", "совет", "посовет", "порекоменд",
        "помогите разобрат", "помогите понять", "помогите выбрать",
        "вопрос по", "вопросы о", "хотел бы обсудить", "хотел бы поговорить",
        "нужна помощь", "нужен совет", "что посоветуете",
        # Дополнительные
        "подсказать", "подскажите", "объясните", "объясни", "расскажите",
        "разъясните", "проясните", "уточните", "расшифруйте",
        "не понимаю как", "не могу разобраться", "запутался",
        "поясните простым", "на пальцах", "для чайников",
        "нужен эксперт", "поговорить со специалист", "менеджер нужен",
        "хочу узнать подробнее", "хочу разобраться", "хочу понять",
    ],

    # Сравнение с конкурентами
    "comparison": [
        "сравн", "разниц", "отличи", "отличает", "лучше чем", "хуже чем",
        "преимущ", "плюс", "минус", "vs", "против", "или", "вместо",
        "почему вас", "почему вы", "чего нет у", "что есть у вас",
        "по сравнению", "относительно",
        # Дополнительные
        "аналог", "альтернатив", "конкурент", "похож на",
        "чем круче", "чем лучше", "чем отличается", "в чём разница",
        "что выбрать", "что взять", "что лучше", "что хуже",
        "табличка сравнен", "матрица сравнен", "сравнительная таблиц",
        "battle", "батл", "versus", "версус",
    ],

    # Детали по цене
    "pricing_details": [
        "что входит", "из чего состоит", "складывается цена", "состав тариф",
        "прайс-лист", "прайслист", "расчёт", "расчет", "калькуляц",
        "скидк", "акци", "минимальн пакет", "базов тариф",
        "за пользователя", "за рабочее место", "за лицензию",
        "помесячн", "ежемесячн", "годов оплат", "разов оплат",
        "рассрочк", "отсрочк", "условия оплат", "способы оплат",
        # Дополнительные
        "тарифная сетк", "линейка тариф", "пакетные предложен",
        "enterprise", "энтерпрайз", "корпоративн тариф", "premium", "pro",
        "стандарт", "бизнес", "старт", "лайт", "free", "фри", "бесплатн",
        "дополнительн опции", "платные модули", "надбавки", "доплаты",
        "внедрение", "настройка", "обучение", "сопровождение", "поддержка",
        "скрытые плат", "комиссия", "абонентская", "единоразов",
        "возврат средств", "гарантия возврат", "money back",
    ],

    # Возражение "надо подумать"
    "objection_think": [
        "подумать", "посовещ", "обсудить", "согласов", "посоветов",
        "с руководств", "с начальств", "с директор",
        "не в моей компетенц", "не я решаю", "решение принима",
        "дайте время", "нужно время", "раздумать", "обдумать",
        "не готов", "не готовы", "перезвоню сам", "вернусь",
        "пока не могу", "пока не готов",
        # Дополнительные
        "спрошу у шефа", "уточню у директор", "согласую с собственник",
        "посоветуюсь с партнёр", "покажу коллег", "обсужу с командой",
        "это не моё решен", "выше моего уровня", "не уполномоч",
        "взвесить все за и против", "сравнить вариант", "подумать на холодн голов",
        "переспать с мыслью", "переварить информац", "осмыслить",
        "пока рано решать", "ещё не созрел", "нужно дозреть",
    ],

    # Прощание
    "farewell": [
        "до свидания", "до связи", "до встречи", "пока", "всего доброго",
        "всего хорошего", "удачи", "хорошего дня", "хорошего вечера",
        "спасибо пока", "благодарю пока", "бай", "бб", "покедова",
        "чао", "адьёс", "на сегодня всё", "на этом всё",
        # Дополнительные
        "досвидос", "бывай", "бываем", "давай", "ну давай",
        "созвонимся", "ещё спишемся", "на связи", "будем на связи",
        "хорошего продолжения", "успехов", "удачного дня", "отличного дня",
        "приятного вечера", "спокойной ночи", "добрых снов",
        "ариведерчи", "гудбай", "goodbye", "bye", "see you", "сиюу",
    ],

    # Благодарность
    "gratitude": [
        "спасибо", "благодарю", "спс", "пасибо", "благодарн", "признателен",
        "большое спасибо", "огромное спасибо", "спасибо за", "благодарю за",
        "очень благодарен", "очень признателен",
        # Дополнительные
        "сенкс", "thanks", "thx", "thank you", "респект", "respect",
        "премного благодар", "искренне благодар", "от души",
        "благодарочка", "спасибочки", "спасибки", "благодарствую",
        "оценил помощь", "выручили", "помогли", "спасли",
    ],

    # Болтовня/Small talk
    "small_talk": [
        "как дела", "как жизнь", "как настроение", "как сам", "как сама",
        "что нового", "что новенького", "как выходные", "как праздники",
        "какая погода", "хорошая погода",
        # Дополнительные
        "как оно", "как ты", "как вы там", "чё как", "шо нового",
        "норм дела", "как поживаете", "как идут дела", "как бизнес",
        "как настрой", "как боевой дух", "как моральный дух",
        "ну что там", "ну как", "давно не общались", "сто лет не виделись",
    ],

    # Неясно/Уточнение
    "unclear": [
        "что", "ась", "чего", "не понял", "не понятно", "что это",
        "повторите", "ещё раз", "не расслышал", "переформулир",
        "можно подробнее", "что имеете в виду",
        # Дополнительные
        "чёё", "чоо", "шо", "шта", "а?", "э?", "хм", "ммм",
        "не уловил", "не догнал", "не врубился", "не дошло",
        "объясните ещё раз", "можно повторить", "перефразируй",
        "слишком сложно", "простыми словами", "на пальцах объясни",
        "чего-чего", "как-как", "в смысле", "то есть",
    ],

    # =================================================================
    # PHASE 3: Circular Flow (возврат назад по фазам)
    # =================================================================

    "go_back": [
        # Прямые запросы на возврат
        "вернуться", "назад", "подожди", "стоп", "погоди",
        "давай вернёмся", "давай вернемся", "хочу вернуться",
        "вернись", "вернитесь", "можно назад",
        # Остановка
        "подождите", "минутку", "секунду", "постой",
        "притормози", "давай помедленнее", "не так быстро",
    ],
    "correct_info": [
        # Исправление информации
        "я ошибся", "я неправильно", "не так сказал", "уточню",
        "на самом деле", "точнее", "уточняю", "исправляюсь",
        "не совсем так", "я имел в виду", "правильнее будет",
        "я неверно", "я неточно", "перепутал", "ошибка",
        # Переосмысление
        "погодите", "стоп", "нет подождите", "не то сказал",
        "давайте заново", "давай заново", "с начала",
    ],

    # =================================================================
    # ДОПОЛНИТЕЛЬНЫЕ ВОЗРАЖЕНИЯ (Phase 4 coverage)
    # =================================================================

    "objection_complexity": [
        # Сложность внедрения
        "сложно", "сложност", "непрост", "трудно", "труднос",
        "внедрен", "внедрят", "настройк", "настраива",
        # Переход и миграция
        "переход", "мигрир", "миграц", "перенос", "переносить",
        # Обучение
        "переучи", "обучени", "обучать", "учить заново",
        # Ресурсы
        "ресурсов нет", "нет ресурс", "много работ", "много возн",
        # Страхи
        "сломает", "пугает", "боюсь", "страшно", "риск",
        # Сопротивление
        "сопротивля", "не захот", "будут против", "не примут",
        # Время на внедрение
        "займёт", "займет", "потребует", "долго настра",
        # Дополнительные
        "болезнен", "геморрой", "головняк", "морок", "канитель",
        "заморочк", "запар", "сложняк", "непросто",
    ],

    "objection_trust": [
        # Недоверие
        "не уверен", "не верю", "не доверя", "сомнева", "сомнен",
        # Доказательства
        "гарант", "доказательств", "подтверд", "подтвержден",
        # Отзывы и кейсы
        "отзыв", "референс", "кейс", "пример клиент", "кто пользу",
        # Скептицизм
        "слишком хорош", "звучит красиво", "обещани", "обеща",
        "обманете", "обман", "развод", "разводк", "лохотрон",
        # Проверка
        "проверить", "убедиться", "удостовериться",
        # Риски
        "а если не", "что если", "вдруг не",
        # Репутация
        "репутац", "надёжн", "надежн", "стабильн", "давно на рынк",
    ],

    "objection_timing": [
        # Отложить
        "не сейчас", "позже", "потом", "после", "через",
        "в следующ", "на следующ", "в будущ",
        # Конкретные сроки
        "после нового год", "после праздник", "после отпуск",
        "в январ", "в феврал", "весн", "осен", "летом", "зимой",
        "через месяц", "через недел", "через полгод", "через год",
        "в конце год", "в начале год", "в следующем квартал",
        # Привязка к событиям
        "после проект", "после релиз", "после закрыт", "после сдач",
        "когда бюджет", "когда утверд", "когда согласу",
        # Неопределённые сроки
        "когда-нибудь", "как-нибудь", "рано ещё", "рано еще",
        "пока рано", "не время", "несвоеврем",
        # Напоминания
        "напомните", "напишите позже", "перезвоните потом",
    ],

    "objection_no_need": [
        # Прямой отказ
        "не нужно", "не надо", "не требует", "не нужна",
        "ненужно", "ненадо",
        # Справляемся сами
        "справляемся", "справимся", "обойдёмся", "обойдемся",
        "обходимся", "хватает", "достаточно",
        # Нет проблемы
        "нет проблем", "проблем нет", "всё работает", "все работает",
        "и так норм", "и так хорош", "устраива",
        # Альтернативы
        "excel", "эксел", "блокнот", "тетрадк", "таблиц",
        "своими силами", "вручную", "по старинк",
        # Размер бизнеса
        "маленьк", "небольш", "мало клиент", "мало заказ",
        # Отсутствие смысла
        "не вижу смысл", "зачем нам", "для чего", "лишн",
        "трата ресурс", "трата времен", "трата денег",
    ],

    "info_provided": [
        # Тип бизнеса
        "занимаемся", "работаем в", "наша сфера", "наш бизнес",
        "продаём", "продаем", "производим", "оказыва услуг",
        # Размер
        "человек", "сотрудник", "менеджер", "продавец", "оператор",
        "точек", "филиал", "офис", "магазин", "ресторан",
        # Клиенты
        "клиент", "заказчик", "покупател", "b2b", "b2c", "корпоратив",
        # Обороты
        "оборот", "выручк", "средний чек", "в месяц", "в год",
        # Каналы
        "сайт", "инстаграм", "маркетплейс", "авито", "звонк",
    ],
}

# =============================================================================
# ИНТЕНТЫ: ПОЛНЫЕ ФРАЗЫ (для pymorphy2 fallback)
# =============================================================================

INTENT_PHRASES = {
    "greeting": [
        # Стандартные
        "привет", "здравствуйте", "добрый день", "доброе утро", "добрый вечер",
        "хай", "приветствую", "салют",
        # Разговорные
        "прив", "здарова", "дарова", "хаюшки", "приветик", "ку",
        "здрасьте", "доброго времени", "доброго дня",
        # Формальные и вежливые
        "рад приветствовать", "приятно познакомиться", "всем привет",
        # Дополнительные
        "дратути", "превед", "приветос", "здорово", "хеллоу",
        "доброго времени суток", "приветствую вас", "здравия желаю",
        "добренького", "утречко доброе", "добрый денёчек",
    ],
    "price_question": [
        # Стандартные
        "сколько стоит", "какая цена", "прайс", "почём", "стоимость",
        "какой ценник", "по деньгам", "какие тарифы", "какие расценки",
        "сколько это будет стоить", "во сколько обойдётся", "какой бюджет нужен",
        # Вежливые
        "не подскажете стоимость", "можно узнать цену", "подскажите по ценам",
        "интересует стоимость", "хотел бы узнать цену", "скажите сколько",
        # Косвенные
        "интересует финансовая сторона", "что по деньгам", "что по цене",
        "какие условия по оплате", "как по финансам",
        # С контекстом
        "а если на год сколько выйдет", "сколько за месяц", "сколько за пользователя",
        "какая цена за лицензию", "стоимость подписки", "абонентская плата",
        "цена внедрения", "скрытые платежи есть", "есть пробный период",
        # Разговорные
        "чё почём", "скока стоит", "почом будет", "скинь прайс",
        # Дополнительные вежливые
        "не подскажете по стоимости", "сколько это удовольствие стоит",
        "хотелось бы узнать цену", "интересно узнать стоимость",
        "если не секрет сколько", "можете озвучить цену",
        # Дополнительные с контекстом
        "сколько за одно рабочее место", "цена за оператора",
        "сколько если оплатить сразу за год", "есть ли скидка за объём",
        "минимальный пакет сколько стоит", "сколько стоит базовый тариф",
        "какой минимальный платёж", "от какой суммы можно начать",
        "сколько за внедрение берёте", "настройка платная",
        "обучение входит в стоимость", "что входит в цену",
        # Дополнительные разговорные
        "во сколько влетит", "сколько это встанет", "какой чек выйдет",
        "в какую сумму уложимся", "какие денежки нужны",
    ],
    "objection_price": [
        # Стандартные
        "дорого", "слишком дорого", "дешевле есть", "нет бюджета",
        "не потянем", "денег нет", "дороговато",
        # Разговорные
        "цены кусаются", "ценник не по карману", "жирновато",
        "накладно выходит", "неподъёмная сумма",
        # Сравнительные
        "у конкурентов дешевле", "есть варианты подешевле",
        "видел дешевле", "другие предлагают дешевле",
        # Бюджетные
        "бюджет не позволяет", "не заложено в бюджет", "урезали бюджет",
        "выделили мало", "не выделили средства",
        # Скидки
        "есть скидки", "можно дешевле", "скиньте цену", "торг уместен",
        # Дополнительные
        "это перебор", "слишком много хотите", "завышенный ценник",
        "не окупится", "не отобьётся", "рентабельность под вопросом",
        "за эти деньги можно что-то получше", "цена не соответствует",
        "неоправданно дорого", "не стоит таких денег",
        "режем расходы сейчас", "оптимизируем затраты",
        "в кризис не до этого", "экономим каждую копейку",
        "можно бесплатную версию", "есть бесплатный период",
    ],
    "objection_no_time": [
        # Стандартные
        "нет времени", "занят", "не сейчас", "перезвоните позже",
        "давайте потом", "сейчас не могу",
        # Разговорные
        "некогда совсем", "завален работой", "запара на работе", "аврал",
        "горят дедлайны", "конец квартала",
        # Отложенные
        "в другой раз", "на следующей неделе", "через месяц",
        "после праздников", "после отпуска", "давайте в следующем квартале",
        # Вежливые
        "сейчас не лучшее время", "не до этого сейчас", "голова другим забита",
        "руки не доходят", "много других задач",
        # Дополнительные
        "загружены по горло", "зашиваемся", "работы невпроворот",
        "сейчас горячая пора", "высокий сезон у нас",
        "отчётный период", "конец года", "конец месяца",
        "после новогодних праздников", "в январе напишите",
        "пока разгребём текущие дела", "освободимся и свяжемся",
        "может через пару недель", "давайте после выходных",
        "на этой неделе точно нет", "следующий месяц тоже занят",
    ],
    "objection_competitor": [
        # CRM упоминания
        "уже есть crm", "используем битрикс", "у нас амо", "есть система",
        "уже пользуемся", "работаем в другой",
        # Конкретные системы
        "сидим на битриксе", "внедрили амо", "перешли на мегаплан",
        "используем salesforce", "подключили pipedrive", "работаем в hubspot",
        # Своя разработка
        "у нас своя система", "самописная crm", "написали сами",
        "своя разработка", "кастомное решение",
        # Замена
        "менять не планируем", "устраивает текущая", "привыкли к своей",
        "не хотим переучиваться", "переход дорого обойдётся",
        # Дополнительные
        "уже внедрили другую систему", "недавно купили crm",
        "вложились в битрикс", "оплатили амо на год вперёд",
        "команда обучена на другой системе", "все привыкли к текущей",
        "переносить данные сложно", "миграция будет долгой",
        "у нас всё в notion", "ведём в trello",
        "работаем в excel пока нормально", "гугл таблицы устраивают",
        "бесплатной версии хватает", "используем бесплатную crm",
    ],
    "question_features": [
        # Стандартные
        "что умеете", "какие функции", "какие возможности", "что может",
        "что включено", "что входит", "как работает",
        # Вопросы о продукте
        "что такое", "что это такое", "что это за", "что за продукт",
        "расскажите о продукте", "расскажите про продукт",
        "хочу узнать о продукте", "хочу узнать про продукт",
        # Конкретные вопросы
        "есть ли воронка", "есть автоматизация", "можно настроить",
        "умеете делать рассылки", "есть аналитика", "какие отчёты",
        # Сравнительные
        "чем лучше конкурентов", "какие преимущества", "в чём отличие",
        "почему вас выбрать", "что вы можете чего нет у других",
        # Технические
        "какой стек", "на чём написано", "где хранятся данные",
        "есть мобильное приложение", "работает офлайн",
        # Практические
        "сколько займёт внедрение", "нужно ли обучение", "есть поддержка",
        "как быстро отвечаете", "есть документация",
        # Дополнительные
        "какие фишки есть", "в чём ваша фишка", "какая киллер фича",
        "что умеет ваша система", "расскажите про функционал",
        "покажите возможности", "демонстрация возможностей",
        "можно автоматизировать рутину", "есть ли шаблоны",
        "можно настроить под себя", "насколько гибкая система",
        "есть api для разработчиков", "можно кастомизировать",
        "как с безопасностью", "данные защищены",
        "есть резервное копирование", "где сервера расположены",
        "можно выгрузить данные", "экспорт есть",
    ],
    "question_integrations": [
        # Стандартные
        "какие интеграции", "с чем интегрируется", "подключается ли",
        "есть интеграция с", "работает с 1с",
        # Мессенджеры
        "подключается к whatsapp", "есть телеграм бот", "интеграция с вайбер",
        "работает с вконтакте", "подключается инстаграм",
        # Телефония
        "есть интеграция с телефонией", "подключается к ats", "работает с манго",
        "можно записывать звонки", "интеграция с ip-телефонией",
        # Учётные системы
        "синхронизируется с 1с", "есть связь с бухгалтерией",
        "интеграция с мой склад", "подключается к эльбе",
        # Маркетплейсы
        "работает с авито", "подключается к wildberries", "есть озон интеграция",
        # Дополнительные
        "интеграция с вотсапом", "подключить телегу можно",
        "с вк работает", "инста подключается",
        "интеграция с ройстат", "коллтрекинг есть",
        "работает с колмагик", "интегрируется с колтач",
        "есть вебхуки", "апи открытое",
        "можно через zapier", "albato поддерживаете",
        "рассылки через sendpulse", "юнисендер интеграция",
        "с тильдой работает", "формы с сайта собирает",
        "лиды с лендинга подтягивает", "чат на сайт есть",
    ],
    "agreement": [
        # Стандартные
        "интересно", "давайте", "расскажите", "хочу попробовать", "да",
        "согласен", "подходит", "нравится", "готов", "хочу демо",
        # Активный интерес
        "покажите в деле", "хочу посмотреть", "давайте попробуем",
        "запишите на демо", "когда можно посмотреть", "как подключиться",
        # Разговорные
        "окей", "ладно", "договорились", "идёт", "пойдёт", "заметано",
        "супер", "класс", "отлично", "круто", "норм",
        # Уточняющие
        "расскажите подробнее", "а поподробнее можно", "интересно узнать больше",
        "хочу детали", "что ещё умеете",
        # Дополнительные
        "звучит интересно", "звучит неплохо", "заинтересовали",
        "заинтриговали", "любопытно", "хочется попробовать",
        "было бы интересно посмотреть", "можно глянуть",
        "го демо", "погнали", "поехали", "стартуем",
        "давай попробуем", "почему бы и нет", "можно попробовать",
        "запишите меня", "записывайте", "бронируйте время",
        "когда можно созвониться", "когда удобно показать",
        "готов посмотреть", "готовы к демо", "ждём презентацию",
        # Расширенные позитивные сигналы
        "это то что нужно", "именно то что искали", "под нас подходит",
        "нам актуально", "нам релевантно", "то что надо",
        "выставляйте счёт", "присылайте договор", "оформляем",
        "берём на тест", "запускаем пилот", "начинаем работу",
        "жду подробности", "скиньте материалы", "пришлите презентацию",
        "добавьте в чат", "подключите к демо", "включите в рассылку",
    ],

    # =================================================================
    # SPIN-ИНТЕНТЫ (полные фразы)
    # =================================================================

    # Ответы на Situation вопросы
    "situation_provided": [
        "у нас человек", "в команде человек", "нас человек", "работает человек",
        "используем excel", "работаем в excel", "ведём в таблицах", "в 1с",
        "у нас магазин", "у нас ресторан", "у нас склад", "у нас офис",
        "розничная торговля", "оптовые продажи", "сфера услуг",
        "ведём вручную", "записываем в блокнот", "всё в голове",
        "пользуемся", "работаем в", "используем",
    ],

    # Ответы на Problem вопросы
    "problem_revealed": [
        "теряем клиентов", "забываем перезвонить", "путаница в остатках",
        "не успеваем обрабатывать", "много ручной работы", "нет контроля",
        "не видим статистику", "не понимаем что происходит",
        "бардак в данных", "каждый ведёт по-своему", "данные теряются",
        "ошибки в заказах", "проблемы с учётом", "сложно отслеживать",
    ],

    # Ответы на Implication вопросы
    "implication_acknowledged": [
        "теряем тысяч", "уходит часов", "это стоит", "обходится в",
        "примерно клиентов", "около процентов", "тратим времени",
        "да это серьёзно", "да это проблема", "согласен критично",
        "к сожалению много", "да уж немало",
    ],

    # Ответы на Need-Payoff вопросы
    "need_expressed": [
        "было бы здорово", "хотелось бы", "нужно чтобы",
        "помогло бы", "решило бы проблему", "избавило бы",
        "да это упростило бы", "конечно помогло бы",
        "хотим автоматизировать", "нужна система", "хотим видеть",
    ],

    # Отрицание проблемы (ответ на Problem вопросы)
    "no_problem": [
        "нет у нас таких проблем", "нет проблем у нас", "у нас всё хорошо",
        "всё хорошо с этим", "нас всё устраивает", "нас устраивает текущая ситуация",
        "мы справляемся", "справляемся своими силами", "у нас всё под контролем",
        "нет никаких проблем", "проблем не испытываем", "с этим всё в порядке",
        "всё работает нормально", "не жалуемся на это", "нет таких сложностей",
        "это не про нас", "у нас по-другому", "нам это не грозит",
        "ничего подобного у нас нет", "таких проблем не замечали",
        "нет не теряем клиентов", "нет не забываем перезвонить",
        "нет всё фиксируем", "у нас с этим порядок",
    ],

    # Отрицание потребности (ответ на Need-Payoff вопросы)
    "no_need": [
        "нам это не нужно", "не нужно нам это", "мы обойдёмся",
        "обходимся без этого", "и так справляемся", "справимся и так",
        "пока не нужно нам это", "сейчас в этом нет необходимости",
        "без этого обойдёмся нормально", "нет в этом необходимости",
        "не видим в этом необходимости", "не вижу смысла в этом",
        "нам это ни к чему сейчас", "это лишнее для нас",
        "для нас это не актуально", "текущего решения хватает",
        "хватает того что есть сейчас", "нас устраивает как есть",
        "менять ничего не хотим", "ничего менять не нужно",
        "оставим как есть пока", "не требуется нам такое",
    ],

    "rejection": [
        # Стандартные
        "не интересно", "не нужно", "нет", "отстаньте", "не хочу",
        "не буду", "отказываюсь", "не надо",
        # Резкие
        "отвалите", "хватит спамить", "прекратите", "достали",
        "сколько можно", "не пишите больше", "заблокирую",
        # Вежливые
        "спасибо не надо", "благодарю но нет", "пожалуй откажусь",
        "воздержусь", "обойдёмся", "справимся сами",
        # Скептичные
        "не верю в это", "сомневаюсь что поможет", "вряд ли нам подойдёт",
        "не наш вариант", "не для нас",
        # Дополнительные
        "неинтересно совсем", "абсолютно не нужно", "точно нет",
        "без вас обойдёмся", "без вас справимся", "пас",
        "отписывайте меня", "удалите мой контакт", "уберите из базы",
        "надоели", "утомили", "замучили", "задолбали уже",
        "не актуально для нас", "мимо кассы", "не по адресу",
        "это не для нашей компании", "нам это не подходит",
        "мы не ваша целевая аудитория", "не наш профиль",
    ],

    # =================================================================
    # НОВЫЕ ИНТЕНТЫ (полные фразы)
    # =================================================================

    # Запрос обратного звонка
    "callback_request": [
        "перезвоните мне", "позвоните мне", "можете перезвонить",
        "жду вашего звонка", "ожидаю звонка", "свяжитесь со мной",
        "вот мой номер", "вот мой телефон", "запишите мой номер",
        "наберите меня", "созвонимся", "давайте созвонимся",
        "можно созвониться", "хочу поговорить по телефону",
        "лучше по телефону", "удобнее позвонить",
    ],

    # Запрос демо
    "demo_request": [
        "хочу демо", "покажите демо", "можно демо", "дайте демо",
        "хочу посмотреть как работает", "покажите в действии",
        "хочу попробовать", "можно попробовать", "хочу потестировать",
        "есть пробный период", "бесплатный период",
        "дайте тестовый доступ", "пробный доступ", "триал",
        "запишите на демо", "хочу презентацию", "покажите презентацию",
        "можно посмотреть систему", "хочу увидеть интерфейс",
    ],

    # Запрос консультации
    "consultation_request": [
        "нужна консультация", "хочу консультацию", "можно проконсультироваться",
        "посоветуйте что выбрать", "порекомендуйте решение",
        "помогите разобраться", "помогите понять", "помогите выбрать",
        "у меня вопрос", "есть вопросы", "хотел бы обсудить",
        "нужен совет", "что посоветуете", "как лучше сделать",
    ],

    # Сравнение с конкурентами
    "comparison": [
        "чем лучше амо", "чем лучше битрикса", "чем отличаетесь от амо",
        "чем отличаетесь от битрикса", "сравните с амо", "сравните с битрикс",
        "почему вас а не амо", "почему вас а не битрикс",
        "в чём преимущества", "какие плюсы", "какие минусы",
        "что есть у вас чего нет у других", "уникальные функции",
        "амо или вы", "битрикс или вы", "вы или амо",
    ],

    # Детали по цене
    "pricing_details": [
        "что входит в стоимость", "из чего складывается цена",
        "дайте прайс-лист", "пришлите прайс", "скиньте расчёт",
        "есть скидки", "какие акции", "минимальный пакет",
        "базовый тариф сколько", "цена за пользователя",
        "помесячная оплата", "годовая оплата", "есть рассрочка",
        "условия оплаты", "способы оплаты", "как оплатить",
        "скрытые платежи есть", "за что ещё платить",
    ],

    # Возражение "надо подумать"
    "objection_think": [
        "надо подумать", "нужно подумать", "дайте подумать",
        "нужно обсудить", "надо посовещаться", "обсужу с руководством",
        "посоветуюсь с директором", "согласую с начальством",
        "это не я решаю", "решение принимает не я",
        "не в моей компетенции", "нужно время на решение",
        "дайте пару дней", "вернусь позже", "перезвоню когда решу",
        "пока не готов к решению", "нужно всё взвесить",
    ],

    # Прощание
    "farewell": [
        "до свидания", "до связи", "до встречи", "пока",
        "всего доброго", "всего хорошего", "удачи",
        "хорошего дня", "хорошего вечера", "отличного дня",
        "спасибо пока", "спасибо до связи", "благодарю пока",
        "бай", "пока-пока", "чао", "на сегодня всё",
    ],

    # Благодарность
    "gratitude": [
        "спасибо", "благодарю", "большое спасибо", "огромное спасибо",
        "спасибо за информацию", "спасибо за помощь",
        "благодарю за консультацию", "очень благодарен",
        "признателен за помощь", "спасибо что помогли",
    ],

    # Болтовня/Small talk
    "small_talk": [
        "как дела", "как жизнь", "как настроение", "как сам",
        "что нового", "что новенького", "как выходные провели",
        "как праздники", "какая погода", "хорошая погода сегодня",
    ],

    # Неясно/Уточнение
    "unclear": [
        "что", "ась", "чего", "не понял", "не понятно",
        "что это", "повторите пожалуйста", "ещё раз скажите",
        "не расслышал", "переформулируйте", "можно подробнее",
        "что имеете в виду", "что вы сказали",
    ],

    # Phase 3: Circular Flow
    "go_back": [
        "вернуться назад", "давай вернёмся", "хочу вернуться",
        "можно назад", "подождите минутку", "стоп погодите",
        "давай помедленнее", "не так быстро", "притормози",
    ],
    "correct_info": [
        "я ошибся", "не так сказал", "уточню",
        "на самом деле", "я имел в виду", "исправляюсь",
        "не совсем так", "правильнее будет", "я перепутал",
        "давайте заново", "с начала", "не то сказал",
    ],

    # =================================================================
    # ДОПОЛНИТЕЛЬНЫЕ ВОЗРАЖЕНИЯ (Phase 4 coverage)
    # =================================================================

    "objection_complexity": [
        # Сложность внедрения
        "слишком сложно внедрять", "долго настраивать систему",
        "много работы с переходом", "придётся переучивать команду",
        "интеграция займёт месяцы", "нет ресурсов на внедрение",
        "потребует много сил", "процесс миграции пугает",
        "боюсь что всё сломается", "переход будет болезненным",
        "надо переносить данные", "сотрудники будут сопротивляться",
        "нет времени на обучение", "слишком много возни",
        # Дополнительные
        "сложно разобраться", "слишком запутанная система",
        "непростой переход", "долгое внедрение",
        "нужен специалист для настройки", "без айтишника не разберёмся",
    ],

    "objection_trust": [
        # Недоверие
        "не уверен что это работает", "сомневаюсь в результате",
        "а есть гарантии", "кто ещё пользуется вашей системой",
        "покажите отзывы клиентов", "откуда мне знать что не обманете",
        "звучит слишком хорошо", "не верю в такие обещания",
        "какие есть доказательства", "а что если не поможет",
        "можете подтвердить результаты", "хочу увидеть референсы",
        "кейсы из нашей отрасли есть", "почему должен вам доверять",
        # Дополнительные
        "нужны доказательства", "чем докажете", "хочу примеры",
        "есть реальные клиенты", "можно поговорить с вашими клиентами",
        "сколько лет на рынке", "кто за вами стоит",
    ],

    "objection_timing": [
        # Отложить на время
        "не сейчас", "давайте после нового года",
        "перезвоните через месяц", "в следующем квартале обсудим",
        "после праздников вернёмся", "сейчас не лучшее время",
        "подождите до весны", "может быть в следующем году",
        "пока рано об этом говорить", "через полгода напомните",
        "после отпуска созвонимся", "ближе к концу года",
        "когда бюджет сформируем", "после закрытия проекта",
        # Дополнительные
        "давайте отложим", "не в этом месяце", "в другой раз",
        "может потом", "ещё не время", "напишите позже",
    ],

    "objection_no_need": [
        # Нет потребности
        "нам это не нужно", "справляемся без CRM",
        "и так всё работает", "обойдёмся своими силами",
        "нет такой проблемы", "не вижу смысла в этом",
        "нам не требуется автоматизация", "мы маленькие нам не надо",
        "обходимся без этого", "хватает текущих инструментов",
        "excel нас устраивает", "ведём всё в блокноте",
        "зачем нам это нужно", "лишняя трата ресурсов",
        # Дополнительные
        "не нуждаемся", "без этого обойдёмся", "и так хорошо",
        "текущих решений достаточно", "работаем по старинке",
        "нам хватает того что есть", "не видим необходимости",
    ],

    "info_provided": [
        # Информация о бизнесе
        "мы занимаемся продажами", "у нас 10 менеджеров",
        "работаем с корпоративными клиентами", "основной канал сайт",
        "средний чек 50 тысяч", "продаём услуги",
        # Дополнительные
        "у нас ресторан", "у нас магазин", "у нас салон",
        "работаем в сфере услуг", "занимаемся оптовой торговлей",
        "в команде 5 человек", "оборот миллион в месяц",
        "клиентов около 100", "работаем на рынке 3 года",
    ],

    "contact_provided": [
        # Контактные данные
        "мой номер", "вот телефон", "записывайте номер",
        "пишите на почту", "вот мой email", "моя почта",
        "звоните по этому номеру", "мой телеграм",
        "напишите в WhatsApp", "вот визитка",
        # Дополнительные
        "контакт для связи", "связаться можно по",
        "лучше на почту", "пишите сюда", "вот мои контакты",
    ],
}

# Веса для разных методов классификации (из settings.yaml)
CLASSIFIER_CONFIG = {
    "root_match_weight": settings.classifier.weights.root_match,
    "phrase_match_weight": settings.classifier.weights.phrase_match,
    "lemma_match_weight": settings.classifier.weights.lemma_match,
    "high_confidence_threshold": settings.classifier.thresholds.high_confidence,
    "min_confidence": settings.classifier.thresholds.min_confidence,
    # Веса для слияния результатов классификаторов (disambiguation)
    # root_classifier_weight + lemma_classifier_weight должны = 1.0
    "root_classifier_weight": getattr(
        getattr(settings.classifier, "merge_weights", None),
        "root_classifier", 0.6
    ) if hasattr(settings.classifier, "merge_weights") else 0.6,
    "lemma_classifier_weight": getattr(
        getattr(settings.classifier, "merge_weights", None),
        "lemma_classifier", 0.4
    ) if hasattr(settings.classifier, "merge_weights") else 0.4,
}

# =============================================================================
# DISAMBIGUATION CONFIG (уточнение намерения при близких scores)
# =============================================================================

DISAMBIGUATION_CONFIG = {
    # Минимальный confidence для рассмотрения
    "min_confidence_threshold": 0.4,

    # Максимальный разрыв между top-1 и top-2
    "max_score_gap": 0.15,

    # Количество опций для показа пользователю
    "max_options": 3,

    # Минимальный confidence опции для включения
    "min_option_confidence": 0.25,

    # Исключённые интенты (не показывать в disambiguation)
    "excluded_intents": ["unclear", "small_talk"],

    # Интенты которые не требуют disambiguation даже при близких scores
    "bypass_disambiguation_intents": [
        "rejection",
        "contact_provided",
        "demo_request",
    ],

    # Cooldown: не показывать disambiguation N ходов после предыдущего
    "cooldown_turns": 3,
}

# =============================================================================
# ИНТЕНТЫ-ВОПРОСЫ (требуют ответа из базы знаний)
# =============================================================================
# Принцип: когда клиент задаёт вопрос, бот должен СНАЧАЛА ответить,
# а ПОТОМ продолжить квалификацию/продажу

QUESTION_INTENTS = {
    "question_features",      # Что такое? Какие функции?
    "question_integrations",  # С чем интегрируется?
    "price_question",         # Сколько стоит?
    "pricing_details",        # Детали по ценам, что входит?
    "comparison",             # Сравнение с конкурентами
    "consultation_request",   # Запрос консультации
}

# =============================================================================
# СОСТОЯНИЯ И ПЕРЕХОДЫ
# =============================================================================

SALES_STATES = {
    "greeting": {
        "goal": "Поздороваться и узнать чем помочь",
        "required_data": [],
        "transitions": {
            # Переход в SPIN: начинаем с Situation
            "price_question": "spin_situation",
            "question_features": "spin_situation",
            "question_integrations": "spin_situation",
            "agreement": "spin_situation",
            "info_provided": "spin_situation",
            # Сравнение и детали по цене — тоже вопросы, переходим в SPIN
            "comparison": "spin_situation",
            "pricing_details": "spin_situation",
            # Запрос консультации — проявление интереса
            "consultation_request": "spin_situation",
            # Клиент сразу хочет демо или звонок — переходим в close
            "demo_request": "close",
            "callback_request": "close",
            # На rejection сразу мягко закрываем
            "rejection": "soft_close",
            # Прощание — мягко завершаем
            "farewell": "soft_close",
            # Возражения — цена и конкурент можно отработать, время/думать → мягкое закрытие
            "objection_price": "handle_objection",
            "objection_competitor": "handle_objection",
            "objection_no_time": "soft_close",
            "objection_think": "soft_close",
        },
        "rules": {
            # На приветствие просто здороваемся
            "greeting": "greet_back",
            # На непонятное — спрашиваем чем помочь
            "unclear": "ask_how_to_help",
            # На благодарность — кратко ответить и спросить чем помочь
            "gratitude": "acknowledge_and_continue",
            # Small talk — поддержать и узнать чем помочь
            "small_talk": "small_talk_and_continue",
        }
    },

    # =================================================================
    # SPIN SELLING: 4 фазы квалификации
    # =================================================================

    # S - Situation: понять текущую ситуацию клиента
    "spin_situation": {
        "goal": "Понять текущую ситуацию клиента (размер, инструменты, процессы)",
        "spin_phase": "situation",
        "required_data": ["company_size"],
        "optional_data": ["current_tools", "business_type"],
        "transitions": {
            "data_complete": "spin_problem",
            # SPIN progress: клиент рассказал о ситуации — переходим к проблемам
            "situation_provided": "spin_problem",
            # info_provided тоже переводит на следующую фазу (унификация с situation_provided)
            "info_provided": "spin_problem",
            "rejection": "soft_close",
            # Клиент сразу хочет демо или звонок — переходим в close
            "demo_request": "close",
            "callback_request": "close",
            # Прощание — мягко завершаем
            "farewell": "soft_close",
            # Возражения — обрабатываем: цена и конкурент → handle_objection, время/думать → soft_close
            "objection_price": "handle_objection",
            "objection_competitor": "handle_objection",
            "objection_no_time": "soft_close",
            "objection_think": "soft_close",
        },
        "rules": {
            # Conditional: если есть данные для цены, клиент раздражён или повторный запрос — отвечаем
            # Phase 5: Добавлены context-aware условия (should_answer_directly, client_stuck)
            "price_question": [
                {"when": "can_answer_price", "then": "answer_with_facts"},
                {"when": "should_answer_directly", "then": "answer_with_facts"},
                "deflect_and_continue"
            ],
            "pricing_details": [
                {"when": "can_answer_price", "then": "answer_with_facts"},
                {"when": "should_answer_directly", "then": "answer_with_facts"},
                "deflect_and_continue"
            ],
            "comparison": "answer_and_continue",
            "consultation_request": "acknowledge_and_continue",
            "question_features": "answer_and_continue",
            "question_integrations": "answer_and_continue",
            # При неясных ответах — переспрашиваем о ситуации
            # Phase 5: если застряли — переключаемся на clarify
            "unclear": [
                {"when": "client_stuck", "then": "clarify_one_question"},
                "probe_situation"
            ],
            "small_talk": "small_talk_and_continue",
            "gratitude": "acknowledge_and_continue",
        }
    },

    # P - Problem: выявить проблемы и боли
    "spin_problem": {
        "goal": "Выявить проблемы и боли клиента",
        "spin_phase": "problem",
        "required_data": ["pain_point"],
        "transitions": {
            "data_complete": "spin_implication",
            # SPIN progress: клиент раскрыл проблему — переходим к последствиям
            "problem_revealed": "spin_implication",
            # info_provided с pain_point тоже переводит на следующую фазу
            "info_provided": "spin_implication",
            "rejection": "soft_close",
            # Если клиент уже явно выразил интерес — можно пропустить I и N
            "agreement": "presentation",
            # Если клиент говорит "нет проблем" — пробуем показать скрытые последствия
            "no_problem": "spin_implication",
            # Клиент сразу хочет демо или звонок — переходим в close
            "demo_request": "close",
            "callback_request": "close",
            # Прощание — мягко завершаем
            "farewell": "soft_close",
            # Возражения — обрабатываем: цена и конкурент → handle_objection, время/думать → soft_close
            "objection_price": "handle_objection",
            "objection_competitor": "handle_objection",
            "objection_no_time": "soft_close",
            "objection_think": "soft_close",
        },
        "rules": {
            # Conditional: если есть данные для цены, клиент раздражён или повторный запрос — отвечаем
            # Phase 5: Добавлены context-aware условия
            "price_question": [
                {"when": "can_answer_price", "then": "answer_with_facts"},
                {"when": "should_answer_directly", "then": "answer_with_facts"},
                "deflect_and_continue"
            ],
            "pricing_details": [
                {"when": "can_answer_price", "then": "answer_with_facts"},
                {"when": "should_answer_directly", "then": "answer_with_facts"},
                "deflect_and_continue"
            ],
            "comparison": "answer_and_continue",
            "consultation_request": "acknowledge_and_continue",
            "question_features": "answer_and_continue",
            "question_integrations": "answer_and_continue",
            # Если клиент неясно ответил — переспрашиваем о проблемах
            # Phase 5: если застряли — переключаемся на clarify
            "unclear": [
                {"when": "client_stuck", "then": "clarify_one_question"},
                {"when": "client_oscillating", "then": "summarize_and_clarify"},
                "probe_problem"
            ],
            "small_talk": "small_talk_and_continue",
            "gratitude": "acknowledge_and_continue",
        }
    },

    # I - Implication: показать последствия проблем (квантифицировать)
    "spin_implication": {
        "goal": "Помочь осознать последствия и масштаб проблемы",
        "spin_phase": "implication",
        # ВАЖНО: implication_probed устанавливается при ВХОДЕ в фазу (state_machine.py:608)
        # Семантика: "мы вошли в I-фазу", предотвращает пропуск фазы при первом неясном ответе
        "required_data": ["implication_probed"],
        "optional_data": ["pain_impact", "financial_impact"],
        "transitions": {
            "data_complete": "spin_need_payoff",
            "rejection": "soft_close",
            # Если клиент уже понимает масштаб — переходим дальше
            "agreement": "spin_need_payoff",
            "implication_acknowledged": "spin_need_payoff",
            # Если клиент говорит "нет проблем" даже на I-вопрос — идём к N
            "no_problem": "spin_need_payoff",
            # Клиент сразу хочет демо или звонок — переходим в close
            "demo_request": "close",
            "callback_request": "close",
            # Прощание — мягко завершаем
            "farewell": "soft_close",
            # Возражения — обрабатываем: цена и конкурент → handle_objection, время/думать → soft_close
            "objection_price": "handle_objection",
            "objection_competitor": "handle_objection",
            "objection_no_time": "soft_close",
            "objection_think": "soft_close",
        },
        "rules": {
            # Conditional: если есть данные для цены, клиент раздражён или повторный запрос — отвечаем
            # Phase 5: Добавлены context-aware условия
            "price_question": [
                {"when": "can_answer_price", "then": "answer_with_facts"},
                {"when": "should_answer_directly", "then": "answer_with_facts"},
                "deflect_and_continue"
            ],
            "pricing_details": [
                {"when": "can_answer_price", "then": "answer_with_facts"},
                {"when": "should_answer_directly", "then": "answer_with_facts"},
                "deflect_and_continue"
            ],
            "comparison": "answer_and_continue",
            "consultation_request": "acknowledge_and_continue",
            "question_features": "answer_and_continue",
            "question_integrations": "answer_and_continue",
            # При неясных ответах — переспрашиваем о последствиях
            # Phase 5: если застряли — переключаемся на clarify
            "unclear": [
                {"when": "client_stuck", "then": "clarify_one_question"},
                {"when": "client_oscillating", "then": "summarize_and_clarify"},
                "probe_implication"
            ],
            "small_talk": "small_talk_and_continue",
            "gratitude": "acknowledge_and_continue",
        }
    },

    # N - Need-Payoff: клиент сам формулирует ценность решения
    "spin_need_payoff": {
        "goal": "Помочь клиенту сформулировать ценность решения",
        "spin_phase": "need_payoff",
        # ВАЖНО: need_payoff_probed устанавливается при ВХОДЕ в фазу (state_machine.py:610)
        # Семантика: "мы вошли в N-фазу", предотвращает пропуск фазы при первом неясном ответе
        "required_data": ["need_payoff_probed"],
        "optional_data": ["desired_outcome", "value_acknowledged"],
        "transitions": {
            "data_complete": "presentation",
            "agreement": "presentation",
            "need_expressed": "presentation",
            "rejection": "soft_close",
            # Если клиент не видит ценности — мягко завершаем
            "no_need": "soft_close",
            # Клиент сразу хочет демо или звонок — переходим в close
            "demo_request": "close",
            "callback_request": "close",
            # Прощание — мягко завершаем
            "farewell": "soft_close",
            # Возражения — обрабатываем: цена и конкурент → handle_objection, время/думать → soft_close
            "objection_price": "handle_objection",
            "objection_competitor": "handle_objection",
            "objection_no_time": "soft_close",
            "objection_think": "soft_close",
        },
        "rules": {
            # Conditional: если есть данные для цены, клиент раздражён или повторный запрос — отвечаем
            # Phase 5: Добавлены context-aware условия
            "price_question": [
                {"when": "can_answer_price", "then": "answer_with_facts"},
                {"when": "should_answer_directly", "then": "answer_with_facts"},
                "deflect_and_continue"
            ],
            "pricing_details": [
                {"when": "can_answer_price", "then": "answer_with_facts"},
                {"when": "should_answer_directly", "then": "answer_with_facts"},
                "deflect_and_continue"
            ],
            "comparison": "answer_and_continue",
            "consultation_request": "acknowledge_and_continue",
            "question_features": "answer_and_continue",
            "question_integrations": "answer_and_continue",
            # При неясных ответах — переспрашиваем о ценности
            # Phase 5: если застряли — переключаемся на clarify
            "unclear": [
                {"when": "client_stuck", "then": "clarify_one_question"},
                {"when": "client_oscillating", "then": "summarize_and_clarify"},
                "probe_need_payoff"
            ],
            "small_talk": "small_talk_and_continue",
            "gratitude": "acknowledge_and_continue",
        }
    },

    "presentation": {
        "goal": "Показать ценность продукта",
        "required_data": [],
        "transitions": {
            "agreement": "close",
            "objection_price": "handle_objection",
            "rejection": "soft_close",
            # Клиент хочет демо или звонок — переходим в close
            "demo_request": "close",
            "callback_request": "close",
            # FIX: consultation_request = сильный сигнал интереса → close
            "consultation_request": "close",
            # Прощание — мягко завершаем
            "farewell": "soft_close",
            # Возражения по времени и "надо подумать" — обрабатываем
            "objection_no_time": "handle_objection",
            "objection_think": "handle_objection",
            # Возражение по конкуренту — обрабатываем
            "objection_competitor": "handle_objection",
        },
        "rules": {
            "price_question": "answer_with_facts",
            "pricing_details": "answer_with_facts",
            "comparison": "answer_and_continue",
            "consultation_request": "acknowledge_and_continue",
            "question_features": "answer_and_continue",
            "question_integrations": "answer_and_continue",
            "small_talk": "small_talk_and_continue",
            "gratitude": "acknowledge_and_continue",
            "unclear": "clarify_and_continue",
        }
    },

    "handle_objection": {
        "goal": "Отработать возражение",
        "required_data": [],
        "transitions": {
            "agreement": "close",
            "rejection": "soft_close",
            # Клиент хочет демо или звонок — переходим в close
            "demo_request": "close",
            "callback_request": "close",
            # Прощание — мягко завершаем
            "farewell": "soft_close",
            # Conditional: при достижении лимита возражений → soft_close
            "objection_price": [
                {"when": "objection_limit_reached", "then": "soft_close"},
                "handle_objection"
            ],
            "objection_no_time": [
                {"when": "objection_limit_reached", "then": "soft_close"},
                "handle_objection"
            ],
            "objection_think": [
                {"when": "objection_limit_reached", "then": "soft_close"},
                "handle_objection"
            ],
            "objection_competitor": [
                {"when": "objection_limit_reached", "then": "soft_close"},
                "handle_objection"
            ],
            # FIX: Вопросы = сигнал интереса, клиент пересматривает решение
            # Выходим из handle_objection обратно в presentation/close
            "question_features": "presentation",
            "question_integrations": "presentation",
            "comparison": "presentation",
            "consultation_request": "close",  # Сильный сигнал интереса!
            # info_provided = клиент даёт контекст, возвращаем в квалификацию
            "info_provided": "spin_situation",
        },
        "rules": {
            # Conditional: если есть данные для ROI — отвечаем с расчётом
            "price_question": [
                {"when": "can_handle_with_roi", "then": "answer_with_roi"},
                "answer_with_facts"
            ],
            "pricing_details": [
                {"when": "can_handle_with_roi", "then": "answer_with_roi"},
                "answer_with_facts"
            ],
            "comparison": "answer_and_continue",
            "consultation_request": "acknowledge_and_continue",
            "question_features": "answer_and_continue",
            "question_integrations": "answer_and_continue",
            "small_talk": "small_talk_and_continue",
            "gratitude": "acknowledge_and_continue",
            "unclear": "clarify_and_continue",
        }
    },

    "close": {
        "goal": "Взять контакт или назначить демо",
        "required_data": ["contact_info"],
        "transitions": {
            "data_complete": "success",
            # Клиент предоставил контакт — успешное завершение
            "contact_provided": "success",
            # Conditional: если контакт уже есть — сразу success, иначе продолжаем
            "agreement": [
                {"when": "ready_for_close", "then": "success"},
                "close"
            ],
            # Демо-запрос: если контакт есть — успех, иначе продолжаем собирать
            "demo_request": [
                {"when": "ready_for_close", "then": "success"},
                "close"
            ],
            "callback_request": [
                {"when": "ready_for_close", "then": "success"},
                "close"
            ],
            "consultation_request": [
                {"when": "ready_for_close", "then": "success"},
                "close"
            ],
            "rejection": "soft_close",
            # Прощание без контакта — мягко завершаем
            "farewell": "soft_close",
            # Возражения — возвращаемся к обработке возражений
            "objection_price": "handle_objection",
            "objection_no_time": "handle_objection",
            "objection_think": "handle_objection",
            "objection_competitor": "handle_objection",
        },
        "rules": {
            # На вопросы — отвечаем и продолжаем собирать контакт
            "price_question": "answer_with_facts",
            "pricing_details": "answer_with_facts",
            "comparison": "answer_and_continue",
            "question_features": "answer_and_continue",
            "question_integrations": "answer_and_continue",
            "small_talk": "small_talk_and_continue",
            "gratitude": "acknowledge_and_continue",
            "unclear": "clarify_and_continue",
            # info_provided — клиент дает информацию, продолжаем
            "info_provided": "continue_current_goal",
        }
    },

    "success": {
        "goal": "Завершить успешно",
        "is_final": True
    },

    "soft_close": {
        "goal": "Вежливо завершить, но дать возможность вернуться",
        "is_final": False,  # Не финальное — клиент может передумать
        "transitions": {
            # Если клиент передумал — даём новый шанс
            "agreement": "spin_situation",
            "demo_request": "close",
            "callback_request": "close",
            # Если клиент сам хочет вернуться
            "go_back": "greeting",
            "correct_info": "greeting",
            # Если твёрдо отказывается — остаёмся (но не бесконечно)
            "rejection": "soft_close",
            "farewell": "soft_close",
            # FIX: Вопросы = проявление интереса → возвращаем в диалог
            # Если клиент задаёт вопросы в soft_close, он ещё не ушёл
            "price_question": "presentation",
            "pricing_details": "presentation",  # Детали по ценам = интерес
            "question_features": "spin_situation",
            "question_integrations": "spin_situation",
            "comparison": "presentation",  # Сравнение = выбирает между вариантами
            "consultation_request": "close",  # Хочет консультацию = сильный интерес!
            # info_provided = клиент отвечает на вопросы → продолжаем диалог
            "info_provided": "spin_situation",
            "situation_provided": "spin_situation",
        },
        "rules": {
            # На вопросы — отвечаем (transitions выше обеспечат переход)
            "price_question": "answer_with_facts",
            "pricing_details": "answer_with_facts",
            "question_features": "answer_and_continue",
            "question_integrations": "answer_and_continue",
            "comparison": "answer_and_continue",
            "gratitude": "acknowledge_farewell",
            "small_talk": "polite_farewell",
        }
    }
}

# =============================================================================
# БАЗА ЗНАНИЙ
# =============================================================================

KNOWLEDGE = {
    "pricing": {
        "basic": {"name": "Базовый", "price": 990, "users": "1-5"},
        "team": {"name": "Команда", "price": 790, "users": "6-25"},
        "business": {"name": "Бизнес", "price": 590, "users": "26+"}
    },
    "features": [
        "Воронка продаж",
        "Автоматические напоминания", 
        "История клиента",
        "Отчёты"
    ],
    "discount_annual": 20
}

# =============================================================================
# CATEGORY ROUTER PROMPT
# =============================================================================

CATEGORY_ROUTER_PROMPT = """Определи категории для поиска в базе знаний Wipon (система автоматизации торговли в Казахстане).

КАТЕГОРИИ (выбирай ТОЛЬКО из этого списка):

equipment (316 секций) — оборудование и периферия:
  сканеры штрихкодов, принтеры чеков, весы, POS-терминалы, ТСД,
  совместимость устройств, USB/Bluetooth подключение, какой сканер/принтер выбрать
  КОНКРЕТНЫЕ модели и характеристики оборудования

pricing (286 секций) — цены и тарифы:
  тарифы Mini/Lite/Standard/Pro, сколько стоит, стоимость подписки,
  рассрочка на оборудование, ежемесячный платёж, прайс-лист, кредиты

products (273 секции) — ПРОДУКТЫ И ВЫБОР РЕШЕНИЯ:
  Wipon Desktop, Wipon Kassa, Wipon Pro, Wipon ТИС, Wipon Cashback
  ЧТО ПОДОЙДЁТ для магазина/кафе/фастфуда/бутика/стройматериалов/рынка
  ЧТО ПОСОВЕТУЕТЕ, какую программу выбрать, демо-версия
  Работает ли на Windows/Mac, для сети магазинов, для франшизы
  Можно ли без бухгалтера, о компании, кейсы успеха, системные требования

support (201 секция) — техподдержка и обучение:
  как связаться, обучение кассиров, настройка системы, внедрение, миграция,
  консультации, удалённая помощь, выезд специалиста, переход с других систем
  партнёрская программа, контакты, как начать работу

tis (191 секция) — трёхкомпонентная система для ИП на упрощёнке:
  что такое ТИС, лимиты по доходу и НДС, подключение ТИС, сертификация,
  ТИС vs обычная касса, нужен ли ТИС, налоговые вопросы ИП

regions (130 секций) — регионы и доставка оборудования:
  работаете ли в моём городе (Алматы, Астана, Шымкент, Караганда...),
  доставка оборудования, география работы, по всему Казахстану, офисы компании

inventory (93 секции) — товары и склад:
  остатки, приход товара, списание, перемещение между складами, инвентаризация,
  учёт товаров, большой ассортимент, где товар, расхождения остатков

features (90 секций) — ФУНКЦИИ ВНУТРИ ПРОГРАММЫ:
  печать ценников и этикеток, логотип на чеке, работа с валютами
  доставка заказов (модуль доставки), две валюты, мультивалюта
  возможности программы (общие вопросы о функционале)

integrations (86 секций) — интеграции с внешними сервисами:
  Kaspi.kz, Halyk Market, банки, эквайринг, POS-терминалы,
  маркировка товаров, 1С, ОФД, синхронизация заказов, API

fiscal (68 секций) — фискализация:
  чеки, ОФД, отправка в налоговую, статус фискализации,
  ошибки фискализации, автопробитие чеков, фискальный признак

analytics (63 секции) — аналитика и отчёты:
  себестоимость, расчёт прибыли, отчёты по продажам, статистика,
  топ продаж, ABC-анализ, выручка, финансовые показатели

employees (55 секций) — сотрудники и кадры:
  кассиры, отчёты по продажам сотрудника, кто сколько продал,
  история действий, ошибочное списание, доступы сотрудников

stability (45 секций) — надёжность и стабильность:
  работа офлайн (без интернета), восстановление данных, зависания,
  резервное копирование, данные не пропадут, слабый интернет
  безопасность данных, SLA, шифрование, защита

mobile (35 секций) — мобильное приложение:
  доступ с телефона, удалённый просмотр продаж и остатков,
  приложение iOS/Android, синхронизация с телефоном

promotions (26 секций) — акции и скидки:
  автоматические скидки, расписание акций, скидки по времени,
  программа лояльности, бонусы, кэшбэк

competitors (7 секций) — СРАВНЕНИЕ С КОНКУРЕНТАМИ:
  wipon vs iiko, wipon vs poster, wipon vs 1c, wipon vs umag
  почему wipon лучше, чем отличается, переход с конкурентов

faq (4 секции) — общие частые вопросы

---

ПРИМЕРЫ КЛАССИФИКАЦИИ:
"Что посоветуете для маленького магазина?" → ["products", "equipment", "pricing"]
"подойдёт для фастфуда?" → ["products", "features", "equipment"]
"wipon работает на mac?" → ["products", "support", "features"]
"можно без бухгалтера работать?" → ["products", "tis", "features"]
"есть ли доставка в программе?" → ["features", "integrations", "products"]
"печать ценников" → ["features", "equipment", "inventory"]
"какой сканер лучше?" → ["equipment", "support", "products"]
"работаете в караганде?" → ["regions", "support", "equipment"]
"wipon vs iiko" → ["competitors", "products", "pricing"]
"чем лучше умаг?" → ["competitors", "products", "support"]

---

Запрос клиента: {query}

Выбери {top_k} наиболее подходящих категорий для поиска ответа.
Ответь ТОЛЬКО JSON массивом без пояснений: ["category1", "category2"]"""

# =============================================================================
# ШАБЛОНЫ ПРОМПТОВ
# =============================================================================

SYSTEM_PROMPT = """Ты менеджер по продажам CRM-системы.

СТРОГО: Отвечай ТОЛЬКО на русском языке. Никогда не переключайся на другие языки.

=== СТИЛЬ ОБЩЕНИЯ ===
- Звучи как живой человек, а не как робот
- Используй разговорные конструкции: "Кстати...", "Вот что важно...", "Смотрите..."
- Избегай шаблонных фраз: "Отлично!", "Спасибо за информацию!", "Рад помочь!"
- Подстраивайся под стиль клиента (формальный/неформальный)
- Никогда не повторяй одну и ту же фразу дважды

=== ДЛИНА ОТВЕТОВ ===
- Максимум 2-3 предложения
- Максимум 50-60 слов
- Лучше недосказать, чем перегрузить

=== СТРУКТУРА ===
- Короткая реакция (опционально) → Суть → Один вопрос
- Если клиент раздражён — ещё короче, без вступлений

{tone_instruction}"""


# Базовый SYSTEM_PROMPT без tone_instruction (для обратной совместимости)
SYSTEM_PROMPT_BASE = """Ты менеджер по продажам CRM-системы.

СТРОГО: Отвечай ТОЛЬКО на русском языке. Никогда не переключайся на другие языки.

Правила общения:
- Говори на "вы", дружелюбно, без давления
- Отвечай кратко: 2-3 предложения максимум
- Задавай только ОДИН вопрос за раз"""

PROMPT_TEMPLATES = {
    "greet_back": """{system}

Задача: Просто поздороваться в ответ и спросить чем можете помочь.
НЕ задавай вопросов о компании или команде — просто узнай что интересует клиента.

Клиент: "{user_message}"

Ответ на русском (1-2 коротких предложения):""",

    "ask_how_to_help": """{system}

Задача: Вежливо спросить чем можете помочь.
НЕ задавай конкретных вопросов — просто узнай что интересует клиента.

Диалог:
{history}

Клиент: "{user_message}"

Ответ на русском (1-2 коротких предложения):""",

    "greeting": """{system}

Задача: Поздороваться и спросить чем можете помочь.
Клиент: "{user_message}"

Ответ на русском (1-2 предложения):""",

    "deflect_and_continue": """{system}

Ситуация: Клиент спросил о цене, но мы не знаем размер его команды.

Диалог:
{history}

Клиент: "{user_message}"

Структура ответа:
1. Признай вопрос о цене (покажи что услышал)
2. Объясни что цена зависит от количества пользователей
3. Спроси сколько человек будет работать

Пример: "Хороший вопрос! Стоимость зависит от размера команды. Подскажите, сколько человек будет пользоваться системой?"

Задай ОДИН вопрос. Ответ на русском (2 предложения):""",

    "continue_current_goal": """{system}

Уже знаем о клиенте: {collected_data}
Нужно узнать: {missing_data}

Диалог:
{history}

Клиент: "{user_message}"

ВАЖНО - структура ответа:
1. СНАЧАЛА кратко отреагируй на слова клиента (признай проблему, вырази понимание)
2. ПОТОМ естественно перейди к вопросу

Примеры хороших переходов:
- "Понимаю, низкие продажи — это серьёзный вызов. Чтобы понять как помочь, подскажите — сколько человек у вас в команде продаж?"
- "Да, потеря клиентов — частая боль. А сколько менеджеров сейчас работает с клиентами?"
- "Это важный момент. Скажите, сколько человек будет пользоваться системой?"

Если нужно узнать company_size — спроси сколько человек в команде/продажах.
Если нужно узнать pain_point — спроси какую задачу хотят решить или что не устраивает сейчас.

Задай только ОДИН вопрос. Не начинай с "Отлично!" или "Спасибо!".
Ответ на русском (2 предложения: реакция + вопрос):""",

    "presentation": """{system}

Информация о клиенте:
- Размер команды: {company_size} человек
- Проблема: {pain_point}

Наш продукт: {facts}

Диалог:
{history}

Клиент: "{user_message}"

Структура ответа:
1. Кратко отреагируй на последнее сообщение клиента (покажи что услышал)
2. Покажи как наш продукт решает именно ЕГО проблему ({pain_point})
3. Спроси готов ли попробовать или есть вопросы

Пример: "Да, с командой из {company_size} человек это особенно актуально. Наша CRM поможет [решение проблемы]. Хотите посмотреть как это работает?"

Ответ на русском (3-4 предложения):""",

    "handle_objection": """{system}

Ситуация: Клиент говорит что дорого.
Информация о клиенте:
- Проблема: {pain_point}
- Размер: {company_size} человек

Наш продукт: {facts}

Диалог:
{history}

Клиент: "{user_message}"

Структура ответа:
1. СНАЧАЛА признай опасения клиента (покажи что понимаешь)
2. ПОТОМ мягко отработай возражение одной из техник:
   - Сравни с ценой проблемы ("сколько теряете на {pain_point}...")
   - Или раздели на день/человека
   - Упомяни скидку 20% за год

Пример: "Понимаю, вопрос бюджета важен. При этом, если сейчас теряете хотя бы одного клиента в месяц — это уже дороже подписки. А при оплате за год ещё скидка 20%."

Ответ на русском (2-3 предложения, без давления, с эмпатией):""",

    "answer_with_facts": """{system}

Клиент спрашивает о продукте. Вот точные данные:
{facts}

Диалог:
{history}

Клиент: "{user_message}"

Ответь точно по фактам, на русском (2-3 предложения):""",

    "answer_with_knowledge": """{system}

ВАЖНО: Отвечай СТРОГО на основе фактов ниже.
Если информации нет в фактах — скажи "Уточню у коллег и сразу вернусь с ответом".
НЕ ПРИДУМЫВАЙ информацию, которой нет.

=== ФАКТЫ О ПРОДУКТЕ ===
{retrieved_facts}
========================

Информация о клиенте:
- Размер: {company_size}
- Потребность: {pain_point}

Диалог:
{history}

Клиент: "{user_message}"

Ответь кратко (2-3 предложения), используя ТОЛЬКО факты выше.
Ответ на русском:""",

    "answer_question": """{system}

ВАЖНО: Клиент задал вопрос — ты ОБЯЗАН на него ответить!
Используй ТОЛЬКО факты ниже. Если информации нет — честно скажи что уточнишь.

=== ФАКТЫ О ПРОДУКТЕ ===
{retrieved_facts}
========================

Диалог:
{history}

Клиент спросил: "{user_message}"

Твоя задача:
1. СНАЧАЛА кратко ответь на вопрос клиента (2-3 предложения)
2. ПОТОМ задай ОДИН уточняющий вопрос чтобы лучше понять потребности
   (например: сколько человек в команде, какие задачи хотите решить)

НЕ игнорируй вопрос клиента! Сначала ответ, потом вопрос.
Ответ на русском:""",

    "soft_close": """{system}

Ситуация: Клиент не заинтересован или отказывается.

Диалог:
{history}

Клиент: "{user_message}"

Структура ответа:
1. Признай решение клиента (без давления, с уважением)
2. Поблагодари за время
3. Оставь дверь открытой (если передумает — всегда рады помочь)

Пример: "Понимаю, сейчас не время. Спасибо что уделили время! Если вопрос станет актуальным — обращайтесь, буду рад помочь."

Ответ на русском (2 предложения, тепло и без обиды):""",

    "close": """{system}

Ситуация: Клиент заинтересован и готов к следующему шагу.

Диалог:
{history}

Клиент: "{user_message}"

Структура ответа:
1. Позитивно отреагируй на интерес клиента
2. Предложи конкретный следующий шаг (демо или тестовый период)
3. Попроси контакт для связи

Пример: "Отлично, рад что заинтересовались! Давайте запишу вас на демо — покажу систему под ваши задачи. Подскажите удобный номер или почту для связи?"

Ответ на русском (2-3 предложения):""",

    # =================================================================
    # SPIN SELLING ПРОМПТЫ
    # =================================================================

    # S - Situation: понять текущую ситуацию
    "spin_situation": """{system}

ЭТАП: Situation (понять текущую ситуацию клиента)

Диалог:
{history}

Клиент: "{user_message}"

Уже знаем о клиенте: {collected_data}
Нужно узнать: размер команды, чем пользуются сейчас для учёта, тип бизнеса

Твоя задача:
1. СНАЧАЛА кратко отреагируй на слова клиента (1 предложение, покажи эмпатию)
2. ПОТОМ задай ОДИН открытый вопрос о текущей ситуации

Хорошие S-вопросы (выбери подходящий):
- "Расскажите, как сейчас ведёте учёт товаров/клиентов?"
- "Сколько человек работает с клиентами?"
- "Чем сейчас пользуетесь для учёта — Excel, 1С, или что-то другое?"
- "Какой у вас формат бизнеса — розница, опт, услуги?"

ВАЖНО: НЕ задавай вопросы о проблемах — сначала пойми ситуацию.
Задай только ОДИН вопрос.
Ответ на русском (2 предложения: реакция + вопрос):""",

    # P - Problem: выявить проблемы
    "spin_problem": """{system}

ЭТАП: Problem (выявить боли и проблемы)

Диалог:
{history}

Клиент: "{user_message}"

Уже знаем о клиенте: {collected_data}

Твоя задача:
1. СНАЧАЛА отреагируй на информацию клиента (покажи что понял ситуацию)
2. ПОТОМ задай ОДИН вопрос о ПРОБЛЕМАХ/ТРУДНОСТЯХ

Хорошие P-вопросы (выбери подходящий):
- "Какая главная головная боль с учётом прямо сейчас?"
- "С какими сложностями сталкиваетесь при работе с {current_tools}?"
- "Что не устраивает в текущем процессе?"
- "Бывают ситуации когда не хватает информации о товарах/клиентах?"
- "Случается терять данные или путать заказы?"
- "Бывает что клиент приходит за товаром, а его нет?"

ВАЖНО: Задай именно вопрос о ПРОБЛЕМЕ, не о желаниях.
Задай только ОДИН вопрос.
Ответ на русском (2 предложения: реакция + вопрос о проблеме):""",

    # I - Implication: показать последствия
    "spin_implication": """{system}

ЭТАП: Implication (помочь осознать последствия проблемы)

Диалог:
{history}

Клиент: "{user_message}"
Выявленная проблема: {pain_point}

Твоя задача:
1. СНАЧАЛА признай проблему клиента (покажи эмпатию и понимание)
2. ПОТОМ задай ОДИН вопрос о ПОСЛЕДСТВИЯХ этой проблемы

Хорошие I-вопросы (выбери подходящий):
- "Сколько примерно клиентов теряете из-за этого в месяц?"
- "Сколько времени уходит на ручную работу каждый день?"
- "Во сколько это обходится бизнесу, если посчитать?"
- "Как это влияет на продажи/прибыль?"
- "Если посчитать — сколько выручки теряете на пересортице за месяц?"
- "Когда клиент уходит без покупки — это как часто?"

ВАЖНО:
- Не преувеличивай и не драматизируй
- Просто помоги клиенту ОСОЗНАТЬ масштаб проблемы
- Вопрос должен быть о ПОСЛЕДСТВИЯХ, не о самой проблеме

Задай только ОДИН вопрос.
Ответ на русском (2 предложения: эмпатия + вопрос о последствиях):""",

    # N - Need-Payoff: создать ценность решения
    "spin_need_payoff": """{system}

ЭТАП: Need-Payoff (клиент сам формулирует ценность решения)

Диалог:
{history}

Клиент: "{user_message}"
Проблема: {pain_point}
Последствия: {pain_impact}

Твоя задача:
1. СНАЧАЛА подтверди понимание ситуации (кратко)
2. ПОТОМ задай ОДИН вопрос, чтобы КЛИЕНТ САМ сформулировал ценность решения

Хорошие N-вопросы (выбери подходящий):
- "Если бы остатки обновлялись автоматически — насколько это упростило бы работу?"
- "Как изменилась бы ситуация, если бы вся информация о клиентах была в одном месте?"
- "Что было бы, если бы вы видели все продажи в реальном времени?"
- "Если бы система сама напоминала о заканчивающихся товарах — помогло бы?"
- "Насколько было бы проще, если бы вся статистика была в одном месте?"
- "Что если бы каждый продавец видел актуальные остатки на телефоне?"

ВАЖНО:
- НЕ говори сам какую пользу принесёт система
- Пусть КЛИЕНТ САМ озвучит желаемый результат
- Это создаёт внутреннюю мотивацию к покупке

Задай только ОДИН вопрос.
Ответ на русском (2 предложения):""",

    # Переход из spin_situation
    "transition_to_spin_problem": """{system}

Клиент рассказал о своей ситуации. Переходим к выявлению проблем.

Диалог:
{history}

Клиент: "{user_message}"

Уже знаем: {collected_data}

Твоя задача:
1. Кратко подтверди что понял ситуацию (1 предложение)
2. Плавно перейди к вопросу о трудностях/проблемах

Пример: "Понял, команда из {company_size} человек, работаете в Excel. Скажите, какая главная сложность с текущим учётом?"

Ответ на русском (2 предложения):""",

    # Переход из spin_problem
    "transition_to_spin_implication": """{system}

Клиент озвучил проблему. Помогаем осознать её последствия.

Диалог:
{history}

Клиент: "{user_message}"

Проблема клиента: {pain_point}
Уже знаем: {collected_data}

Твоя задача:
1. Признай проблему с эмпатией (покажи что понимаешь)
2. Задай вопрос о ПОСЛЕДСТВИЯХ этой проблемы

Пример: "Да, путаница в остатках — частая проблема. А как это влияет на продажи? Бывает что клиент уходит без покупки из-за этого?"

Ответ на русском (2 предложения):""",

    # Переход из spin_implication
    "transition_to_spin_need_payoff": """{system}

Клиент осознал последствия проблемы. Помогаем сформулировать ценность решения.

Диалог:
{history}

Клиент: "{user_message}"

Проблема: {pain_point}
Уже знаем: {collected_data}

Твоя задача:
1. Подтверди понимание масштаба проблемы
2. Задай вопрос чтобы клиент САМ озвучил желаемый результат

Пример: "Понимаю, это ощутимые потери. Если бы остатки обновлялись автоматически после каждой продажи — насколько это упростило бы работу?"

Ответ на русском (2 предложения):""",

    # Переход из spin_need_payoff в presentation
    "transition_to_presentation": """{system}

Клиент сформулировал желаемый результат. Переходим к презентации решения.

Диалог:
{history}

Клиент: "{user_message}"

Информация о клиенте:
- Размер: {company_size} человек
- Проблема: {pain_point}
- Желаемый результат: {desired_outcome}

Наш продукт: {facts}

Твоя задача:
1. Подтверди что понял потребность клиента
2. Покажи как наш продукт РЕШАЕТ ИМЕННО ЕГО проблему
3. Свяжи функции продукта с его желаемым результатом
4. Спроси готов ли попробовать

ВАЖНО: Презентация должна быть персонализированной под ЕГО ситуацию!

Ответ на русском (3-4 предложения):""",

    # =================================================================
    # PROBE TEMPLATES - переспрашивание при неясных ответах
    # =================================================================

    # Переспросить о ситуации (при unclear в spin_situation)
    "probe_situation": """{system}

СИТУАЦИЯ: Клиент дал неясный ответ на вопрос о текущей ситуации.
Нужно мягко переспросить, чтобы понять его ситуацию.

Диалог:
{history}

Клиент: "{user_message}"

Уже знаем: {collected_data}

Твоя задача:
1. Покажи что понял (не критикуй за неясный ответ)
2. Переформулируй вопрос более конкретно
3. Предложи варианты для удобства ответа

Пример: "Понял, давайте уточню — сколько примерно человек у вас занимается продажами или работой с клиентами? 2-3, около 10, или больше?"

Ответ на русском (2 предложения):""",

    # Переспросить о проблемах (при unclear или no_problem в spin_problem)
    "probe_problem": """{system}

СИТУАЦИЯ: Клиент не озвучил конкретную проблему или сказал что проблем нет.
Нужно мягко помочь выявить скрытые сложности.

Диалог:
{history}

Клиент: "{user_message}"

Уже знаем: {collected_data}

Твоя задача:
1. Признай ответ клиента (не спорь)
2. Задай вопрос о конкретной рутинной задаче
3. Ищи скрытые неудобства, а не явные проблемы

Хорошие формулировки:
- "Понимаю. А если говорить о рутине — что занимает больше всего времени?"
- "Ясно. А бывают моменты когда хотелось бы видеть информацию быстрее?"
- "Хорошо. А как отслеживаете кто из клиентов давно не обращался?"

Ответ на русском (2 предложения):""",

    # Переспросить о последствиях (при unclear в spin_implication)
    "probe_implication": """{system}

СИТУАЦИЯ: Клиент дал неясный ответ на вопрос о последствиях проблемы.
Нужно помочь осознать масштаб, но без давления.

Диалог:
{history}

Клиент: "{user_message}"

Проблема клиента: {pain_point}
Уже знаем: {collected_data}

Твоя задача:
1. Покажи понимание (не настаивай на точных цифрах)
2. Переформулируй вопрос о последствиях проще
3. Предложи примерные рамки для оценки

Хорошие формулировки:
- "Понимаю, сложно оценить точно. Скажите примерно — это часто случается? Раз в неделю, в месяц?"
- "Да, тут нужно подумать. А в целом — это скорее небольшое неудобство или реально влияет на работу?"
- "Ясно. Если по ощущениям — это отнимает заметное время или терпимо?"

Ответ на русском (2 предложения):""",

    # Переспросить о ценности (при unclear в spin_need_payoff)
    "probe_need_payoff": """{system}

СИТУАЦИЯ: Клиент не смог сформулировать желаемый результат.
Нужно помочь представить идеальную ситуацию.

Диалог:
{history}

Клиент: "{user_message}"

Проблема: {pain_point}
Уже знаем: {collected_data}

Твоя задача:
1. Покажи понимание (это нормально что сложно представить)
2. Предложи конкретный сценарий улучшения
3. Спроси было бы это полезно

Хорошие формулировки:
- "Понимаю, сложно сразу представить. А если бы вся информация о клиентах была в одном месте и доступна в пару кликов — это упростило бы работу?"
- "Ясно. Давайте так — если бы система сама напоминала о задачах и следующих шагах с клиентами — было бы полезно?"
- "Хороший вопрос. А представьте: все продажи, остатки и заказы видны в реальном времени с телефона — это бы помогло?"

Ответ на русском (2 предложения):""",

    # =================================================================
    # УНИВЕРСАЛЬНЫЕ TEMPLATES для small_talk и gratitude
    # =================================================================

    # Ответить на small talk и продолжить SPIN
    "small_talk_and_continue": """{system}

СИТУАЦИЯ: Клиент отклонился от темы (small talk).
Нужно вежливо ответить и мягко вернуться к делу.

Диалог:
{history}

Клиент: "{user_message}"

Текущая фаза: {spin_phase}
Уже знаем: {collected_data}

Твоя задача:
1. Кратко и дружелюбно ответь на реплику клиента (1 предложение)
2. Плавно верни разговор к теме

Пример: "Спасибо, всё хорошо! Так вот, возвращаясь к вашей ситуации..."

Ответ на русском (2 короткие предложения):""",

    # Поблагодарить и продолжить SPIN
    "acknowledge_and_continue": """{system}

СИТУАЦИЯ: Клиент выразил благодарность в середине разговора.
Нужно принять благодарность и продолжить диалог.

Диалог:
{history}

Клиент: "{user_message}"

Текущая фаза: {spin_phase}
Уже знаем: {collected_data}

Твоя задача:
1. Кратко и тепло ответить на благодарность
2. Продолжить разговор по теме

Пример: "Пожалуйста! Рад помочь. Так вот, продолжая наш разговор..."

Ответ на русском (2 короткие предложения):""",

    # =================================================================
    # PHASE 2: ЕСТЕСТВЕННОСТЬ ДИАЛОГА - НОВЫЕ ПРОМПТЫ
    # =================================================================

    # Ответ на вопрос о цене с диапазоном (заменяет deflect_and_continue в ранних фазах)
    "answer_with_range_and_qualify": """{system}

Клиент спросил о цене. Сначала дай диапазон, потом уточни.

Факты о ценах: {facts}

Диалог:
{history}

Клиент: "{user_message}"

Ответь по структуре:
1. Диапазон цен (от X до Y за человека)
2. Упомяни что зависит от размера команды
3. Спроси сколько человек будет работать

Пример: "От 590 до 990₽ за человека в месяц — зависит от размера команды. Подскажите, сколько человек будет пользоваться?"

Ответ на русском (2 предложения, до 40 слов):""",

    # Короткий ответ для раздражённого клиента
    "short_response_frustrated": """{system}

ВАЖНО: Клиент раздражён. Будь МАКСИМАЛЬНО кратким.

Диалог:
{history}

Клиент: "{user_message}"

Уже знаем: {collected_data}

Твоя задача:
1. Признай неудобство (одна фраза)
2. Ответь по существу максимально коротко
3. НЕ задавай лишних вопросов

Максимум 1-2 предложения, до 25 слов.

Ответ на русском:""",

    # Ответ с эмпатией (для problem-фазы)
    "empathetic_response": """{system}

КОНТЕКСТ: Клиент озвучил проблему. Покажи что понимаешь.

Диалог:
{history}

Клиент: "{user_message}"

Проблема клиента: {pain_point}
Уже знаем: {collected_data}

Твоя задача:
1. Признай проблему с эмпатией (НЕ шаблонно!)
2. Задай один уточняющий вопрос о последствиях

Примеры эмпатичных реакций:
- "Да, знакомая ситуация..."
- "Понимаю, это реально отнимает силы..."
- "Многие с этим сталкиваются..."

НЕ используй: "Отлично!", "Спасибо за информацию!", "Понимаю вас!"

Ответ на русском (2 предложения):""",

    # Ответ неформальным стилем (если клиент общается неформально)
    "informal_response": """{system}

КОНТЕКСТ: Клиент общается неформально. Подстройся под его стиль.

Диалог:
{history}

Клиент: "{user_message}"

Уже знаем: {collected_data}

Твоя задача:
1. Ответь в том же неформальном стиле
2. Используй "ты" вместо "вы" если клиент сам на "ты"
3. Можно использовать разговорные выражения

Примеры:
- "Короче, тут такая тема..."
- "Ну смотри, по ценам..."
- "Понял, окей..."

НЕ перегибай с неформальностью. Будь естественным.

Ответ на русском (2-3 предложения):""",

    # Мягкое завершение для critically frustrated
    "soft_exit_frustrated": """{system}

СИТУАЦИЯ: Клиент очень раздражён. Нужно завершить без давления.

Диалог:
{history}

Клиент: "{user_message}"

Твоя задача:
1. Кратко извинись
2. Предложи альтернативу (информация на почту / связаться позже)
3. НЕ навязывайся

Пример: "Понимаю, не буду отнимать время. Если будет интересно — пишите, с удовольствием помогу."

Максимум 2 предложения.

Ответ на русском:""",

    # =================================================================
    # НОВЫЕ TEMPLATES для обработки интентов
    # =================================================================

    # Ответить на вопрос и продолжить разговор
    "answer_and_continue": """{system}

СИТУАЦИЯ: Клиент задал вопрос. Нужно ответить и продолжить диалог.

Диалог:
{history}

Клиент: "{user_message}"

Текущая фаза: {spin_phase}
Уже знаем: {collected_data}

Факты для ответа (если есть): {facts}

Твоя задача:
1. Кратко и по делу ответь на вопрос клиента
2. Плавно верни разговор к текущей теме

Ответ на русском (2-3 предложения):""",

    # Уточнить непонятное и продолжить
    "clarify_and_continue": """{system}

СИТУАЦИЯ: Ответ клиента неясен. Нужно мягко уточнить.

Диалог:
{history}

Клиент: "{user_message}"

Текущая фаза: {spin_phase}
Уже знаем: {collected_data}

Твоя задача:
1. Покажи что услышал клиента
2. Мягко уточни что он имел в виду

Пример: "Интересно! Можете рассказать подробнее?"

Ответ на русском (1-2 предложения):""",

    # Подтвердить интерес и собрать контакт
    "confirm_and_collect_contact": """{system}

СИТУАЦИЯ: Клиент выразил интерес к демо/звонку/консультации.
Нужно подтвердить и собрать контактные данные.

Диалог:
{history}

Клиент: "{user_message}"

Уже знаем: {collected_data}

Твоя задача:
1. Подтверди что всё понял
2. Попроси контактные данные (телефон или email) для связи

Пример: "Отлично, договорились! Подскажите номер телефона — перезвоним в удобное время."

Ответ на русском (2 предложения):""",

    # Обработка прощания
    "handle_farewell": """{system}

СИТУАЦИЯ: Клиент прощается. Нужно вежливо завершить разговор.

Диалог:
{history}

Клиент: "{user_message}"

Уже знаем: {collected_data}

Твоя задача:
1. Попрощаться тепло и дружелюбно
2. Если контакт не собран — мягко предложить связаться позже

Пример: "До свидания! Если появятся вопросы — обращайтесь."

Ответ на русском (1-2 предложения):""",

    # Обработка возражения "нет времени"
    "handle_objection_no_time": """{system}

СИТУАЦИЯ: Клиент говорит что у него нет времени.

Диалог:
{history}

Клиент: "{user_message}"

Уже знаем: {collected_data}

Твоя задача:
1. Проявить понимание
2. Предложить альтернативу (связаться позже, отправить информацию)
3. НЕ давить

Пример: "Понимаю, время дорого. Могу написать вам позже или скинуть краткую информацию на почту — как удобнее?"

Ответ на русском (2 предложения):""",

    # Обработка возражения "надо подумать"
    "handle_objection_think": """{system}

СИТУАЦИЯ: Клиент говорит что ему нужно подумать/посоветоваться.

Диалог:
{history}

Клиент: "{user_message}"

Уже знаем: {collected_data}

Твоя задача:
1. Поддержать решение
2. Предложить дополнительную информацию или ответить на вопросы
3. Договориться о следующем шаге

Пример: "Конечно, важное решение не принимают на ходу. Могу отправить презентацию — будет проще обсудить с коллегами. Куда удобнее — на почту или в мессенджер?"

Ответ на русском (2-3 предложения):""",
}