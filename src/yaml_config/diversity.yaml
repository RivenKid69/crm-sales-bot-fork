# =============================================================================
# Response Diversity Configuration (SSoT)
# =============================================================================
#
# Единый источник истины для:
# - Запрещённых паттернов начала ответов (banned_openings)
# - Альтернативных вступлений (alternative_openings)
# - Переходных фраз (transitions)
# - Стратегий замены (replacement_strategies)
#
# Принципы:
# 1. LRU rotation — не повторять недавно использованные фразы
# 2. Context-aware — разные вступления для разных ситуаций
# 3. Probabilistic skip — иногда пропускать вступление совсем
# 4. Graceful degradation — если всё использовано, начать заново
#
# Исследование: Stanford 2024 показало 1.6-2.1x рост diversity при rotation
# =============================================================================

version: "1.0"
description: "Response Diversity Engine Configuration"

# =============================================================================
# BANNED OPENINGS — запрещённые начала ответов
# =============================================================================
# Эти фразы будут автоматически заменяться на альтернативы
# Проблема: LLM копирует примеры из промптов и создаёт монотонность

banned_openings:
  # Высший приоритет — полное совпадение
  exact_match:
    - "Понимаю"
    - "Понимаю,"
    - "Понимаю."
    - "Понимаю!"
    - "Понимаю вас"
    - "Понимаю вас,"
    - "Понимаю вас."

  # Паттерны для regex matching
  patterns:
    - "^Понимаю[,.]?\\s"          # Понимаю, ... / Понимаю. ...
    - "^Понимаю вас[,.]?\\s"      # Понимаю вас, ...
    - "^Я понимаю[,.]?\\s"        # Я понимаю, ...
    - "^Да, понимаю[,.]?\\s"      # Да, понимаю, ...

  # Другие монотонные паттерны (для будущего расширения)
  other_monotonous:
    - "^Отлично!\\s"              # Отлично! — тоже часто повторяется
    - "^Спасибо за информацию[!.]?\\s"  # Спасибо за информацию!
    - "^Хороший вопрос[!.]?\\s"   # Хороший вопрос!

# =============================================================================
# ALTERNATIVE OPENINGS — альтернативные вступления
# =============================================================================
# Группированы по контексту использования
# Каждая группа имеет свой набор фраз и вероятность пропуска (skip_probability)

alternative_openings:
  # Эмпатия — для проблем и возражений
  empathy:
    skip_probability: 0.2  # 20% шанс пропустить вступление
    phrases:
      - ""                 # Пустая строка = без вступления
      - "Да, это важно."
      - "Знакомая ситуация."
      - "Многие с этим сталкиваются."
      - "Это частая проблема."
      - "Слышу вас."
      - "Это действительно актуально."
      - "Да, это серьёзно."
      - "Вижу, что это волнует."
      - "Это ключевой момент."

  # Подтверждение — для нейтральных ответов
  acknowledgment:
    skip_probability: 0.3
    phrases:
      - ""
      - "Понял."
      - "Хорошо."
      - "Ясно."
      - "Так."
      - "Окей."
      - "Принял."
      - "Услышал."
      - "Понятно."
      - "Записал."

  # Позитивная реакция — для хороших новостей
  positive:
    skip_probability: 0.25
    phrases:
      - ""
      - "Отлично."
      - "Здорово."
      - "Звучит хорошо."
      - "Интересно."
      - "Рад слышать."
      - "Замечательно."

  # Проблемы — для признания боли клиента
  problem_acknowledgment:
    skip_probability: 0.15
    phrases:
      - ""
      - "Да, это серьёзно."
      - "Это действительно проблема."
      - "Да, с этим сталкиваются многие."
      - "Знакомая боль."
      - "Это распространённая проблема."
      - "Да, это отнимает силы."

  # Возражения — для мягкого ответа на возражения
  objection:
    skip_probability: 0.1
    phrases:
      - ""
      - "Да, это важный момент."
      - "Хороший вопрос на самом деле."
      - "Логичное сомнение."
      - "Справедливое замечание."
      - "Да, об этом стоит поговорить."

# =============================================================================
# TRANSITIONS — переходные фразы
# =============================================================================
# Используются для связки между частями ответа

transitions:
  to_question:
    skip_probability: 0.4
    phrases:
      - ""
      - "Скажите,"
      - "Подскажите,"
      - "А"
      - "Кстати,"
      - "Вот что интересно:"
      - "Ещё момент:"
      - "Уточните,"

  to_deeper:
    skip_probability: 0.3
    phrases:
      - ""
      - "И ещё:"
      - "Важный момент:"
      - "А вот что интересно:"
      - "Кстати говоря,"

  to_proposal:
    skip_probability: 0.2
    phrases:
      - ""
      - "Давайте так:"
      - "Предлагаю:"
      - "Вот что могу предложить:"
      - "Смотрите,"
      - "Есть вариант:"

# =============================================================================
# CONTEXT MAPPING — маппинг контекста на группу вступлений
# =============================================================================
# Определяет какую группу использовать в зависимости от ситуации

context_mapping:
  # По интенту
  intent_to_opening:
    objection_price: objection
    objection_no_time: objection
    objection_think: objection
    objection_competitor: objection
    objection_complexity: objection
    objection_trust: objection
    objection_not_now: objection
    objection_no_need: objection

    situation_provided: acknowledgment
    problem_shared: problem_acknowledgment
    pain_impact_shared: empathy
    need_expressed: positive

    demo_request: positive
    agreement: positive
    contact_provided: positive

    price_question: acknowledgment
    feature_question: acknowledgment
    integration_question: acknowledgment

  # По состоянию
  state_to_opening:
    greeting: acknowledgment
    spin_situation: acknowledgment
    spin_problem: problem_acknowledgment
    spin_implication: empathy
    spin_need_payoff: positive
    presentation: positive
    handle_objection: objection
    close: positive
    soft_close: empathy

  # По уровню фрустрации
  frustration_to_opening:
    0: acknowledgment      # Нейтральный
    1: acknowledgment      # Слегка недоволен
    2: empathy            # Недоволен
    3: problem_acknowledgment  # Сильно недоволен
    4: problem_acknowledgment  # Очень недоволен
    5: problem_acknowledgment  # Критически недоволен

# =============================================================================
# REPLACEMENT STRATEGIES — стратегии замены
# =============================================================================

replacement_strategies:
  # Стратегия по умолчанию
  default:
    max_lru_history: 5      # Сколько последних фраз помнить
    fallback_to_empty: true # Если всё использовано — без вступления

  # Стратегия для высокого engagement
  high_engagement:
    max_lru_history: 3
    fallback_to_empty: false
    prefer_empty_probability: 0.4  # Предпочитать пустые вступления

  # Стратегия для низкого engagement
  low_engagement:
    max_lru_history: 7
    fallback_to_empty: false
    prefer_empty_probability: 0.1  # Реже пропускать вступления

# =============================================================================
# PROMPT INSTRUCTIONS — инструкции для промптов
# =============================================================================
# Эти инструкции добавляются в промпты чтобы LLM не генерировала монотонные ответы

prompt_instructions:
  # Добавляется в system prompt
  system_instruction: |
    ВАЖНО о структуре ответа:
    - НЕ начинай ответ со слова "Понимаю" или "Понимаю вас"
    - НЕ используй одинаковые вступления подряд
    - Варьируй начало ответа: иногда с эмпатией, иногда сразу к делу
    - Краткость важнее формальных вступлений

  # Добавляется к примерам в промптах
  example_instruction: |
    Примеры вступлений (чередуй, не повторяй):
    - "Да, это важно. [продолжение]"
    - "Слышу вас. [продолжение]"
    - "[сразу к делу без вступления]"
    - "Знакомая ситуация. [продолжение]"

# =============================================================================
# METRICS — метрики для мониторинга
# =============================================================================

metrics:
  # Счётчики для статистики
  track_opening_usage: true       # Отслеживать использование вступлений
  track_banned_replacements: true # Отслеживать замены запрещённых фраз
  track_skip_rate: true           # Отслеживать частоту пропуска вступлений

  # Пороги для алертов
  alert_thresholds:
    same_opening_streak: 3        # Алерт если одно вступление 3+ раза подряд
    banned_opening_rate: 0.05     # Алерт если >5% ответов с запрещёнными началами
