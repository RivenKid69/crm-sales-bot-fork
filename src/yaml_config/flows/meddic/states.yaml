# =============================================================================
# MEDDIC STATES
# =============================================================================
# FIX: Переработано для использования universal intents
# =============================================================================

states:
  meddic_metrics:
    extends: _base_phase
    mixins:
      - unified_progress
    goal: "Определить метрики успеха"
    phase: metrics
    required_data:
      - success_metrics
    optional_data:
      - company_size
      - business_type
    parameters:
      next_phase_state: meddic_buyer
      prev_phase_state: greeting  # FIX: First phase goes back to greeting
      default_price_action: deflect_and_continue
      default_unclear_action: continue_current_goal
    rules:
      unclear: explore_success_metrics
    transitions:
      data_complete: meddic_buyer

  meddic_buyer:
    extends: _base_phase
    mixins:
      - unified_progress
    goal: "Идентифицировать экономического покупателя"
    phase: buyer
    required_data:
      - decision_maker
    parameters:
      next_phase_state: meddic_criteria
      prev_phase_state: meddic_metrics  # FIX: Go back to previous phase
      default_price_action: deflect_and_continue
      default_unclear_action: continue_current_goal
    rules:
      unclear: identify_decision_maker
    transitions:
      data_complete: meddic_criteria

  meddic_criteria:
    extends: _base_phase
    mixins:
      - unified_progress
    goal: "Понять критерии принятия решения"
    phase: criteria
    required_data:
      - decision_criteria
    parameters:
      next_phase_state: meddic_process
      prev_phase_state: meddic_buyer  # FIX: Go back to previous phase
      default_price_action: deflect_and_continue
      default_unclear_action: continue_current_goal
    rules:
      unclear: explore_criteria
    transitions:
      data_complete: meddic_process

  meddic_process:
    extends: _base_phase
    mixins:
      - unified_progress
    goal: "Понять процесс принятия решения"
    phase: process
    on_enter:
      set_flags:
        process_probed: true
    required_data:
      - process_probed
    parameters:
      next_phase_state: meddic_pain
      prev_phase_state: meddic_criteria  # FIX: Go back to previous phase
      default_price_action: deflect_and_continue
      default_unclear_action: continue_current_goal
    rules:
      unclear: map_decision_process
    transitions:
      data_complete: meddic_pain

  meddic_pain:
    extends: _base_phase
    mixins:
      - unified_progress
    goal: "Идентифицировать боль"
    phase: pain
    required_data:
      - pain_point
    parameters:
      next_phase_state: meddic_champion
      prev_phase_state: meddic_process  # FIX: Go back to previous phase
      default_price_action: deflect_and_continue
      default_unclear_action: continue_current_goal
    rules:
      unclear: explore_pain
    transitions:
      data_complete: meddic_champion

  meddic_champion:
    extends: _base_phase
    mixins:
      - unified_progress
    goal: "Найти внутреннего чемпиона"
    phase: champion
    on_enter:
      set_flags:
        champion_probed: true
    required_data:
      - champion_probed
    parameters:
      next_phase_state: presentation
      prev_phase_state: meddic_pain  # FIX: Go back to previous phase
      default_price_action: answer_with_facts
      default_unclear_action: continue_current_goal
    rules:
      unclear: identify_champion
    transitions:
      data_complete: presentation
      demo_request: close
      callback_request: close
