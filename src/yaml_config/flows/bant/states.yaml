# =============================================================================
# BANT STATES
# =============================================================================
# FIX: Переработано для использования universal intents
#
# unified_progress mixin обеспечивает catch-all переходы для unexpected intents.
# Custom rules (situation_provided, problem_revealed) переопределяют mixin —
# BANT сохраняет qualification-gate семантику для этих intents.
# =============================================================================

states:
  # Budget phase
  bant_budget:
    extends: _base_phase
    mixins:
      - unified_progress
      - objection_handling
      - price_handling
      - product_questions
      - exit_intents
      - close_shortcuts
    goal: "Выяснить бюджет клиента"
    phase: budget
    required_data:
      - budget_range
    parameters:
      next_phase_state: bant_authority
      prev_phase_state: greeting
      default_price_action: answer_with_pricing
      default_unclear_action: continue_current_goal
    rules:
      unclear: clarify_budget_question
      # Override unified_progress: stay in budget for these intents
      situation_provided: ask_about_budget
      problem_revealed: ask_about_budget
    transitions:
      agreement: bant_authority
      info_provided: bant_authority
      data_complete: bant_authority

  # Authority phase
  bant_authority:
    extends: _base_phase
    mixins:
      - unified_progress
      - objection_handling
      - price_handling
      - product_questions
      - exit_intents
      - close_shortcuts
    goal: "Определить лицо принимающее решение"
    phase: authority
    required_data:
      - decision_maker
    parameters:
      next_phase_state: bant_need
      prev_phase_state: bant_budget
      default_price_action: answer_with_pricing
      default_unclear_action: continue_current_goal
    rules:
      unclear: clarify_authority_question
      # Override unified_progress: stay in authority for these intents
      situation_provided: ask_about_authority
      problem_revealed: ask_about_authority
    transitions:
      agreement: bant_need
      info_provided: bant_need
      data_complete: bant_need

  # Need phase
  bant_need:
    extends: _base_phase
    mixins:
      - unified_progress
      - objection_handling
      - price_handling
      - product_questions
      - exit_intents
      - close_shortcuts
    goal: "Выявить потребность"
    phase: need
    required_data:
      - pain_point
    parameters:
      next_phase_state: bant_timeline
      prev_phase_state: bant_authority
      default_price_action: answer_with_pricing
      default_unclear_action: continue_current_goal
    rules:
      unclear: clarify_need_question
      no_need: create_need_awareness
      problem_revealed: explore_need_deeper
    transitions:
      agreement: bant_timeline
      info_provided: bant_timeline
      need_expressed: bant_timeline
      data_complete: bant_timeline

  # Timeline phase
  bant_timeline:
    extends: _base_phase
    mixins:
      - unified_progress
      - objection_handling
      - price_handling
      - product_questions
      - exit_intents
      - close_shortcuts
    goal: "Определить сроки принятия решения"
    phase: timeline
    required_data:
      - decision_timeline
    parameters:
      next_phase_state: presentation
      prev_phase_state: bant_need
      default_price_action: answer_with_facts
      default_unclear_action: continue_current_goal
    rules:
      unclear: clarify_timeline_question
      situation_provided: continue_current_goal
      problem_revealed: continue_current_goal
    transitions:
      agreement: presentation
      info_provided: presentation
      data_complete: presentation
      demo_request: close
      callback_request: close
