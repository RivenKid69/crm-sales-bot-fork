# =============================================================================
# SANDLER METHOD STATES
# =============================================================================
# FIX: Переработано для использования universal intents
# =============================================================================

states:
  sandler_bonding:
    extends: _base_phase
    mixins:
      - unified_progress
      - sandler_rules
    goal: "Установить доверительный контакт"
    on_enter:
      set_flags:
        bonding_probed: true
    required_data:
      - bonding_probed
    parameters:
      next_phase_state: sandler_contract
      prev_phase_state: greeting  # FIX: First phase goes back to greeting
      default_price_action: answer_with_pricing
      default_unclear_action: continue_current_goal
    rules:
      small_talk: build_rapport
      unclear: gentle_exploration
    transitions:
      data_complete: sandler_contract

  sandler_contract:
    extends: _base_phase
    mixins:
      - unified_progress
      - sandler_rules
    goal: "Установить правила разговора"
    on_enter:
      set_flags:
        contract_probed: true
    required_data:
      - contract_probed
    parameters:
      next_phase_state: sandler_pain
      prev_phase_state: sandler_bonding  # FIX: Go back to previous phase
      default_price_action: answer_with_pricing
      default_unclear_action: continue_current_goal
    rules:
      unclear: explain_process
    transitions:
      data_complete: sandler_pain

  sandler_pain:
    extends: _base_phase
    mixins:
      - unified_progress
      - sandler_rules
    goal: "Глубоко исследовать боль"
    phase: pain
    required_data:
      - pain_point
    parameters:
      next_phase_state: sandler_budget
      prev_phase_state: sandler_contract  # FIX: Go back to previous phase
      default_price_action: answer_with_pricing
      default_unclear_action: continue_current_goal
    rules:
      unclear: probe_pain
    transitions:
      data_complete: sandler_budget

  sandler_budget:
    extends: _base_phase
    mixins:
      - unified_progress
      - sandler_rules
    goal: "Обсудить бюджет"
    phase: budget
    required_data:
      - budget_range
    parameters:
      next_phase_state: sandler_decision
      prev_phase_state: sandler_pain  # FIX: Go back to previous phase
      default_price_action: answer_with_facts
      default_unclear_action: continue_current_goal
    rules:
      unclear: clarify_budget
    transitions:
      data_complete: sandler_decision

  sandler_decision:
    extends: _base_phase
    mixins:
      - unified_progress
      - sandler_rules
    goal: "Понять процесс принятия решения"
    required_data:
      - decision_maker
    parameters:
      next_phase_state: presentation
      prev_phase_state: sandler_budget  # FIX: Go back to previous phase
      default_price_action: answer_with_facts
      default_unclear_action: continue_current_goal
    rules:
      unclear: explore_decision_process
    transitions:
      data_complete: presentation
      demo_request: close
      callback_request: close
