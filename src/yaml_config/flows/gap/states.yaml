# =============================================================================
# GAP SELLING STATES
# =============================================================================
# FIX: Переработано для использования universal intents
# =============================================================================

states:
  gap_current:
    extends: _base_phase
    mixins:
      - unified_progress
      - gap_rules
    goal: "Понять текущее состояние"
    phase: discover
    required_data:
      - company_size
    optional_data:
      - current_tools
    parameters:
      next_phase_state: gap_future
      prev_phase_state: greeting  # FIX: First phase goes back to greeting
      default_price_action: answer_with_pricing
      default_unclear_action: continue_current_goal
    rules:
      unclear: explore_current
    transitions:
      data_complete: gap_future

  gap_future:
    extends: _base_phase
    mixins:
      - unified_progress
      - gap_rules
    goal: "Визуализировать желаемое будущее"
    required_data:
      - desired_outcome
    parameters:
      next_phase_state: gap_analysis
      prev_phase_state: gap_current  # FIX: Go back to previous phase
      default_price_action: answer_with_pricing
      default_unclear_action: continue_current_goal
    rules:
      unclear: explore_future
    transitions:
      data_complete: gap_analysis

  gap_analysis:
    extends: _base_phase
    mixins:
      - unified_progress
      - gap_rules
    goal: "Показать разрыв"
    phase: quantify
    required_data:
      - pain_impact
    parameters:
      next_phase_state: gap_solution
      prev_phase_state: gap_future  # FIX: Go back to previous phase
      default_price_action: answer_with_pricing
      default_unclear_action: continue_current_goal
    rules:
      unclear: highlight_gap
    transitions:
      data_complete: gap_solution

  gap_solution:
    extends: _base_phase
    mixins:
      - unified_progress
      - gap_rules
    goal: "Показать как решение заполняет разрыв"
    on_enter:
      set_flags:
        solution_probed: true
    required_data:
      - solution_probed
    parameters:
      next_phase_state: presentation
      prev_phase_state: gap_analysis  # FIX: Go back to previous phase
      default_price_action: answer_with_facts
      default_unclear_action: continue_current_goal
    rules:
      unclear: clarify_solution
    transitions:
      data_complete: presentation
      demo_request: close
      callback_request: close
