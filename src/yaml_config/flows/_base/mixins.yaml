# =============================================================================
# MIXINS: Переиспользуемые блоки правил и переходов
# =============================================================================
# Версия: 1.0
# Mixins позволяют избежать дублирования правил между состояниями.
# Использование: добавьте список mixins в состояние.
#
# Пример:
#   states:
#     my_state:
#       mixins:
#         - price_handling
#         - exit_intents
#       parameters:
#         default_price_action: deflect_and_continue
# =============================================================================

mixins:
  # =================================================================
  # PRICE HANDLING: Обработка ценовых вопросов
  # =================================================================
  price_handling:
    description: "Правила для обработки вопросов о цене"
    rules:
      price_question:
        - when: can_answer_price
          then: answer_with_facts
        - when: should_answer_directly
          then: answer_with_facts
        - "{{default_price_action}}"
      pricing_details:
        - when: can_answer_price
          then: answer_with_facts
        - when: should_answer_directly
          then: answer_with_facts
        - "{{default_price_action}}"

  # =================================================================
  # PRODUCT QUESTIONS: Вопросы о продукте
  # =================================================================
  product_questions:
    description: "Правила для вопросов о функциях и интеграциях"
    rules:
      question_features: answer_and_continue
      question_integrations: answer_and_continue
      comparison: answer_and_continue
      consultation_request: acknowledge_and_continue

  # =================================================================
  # OBJECTION HANDLING: Обработка возражений
  # =================================================================
  # FIX: Все возражения теперь направляются в handle_objection по умолчанию.
  # Переход в soft_close происходит только при достижении лимита возражений
  # (3 подряд или 5 всего) через условие objection_limit_reached.
  # =================================================================
  objection_handling:
    description: "Переходы для обработки возражений"
    transitions:
      # Основные возражения
      objection_price:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_competitor:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_no_time:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_think:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      # FIX: Добавлены недостающие objection handlers
      # Эти интенты определены в classifier но не имели transitions
      objection_complexity:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_timing:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_trust:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_no_need:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection

  # =================================================================
  # DIALOGUE REPAIR: Восстановление диалога
  # =================================================================
  dialogue_repair:
    description: "Правила для застрявшего диалога"
    rules:
      unclear:
        - when: client_stuck
          then: clarify_one_question
        - when: client_oscillating
          then: summarize_and_clarify
        - "{{default_unclear_action}}"

  # =================================================================
  # EXIT INTENTS: Завершающие интенты
  # =================================================================
  exit_intents:
    description: "Обработка завершающих интентов"
    transitions:
      rejection: soft_close
      farewell: soft_close

  # =================================================================
  # META INTENTS: Мета-интенты управления стилем общения
  # =================================================================
  meta_intents:
    description: "Обработка мета-интентов (не влияют на flow, только на стиль)"
    rules:
      # request_brevity: клиент просит говорить короче
      # Остаёмся в текущем состоянии, но отвечаем кратко
      request_brevity: respond_briefly

  # =================================================================
  # DEMO/CALLBACK SHORTCUTS: Быстрый переход к закрытию
  # =================================================================
  close_shortcuts:
    description: "Быстрые переходы к закрытию при запросе демо/звонка"
    transitions:
      demo_request: close
      callback_request: close

  # =================================================================
  # SOCIAL INTENTS: Социальные интенты
  # =================================================================
  social_intents:
    description: "Обработка социальных интентов (благодарность, small talk)"
    rules:
      gratitude: acknowledge_and_continue
      small_talk: small_talk_and_continue

  # =================================================================
  # SPIN COMMON: Общие правила для всех SPIN фаз
  # =================================================================
  # Комбинация нескольких mixins для удобства
  spin_common:
    description: "Стандартный набор правил для SPIN состояний"
    # Этот mixin объединяет несколько других
    includes:
      - price_handling
      - product_questions
      - objection_handling
      - dialogue_repair
      - exit_intents
      - close_shortcuts
      - social_intents
      - meta_intents

# =================================================================
# UNIFIED PROGRESS: Универсальные прогресс-переходы для всех flows
# =================================================================
# Решает проблему рассинхронизации между classifier (33 интента)
# и flow-specific transitions (107+ интентов).
#
# Принцип: все flows используют ОДИНАКОВЫЕ universal intents для прогресса.
# Flow-specific логика реализуется через rules (actions), не transitions.
# =================================================================
  unified_progress:
    description: "Universal progress transitions - работают со всеми classifier intents"
    transitions:
      # Основной прогресс - клиент согласен/предоставил информацию
      agreement: "{{next_phase_state}}"
      info_provided: "{{next_phase_state}}"
      # SPIN-like progress intents
      situation_provided: "{{next_phase_state}}"
      problem_revealed: "{{next_phase_state}}"
      implication_acknowledged: "{{next_phase_state}}"
      need_expressed: "{{next_phase_state}}"
      # Вопросы как сигнал интереса (остаёмся, но отвечаем)
      # question_features и другие обрабатываются через rules
    rules:
      # Вопросы обрабатываем в текущем состоянии
      question_features: answer_and_continue
      question_integrations: answer_and_continue
      comparison: answer_and_continue
      consultation_request: acknowledge_and_continue

# =================================================================
# CHALLENGER SALE: Провокационный подход
# =================================================================
# FIX: Используем universal intents вместо flow-specific
  challenger_rules:
    description: "Правила для Challenger Sale - провокация, вызов статус-кво"
    rules:
      # Маппинг: insight_shared → info_provided (через unified_progress)
      # Маппинг: reframe_accepted → agreement (через unified_progress)
      # Flow-specific actions для контента ответов
      no_problem: reframe_perspective       # Клиент не видит проблем → бросаем вызов
      problem_revealed: deepen_insight      # Клиент упомянул проблему → углубляем
      need_expressed: acknowledge_and_continue

# =================================================================
# VALUE BASED: ROI и цифры
# =================================================================
# FIX: Используем universal intents
  value_rules:
    description: "Правила для Value-Based Selling - фокус на ROI"
    rules:
      # Маппинг: value_question → price_question (classifier intent)
      # Маппинг: roi_inquiry → price_question + pricing_details
      price_question: calculate_roi_response
      pricing_details: present_business_case
      # Flow-specific для контекста value selling
      problem_revealed: quantify_impact       # При проблеме → считаем влияние
      need_expressed: present_roi             # При потребности → показываем ROI

# =================================================================
# CONSULTATIVE: Эксперт-консультант
# =================================================================
# FIX: Используем universal intents
  consultative_rules:
    description: "Экспертный консультативный подход"
    rules:
      # Маппинг: technical_question → question_features/question_integrations
      question_features: answer_as_consultant
      question_integrations: answer_as_consultant
      consultation_request: provide_expert_advice
      # Клиент описывает проблему → рекомендуем решение
      problem_revealed: recommend_solution

# =================================================================
# TRANSACTIONAL: Быстро и по делу
# =================================================================
# FIX: Используем universal intents
  transactional_rules:
    description: "Минимум разговоров, быстрое закрытие"
    rules:
      # Короткие ответы на всё
      question_features: answer_briefly
      question_integrations: answer_briefly
      price_question: answer_with_facts
      pricing_details: answer_with_facts
    transitions:
      # Маппинг: buying_signal → demo_request, callback_request (classifier intents)
      demo_request: close
      callback_request: close
      contact_provided: success

# =================================================================
# SANDLER: Pain Funnel
# =================================================================
# FIX: Используем universal intents
  sandler_rules:
    description: "Sandler Method - глубокое исследование боли"
    rules:
      # Маппинг: pain_revealed → problem_revealed (classifier intent)
      problem_revealed: explore_pain_deeper
      # При согласии с проблемой → квантифицируем
      agreement: quantify_pain
      # Маппинг: budget_discussed → info_provided + price context
      info_provided: confirm_budget
    transitions:
      # Критическая боль = strong agreement + demo_request
      need_expressed: close

# =================================================================
# SOLUTION: Решение проблем
# =================================================================
# FIX: Используем universal intents
  solution_rules:
    description: "Solution Selling - глубокое понимание проблемы"
    rules:
      # Маппинг: problem_described → problem_revealed, situation_provided
      situation_provided: map_to_solution
      problem_revealed: map_to_solution
      # Маппинг: solution_fit → agreement
      agreement: prove_value
      need_expressed: acknowledge_and_continue

# =================================================================
# INBOUND: Помощь, не продажа
# =================================================================
# FIX: Используем universal intents
  inbound_rules:
    description: "Inbound - помогаем, не продаём агрессивно"
    rules:
      # Маппинг: help_request → consultation_request
      consultation_request: provide_helpful_answer
      # Маппинг: information_request → question_features, question_integrations
      question_features: share_value
      question_integrations: share_value
      # Клиент делится проблемой → предлагаем ресурс
      problem_revealed: offer_resource

# =================================================================
# AIDA: Внимание-Интерес-Желание-Действие
# =================================================================
# FIX: Используем universal intents
  aida_rules:
    description: "AIDA marketing flow"
    rules:
      # Маппинг: attention_captured → agreement, info_provided (через unified_progress)
      # Маппинг: interest_shown → question_features
      question_features: create_desire
      question_integrations: create_desire
      # Маппинг: desire_expressed → need_expressed (через unified_progress)
      # Actions для flow-specific контента
      agreement: build_interest

# =================================================================
# GAP SELLING: Разрыв текущее vs желаемое
# =================================================================
# FIX: Используем universal intents
  gap_rules:
    description: "Gap Selling - показать разрыв"
    rules:
      # Маппинг: current_state_described → situation_provided
      situation_provided: explore_future_state
      # Маппинг: gap_identified → problem_revealed
      problem_revealed: present_solution
      # Маппинг: solution_accepted → agreement
      agreement: acknowledge_and_continue

# =================================================================
# PHASE PROGRESS: Прогресс-интенты для перехода между фазами
# =================================================================
# Фундаментальное решение: когда клиент предоставляет информацию
# (situation_provided, problem_revealed, etc.), это сигнал прогресса.
# Вместо застревания в том же состоянии, переходим к следующей фазе.
#
# Использование: состояние должно определить параметр next_phase_state
# Пример:
#   bant_budget:
#     extends: _base_phase
#     parameters:
#       next_phase_state: bant_authority
# =================================================================
  phase_progress:
    description: "Переходы для прогресс-интентов (информация о ситуации, проблемах, потребностях)"
    transitions:
      situation_provided: "{{next_phase_state}}"
      problem_revealed: "{{next_phase_state}}"
      implication_acknowledged: "{{next_phase_state}}"
      need_expressed: "{{next_phase_state}}"

# =================================================================
# ПАРАМЕТРЫ ПО УМОЛЧАНИЮ
# =================================================================
# Эти значения используются если параметр не указан в состоянии
defaults:
  default_price_action: deflect_and_continue
  default_unclear_action: continue_current_goal
  next_phase_state: presentation  # По умолчанию: переход к презентации
