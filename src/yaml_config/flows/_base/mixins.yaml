# =============================================================================
# MIXINS: Переиспользуемые блоки правил и переходов
# =============================================================================
# Версия: 1.0
# Mixins позволяют избежать дублирования правил между состояниями.
# Использование: добавьте список mixins в состояние.
#
# Пример:
#   states:
#     my_state:
#       mixins:
#         - price_handling
#         - exit_intents
#       parameters:
#         default_price_action: deflect_and_continue
# =============================================================================

mixins:
  # =================================================================
  # UNIVERSAL BASE MIXIN - MANDATORY FOR ALL STATES
  # =================================================================
  # Guarantees ALL critical intents have explicit mappings.
  # This mixin MUST be first in the _base_phase to provide guaranteed coverage.
  # Other mixins can override these mappings with conditional logic.
  # Relies on taxonomy fallback for non-critical intents.
  # =================================================================
  _universal_base:
    description: "Universal base with GUARANTEED coverage for all critical intents"
    rules:
      # CRITICAL: Price intents (explicit mappings override taxonomy fallback)
      price_question: answer_with_pricing
      pricing_details: answer_with_pricing
      cost_inquiry: answer_with_pricing
      discount_request: answer_with_pricing
      payment_terms: answer_with_pricing
      pricing_comparison: answer_with_pricing
      budget_question: answer_with_pricing

      # Product questions
      question_features: answer_with_facts
      question_integrations: answer_with_facts

      # NEW: Top-5 high-frequency fact intents (double coverage for safety)
      # These ensure critical questions are ALWAYS answered, even if
      # Secondary Intent Detection or taxonomy fallback fails
      question_technical: answer_with_facts
      question_security: answer_with_facts
      question_support: answer_with_facts
      comparison: answer_with_facts
      question_implementation: answer_with_facts

      # Meta intents (dialogue control)
      request_brevity: respond_briefly
      unclear: clarify_one_question

      # Purchase progression (critical for contact_provided fix)
      demo_request: schedule_demo
      callback_request: schedule_callback
      request_references: provide_references
      consultation_request: schedule_consultation

    transitions:
      # CRITICAL: Universal transitions for purchase intents
      contact_provided: success
      demo_request: close
      callback_request: close
      request_references: close
      consultation_request: close

      # Exit transitions
      rejection: soft_close
      farewell: soft_close

      # Escalation transitions
      request_human: escalated
      speak_to_manager: escalated
      talk_to_person: escalated
      not_a_bot: escalated
      real_person: escalated
      human_please: escalated
      escalate: escalated

      # Technical problems
      problem_technical: escalated
      problem_connection: escalated
      problem_sync: escalated
      problem_fiscal: escalated
      request_technical_support: escalated

      # Sensitive intents
      legal_question: escalated
      formal_complaint: escalated
      contract_dispute: escalated
      data_deletion: escalated
      gdpr_request: escalated

  # =================================================================
  # PRICE HANDLING: Обработка ценовых вопросов
  # =================================================================
  price_handling:
    description: "Правила для обработки вопросов о цене (все 7 price_related интентов)"
    rules:
      price_question:
        - when: can_answer_price
          then: answer_with_pricing
        - when: price_repeated_2x
          then: answer_with_pricing
        - when: should_answer_directly
          then: answer_with_pricing
        - "{{default_price_action}}"
      pricing_details:
        - when: can_answer_price
          then: answer_with_pricing
        - when: price_repeated_2x
          then: answer_with_pricing
        - when: should_answer_directly
          then: answer_with_pricing
        - "{{default_price_action}}"
      cost_inquiry:
        - when: can_answer_price
          then: answer_with_pricing
        - when: price_repeated_2x
          then: answer_with_pricing
        - when: should_answer_directly
          then: answer_with_pricing
        - "{{default_price_action}}"
      discount_request:
        - when: can_answer_price
          then: answer_with_pricing
        - when: price_repeated_2x
          then: answer_with_pricing
        - when: should_answer_directly
          then: answer_with_pricing
        - "{{default_price_action}}"
      payment_terms:
        - when: can_answer_price
          then: answer_with_pricing
        - when: price_repeated_2x
          then: answer_with_pricing
        - when: should_answer_directly
          then: answer_with_pricing
        - "{{default_price_action}}"
      pricing_comparison:
        - when: can_answer_price
          then: answer_with_pricing
        - when: price_repeated_2x
          then: answer_with_pricing
        - when: should_answer_directly
          then: answer_with_pricing
        - "{{default_price_action}}"
      budget_question:
        - when: can_answer_price
          then: answer_with_pricing
        - when: price_repeated_2x
          then: answer_with_pricing
        - when: should_answer_directly
          then: answer_with_pricing
        - "{{default_price_action}}"

  # =================================================================
  # PRODUCT QUESTIONS: Вопросы о продукте
  # =================================================================
  product_questions:
    description: "Правила для вопросов о функциях и интеграциях"
    rules:
      question_features: answer_and_continue
      question_integrations: answer_and_continue
      comparison: answer_and_continue
      consultation_request: acknowledge_and_continue

  # =================================================================
  # OBJECTION HANDLING: Обработка возражений
  # =================================================================
  # FIX: Все возражения теперь направляются в handle_objection по умолчанию.
  # Переход в soft_close происходит только при достижении лимита возражений
  # (3 подряд или 5 всего) через условие objection_limit_reached.
  # =================================================================
  objection_handling:
    description: "Переходы для обработки возражений"
    transitions:
      # Основные возражения
      objection_price:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_competitor:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_no_time:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_think:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      # FIX: Добавлены недостающие objection handlers
      # Эти интенты определены в classifier но не имели transitions
      objection_complexity:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_timing:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_trust:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_no_need:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection

  # =================================================================
  # DIALOGUE REPAIR: Восстановление диалога
  # =================================================================
  dialogue_repair:
    description: "Правила для застрявшего диалога"
    rules:
      unclear:
        - when: client_stuck
          then: clarify_one_question
        - when: client_oscillating
          then: summarize_and_clarify
        - "{{default_unclear_action}}"

  # =================================================================
  # EXIT INTENTS: Завершающие интенты
  # =================================================================
  exit_intents:
    description: "Обработка завершающих интентов"
    transitions:
      rejection: soft_close
      farewell: soft_close

  # =================================================================
  # META INTENTS: Мета-интенты управления стилем общения
  # =================================================================
  meta_intents:
    description: "Обработка мета-интентов (не влияют на flow, только на стиль)"
    rules:
      # request_brevity: клиент просит говорить короче
      # Остаёмся в текущем состоянии, но отвечаем кратко
      request_brevity: respond_briefly

  # =================================================================
  # DEMO/CALLBACK SHORTCUTS: Быстрый переход к закрытию
  # =================================================================
  close_shortcuts:
    description: "Быстрые переходы к закрытию при запросе демо/звонка"
    transitions:
      demo_request: close
      callback_request: close

  # =================================================================
  # SOCIAL INTENTS: Социальные интенты
  # =================================================================
  social_intents:
    description: "Обработка социальных интентов (благодарность, small talk)"
    rules:
      gratitude: acknowledge_and_continue
      small_talk: small_talk_and_continue

  # =================================================================
  # SPIN COMMON: Общие правила для всех SPIN фаз
  # =================================================================
  # Комбинация нескольких mixins для удобства
  spin_common:
    description: "Стандартный набор правил для SPIN состояний"
    # Этот mixin объединяет несколько других
    includes:
      - price_handling
      - product_questions
      - objection_handling
      - dialogue_repair
      - exit_intents
      - close_shortcuts
      - social_intents
      - meta_intents

# =================================================================
# UNIFIED PROGRESS: Универсальные прогресс-переходы для всех flows
# =================================================================
# Решает проблему рассинхронизации между classifier (33 интента)
# и flow-specific transitions (107+ интентов).
#
# Принцип: все flows используют ОДИНАКОВЫЕ universal intents для прогресса.
# Flow-specific логика реализуется через rules (actions), не transitions.
# =================================================================
  unified_progress:
    description: "Universal progress transitions - работают со всеми classifier intents"
    transitions:
      # Основной прогресс - клиент согласен/предоставил информацию
      agreement: "{{next_phase_state}}"
      info_provided: "{{next_phase_state}}"
      # SPIN-like progress intents
      situation_provided: "{{next_phase_state}}"
      problem_revealed: "{{next_phase_state}}"
      implication_acknowledged: "{{next_phase_state}}"
      need_expressed: "{{next_phase_state}}"
      # Вопросы как сигнал интереса (остаёмся, но отвечаем)
      # question_features и другие обрабатываются через rules
    rules:
      # Вопросы обрабатываем в текущем состоянии
      question_features: answer_and_continue
      question_integrations: answer_and_continue
      comparison: answer_and_continue
      consultation_request: acknowledge_and_continue

# =================================================================
# CHALLENGER SALE: Провокационный подход
# =================================================================
# FIX: Используем universal intents вместо flow-specific
  challenger_rules:
    description: "Правила для Challenger Sale - провокация, вызов статус-кво"
    rules:
      # Маппинг: insight_shared → info_provided (через unified_progress)
      # Маппинг: reframe_accepted → agreement (через unified_progress)
      # Flow-specific actions для контента ответов
      no_problem: reframe_perspective       # Клиент не видит проблем → бросаем вызов
      problem_revealed: deepen_insight      # Клиент упомянул проблему → углубляем
      need_expressed: acknowledge_and_continue

# =================================================================
# VALUE BASED: ROI и цифры
# =================================================================
# FIX: Используем universal intents
  value_rules:
    description: "Правила для Value-Based Selling - фокус на ROI"
    rules:
      # Маппинг: value_question → price_question (classifier intent)
      # Маппинг: roi_inquiry → price_question + pricing_details
      price_question: calculate_roi_response
      pricing_details: present_business_case
      # Flow-specific для контекста value selling
      problem_revealed: quantify_impact       # При проблеме → считаем влияние
      need_expressed: present_roi             # При потребности → показываем ROI

# =================================================================
# CONSULTATIVE: Эксперт-консультант
# =================================================================
# FIX: Используем universal intents
  consultative_rules:
    description: "Экспертный консультативный подход"
    rules:
      # Маппинг: technical_question → question_features/question_integrations
      question_features: answer_as_consultant
      question_integrations: answer_as_consultant
      consultation_request: provide_expert_advice
      # Клиент описывает проблему → рекомендуем решение
      problem_revealed: recommend_solution

# =================================================================
# TRANSACTIONAL: Быстро и по делу
# =================================================================
# FIX: Используем universal intents
  transactional_rules:
    description: "Минимум разговоров, быстрое закрытие"
    rules:
      # Короткие ответы на всё
      question_features: answer_briefly
      question_integrations: answer_briefly
      price_question: answer_with_facts
      pricing_details: answer_with_facts
    transitions:
      # Маппинг: buying_signal → demo_request, callback_request (classifier intents)
      demo_request: close
      callback_request: close
      contact_provided: success

# =================================================================
# SANDLER: Pain Funnel
# =================================================================
# FIX: Используем universal intents
  sandler_rules:
    description: "Sandler Method - глубокое исследование боли"
    rules:
      # Маппинг: pain_revealed → problem_revealed (classifier intent)
      problem_revealed: explore_pain_deeper
      # При согласии с проблемой → квантифицируем
      agreement: quantify_pain
      # Маппинг: budget_discussed → info_provided + price context
      info_provided: confirm_budget
    transitions:
      # Критическая боль = strong agreement + demo_request
      need_expressed: close

# =================================================================
# SOLUTION: Решение проблем
# =================================================================
# FIX: Используем universal intents
  solution_rules:
    description: "Solution Selling - глубокое понимание проблемы"
    rules:
      # Маппинг: problem_described → problem_revealed, situation_provided
      situation_provided: map_to_solution
      problem_revealed: map_to_solution
      # Маппинг: solution_fit → agreement
      agreement: prove_value
      need_expressed: acknowledge_and_continue

# =================================================================
# INBOUND: Помощь, не продажа
# =================================================================
# FIX: Используем universal intents
  inbound_rules:
    description: "Inbound - помогаем, не продаём агрессивно"
    rules:
      # Маппинг: help_request → consultation_request
      consultation_request: provide_helpful_answer
      # Маппинг: information_request → question_features, question_integrations
      question_features: share_value
      question_integrations: share_value
      # Клиент делится проблемой → предлагаем ресурс
      problem_revealed: offer_resource

# =================================================================
# AIDA: Внимание-Интерес-Желание-Действие
# =================================================================
# FIX: Используем universal intents
  aida_rules:
    description: "AIDA marketing flow"
    rules:
      # Маппинг: attention_captured → agreement, info_provided (через unified_progress)
      # Маппинг: interest_shown → question_features
      question_features: create_desire
      question_integrations: create_desire
      # Маппинг: desire_expressed → need_expressed (через unified_progress)
      # Actions для flow-specific контента
      agreement: build_interest

# =================================================================
# GAP SELLING: Разрыв текущее vs желаемое
# =================================================================
# FIX: Используем universal intents
  gap_rules:
    description: "Gap Selling - показать разрыв"
    rules:
      # Маппинг: current_state_described → situation_provided
      situation_provided: explore_future_state
      # Маппинг: gap_identified → problem_revealed
      problem_revealed: present_solution
      # Маппинг: solution_accepted → agreement
      agreement: acknowledge_and_continue

# =================================================================
# PHASE PROGRESS: Прогресс-интенты для перехода между фазами
# =================================================================
# Фундаментальное решение: когда клиент предоставляет информацию
# (situation_provided, problem_revealed, etc.), это сигнал прогресса.
# Вместо застревания в том же состоянии, переходим к следующей фазе.
#
# Использование: состояние должно определить параметр next_phase_state
# Пример:
#   bant_budget:
#     extends: _base_phase
#     parameters:
#       next_phase_state: bant_authority
# =================================================================
  phase_progress:
    description: "Переходы для прогресс-интентов (информация о ситуации, проблемах, потребностях)"
    transitions:
      situation_provided: "{{next_phase_state}}"
      problem_revealed: "{{next_phase_state}}"
      implication_acknowledged: "{{next_phase_state}}"
      need_expressed: "{{next_phase_state}}"

# =================================================================
# EXTENDED OBJECTION HANDLING: Все 18 типов возражений
# =================================================================
  extended_objection_handling:
    description: "Обработка всех 18 типов возражений из schemas.py"
    transitions:
      # Основные возражения (4)
      objection_price:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_competitor:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_no_time:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_think:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      # Дополнительные возражения (14)
      objection_timing:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_complexity:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_trust:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_no_need:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_risk:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_team_resistance:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_security:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_bad_experience:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_priority:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_scale:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_change_management:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_contract_bound:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_company_policy:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_roi_doubt:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection

# =================================================================
# EQUIPMENT QUESTIONS: Вопросы об оборудовании (12 интентов)
# =================================================================
  equipment_questions:
    description: "Обработка вопросов об оборудовании"
    rules:
      question_equipment_general: answer_with_facts
      question_pos_monoblock: answer_with_facts
      question_scales: answer_with_facts
      question_scanner: answer_with_facts
      question_printer: answer_with_facts
      question_cash_drawer: answer_with_facts
      question_equipment_bundle: answer_with_facts
      question_equipment_specs: answer_with_facts
      question_equipment_warranty: answer_with_facts
      question_equipment_install: answer_with_facts
      question_equipment_compat: answer_with_facts
      question_second_screen: answer_with_facts

# =================================================================
# TARIFF QUESTIONS: Вопросы о тарифах (8 интентов)
# =================================================================
  tariff_questions:
    description: "Обработка вопросов о тарифах"
    rules:
      question_tariff_mini: answer_with_facts
      question_tariff_lite: answer_with_facts
      question_tariff_standard: answer_with_facts
      question_tariff_pro: answer_with_facts
      question_tariff_comparison: answer_with_facts
      question_installment: answer_with_facts
      question_trial_period: answer_with_facts
      question_ofd_payment: answer_with_facts

# =================================================================
# TIS QUESTIONS: Вопросы о ТИС (10 интентов)
# =================================================================
  tis_questions:
    description: "Обработка вопросов о Трёхкомпонентной Интегрированной Системе"
    rules:
      question_tis_general: answer_with_facts
      question_tis_limits: answer_with_facts
      question_tis_price: answer_with_facts
      question_tis_requirements: answer_with_facts
      question_tis_benefits: answer_with_facts
      question_tis_2026: answer_with_facts
      question_tis_components: answer_with_facts
      question_tis_multi_location: answer_with_facts
      question_tis_transition: answer_with_facts
      question_tis_reports: answer_with_facts

# =================================================================
# TAX QUESTIONS: Вопросы о налогах (8 интентов)
# =================================================================
  tax_questions:
    description: "Обработка вопросов о налогах и СНР"
    rules:
      question_retail_tax_general: answer_with_facts
      question_retail_tax_rates: answer_with_facts
      question_retail_tax_oked: answer_with_facts
      question_retail_tax_reports: answer_with_facts
      question_retail_tax_transition: answer_with_facts
      question_snr_comparison: answer_with_facts
      question_vat_registration: answer_with_facts
      question_tax_optimization: answer_with_facts

# =================================================================
# ACCOUNTING QUESTIONS: Бухгалтерия (8 интентов)
# =================================================================
  accounting_questions:
    description: "Обработка вопросов о бухгалтерии и документах"
    rules:
      question_accounting_services: answer_with_facts
      question_esf_snt: answer_with_facts
      question_form_910: answer_with_facts
      question_form_200: answer_with_facts
      question_form_300: answer_with_facts
      question_business_registration: answer_with_facts
      question_business_closure: answer_with_facts
      question_document_flow: answer_with_facts

# =================================================================
# INTEGRATION QUESTIONS: Интеграции (14 интентов)
# =================================================================
  integration_questions:
    description: "Обработка вопросов об интеграциях"
    rules:
      # Специфичные интеграции (8)
      question_bank_terminal: answer_with_facts
      question_kaspi_integration: answer_with_facts
      question_halyk_integration: answer_with_facts
      question_1c_integration: answer_with_facts
      question_iiko_integration: answer_with_facts
      question_ofd_connection: answer_with_facts
      question_marking_ismet: answer_with_facts
      question_cashback_loyalty: answer_with_facts
      # Дополнительные интеграции (6)
      question_glovo_wolt: answer_with_facts
      question_telegram_bot: answer_with_facts
      question_whatsapp_business: answer_with_facts
      question_instagram_shop: answer_with_facts
      question_website_widget: answer_with_facts
      question_delivery_services: answer_with_facts

# =================================================================
# OPERATIONS QUESTIONS: Учёт и операции (10 интентов)
# =================================================================
  operations_questions:
    description: "Обработка вопросов об операциях и учёте"
    rules:
      question_inventory: answer_with_facts
      question_revision: answer_with_facts
      question_purchase_mgmt: answer_with_facts
      question_sales_mgmt: answer_with_facts
      question_cash_operations: answer_with_facts
      question_returns_mgmt: answer_with_facts
      question_employee_control: answer_with_facts
      question_multi_location: answer_with_facts
      question_promo_discounts: answer_with_facts
      question_price_labels: answer_with_facts

# =================================================================
# BUSINESS SCENARIOS: Бизнес-сценарии (18 интентов)
# =================================================================
  business_scenarios:
    description: "Обработка вопросов о бизнес-сценариях"
    rules:
      # Основные (10)
      question_grocery_store: answer_with_facts
      question_restaurant_cafe: answer_with_facts
      question_pharmacy: answer_with_facts
      question_clothing_store: answer_with_facts
      question_small_business: answer_with_facts
      question_network_stores: answer_with_facts
      question_market_stall: answer_with_facts
      question_alcohol_tobacco: answer_with_facts
      question_beauty_salon: answer_with_facts
      question_construction: answer_with_facts
      # Дополнительные (8)
      question_wholesale: answer_with_facts
      question_auto_parts: answer_with_facts
      question_electronics: answer_with_facts
      question_pet_shop: answer_with_facts
      question_flower_shop: answer_with_facts
      question_hotel: answer_with_facts
      question_service_center: answer_with_facts
      question_sports_shop: answer_with_facts

# =================================================================
# TECHNICAL PROBLEMS: Технические проблемы (6 интентов)
# =================================================================
  technical_problems:
    description: "Обработка технических проблем"
    rules:
      problem_technical: offer_support
      problem_connection: offer_support
      problem_sync: offer_support
      problem_fiscal: offer_support
      request_technical_support: connect_to_support
      request_configuration: offer_setup_help

# =================================================================
# FISCAL QUESTIONS: Фискализация (8 интентов)
# =================================================================
  fiscal_questions:
    description: "Обработка вопросов о фискализации"
    rules:
      question_fiscal_general: answer_with_facts
      question_fiscal_receipt: answer_with_facts
      question_fiscal_z_report: answer_with_facts
      question_fiscal_x_report: answer_with_facts
      question_fiscal_kkm: answer_with_facts
      question_fiscal_ofd_wipon: answer_with_facts
      question_fiscal_correction: answer_with_facts
      question_fiscal_replacement: answer_with_facts

# =================================================================
# ANALYTICS QUESTIONS: Аналитика (8 интентов)
# =================================================================
  analytics_questions:
    description: "Обработка вопросов об аналитике"
    rules:
      question_analytics_sales: answer_with_facts
      question_analytics_abc: answer_with_facts
      question_analytics_profit: answer_with_facts
      question_analytics_comparison: answer_with_facts
      question_analytics_realtime: answer_with_facts
      question_analytics_export: answer_with_facts
      question_analytics_custom: answer_with_facts
      question_analytics_dashboard: answer_with_facts

# =================================================================
# WIPON PRODUCTS: Продукты Wipon (6 интентов)
# =================================================================
  wipon_products:
    description: "Обработка вопросов о продуктах Wipon"
    rules:
      question_wipon_pro: answer_with_facts
      question_wipon_desktop: answer_with_facts
      question_wipon_kassa: answer_with_facts
      question_wipon_consulting: answer_with_facts
      question_wipon_cashback_app: answer_with_facts
      question_product_comparison: answer_with_facts

# =================================================================
# EMPLOYEE QUESTIONS: Сотрудники/кадры (6 интентов)
# =================================================================
  employee_questions:
    description: "Обработка вопросов о сотрудниках"
    rules:
      question_employees_salary: answer_with_facts
      question_employees_schedule: answer_with_facts
      question_employees_permissions: answer_with_facts
      question_employees_tracking: answer_with_facts
      question_employees_motivation: answer_with_facts
      question_employees_onboarding: answer_with_facts

# =================================================================
# PROMO LOYALTY: Промо/лояльность (6 интентов)
# =================================================================
  promo_loyalty:
    description: "Обработка вопросов о программах лояльности"
    rules:
      question_loyalty_program: answer_with_facts
      question_bonus_system: answer_with_facts
      question_discount_cards: answer_with_facts
      question_gift_cards: answer_with_facts
      question_customer_database: answer_with_facts
      question_sms_marketing: answer_with_facts

# =================================================================
# STABILITY QUESTIONS: Стабильность (6 интентов)
# =================================================================
  stability_questions:
    description: "Обработка вопросов о надёжности системы"
    rules:
      question_backup_restore: answer_with_facts
      question_uptime_sla: answer_with_facts
      question_server_location: answer_with_facts
      question_data_encryption: answer_with_facts
      question_disaster_recovery: answer_with_facts
      question_system_requirements: answer_with_facts

# =================================================================
# REGION QUESTIONS: Регионы (6 интентов)
# =================================================================
  region_questions:
    description: "Обработка вопросов о регионах"
    rules:
      question_region_almaty: answer_with_facts
      question_region_astana: answer_with_facts
      question_region_shymkent: answer_with_facts
      question_region_other: answer_with_facts
      question_pickup_office: answer_with_facts
      question_courier_service: answer_with_facts

# =================================================================
# DELIVERY SERVICE: Доставка и сервис (6 интентов)
# =================================================================
  delivery_service:
    description: "Обработка вопросов о доставке и сервисе"
    rules:
      question_delivery: answer_with_facts
      question_delivery_time: answer_with_facts
      question_office_location: answer_with_facts
      question_working_hours: answer_with_facts
      # Сервисные запросы обрабатываются через rules (не transitions)
      request_refund: handle_service_request
      request_equipment_return: handle_service_request

# =================================================================
# CONVERSATIONAL INTENTS: Разговорные/эмоциональные (10 интентов)
# =================================================================
  conversational_intents:
    description: "Обработка эмоциональных и разговорных интентов"
    rules:
      compliment: acknowledge_and_continue
      joke_response: acknowledge_and_continue
      surprise_expression: acknowledge_and_continue
      relief_expression: acknowledge_and_continue
      curiosity_expression: engage_curiosity
      # Негативные эмоции — эмпатия
      frustration_expression: empathize_and_help
      skepticism_expression: address_concerns
      confusion_expression: clarify_and_help
      impatience_expression: prioritize_response
      empathy_request: show_understanding

# =================================================================
# PURCHASE STAGES: Этапы покупки (8 интентов)
# =================================================================
  purchase_stages:
    description: "Обработка этапов покупки"
    rules:
      request_proposal: provide_proposal
      request_contract: provide_contract_info
      request_invoice: provide_invoice_info
      request_discount: handle_discount_request
      negotiate_terms: handle_negotiation
      request_trial_extension: handle_trial_extension
      request_references: provide_references
      request_sla: provide_sla_info
    transitions:
      # Все эти → close (готовность к покупке)
      request_proposal: close
      request_contract: close
      request_invoice: close

# =================================================================
# POSITIVE SIGNALS: Позитивные сигналы (8 новых интентов)
# =================================================================
  positive_signals:
    description: "Обработка позитивных сигналов покупки"
    transitions:
      ready_to_buy: close
      budget_approved: close
      decision_maker_identified: "{{next_phase_state}}"
      urgency_expressed: close
      competitor_dissatisfied: "{{next_phase_state}}"
      expansion_planned: "{{next_phase_state}}"
      positive_feedback: "{{next_phase_state}}"
      internal_champion: close

# =================================================================
# COMPANY INFO: Вопросы о компании (4 интента)
# =================================================================
  company_info:
    description: "Обработка вопросов о компании Wipon"
    rules:
      company_info_question: answer_with_facts
      experience_question: answer_with_facts
      case_study_request: provide_case_study
      roi_question: answer_with_roi

# =================================================================
# DIALOGUE CONTROL: Управление диалогом (8 интентов)
# =================================================================
  dialogue_control:
    description: "Обработка мета-интентов управления диалогом"
    rules:
      unclear: "{{default_unclear_action}}"
      request_brevity: respond_briefly
      clarification_request: clarify_and_continue
      repeat_request: repeat_previous
      example_request: provide_example
      summary_request: provide_summary
    transitions:
      go_back: "{{prev_phase_state}}"
      correct_info: "{{prev_phase_state}}"

# =================================================================
# LANGUAGE HANDLING: Языковые интенты
# =================================================================
  language_handling:
    description: "Обработка языковых особенностей"
    rules:
      language_kazakh: respond_in_kazakh
      payment_confirmation: acknowledge_payment

# =================================================================
# EXTENDED PRODUCT QUESTIONS: Расширенные вопросы о продукте (14 интентов)
# =================================================================
  extended_product_questions:
    description: "Обработка расширенных вопросов о продукте"
    rules:
      question_security: answer_with_facts
      question_support: answer_with_facts
      question_implementation: answer_with_facts
      question_training: answer_with_facts
      question_updates: answer_with_facts
      question_mobile: answer_with_facts
      question_offline: answer_with_facts
      question_data_migration: answer_with_facts
      question_customization: answer_with_facts
      question_reports: answer_with_facts
      question_automation: answer_with_facts
      question_scalability: answer_with_facts

# =================================================================
# WIPON FULL: Полный набор правил для Wipon бота
# Комбинация всех новых mixins
# =================================================================
  wipon_full:
    description: "Полный набор правил для Wipon CRM Sales Bot"
    includes:
      - price_handling
      - product_questions
      - extended_product_questions
      - extended_objection_handling
      - dialogue_repair
      - exit_intents
      - close_shortcuts
      - social_intents
      - meta_intents
      - equipment_questions
      - tariff_questions
      - tis_questions
      - tax_questions
      - accounting_questions
      - integration_questions
      - operations_questions
      - business_scenarios
      - technical_problems
      - fiscal_questions
      - analytics_questions
      - wipon_products
      - employee_questions
      - promo_loyalty
      - stability_questions
      - region_questions
      - delivery_service
      - conversational_intents
      - purchase_stages
      - positive_signals
      - company_info
      - dialogue_control
      - language_handling

# =================================================================
# ПАРАМЕТРЫ ПО УМОЛЧАНИЮ
# =================================================================
# Эти значения используются если параметр не указан в состоянии
defaults:
  default_price_action: deflect_and_continue
  default_unclear_action: continue_current_goal
  next_phase_state: presentation  # По умолчанию: переход к презентации
  prev_phase_state: greeting  # По умолчанию: возврат на greeting
