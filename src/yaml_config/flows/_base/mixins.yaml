# =============================================================================
# MIXINS: Переиспользуемые блоки правил и переходов
# =============================================================================
# Версия: 1.0
# Mixins позволяют избежать дублирования правил между состояниями.
# Использование: добавьте список mixins в состояние.
#
# Пример:
#   states:
#     my_state:
#       mixins:
#         - price_handling
#         - exit_intents
#       parameters:
#         default_price_action: deflect_and_continue
# =============================================================================

mixins:
  # =================================================================
  # PRICE HANDLING: Обработка ценовых вопросов
  # =================================================================
  price_handling:
    description: "Правила для обработки вопросов о цене"
    rules:
      price_question:
        - when: can_answer_price
          then: answer_with_facts
        - when: should_answer_directly
          then: answer_with_facts
        - "{{default_price_action}}"
      pricing_details:
        - when: can_answer_price
          then: answer_with_facts
        - when: should_answer_directly
          then: answer_with_facts
        - "{{default_price_action}}"

  # =================================================================
  # PRODUCT QUESTIONS: Вопросы о продукте
  # =================================================================
  product_questions:
    description: "Правила для вопросов о функциях и интеграциях"
    rules:
      question_features: answer_and_continue
      question_integrations: answer_and_continue
      comparison: answer_and_continue
      consultation_request: acknowledge_and_continue

  # =================================================================
  # OBJECTION HANDLING: Обработка возражений
  # =================================================================
  # FIX: Все возражения теперь направляются в handle_objection по умолчанию.
  # Переход в soft_close происходит только при достижении лимита возражений
  # (3 подряд или 5 всего) через условие objection_limit_reached.
  # =================================================================
  objection_handling:
    description: "Переходы для обработки возражений"
    transitions:
      objection_price:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_competitor:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_no_time:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_think:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection

  # =================================================================
  # DIALOGUE REPAIR: Восстановление диалога
  # =================================================================
  dialogue_repair:
    description: "Правила для застрявшего диалога"
    rules:
      unclear:
        - when: client_stuck
          then: clarify_one_question
        - when: client_oscillating
          then: summarize_and_clarify
        - "{{default_unclear_action}}"

  # =================================================================
  # EXIT INTENTS: Завершающие интенты
  # =================================================================
  exit_intents:
    description: "Обработка завершающих интентов"
    transitions:
      rejection: soft_close
      farewell: soft_close

  # =================================================================
  # DEMO/CALLBACK SHORTCUTS: Быстрый переход к закрытию
  # =================================================================
  close_shortcuts:
    description: "Быстрые переходы к закрытию при запросе демо/звонка"
    transitions:
      demo_request: close
      callback_request: close

  # =================================================================
  # SOCIAL INTENTS: Социальные интенты
  # =================================================================
  social_intents:
    description: "Обработка социальных интентов (благодарность, small talk)"
    rules:
      gratitude: acknowledge_and_continue
      small_talk: small_talk_and_continue

  # =================================================================
  # SPIN COMMON: Общие правила для всех SPIN фаз
  # =================================================================
  # Комбинация нескольких mixins для удобства
  spin_common:
    description: "Стандартный набор правил для SPIN состояний"
    # Этот mixin объединяет несколько других
    includes:
      - price_handling
      - product_questions
      - objection_handling
      - dialogue_repair
      - exit_intents
      - close_shortcuts
      - social_intents

# =================================================================
# CHALLENGER SALE: Провокационный подход
# =================================================================
  challenger_rules:
    description: "Правила для Challenger Sale - провокация, вызов статус-кво"
    rules:
      insight_shared: deepen_insight
      client_resistant: reframe_perspective
      reframe_accepted: acknowledge_and_continue
      status_quo_challenged: continue_current_goal
    transitions:
      commitment: close

# =================================================================
# VALUE BASED: ROI и цифры
# =================================================================
  value_rules:
    description: "Правила для Value-Based Selling - фокус на ROI"
    rules:
      value_question: calculate_roi_response
      roi_inquiry: present_business_case
      savings_question: answer_with_facts
      cost_concern: answer_with_roi

# =================================================================
# CONSULTATIVE: Эксперт-консультант
# =================================================================
  consultative_rules:
    description: "Экспертный консультативный подход"
    rules:
      technical_question: answer_as_consultant
      advice_request: provide_expert_advice
      recommendation_request: recommend_solution

# =================================================================
# TRANSACTIONAL: Быстро и по делу
# =================================================================
  transactional_rules:
    description: "Минимум разговоров, быстрое закрытие"
    rules:
      any_response: keep_it_short
      buying_signal: fast_close
    transitions:
      buying_signal: close
      ready_to_buy: close

# =================================================================
# SANDLER: Pain Funnel
# =================================================================
  sandler_rules:
    description: "Sandler Method - глубокое исследование боли"
    rules:
      pain_revealed: explore_pain_deeper
      pain_confirmed: quantify_pain
      budget_discussed: confirm_budget
    transitions:
      pain_critical: close

# =================================================================
# SOLUTION: Решение проблем
# =================================================================
  solution_rules:
    description: "Solution Selling - глубокое понимание проблемы"
    rules:
      problem_described: map_to_solution
      solution_fit: prove_value
      value_confirmed: acknowledge_and_continue

# =================================================================
# INBOUND: Помощь, не продажа
# =================================================================
  inbound_rules:
    description: "Inbound - помогаем, не продаём агрессивно"
    rules:
      help_request: provide_helpful_answer
      information_request: share_value
      resource_request: offer_resource

# =================================================================
# AIDA: Внимание-Интерес-Желание-Действие
# =================================================================
  aida_rules:
    description: "AIDA marketing flow"
    rules:
      attention_captured: build_interest
      interest_shown: create_desire
      desire_expressed: call_to_action

# =================================================================
# GAP SELLING: Разрыв текущее vs желаемое
# =================================================================
  gap_rules:
    description: "Gap Selling - показать разрыв"
    rules:
      current_state_described: explore_future_state
      gap_identified: present_solution
      solution_accepted: acknowledge_and_continue

# =================================================================
# PHASE PROGRESS: Прогресс-интенты для перехода между фазами
# =================================================================
# Фундаментальное решение: когда клиент предоставляет информацию
# (situation_provided, problem_revealed, etc.), это сигнал прогресса.
# Вместо застревания в том же состоянии, переходим к следующей фазе.
#
# Использование: состояние должно определить параметр next_phase_state
# Пример:
#   bant_budget:
#     extends: _base_phase
#     parameters:
#       next_phase_state: bant_authority
# =================================================================
  phase_progress:
    description: "Переходы для прогресс-интентов (информация о ситуации, проблемах, потребностях)"
    transitions:
      situation_provided: "{{next_phase_state}}"
      problem_revealed: "{{next_phase_state}}"
      implication_acknowledged: "{{next_phase_state}}"
      need_expressed: "{{next_phase_state}}"

# =================================================================
# ПАРАМЕТРЫ ПО УМОЛЧАНИЮ
# =================================================================
# Эти значения используются если параметр не указан в состоянии
defaults:
  default_price_action: deflect_and_continue
  default_unclear_action: continue_current_goal
  next_phase_state: presentation  # По умолчанию: переход к презентации
