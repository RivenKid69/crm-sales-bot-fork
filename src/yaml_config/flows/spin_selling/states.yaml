# =============================================================================
# SPIN SELLING STATES
# =============================================================================
# Версия: 2.0
# Состояния специфичные для SPIN Selling flow.
# Используют extends и mixins для минимизации дублирования.
#
# Сравнение с оригиналом:
# - Оригинал: ~50 строк на каждое SPIN состояние (rules + transitions)
# - С mixins: ~15 строк на состояние (только уникальное)
# =============================================================================

states:
  # =================================================================
  # АБСТРАКТНЫЙ БАЗОВЫЙ SPIN STATE
  # =================================================================
  # Все общие правила и переходы для SPIN фаз.
  # Наследует от _base_phase, который включает все новые mixins (200+ интентов).
  _spin_base:
    abstract: true
    extends: _base_phase
    parameters:
      next_phase_state: presentation  # Default: переход к презентации
      prev_phase_state: greeting      # Default: возврат на greeting
      default_price_action: deflect_and_continue
      default_unclear_action: continue_current_goal
    transitions:
      # Общие переходы для всех SPIN фаз
      rejection: soft_close
      demo_request: close
      callback_request: close
      farewell: soft_close
      consultation_request: close
      # Позитивные сигналы покупки → close
      ready_to_buy: close
      budget_approved: close
      urgency_expressed: close
      internal_champion: close
      # Этапы покупки → close
      request_proposal: close
      request_contract: close
      request_invoice: close
      # Все 18 возражений → handle_objection (soft_close при лимите)
      # Основные (4)
      objection_price:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_competitor:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_no_time:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_think:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      # Дополнительные (14)
      objection_timing:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_complexity:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_trust:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_no_need:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_risk:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_team_resistance:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_security:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_bad_experience:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_priority:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_scale:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_change_management:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_contract_bound:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_company_policy:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection
      objection_roi_doubt:
        - when: objection_limit_reached
          then: soft_close
        - handle_objection

  # =================================================================
  # S - SITUATION: Понять текущую ситуацию клиента
  # =================================================================
  spin_situation:
    extends: _spin_base
    goal: "Понять текущую ситуацию клиента (размер, инструменты, процессы)"
    phase: situation
    parameters:
      next_phase_state: spin_problem
      prev_phase_state: greeting
    required_data:
      - company_size
    optional_data:
      - current_tools
      - business_type
    transitions:
      # Прогресс по фазе
      data_complete: spin_problem
      situation_provided: spin_problem
      info_provided: spin_problem
      # Позитивные сигналы продвигают flow
      decision_maker_identified: spin_problem
      competitor_dissatisfied: spin_problem
      expansion_planned: spin_problem
      positive_feedback: spin_problem
    rules:
      # Специфичный unclear для situation
      unclear:
        - when: client_stuck
          then: clarify_one_question
        - probe_situation

  # =================================================================
  # P - PROBLEM: Выявить проблемы и боли
  # =================================================================
  spin_problem:
    extends: _spin_base
    goal: "Выявить проблемы и боли клиента"
    phase: problem
    parameters:
      next_phase_state: spin_implication
      prev_phase_state: spin_situation
    required_data:
      - pain_point
    transitions:
      # Прогресс по фазе
      data_complete: spin_implication
      problem_revealed: spin_implication
      info_provided: spin_implication
      # Если клиент говорит "нет проблем" — всё равно переходим
      no_problem: spin_implication
      # Если клиент сразу согласен — в презентацию
      agreement: presentation
      # Позитивные сигналы продвигают flow
      decision_maker_identified: spin_implication
      competitor_dissatisfied: spin_implication
      expansion_planned: spin_implication
      positive_feedback: spin_implication
    rules:
      # Специфичный unclear для problem
      unclear:
        - when: client_stuck
          then: clarify_one_question
        - when: client_oscillating
          then: summarize_and_clarify
        - probe_problem

  # =================================================================
  # I - IMPLICATION: Показать последствия проблем
  # =================================================================
  spin_implication:
    extends: _spin_base
    goal: "Помочь осознать последствия и масштаб проблемы"
    phase: implication
    parameters:
      next_phase_state: spin_need_payoff
      prev_phase_state: spin_problem
    # Set flag when entering this state (replaces hardcoded logic in state_machine.py)
    on_enter:
      set_flags:
        implication_probed: true
    required_data:
      - implication_probed
    optional_data:
      - pain_impact
      - financial_impact
    transitions:
      # Прогресс по фазе
      data_complete: spin_need_payoff
      implication_acknowledged: spin_need_payoff
      # Согласие или "нет проблем" → следующая фаза
      agreement: spin_need_payoff
      no_problem: spin_need_payoff
      # Позитивные сигналы продвигают flow
      decision_maker_identified: spin_need_payoff
      competitor_dissatisfied: spin_need_payoff
      expansion_planned: spin_need_payoff
      positive_feedback: spin_need_payoff
    rules:
      # Специфичный unclear для implication
      unclear:
        - when: client_stuck
          then: clarify_one_question
        - when: client_oscillating
          then: summarize_and_clarify
        - probe_implication

  # =================================================================
  # N - NEED PAYOFF: Клиент формулирует ценность
  # =================================================================
  spin_need_payoff:
    extends: _spin_base
    goal: "Помочь клиенту сформулировать ценность решения"
    phase: need_payoff
    parameters:
      next_phase_state: presentation
      prev_phase_state: spin_implication
    # Set flag when entering this state (replaces hardcoded logic in state_machine.py)
    on_enter:
      set_flags:
        need_payoff_probed: true
    required_data:
      - need_payoff_probed
    optional_data:
      - desired_outcome
      - value_acknowledged
    transitions:
      # Прогресс → презентация
      data_complete: presentation
      agreement: presentation
      need_expressed: presentation
      # Нет потребности — soft close
      no_need: soft_close
      # Позитивные сигналы продвигают к презентации
      decision_maker_identified: presentation
      competitor_dissatisfied: presentation
      expansion_planned: presentation
      positive_feedback: presentation
    rules:
      # Специфичный unclear для need_payoff
      unclear:
        - when: client_stuck
          then: clarify_one_question
        - when: client_oscillating
          then: summarize_and_clarify
        - probe_need_payoff
