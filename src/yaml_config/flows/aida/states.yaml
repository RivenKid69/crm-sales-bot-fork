# =============================================================================
# AIDA STATES
# =============================================================================
# FIX: Переработано для использования universal intents
# Маппинг:
#   attention_captured → agreement, info_provided
#   interest_shown → question_features, agreement
#   desire_expressed → need_expressed, agreement
#   action_taken → demo_request, agreement
# =============================================================================

states:
  aida_attention:
    extends: _base_phase
    mixins:
      - unified_progress  # FIX: Используем universal progress
      - aida_rules
    goal: "Захватить внимание"
    on_enter:
      set_flags:
        attention_probed: true
    required_data:
      - attention_probed
    parameters:
      next_phase_state: aida_interest
      prev_phase_state: greeting  # FIX: First phase goes back to greeting
      default_price_action: deflect_and_continue
      default_unclear_action: continue_current_goal
    rules:
      # Flow-specific actions
      unclear: grab_attention
      greeting: grab_attention
    transitions:
      # Universal intents для прогресса (из unified_progress mixin)
      # agreement: aida_interest (from mixin)
      # info_provided: aida_interest (from mixin)
      data_complete: aida_interest

  aida_interest:
    extends: _base_phase
    mixins:
      - unified_progress
      - aida_rules
    goal: "Развить интерес"
    phase: interest
    required_data:
      - company_size
    parameters:
      next_phase_state: aida_desire
      prev_phase_state: aida_attention  # FIX: Go back to previous phase
      default_price_action: deflect_and_continue
      default_unclear_action: continue_current_goal
    rules:
      unclear: develop_interest
    transitions:
      data_complete: aida_desire

  aida_desire:
    extends: _base_phase
    mixins:
      - unified_progress
      - aida_rules
    goal: "Создать желание"
    phase: desire
    required_data:
      - pain_point
    parameters:
      next_phase_state: aida_action
      prev_phase_state: aida_interest  # FIX: Go back to previous phase
      default_price_action: answer_with_facts
      default_unclear_action: continue_current_goal
    rules:
      unclear: build_desire
    transitions:
      data_complete: aida_action

  aida_action:
    extends: _base_phase
    mixins:
      - unified_progress
      - aida_rules
    goal: "Призвать к действию"
    on_enter:
      set_flags:
        action_probed: true
    required_data:
      - action_probed
    parameters:
      next_phase_state: presentation
      prev_phase_state: aida_desire  # FIX: Go back to previous phase
      default_price_action: answer_with_facts
      default_unclear_action: continue_current_goal
    rules:
      unclear: direct_to_action
    transitions:
      data_complete: presentation
      # Fast track to close on strong buying signals
      demo_request: close
      callback_request: close
