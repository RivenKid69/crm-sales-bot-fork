# =============================================================================
# Question Deduplication Configuration (SSoT)
# =============================================================================
#
# Единый источник истины для предотвращения повторных вопросов бота.
#
# Проблема: Бот переспрашивает о данных, которые клиент уже предоставил.
# Пример: Клиент сказал "ручной учёт, неудобно" → бот спрашивает "Чем пользуетесь для учёта?"
#
# Решение: Динамическая генерация списка вопросов на основе missing_data,
# а не захардкоженный список в промптах.
#
# Принципы:
# 1. SSoT — конфигурация data_fields и связанных вопросов в одном месте
# 2. Context-aware — разные вопросы для разных фаз SPIN
# 3. Dynamic filtering — автоматическое исключение уже отвеченных вопросов
# 4. Graceful degradation — если конфиг недоступен, используем fallback
# 5. Observable — метрики и логирование всех фильтраций
#
# =============================================================================

version: "1.0"
description: "Question Deduplication Engine Configuration"

# =============================================================================
# DATA FIELDS — определение полей данных и связанных вопросов
# =============================================================================
# Каждое поле содержит:
# - description: описание для логов
# - extraction_hints: как LLM понимает что поле заполнено
# - related_questions: вопросы которые НЕ нужно задавать если поле известно
# - phases: в каких фазах SPIN это поле релевантно

data_fields:
  company_size:
    description: "Размер компании (количество сотрудников)"
    extraction_hints:
      - "число сотрудников"
      - "человек в команде"
      - "нас X человек"
    related_questions:
      - "Сколько человек работает с клиентами?"
      - "Сколько человек в вашей команде?"
      - "Сколько сотрудников будет пользоваться системой?"
      - "Какой размер вашей команды?"
      - "Сколько у вас менеджеров?"
    phases: [situation]

  current_tools:
    description: "Текущие инструменты учёта"
    extraction_hints:
      - "Excel"
      - "1С"
      - "вручную"
      - "в блокноте"
      - "CRM"
      - "никак не ведём"
    related_questions:
      - "Чем сейчас пользуетесь для учёта — Excel, 1С, или что-то другое?"
      - "Чем сейчас пользуетесь для учёта?"
      - "Как сейчас ведёте учёт товаров/клиентов?"
      - "Расскажите, как сейчас ведёте учёт?"
      - "В чём ведёте учёт клиентов?"
      - "Какая у вас сейчас система учёта?"
    phases: [situation]

  business_type:
    description: "Тип/формат бизнеса"
    extraction_hints:
      - "розница"
      - "опт"
      - "услуги"
      - "ресторан"
      - "салон"
      - "магазин"
    related_questions:
      - "Какой у вас формат бизнеса — розница, опт, услуги?"
      - "Какой у вас тип бизнеса?"
      - "Чем занимается ваша компания?"
      - "В какой сфере работаете?"
    phases: [situation]

  pain_point:
    description: "Основная проблема/боль клиента"
    extraction_hints:
      - "теряем клиентов"
      - "нет контроля"
      - "ручная работа"
      - "путаница"
      - "не успеваем"
    related_questions:
      - "Какая главная головная боль с учётом прямо сейчас?"
      - "С какими сложностями сталкиваетесь?"
      - "Что не устраивает в текущем процессе?"
      - "Какая основная проблема?"
      - "Что мешает работать эффективнее?"
    phases: [problem]

  pain_impact:
    description: "Последствия проблемы"
    extraction_hints:
      - "теряем X клиентов"
      - "тратим X часов"
      - "потери X рублей"
    related_questions:
      - "Сколько примерно клиентов теряете из-за этого в месяц?"
      - "Сколько времени уходит на ручную работу каждый день?"
      - "Во сколько это обходится бизнесу, если посчитать?"
      - "Как это влияет на продажи/прибыль?"
    phases: [implication]

  desired_outcome:
    description: "Желаемый результат клиента"
    extraction_hints:
      - "хотелось бы"
      - "было бы здорово"
      - "нужно чтобы"
      - "упростило бы"
    related_questions:
      - "Как изменилась бы ситуация, если бы вся информация была в одном месте?"
      - "Что было бы, если бы вы видели все продажи в реальном времени?"
      - "Насколько было бы проще, если бы всё было автоматизировано?"
    phases: [need_payoff]

  contact_info:
    description: "Контактные данные (телефон, email)"
    extraction_hints:
      - "+7"
      - "@"
      - "позвоните"
      - "напишите"
    related_questions:
      - "Как с вами лучше связаться?"
      - "Оставите контакт для демо?"
      - "Куда прислать информацию?"
    phases: [close]

  # --- NEW: Shared fields for MEDDIC/BANT/Sandler/NEAT/etc. ---

  decision_maker:
    description: "Лицо принимающее решение"
    extraction_hints: ["директор", "руководитель", "я решаю", "согласовать"]
    related_questions:
      - "Кто принимает финальное решение?"
      - "С кем нужно согласовать?"
      - "Вы сами принимаете решение или есть руководство?"
    phases: [authority, buyer]

  budget_range:
    description: "Бюджет на решение"
    extraction_hints: ["бюджет", "тысяч", "миллион", "готовы потратить"]
    related_questions:
      - "Какой бюджет рассматриваете?"
      - "На какую сумму ориентируетесь?"
    phases: [budget]

  decision_timeline:
    description: "Сроки принятия решения"
    extraction_hints: ["месяц", "квартал", "скоро", "планируем"]
    related_questions:
      - "Когда планируете внедрение?"
      - "В какие сроки хотите решить вопрос?"
    phases: [timeline]

  decision_criteria:
    description: "Критерии выбора решения"
    extraction_hints: ["важно", "критерий", "главное", "нужно чтобы"]
    related_questions:
      - "Что для вас ключевое при выборе?"
      - "Какие требования к системе?"
    phases: [criteria]

  success_metrics:
    description: "Метрики успеха (KPI)"
    extraction_hints: ["увеличить", "сократить", "KPI", "показатель"]
    related_questions:
      - "По каким метрикам оцениваете успех?"
      - "Какой результат хотите получить в цифрах?"
    phases: [metrics]

  champion_info:
    description: "Внутренний чемпион проекта"
    extraction_hints: ["будет вести", "отвечает", "продвигает"]
    related_questions:
      - "Кто внутри команды будет вести проект?"
      - "Есть человек кто будет помогать внедрению?"
    phases: [champion]

  decision_process:
    description: "Процесс принятия решения"
    extraction_hints: ["этапы", "согласование", "совет", "тест"]
    related_questions:
      - "Какие шаги в процессе принятия решения?"
      - "Нужны ли согласования?"
    phases: [process]

# =============================================================================
# PHASE QUESTIONS — вопросы сгруппированные по фазам
# =============================================================================
# Используется для генерации списка доступных вопросов на основе missing_data

phase_questions:
  situation:
    goal: "Понять текущую ситуацию клиента"
    required_fields: [company_size, current_tools, business_type]
    optional_fields: []
    question_templates:
      company_size:
        - "Сколько человек работает с клиентами?"
        - "Сколько у вас сотрудников?"
        - "Какой размер команды?"
      current_tools:
        - "Чем сейчас пользуетесь для учёта — Excel, 1С, или что-то другое?"
        - "Как сейчас ведёте учёт товаров/клиентов?"
        - "В чём сейчас всё записываете?"
      business_type:
        - "Какой у вас формат бизнеса — розница, опт, услуги?"
        - "Чем занимается ваша компания?"

  problem:
    goal: "Выявить боли и проблемы"
    required_fields: [pain_point]
    optional_fields: [pain_category]
    question_templates:
      pain_point:
        - "Какая главная головная боль с учётом прямо сейчас?"
        - "С какими сложностями сталкиваетесь при работе с {current_tools}?"
        - "Что не устраивает в текущем процессе?"
        - "Случается терять данные или путать заказы?"

  implication:
    goal: "Помочь осознать последствия проблемы"
    required_fields: [pain_impact]
    optional_fields: [financial_impact]
    question_templates:
      pain_impact:
        - "Сколько примерно клиентов теряете из-за этого в месяц?"
        - "Сколько времени уходит на ручную работу каждый день?"
        - "Во сколько это обходится бизнесу, если посчитать?"
        - "Как это влияет на продажи/прибыль?"

  need_payoff:
    goal: "Клиент сам формулирует ценность решения"
    required_fields: [desired_outcome]
    optional_fields: []
    question_templates:
      desired_outcome:
        - "Если бы остатки обновлялись автоматически — насколько это упростило бы работу?"
        - "Как изменилась бы ситуация, если бы вся информация о клиентах была в одном месте?"
        - "Что было бы, если бы вы видели все продажи в реальном времени?"

  # --- MEDDIC phases ---

  metrics:
    goal: "Определить метрики успеха"
    required_fields: [success_metrics]
    optional_fields: [company_size, business_type]
    question_templates:
      success_metrics:
        - "По каким метрикам вы будете оценивать успех внедрения?"
        - "Какие KPI хотите улучшить с помощью новой системы?"
      company_size:
        - "Сколько человек в вашей команде?"
      business_type:
        - "Какой формат бизнеса?"

  buyer:
    goal: "Определить экономического покупателя"
    required_fields: [decision_maker]
    optional_fields: []
    question_templates:
      decision_maker:
        - "Кто принимает финальное решение по бюджету?"
        - "С кем нужно согласовать выбор решения?"

  criteria:
    goal: "Понять критерии выбора"
    required_fields: [decision_criteria]
    optional_fields: []
    question_templates:
      decision_criteria:
        - "Что для вас ключевое при выборе системы?"
        - "Какие требования к решению самые важные?"

  process:
    goal: "Понять процесс принятия решения"
    required_fields: []
    optional_fields: [decision_process]
    question_templates:
      decision_process:
        - "Какие шаги обычно проходите при выборе решения?"

  champion:
    goal: "Найти внутреннего чемпиона"
    required_fields: []
    optional_fields: [champion_info]
    question_templates:
      champion_info:
        - "Кто внутри команды будет вести проект внедрения?"

  # Shared pain phase (used by MEDDIC, Sandler, etc.)
  pain:
    goal: "Выявить боль"
    required_fields: [pain_point]
    optional_fields: []
    question_templates:
      pain_point:
        - "Какая главная сложность сейчас?"
        - "Что мешает работать эффективнее?"

  # --- BANT phases ---

  budget:
    goal: "Понять бюджет"
    required_fields: [budget_range]
    optional_fields: [company_size]
    question_templates:
      budget_range:
        - "Какой бюджет рассматриваете на это решение?"
        - "На какую сумму ориентируетесь?"
      company_size:
        - "Сколько человек будет пользоваться?"

  authority:
    goal: "Определить ЛПР"
    required_fields: [decision_maker]
    optional_fields: []
    question_templates:
      decision_maker:
        - "Кто принимает финальное решение?"
        - "Вы сами решаете или есть руководство?"

  need:
    goal: "Выявить потребность"
    required_fields: [pain_point]
    optional_fields: []
    question_templates:
      pain_point:
        - "Какая главная потребность сейчас?"
        - "Что хотели бы улучшить?"

  timeline:
    goal: "Установить сроки"
    required_fields: [decision_timeline]
    optional_fields: []
    question_templates:
      decision_timeline:
        - "Когда планируете принять решение?"
        - "В какие сроки хотите внедрить?"

  # --- Generic shared phases ---

  discover:
    goal: "Понять ситуацию"
    required_fields: [company_size]
    optional_fields: [current_tools, business_type]
    question_templates:
      company_size:
        - "Сколько человек в команде?"
      current_tools:
        - "Чем сейчас пользуетесь для учёта?"
      business_type:
        - "Какой у вас формат бизнеса?"

  interest:
    goal: "Выявить интерес"
    required_fields: [company_size]
    optional_fields: [business_type]
    question_templates:
      company_size:
        - "Сколько человек в вашей команде?"
      business_type:
        - "Чем занимается ваша компания?"

  desire:
    goal: "Сформировать желание"
    required_fields: [pain_point]
    optional_fields: [desired_outcome]
    question_templates:
      pain_point:
        - "Какая главная сложность сейчас?"
      desired_outcome:
        - "Какой результат был бы идеальным?"

  features:
    goal: "Понять потребности в функционале"
    required_fields: [company_size]
    optional_fields: [current_tools]
    question_templates:
      company_size:
        - "Сколько человек будет пользоваться системой?"
      current_tools:
        - "Чем сейчас пользуетесь?"

  advantages:
    goal: "Показать преимущества"
    required_fields: [pain_point]
    optional_fields: []
    question_templates:
      pain_point:
        - "Какая главная сложность в текущем процессе?"

  benefits:
    goal: "Донести выгоды"
    required_fields: [desired_outcome]
    optional_fields: []
    question_templates:
      desired_outcome:
        - "Какой результат хотите получить?"

  quantify:
    goal: "Оцифровать влияние"
    required_fields: [pain_impact]
    optional_fields: [financial_impact]
    question_templates:
      pain_impact:
        - "Как это влияет на бизнес в цифрах?"
        - "Сколько теряете из-за этого?"

  understand:
    goal: "Понять ситуацию клиента"
    required_fields: [company_size]
    optional_fields: [current_tools]
    question_templates:
      company_size:
        - "Сколько человек в вашей команде?"
      current_tools:
        - "Чем сейчас пользуетесь для работы?"

  advise:
    goal: "Дать экспертный совет"
    required_fields: [pain_point]
    optional_fields: []
    question_templates:
      pain_point:
        - "Какая главная сложность?"

  recommend:
    goal: "Порекомендовать решение"
    required_fields: [desired_outcome]
    optional_fields: []
    question_templates:
      desired_outcome:
        - "Какой результат хотите получить?"

# =============================================================================
# PROMPT INSTRUCTIONS — инструкции для промптов
# =============================================================================
# Динамически генерируемые инструкции для LLM

prompt_instructions:
  # Инструкция "не спрашивай о том, что известно"
  do_not_ask_template: |
    ВАЖНО: НЕ задавай вопросы о том, что уже известно:
    {do_not_ask_list}

  # Инструкция "доступные вопросы"
  available_questions_template: |
    Выбери ОДИН вопрос из доступных (то, что ещё НЕ известно):
    {available_questions_list}

  # Fallback если всё известно
  all_data_collected_instruction: |
    Все данные для этой фазы собраны. Переходи к следующему этапу или подтверди понимание.

# =============================================================================
# DEDUPLICATION STRATEGIES — стратегии дедупликации
# =============================================================================

strategies:
  default:
    # Фильтровать вопросы по collected_data
    filter_by_collected: true
    # Использовать semantic matching для определения похожих вопросов
    semantic_matching: false  # Пока отключено для производительности
    # Логировать каждую фильтрацию
    log_filtering: true

  strict:
    filter_by_collected: true
    semantic_matching: true
    log_filtering: true

# =============================================================================
# METRICS — метрики для мониторинга
# =============================================================================

metrics:
  track_questions_filtered: true
  track_questions_generated: true
  track_dedup_effectiveness: true

  alert_thresholds:
    # Алерт если бот всё равно спросил о известном (через логи LLM)
    repeated_question_detected: 1
    # Алерт если фильтрация не сработала
    dedup_failure_rate: 0.05
