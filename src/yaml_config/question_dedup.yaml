# =============================================================================
# Question Deduplication Configuration (SSoT)
# =============================================================================
#
# Единый источник истины для предотвращения повторных вопросов бота.
#
# Проблема: Бот переспрашивает о данных, которые клиент уже предоставил.
# Пример: Клиент сказал "ручной учёт, неудобно" → бот спрашивает "Чем пользуетесь для учёта?"
#
# Решение: Динамическая генерация списка вопросов на основе missing_data,
# а не захардкоженный список в промптах.
#
# Принципы:
# 1. SSoT — конфигурация data_fields и связанных вопросов в одном месте
# 2. Context-aware — разные вопросы для разных фаз SPIN
# 3. Dynamic filtering — автоматическое исключение уже отвеченных вопросов
# 4. Graceful degradation — если конфиг недоступен, используем fallback
# 5. Observable — метрики и логирование всех фильтраций
#
# =============================================================================

version: "1.0"
description: "Question Deduplication Engine Configuration"

# =============================================================================
# DATA FIELDS — определение полей данных и связанных вопросов
# =============================================================================
# Каждое поле содержит:
# - description: описание для логов
# - extraction_hints: как LLM понимает что поле заполнено
# - related_questions: вопросы которые НЕ нужно задавать если поле известно
# - phases: в каких фазах SPIN это поле релевантно

data_fields:
  company_size:
    description: "Размер компании (количество сотрудников)"
    extraction_hints:
      - "число сотрудников"
      - "человек в команде"
      - "нас X человек"
    related_questions:
      - "Сколько человек работает с клиентами?"
      - "Сколько человек в вашей команде?"
      - "Сколько сотрудников будет пользоваться системой?"
      - "Какой размер вашей команды?"
      - "Сколько у вас менеджеров?"
    phases: [situation]

  current_tools:
    description: "Текущие инструменты учёта"
    extraction_hints:
      - "Excel"
      - "1С"
      - "вручную"
      - "в блокноте"
      - "CRM"
      - "никак не ведём"
    related_questions:
      - "Чем сейчас пользуетесь для учёта — Excel, 1С, или что-то другое?"
      - "Чем сейчас пользуетесь для учёта?"
      - "Как сейчас ведёте учёт товаров/клиентов?"
      - "Расскажите, как сейчас ведёте учёт?"
      - "В чём ведёте учёт клиентов?"
      - "Какая у вас сейчас система учёта?"
    phases: [situation]

  business_type:
    description: "Тип/формат бизнеса"
    extraction_hints:
      - "розница"
      - "опт"
      - "услуги"
      - "ресторан"
      - "салон"
      - "магазин"
    related_questions:
      - "Какой у вас формат бизнеса — розница, опт, услуги?"
      - "Какой у вас тип бизнеса?"
      - "Чем занимается ваша компания?"
      - "В какой сфере работаете?"
    phases: [situation]

  pain_point:
    description: "Основная проблема/боль клиента"
    extraction_hints:
      - "теряем клиентов"
      - "нет контроля"
      - "ручная работа"
      - "путаница"
      - "не успеваем"
    related_questions:
      - "Какая главная головная боль с учётом прямо сейчас?"
      - "С какими сложностями сталкиваетесь?"
      - "Что не устраивает в текущем процессе?"
      - "Какая основная проблема?"
      - "Что мешает работать эффективнее?"
    phases: [problem]

  pain_impact:
    description: "Последствия проблемы"
    extraction_hints:
      - "теряем X клиентов"
      - "тратим X часов"
      - "потери X рублей"
    related_questions:
      - "Сколько примерно клиентов теряете из-за этого в месяц?"
      - "Сколько времени уходит на ручную работу каждый день?"
      - "Во сколько это обходится бизнесу, если посчитать?"
      - "Как это влияет на продажи/прибыль?"
    phases: [implication]

  desired_outcome:
    description: "Желаемый результат клиента"
    extraction_hints:
      - "хотелось бы"
      - "было бы здорово"
      - "нужно чтобы"
      - "упростило бы"
    related_questions:
      - "Как изменилась бы ситуация, если бы вся информация была в одном месте?"
      - "Что было бы, если бы вы видели все продажи в реальном времени?"
      - "Насколько было бы проще, если бы всё было автоматизировано?"
    phases: [need_payoff]

  contact_info:
    description: "Контактные данные (телефон, email)"
    extraction_hints:
      - "+7"
      - "@"
      - "позвоните"
      - "напишите"
    related_questions:
      - "Как с вами лучше связаться?"
      - "Оставите контакт для демо?"
      - "Куда прислать информацию?"
    phases: [close]

# =============================================================================
# PHASE QUESTIONS — вопросы сгруппированные по фазам SPIN
# =============================================================================
# Используется для генерации списка доступных вопросов на основе missing_data

phase_questions:
  situation:
    goal: "Понять текущую ситуацию клиента"
    required_fields: [company_size, current_tools, business_type]
    optional_fields: []
    question_templates:
      company_size:
        - "Сколько человек работает с клиентами?"
        - "Сколько у вас сотрудников?"
        - "Какой размер команды?"
      current_tools:
        - "Чем сейчас пользуетесь для учёта — Excel, 1С, или что-то другое?"
        - "Как сейчас ведёте учёт товаров/клиентов?"
        - "В чём сейчас всё записываете?"
      business_type:
        - "Какой у вас формат бизнеса — розница, опт, услуги?"
        - "Чем занимается ваша компания?"

  problem:
    goal: "Выявить боли и проблемы"
    required_fields: [pain_point]
    optional_fields: [pain_category]
    question_templates:
      pain_point:
        - "Какая главная головная боль с учётом прямо сейчас?"
        - "С какими сложностями сталкиваетесь при работе с {current_tools}?"
        - "Что не устраивает в текущем процессе?"
        - "Случается терять данные или путать заказы?"

  implication:
    goal: "Помочь осознать последствия проблемы"
    required_fields: [pain_impact]
    optional_fields: [financial_impact]
    question_templates:
      pain_impact:
        - "Сколько примерно клиентов теряете из-за этого в месяц?"
        - "Сколько времени уходит на ручную работу каждый день?"
        - "Во сколько это обходится бизнесу, если посчитать?"
        - "Как это влияет на продажи/прибыль?"

  need_payoff:
    goal: "Клиент сам формулирует ценность решения"
    required_fields: [desired_outcome]
    optional_fields: []
    question_templates:
      desired_outcome:
        - "Если бы остатки обновлялись автоматически — насколько это упростило бы работу?"
        - "Как изменилась бы ситуация, если бы вся информация о клиентах была в одном месте?"
        - "Что было бы, если бы вы видели все продажи в реальном времени?"

# =============================================================================
# PROMPT INSTRUCTIONS — инструкции для промптов
# =============================================================================
# Динамически генерируемые инструкции для LLM

prompt_instructions:
  # Инструкция "не спрашивай о том, что известно"
  do_not_ask_template: |
    ВАЖНО: НЕ задавай вопросы о том, что уже известно:
    {do_not_ask_list}

  # Инструкция "доступные вопросы"
  available_questions_template: |
    Выбери ОДИН вопрос из доступных (то, что ещё НЕ известно):
    {available_questions_list}

  # Fallback если всё известно
  all_data_collected_instruction: |
    Все данные для этой фазы собраны. Переходи к следующему этапу или подтверди понимание.

# =============================================================================
# DEDUPLICATION STRATEGIES — стратегии дедупликации
# =============================================================================

strategies:
  default:
    # Фильтровать вопросы по collected_data
    filter_by_collected: true
    # Использовать semantic matching для определения похожих вопросов
    semantic_matching: false  # Пока отключено для производительности
    # Логировать каждую фильтрацию
    log_filtering: true

  strict:
    filter_by_collected: true
    semantic_matching: true
    log_filtering: true

# =============================================================================
# METRICS — метрики для мониторинга
# =============================================================================

metrics:
  track_questions_filtered: true
  track_questions_generated: true
  track_dedup_effectiveness: true

  alert_thresholds:
    # Алерт если бот всё равно спросил о известном (через логи LLM)
    repeated_question_detected: 1
    # Алерт если фильтрация не сработала
    dedup_failure_rate: 0.05
