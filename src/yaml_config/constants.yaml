# =============================================================================
# ЕДИНАЯ ТОЧКА ИСТИНЫ ДЛЯ ВСЕХ КОНСТАНТ STATE MACHINE
# =============================================================================
# Версия: 1.0
# Этот файл является источником истины для всех констант,
# связанных с state machine и диалоговой логикой.
# =============================================================================

# =============================================================================
# SPIN SELLING CONFIGURATION
# =============================================================================
spin:
  # Порядок SPIN фаз (можно изменить!)
  phases:
    - situation
    - problem
    - implication
    - need_payoff

  # Маппинг фаза -> состояние
  states:
    situation: spin_situation
    problem: spin_problem
    implication: spin_implication
    need_payoff: spin_need_payoff

  # Интенты которые указывают на прогресс в соответствующей фазе
  progress_intents:
    situation_provided: situation
    problem_revealed: problem
    implication_acknowledged: implication
    need_expressed: need_payoff

  # Конфигурация классификации по фазам
  # Определяет какие extracted данные означают прогресс в каждой фазе
  phase_classification:
    situation:
      data_fields:
        - company_size
        - current_tools
        - business_type
      intent: situation_provided
      confidence: 0.9
    problem:
      data_fields:
        - pain_point
      intent: problem_revealed
      confidence: 0.9
    implication:
      data_fields:
        - pain_impact
        - financial_impact
      intent: implication_acknowledged
      confidence: 0.9
    need_payoff:
      data_fields:
        - desired_outcome
        - value_acknowledged
      intent: need_expressed
      confidence: 0.9

    # MEDDIC phases
    metrics:
      data_fields:
        - success_metrics
      intent: info_provided
      confidence: 0.9
    buyer:
      data_fields:
        - decision_maker
      intent: info_provided
      confidence: 0.9
    criteria:
      data_fields:
        - decision_criteria
      intent: info_provided
      confidence: 0.9
    process:
      data_fields:
        - decision_process
      intent: info_provided
      confidence: 0.9
    pain:
      data_fields:
        - pain_point
      intent: problem_revealed
      confidence: 0.9
    champion:
      data_fields:
        - champion_info
      intent: info_provided
      confidence: 0.9

    # BANT phases
    budget:
      data_fields:
        - budget_range
      intent: info_provided
      confidence: 0.9
    authority:
      data_fields:
        - decision_maker
      intent: info_provided
      confidence: 0.9
    need:
      data_fields:
        - pain_point
      intent: problem_revealed
      confidence: 0.9
    timeline:
      data_fields:
        - decision_timeline
      intent: info_provided
      confidence: 0.9

    # Shared phases
    discover:
      data_fields:
        - company_size
        - current_tools
      intent: situation_provided
      confidence: 0.9
    interest:
      data_fields:
        - company_size
      intent: info_provided
      confidence: 0.9
    desire:
      data_fields:
        - pain_point
        - desired_outcome
      intent: need_expressed
      confidence: 0.9
    features:
      data_fields:
        - company_size
      intent: situation_provided
      confidence: 0.9
    advantages:
      data_fields:
        - pain_point
      intent: problem_revealed
      confidence: 0.9
    benefits:
      data_fields:
        - desired_outcome
      intent: need_expressed
      confidence: 0.9
    simple:
      data_fields:
        - company_size
      intent: situation_provided
      confidence: 0.9
    align:
      data_fields:
        - pain_point
      intent: problem_revealed
      confidence: 0.9
    understand:
      data_fields:
        - company_size
        - current_tools
      intent: situation_provided
      confidence: 0.9
    advise:
      data_fields:
        - pain_point
      intent: problem_revealed
      confidence: 0.9
    recommend:
      data_fields:
        - desired_outcome
      intent: need_expressed
      confidence: 0.9
    quantify:
      data_fields:
        - pain_impact
        - financial_impact
      intent: implication_acknowledged
      confidence: 0.9
    engage:
      data_fields:
        - company_size
      intent: situation_provided
      confidence: 0.9

  # Конфигурация классификации коротких ответов по фазам
  # Определяет какой интент возвращать при положительном/негативном ответе
  short_answer_classification:
    situation:
      positive_intent: situation_provided
      positive_confidence: 0.7
    problem:
      positive_intent: problem_revealed
      positive_confidence: 0.75
      negative_intent: no_problem
      negative_confidence: 0.7
    implication:
      positive_intent: implication_acknowledged
      positive_confidence: 0.8
    need_payoff:
      positive_intent: need_expressed
      positive_confidence: 0.85
      negative_intent: no_need
      negative_confidence: 0.7

# =============================================================================
# LIMITS
# =============================================================================
limits:
  # Максимум возражений подряд до soft_close
  max_consecutive_objections: 3
  # Максимум возражений за весь диалог
  max_total_objections: 5
  # Максимум возвратов назад по SPIN
  max_gobacks: 2
  # Phase-origin objection escape threshold (lower than standard 3)
  phase_origin_objection_escape: 2

  # Persona-specific objection limits (single source of truth)
  # Names must match personas.py exactly
  persona_objection_limits:
    happy_path:      { consecutive: 3, total: 5 }
    skeptic:         { consecutive: 4, total: 7 }
    busy:            { consecutive: 3, total: 5 }
    price_sensitive: { consecutive: 5, total: 9 }
    competitor_user: { consecutive: 4, total: 7 }
    aggressive:      { consecutive: 5, total: 8 }
    technical:       { consecutive: 4, total: 6 }
    tire_kicker:     { consecutive: 6, total: 12 }
    analytical:      { consecutive: 4, total: 6 }
    friendly:        { consecutive: 4, total: 7 }
    default:         { consecutive: 4, total: 6 }

# =============================================================================
# DISAMBIGUATION (Unified Disambiguation Decision Engine)
# =============================================================================
# Конфигурация для унифицированного механизма уточнения намерений.
# Работает с обоими классификаторами (LLM и Hybrid).
#
# Decision matrix:
# | Confidence | Gap      | Decision     |
# |------------|----------|--------------|
# | >= 0.85    | >= 0.20  | EXECUTE      |
# | >= 0.85    | < 0.20   | CONFIRM      |
# | >= 0.65    | >= 0.20  | EXECUTE      |
# | >= 0.65    | < 0.20   | CONFIRM      |
# | >= 0.45    | any      | DISAMBIGUATE |
# | >= 0.30    | any      | DISAMBIGUATE |
# | < 0.30     | any      | FALLBACK     |
# =============================================================================
disambiguation:
  # Пороги confidence для принятия решений
  thresholds:
    high_confidence: 0.85      # EXECUTE если gap достаточный
    medium_confidence: 0.65    # EXECUTE или CONFIRM в зависимости от gap
    low_confidence: 0.45       # DISAMBIGUATE
    min_confidence: 0.30       # Ниже → FALLBACK

  # Порог gap между top-1 и top-2 интентами
  # Маленький gap = близкие альтернативы = нужно уточнить
  gap_threshold: 0.20

  # Порог gap для подтверждения (CONFIRM → DISAMBIGUATE при gap < этого значения)
  # При gap >= confirm_gap_threshold решение EXECUTE, иначе DISAMBIGUATE
  confirm_gap_threshold: 0.10

  # Настройки опций для показа пользователю
  options:
    max_options: 3             # Максимум вариантов (+ "Другое")
    min_option_confidence: 0.25  # Минимальная confidence для включения в опции

  # DEPRECATED: bypass intents are now derived from intent_taxonomy
  # (entries with bypass_disambiguation: true)
  # Use IntentTaxonomyRegistry.get_bypass_intents() at runtime.
  # bypass_intents:
  #   - rejection
  #   - contact_provided
  #   - demo_request

  # Интенты которые исключаются из опций disambiguation
  # Не показываем их пользователю как варианты
  excluded_intents:
    - unclear           # Не предлагаем "непонятно" как выбор
    - small_talk        # Не предлагаем "поболтать" как выбор

  # Compound message bypass: skip disambiguation when a social intent has
  # substantive (non-social) alternatives — indicates multi-intent, not ambiguity.
  # E.g., "hello, we need a CRM system" = greeting + info_provided
  compound_bypass_intents:
    - greeting
    - farewell
    - small_talk
    - gratitude

  # Cooldown: сколько ходов ждать между disambiguation
  # Чтобы не раздражать пользователя частыми уточнениями
  cooldown_turns: 3

# =============================================================================
# INTENT CATEGORIES
# =============================================================================
intents:
  # Интенты для возврата назад по flow
  go_back:
    - go_back
    - correct_info

  # Категории интентов (source of truth)
  categories:
    # =================================================================
    # БАЗОВЫЕ ВОЗРАЖЕНИЯ (18 интентов)
    # ВАЖНО: rejection НЕ является возражением!
    # - Возражение = "дорого", "нет времени" → можно обработать
    # - Rejection = "не интересует" → финальный отказ
    # =================================================================
    objection:
      - objection_price
      - objection_competitor
      - objection_no_time
      - objection_think
      - objection_timing
      - objection_complexity
      - objection_trust
      - objection_no_need
      - objection_risk
      - objection_team_resistance
      - objection_security
      - objection_bad_experience
      - objection_priority
      - objection_scale
      - objection_change_management
      - objection_contract_bound
      - objection_company_policy
      - objection_roi_doubt

    # =================================================================
    # ИНТЕНТЫ ЗАВЕРШЕНИЯ ДИАЛОГА (exit intents)
    # Используются для перехода в soft_close
    # =================================================================
    exit:
      - rejection
      - farewell

    # =================================================================
    # ЭСКАЛАЦИЯ - интенты требующие человека
    # ВАЖНО: Синхронизирован с EscalationSource.EXPLICIT_ESCALATION_INTENTS
    # =================================================================
    escalation:
      - request_human
      - need_help

    # =================================================================
    # ФРУСТРАЦИЯ - интенты выражающие недовольство
    # ВАЖНО: Синхронизирован с EscalationSource.FRUSTRATION_INTENTS
    # Используется для category_streak в frustration tracking
    # =================================================================
    frustration:
      - frustration_expression
      - impatience_expression

    # =================================================================
    # ЧУВСТВИТЕЛЬНЫЕ ТЕМЫ - требуют человека
    # ВАЖНО: Синхронизирован с EscalationSource.SENSITIVE_INTENTS
    # =================================================================
    sensitive:
      - legal_question
      - compliance_question
      - formal_complaint
      - request_refund
      - contract_dispute
      - data_deletion
      - gdpr_request

    # =================================================================
    # ПОЗИТИВНЫЕ СИГНАЛЫ (включая новые 8)
    # =================================================================
    positive:
      - agreement
      - demo_request
      - callback_request
      - contact_provided
      - consultation_request
      - situation_provided
      - problem_revealed
      - implication_acknowledged
      - need_expressed
      - info_provided
      - question_features
      - question_integrations
      - comparison
      - greeting
      - gratitude
      # Новые позитивные сигналы
      - ready_to_buy
      - budget_approved
      - decision_maker_identified
      - urgency_expressed
      - competitor_dissatisfied
      - expansion_planned
      - positive_feedback
      - internal_champion

    # =================================================================
    # БАЗОВЫЕ ВОПРОСЫ
    # =================================================================
    question:
      - price_question
      - pricing_details
      - question_features
      - question_integrations
      - question_technical
      - comparison
      - question_security
      - question_support
      - question_implementation
      - question_training
      - question_updates
      - question_mobile
      - question_offline
      - question_data_migration
      - question_customization
      - question_reports
      - question_automation
      - question_scalability

    # =================================================================
    # ВОПРОСЫ О ЦЕНЕ (требуют ответа с ценой)
    # ВАЖНО: Должен быть синхронизирован с PriceQuestionSource.DEFAULT_PRICE_INTENTS
    # Используется для category_streak в price_repeated_3x/2x условиях
    # =================================================================
    price_related:
      - price_question
      - pricing_details
      - cost_inquiry
      - discount_request
      - payment_terms
      - pricing_comparison
      - budget_question

    # =================================================================
    # ТЕХНИЧЕСКИЕ ВОПРОСЫ
    # Используется для category_streak в technical_question_repeated_2x
    # Группирует все интенты технических вопросов
    # =================================================================
    technical_question:
      - question_technical
      - question_security
      - question_support
      - question_implementation
      - question_training
      - question_updates
      - question_mobile
      - question_offline
      - question_data_migration
      - question_customization
      - question_reports
      - question_automation
      - question_scalability

    # MOVED: question_requires_facts → composed_categories
    # Now includes all_questions instead of hardcoded 4 intents

    spin_progress:
      - situation_provided
      - problem_revealed
      - implication_acknowledged
      - need_expressed

    # Информативные интенты (клиент предоставляет данные, не застрял)
    # Используется ConversationGuard для проверки перед срабатыванием TIER_3
    informative:
      # SPIN situation
      - situation_provided
      - info_provided
      # SPIN problem
      - problem_revealed
      # SPIN implication
      - implication_acknowledged
      # SPIN need-payoff
      - need_expressed
      - positive_feedback
      # Corrections
      - correct_info

    # =================================================================
    # COMPOSED CATEGORY: negative
    # Определяется через composed_categories (см. ниже)
    # НЕ РЕДАКТИРОВАТЬ ЗДЕСЬ - это placeholder для обратной совместимости
    # Реальное содержимое генерируется автоматически в constants.py
    # =================================================================
    # negative: [] - будет заполнено автоматически из composed_categories

    # =================================================================
    # ВОПРОСЫ ОБ ОБОРУДОВАНИИ (12 интентов)
    # =================================================================
    equipment_questions:
      - question_equipment_general
      - question_pos_monoblock
      - question_scales
      - question_scanner
      - question_printer
      - question_cash_drawer
      - question_equipment_bundle
      - question_equipment_specs
      - question_equipment_warranty
      - question_equipment_install
      - question_equipment_compat
      - question_second_screen

    # =================================================================
    # ВОПРОСЫ О ТАРИФАХ (8 интентов)
    # =================================================================
    tariff_questions:
      - question_tariff_mini
      - question_tariff_lite
      - question_tariff_standard
      - question_tariff_pro
      - question_tariff_comparison
      - question_installment
      - question_trial_period
      - question_ofd_payment

    # =================================================================
    # ВОПРОСЫ О ТИС (10 интентов)
    # =================================================================
    tis_questions:
      - question_tis_general
      - question_tis_limits
      - question_tis_price
      - question_tis_requirements
      - question_tis_benefits
      - question_tis_2026
      - question_tis_components
      - question_tis_multi_location
      - question_tis_transition
      - question_tis_reports

    # =================================================================
    # ВОПРОСЫ О НАЛОГАХ (8 интентов)
    # =================================================================
    tax_questions:
      - question_retail_tax_general
      - question_retail_tax_rates
      - question_retail_tax_oked
      - question_retail_tax_reports
      - question_retail_tax_transition
      - question_snr_comparison
      - question_vat_registration
      - question_tax_optimization

    # =================================================================
    # БУХГАЛТЕРИЯ И ДОКУМЕНТЫ (8 интентов)
    # =================================================================
    accounting_questions:
      - question_accounting_services
      - question_esf_snt
      - question_form_910
      - question_form_200
      - question_form_300
      - question_business_registration
      - question_business_closure
      - question_document_flow

    # =================================================================
    # ИНТЕГРАЦИИ СПЕЦИФИЧНЫЕ (8 интентов)
    # =================================================================
    integration_specific:
      - question_bank_terminal
      - question_kaspi_integration
      - question_halyk_integration
      - question_1c_integration
      - question_iiko_integration
      - question_ofd_connection
      - question_marking_ismet
      - question_cashback_loyalty

    # =================================================================
    # УЧЁТ И ОПЕРАЦИИ (10 интентов)
    # =================================================================
    operations_questions:
      - question_inventory
      - question_revision
      - question_purchase_mgmt
      - question_sales_mgmt
      - question_cash_operations
      - question_returns_mgmt
      - question_employee_control
      - question_multi_location
      - question_promo_discounts
      - question_price_labels

    # =================================================================
    # ДОСТАВКА И СЕРВИС (6 интентов)
    # =================================================================
    delivery_service:
      - question_delivery
      - question_delivery_time
      - question_office_location
      - question_working_hours
      - request_refund
      - request_equipment_return

    # =================================================================
    # БИЗНЕС-СЦЕНАРИИ (18 интентов)
    # =================================================================
    business_scenarios:
      # Основные (10)
      - question_grocery_store
      - question_restaurant_cafe
      - question_pharmacy
      - question_clothing_store
      - question_small_business
      - question_network_stores
      - question_market_stall
      - question_alcohol_tobacco
      - question_beauty_salon
      - question_construction
      # Дополнительные (8)
      - question_wholesale
      - question_auto_parts
      - question_electronics
      - question_pet_shop
      - question_flower_shop
      - question_hotel
      - question_service_center
      - question_sports_shop

    # =================================================================
    # ТЕХНИЧЕСКИЕ ПРОБЛЕМЫ (6 интентов)
    # =================================================================
    technical_problems:
      - problem_technical
      - problem_connection
      - problem_sync
      - problem_fiscal
      - request_technical_support
      - request_configuration

    # =================================================================
    # РАЗГОВОРНЫЕ/ЭМОЦИОНАЛЬНЫЕ (10 интентов)
    # =================================================================
    conversational:
      - compliment
      - joke_response
      - surprise_expression
      - frustration_expression
      - skepticism_expression
      - curiosity_expression
      - empathy_request
      - confusion_expression
      - impatience_expression
      - relief_expression

    # =================================================================
    # ФИСКАЛИЗАЦИЯ (8 интентов)
    # =================================================================
    fiscal_questions:
      - question_fiscal_general
      - question_fiscal_receipt
      - question_fiscal_z_report
      - question_fiscal_x_report
      - question_fiscal_kkm
      - question_fiscal_ofd_wipon
      - question_fiscal_correction
      - question_fiscal_replacement

    # =================================================================
    # АНАЛИТИКА (8 интентов)
    # =================================================================
    analytics_questions:
      - question_analytics_sales
      - question_analytics_abc
      - question_analytics_profit
      - question_analytics_comparison
      - question_analytics_realtime
      - question_analytics_export
      - question_analytics_custom
      - question_analytics_dashboard

    # =================================================================
    # ПРОДУКТЫ WIPON (6 интентов)
    # =================================================================
    wipon_products:
      - question_wipon_pro
      - question_wipon_desktop
      - question_wipon_kassa
      - question_wipon_consulting
      - question_wipon_cashback_app
      - question_product_comparison

    # =================================================================
    # СОТРУДНИКИ/КАДРЫ (6 интентов)
    # =================================================================
    employee_questions:
      - question_employees_salary
      - question_employees_schedule
      - question_employees_permissions
      - question_employees_tracking
      - question_employees_motivation
      - question_employees_onboarding

    # =================================================================
    # ПРОМО/ЛОЯЛЬНОСТЬ (6 интентов)
    # =================================================================
    promo_loyalty:
      - question_loyalty_program
      - question_bonus_system
      - question_discount_cards
      - question_gift_cards
      - question_customer_database
      - question_sms_marketing

    # =================================================================
    # СТАБИЛЬНОСТЬ/НАДЁЖНОСТЬ (6 интентов)
    # =================================================================
    stability_questions:
      - question_backup_restore
      - question_uptime_sla
      - question_server_location
      - question_data_encryption
      - question_disaster_recovery
      - question_system_requirements

    # =================================================================
    # РЕГИОНЫ/ПРИСУТСТВИЕ (6 интентов)
    # =================================================================
    region_questions:
      - question_region_almaty
      - question_region_astana
      - question_region_shymkent
      - question_region_other
      - question_pickup_office
      - question_courier_service

    # =================================================================
    # ДОПОЛНИТЕЛЬНЫЕ ИНТЕГРАЦИИ (6 интентов)
    # =================================================================
    additional_integrations:
      - question_glovo_wolt
      - question_telegram_bot
      - question_whatsapp_business
      - question_instagram_shop
      - question_website_widget
      - question_delivery_services

    # =================================================================
    # ЭТАПЫ ПОКУПКИ (8 интентов)
    # =================================================================
    purchase_stages:
      - request_proposal
      - request_contract
      - request_invoice
      - request_discount
      - negotiate_terms
      - request_trial_extension
      - request_references
      - request_sla

    # =================================================================
    # ВОПРОСЫ О КОМПАНИИ (4 интента)
    # =================================================================
    company_info:
      - company_info_question
      - experience_question
      - case_study_request
      - roi_question

    # REMOVED: objection_return_questions
    # All question intents now covered by composed all_questions category
    # via auto_include.intent_prefix: "question_"

    # =================================================================
    # ДОПОЛНИТЕЛЬНЫЕ ИНТЕНТЫ ДЛЯ БЕЗОПАСНОСТИ GREETING (2 интента)
    # Интенты которые не входят в technical_problems, но должны быть
    # перенаправлены в entry_state из greeting-состояний.
    # =================================================================
    greeting_additional_redirects:
      - request_references     # greeting + "клиенты" → misclass as reference request
      - contact_provided       # greeting + premature contact → skip qualification

    # =================================================================
    # УПРАВЛЕНИЕ ДИАЛОГОМ (8 интентов)
    # =================================================================
    dialogue_control:
      - unclear
      - go_back
      - correct_info
      - request_brevity
      - clarification_request
      - repeat_request
      - example_request
      - summary_request

  # =================================================================
  # COMPOSED CATEGORIES - Декларативная композиция категорий
  # =================================================================
  # Эти категории создаются автоматически путём объединения базовых категорий.
  # Преимущества:
  # 1. Single Source of Truth - базовые категории определены один раз
  # 2. Автоматическая синхронизация - изменение objection обновляет negative
  # 3. Нет дублирования - нет ручного копирования списков
  # 4. Валидация - проверка что все referenced категории существуют
  #
  # Формат:
  #   category_name:
  #     includes: [list of base categories to merge]
  #     description: "Human-readable description"
  # =================================================================
  composed_categories:
    # negative = все негативные сигналы (возражения + exit)
    negative:
      includes:
        - objection
        - exit
      description: "Все негативные сигналы (возражения + отказы/прощания)"

    # blocking = интенты которые блокируют прогресс
    blocking:
      includes:
        - objection
        - exit
        - technical_problems
      description: "Интенты блокирующие прогресс диалога"

    # all_questions = все типы вопросов (для fallback/routing)
    # all_questions uses auto-discovery for question_* categories
    # auto_include scans base_categories for any with question_* intents (7+ categories auto-discovered)
    # explicit includes cover edge cases where intents don't have question_* prefix
    all_questions:
      auto_include:
        intent_prefix: "question_"    # Auto-include ALL base categories with question_* intents
        exclude_categories:           # Categories with question_* intents that are NOT question categories
          - positive                  # Has question_features, question_integrations but is a positive category
      includes:
        - price_related               # Has price_question (not question_* prefix)
        - company_info                # Has company_info_question, experience_question (not question_* prefix)
      description: "Все вопросные категории (auto-discovered + 2 explicit edge cases)"

    # greeting_redirect_intents = все интенты для безопасного перенаправления в greeting
    # SSOT: Единственный источник истины для greeting safety overrides.
    # Паттерн идентичен objection_return_triggers (commit 01252ba).
    greeting_redirect_intents:
      includes:
        - technical_problems              # problem_sync, problem_connection, etc. (6 intents)
        - greeting_additional_redirects   # request_references, contact_provided (2 intents)
      description: "SSOT: Интенты перенаправляемые в entry_state из greeting-состояний"

    # comparison_like = comparison-related intents for pattern detection
    comparison_like:
      includes: []
      direct_intents:
        - comparison
        - question_product_comparison
        - question_tariff_comparison
        - question_snr_comparison
      description: "Comparison-related intents for pattern detection"

    # objection_return_triggers = все интенты вызывающие возврат из handle_objection
    # ВАЖНО: Единственный источник истины для ObjectionReturnSource.DEFAULT_RETURN_INTENTS
    # ALL questions = engagement signal (was: only 2 ghost intents)
    objection_return_triggers:
      includes:
        - positive         # 23 positive signals
        - price_related    # 7 pricing (overlap with all_questions — auto-deduped)
        - all_questions    # FIX RC-1: ALL questions = engagement signal
      description: "SSOT: Интенты вызывающие возврат из handle_objection в сохранённое состояние"

    # question_requires_facts as composed category (was: 4 hardcoded intents)
    question_requires_facts:
      includes:
        - all_questions
      description: "Вопросы требующие ответа фактами (не deflect)"

  # =================================================================
  # МАППИНГ intent → preferred action (override default behavior)
  # NOTE: price_question/pricing_details используют условную логику в mixins,
  # поэтому НЕ указываем их здесь как безусловный override
  # =================================================================
  intent_action_overrides:
    # Pricing intents (defense-in-depth with policy overlay)
    price_question: answer_with_pricing
    pricing_details: answer_with_pricing
    # Facts-based questions
    question_features: answer_with_facts
    question_integrations: answer_with_facts
    # Технические вопросы
    question_equipment_general: answer_with_facts
    question_tariff_comparison: answer_with_facts
    question_tis_general: answer_with_facts
    question_fiscal_general: answer_with_facts
    # Бизнес-сценарии
    question_grocery_store: answer_with_facts
    question_restaurant_cafe: answer_with_facts
    # Технические проблемы → поддержка
    problem_technical: offer_support
    request_technical_support: connect_to_support

  # =================================================================
  # INTENT PATTERN GUARD CONFIG
  # Configurable pattern detection for any intent category.
  # =================================================================
  intent_pattern_guard:
    patterns:
      comparison_like:
        intents:
          - comparison
          - question_product_comparison
          - question_tariff_comparison
          - question_snr_comparison
        persona_limits:
          default: { streak: 3, total: 5 }
          competitor_user: { streak: 4, total: 7 }
          tire_kicker: { streak: 5, total: 9 }
        close_action: close_answer_and_collect
        default_action: nudge_progress

# =============================================================================
# INTENT TAXONOMY - Иерархическая система с intelligent fallback
# =============================================================================
# Resolution order для unmapped intent:
# 1. Exact match (state/global rules)
# 2. Category fallback (price_question → question category → answer_with_pricing)
# 3. Super-category fallback (question → user_input → acknowledge_and_continue)
# 4. Domain fallback (pricing domain → answer_with_pricing)
# 5. DEFAULT_ACTION (только если всё выше failed)
# =============================================================================
intent_taxonomy:
  # =================================================================
  # PRICE INTENTS (7 intents) - CRITICAL for 81% failure fix
  # =================================================================
  price_question:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: high
    bypass_disambiguation: true

  pricing_details:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: high
    bypass_disambiguation: true

  cost_inquiry:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: high
    bypass_disambiguation: true

  discount_request:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: high

  payment_terms:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: high

  pricing_comparison:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: high

  budget_question:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: high

  # =================================================================
  # PURCHASE PROGRESSION (critical for contact_provided fix)
  # =================================================================
  contact_provided:
    category: positive
    super_category: user_action
    semantic_domain: purchase
    fallback_action: collect_contact
    fallback_transition: success
    priority: critical
    bypass_disambiguation: true

  demo_request:
    category: positive
    super_category: user_action
    semantic_domain: purchase
    fallback_action: schedule_demo
    fallback_transition: close
    priority: critical
    bypass_disambiguation: true

  callback_request:
    category: positive
    super_category: user_action
    semantic_domain: purchase
    fallback_action: schedule_callback
    fallback_transition: close
    priority: critical
    bypass_disambiguation: true

  request_references:
    category: purchase_stage
    super_category: user_action
    semantic_domain: purchase
    fallback_action: provide_references
    fallback_transition: close
    priority: high

  consultation_request:
    category: positive
    super_category: user_action
    semantic_domain: purchase
    fallback_action: schedule_consultation
    fallback_transition: close
    priority: high

  # =================================================================
  # META INTENTS (dialogue control)
  # =================================================================
  request_brevity:
    category: meta
    super_category: dialogue_control
    semantic_domain: style
    fallback_action: respond_briefly
    fallback_transition: null
    priority: low

  unclear:
    category: dialogue_repair
    super_category: dialogue_control
    semantic_domain: clarification
    fallback_action: clarify_one_question
    fallback_transition: null
    priority: medium

  go_back:
    category: dialogue_repair
    super_category: dialogue_control
    semantic_domain: navigation
    fallback_action: handle_go_back
    fallback_transition: null
    priority: medium

  correct_info:
    category: dialogue_repair
    super_category: dialogue_control
    semantic_domain: correction
    fallback_action: acknowledge_correction
    fallback_transition: null
    priority: medium

  clarification_request:
    category: dialogue_repair
    super_category: dialogue_control
    semantic_domain: clarification
    fallback_action: provide_clarification
    fallback_transition: null
    priority: medium

  repeat_request:
    category: dialogue_repair
    super_category: dialogue_control
    semantic_domain: clarification
    fallback_action: repeat_last_message
    fallback_transition: null
    priority: low

  example_request:
    category: dialogue_repair
    super_category: dialogue_control
    semantic_domain: clarification
    fallback_action: provide_example
    fallback_transition: null
    priority: medium

  summary_request:
    category: dialogue_repair
    super_category: dialogue_control
    semantic_domain: clarification
    fallback_action: provide_summary
    fallback_transition: null
    priority: medium

  # =================================================================
  # PRODUCT QUESTIONS
  # =================================================================
  question_features:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: high

  question_integrations:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: high

  question_technical:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  comparison:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: high

  question_security:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: high

  question_support:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_implementation:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_training:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_updates:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: low

  question_mobile:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_offline:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_data_migration:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_customization:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_reports:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_automation:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_scalability:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  # =================================================================
  # OBJECTIONS (18 intents)
  # =================================================================
  objection_price:
    category: objection
    super_category: user_concern
    semantic_domain: pricing
    fallback_action: handle_objection
    fallback_transition: null
    priority: high

  objection_competitor:
    category: objection
    super_category: user_concern
    semantic_domain: market
    fallback_action: handle_objection
    fallback_transition: null
    priority: high

  objection_no_time:
    category: objection
    super_category: user_concern
    semantic_domain: timing
    fallback_action: handle_objection
    fallback_transition: null
    priority: medium

  objection_think:
    category: objection
    super_category: user_concern
    semantic_domain: decision
    fallback_action: handle_objection
    fallback_transition: null
    priority: medium

  objection_timing:
    category: objection
    super_category: user_concern
    semantic_domain: timing
    fallback_action: handle_objection
    fallback_transition: null
    priority: medium

  objection_complexity:
    category: objection
    super_category: user_concern
    semantic_domain: implementation
    fallback_action: handle_objection
    fallback_transition: null
    priority: medium

  objection_trust:
    category: objection
    super_category: user_concern
    semantic_domain: trust
    fallback_action: handle_objection
    fallback_transition: null
    priority: high

  objection_no_need:
    category: objection
    super_category: user_concern
    semantic_domain: value
    fallback_action: handle_objection
    fallback_transition: null
    priority: high

  objection_risk:
    category: objection
    super_category: user_concern
    semantic_domain: trust
    fallback_action: handle_objection
    fallback_transition: null
    priority: high

  objection_team_resistance:
    category: objection
    super_category: user_concern
    semantic_domain: implementation
    fallback_action: handle_objection
    fallback_transition: null
    priority: medium

  objection_security:
    category: objection
    super_category: user_concern
    semantic_domain: trust
    fallback_action: handle_objection
    fallback_transition: null
    priority: high

  objection_bad_experience:
    category: objection
    super_category: user_concern
    semantic_domain: trust
    fallback_action: handle_objection
    fallback_transition: null
    priority: high

  objection_priority:
    category: objection
    super_category: user_concern
    semantic_domain: timing
    fallback_action: handle_objection
    fallback_transition: null
    priority: medium

  objection_scale:
    category: objection
    super_category: user_concern
    semantic_domain: implementation
    fallback_action: handle_objection
    fallback_transition: null
    priority: medium

  objection_change_management:
    category: objection
    super_category: user_concern
    semantic_domain: implementation
    fallback_action: handle_objection
    fallback_transition: null
    priority: medium

  objection_contract_bound:
    category: objection
    super_category: user_concern
    semantic_domain: timing
    fallback_action: handle_objection
    fallback_transition: null
    priority: medium

  objection_company_policy:
    category: objection
    super_category: user_concern
    semantic_domain: decision
    fallback_action: handle_objection
    fallback_transition: null
    priority: medium

  objection_roi_doubt:
    category: objection
    super_category: user_concern
    semantic_domain: value
    fallback_action: handle_objection
    fallback_transition: null
    priority: high

  # =================================================================
  # EXIT INTENTS
  # =================================================================
  rejection:
    category: exit
    super_category: user_action
    semantic_domain: termination
    fallback_action: acknowledge_rejection
    fallback_transition: soft_close
    priority: critical
    bypass_disambiguation: true

  farewell:
    category: exit
    super_category: user_action
    semantic_domain: termination
    fallback_action: say_goodbye
    fallback_transition: soft_close
    priority: critical

  # =================================================================
  # ESCALATION INTENTS
  # =================================================================
  request_human:
    category: escalation
    super_category: user_action
    semantic_domain: escalation
    fallback_action: escalate_to_human
    fallback_transition: escalated
    priority: critical

  need_help:
    category: escalation
    super_category: user_action
    semantic_domain: escalation
    fallback_action: offer_help
    fallback_transition: null
    priority: high

  # =================================================================
  # POSITIVE SIGNALS (extended set)
  # =================================================================
  agreement:
    category: positive
    super_category: user_action
    semantic_domain: confirmation
    fallback_action: acknowledge_and_continue
    fallback_transition: null
    priority: medium

  situation_provided:
    category: positive
    super_category: user_action
    semantic_domain: information
    fallback_action: continue_current_goal
    fallback_transition: null
    priority: medium

  problem_revealed:
    category: positive
    super_category: user_action
    semantic_domain: information
    fallback_action: continue_current_goal
    fallback_transition: null
    priority: medium

  implication_acknowledged:
    category: positive
    super_category: user_action
    semantic_domain: information
    fallback_action: continue_current_goal
    fallback_transition: null
    priority: medium

  need_expressed:
    category: positive
    super_category: user_action
    semantic_domain: information
    fallback_action: continue_current_goal
    fallback_transition: null
    priority: medium

  info_provided:
    category: positive
    super_category: user_action
    semantic_domain: information
    fallback_action: continue_current_goal
    fallback_transition: null
    priority: low

  greeting:
    category: positive
    super_category: user_action
    semantic_domain: social
    fallback_action: respond_greeting
    fallback_transition: null
    priority: low

  gratitude:
    category: positive
    super_category: user_action
    semantic_domain: social
    fallback_action: acknowledge_gratitude
    fallback_transition: null
    priority: low

  ready_to_buy:
    category: positive
    super_category: user_action
    semantic_domain: purchase
    fallback_action: guide_to_close
    fallback_transition: close
    priority: critical
    bypass_disambiguation: true

  budget_approved:
    category: positive
    super_category: user_action
    semantic_domain: purchase
    fallback_action: acknowledge_and_continue
    fallback_transition: null
    priority: high

  decision_maker_identified:
    category: positive
    super_category: user_action
    semantic_domain: purchase
    fallback_action: acknowledge_and_continue
    fallback_transition: null
    priority: high

  urgency_expressed:
    category: positive
    super_category: user_action
    semantic_domain: purchase
    fallback_action: acknowledge_and_continue
    fallback_transition: null
    priority: high

  competitor_dissatisfied:
    category: positive
    super_category: user_action
    semantic_domain: market
    fallback_action: acknowledge_and_continue
    fallback_transition: null
    priority: high

  expansion_planned:
    category: positive
    super_category: user_action
    semantic_domain: information
    fallback_action: acknowledge_and_continue
    fallback_transition: null
    priority: medium

  positive_feedback:
    category: positive
    super_category: user_action
    semantic_domain: social
    fallback_action: acknowledge_gratitude
    fallback_transition: null
    priority: low

  internal_champion:
    category: positive
    super_category: user_action
    semantic_domain: purchase
    fallback_action: acknowledge_and_continue
    fallback_transition: null
    priority: high

  # =================================================================
  # EQUIPMENT QUESTIONS (12 intents)
  # =================================================================
  question_equipment_general:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_pos_monoblock:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_scales:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_scanner:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_printer:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_cash_drawer:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_equipment_bundle:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_equipment_specs:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_equipment_warranty:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_equipment_install:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_equipment_compat:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_second_screen:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  # =================================================================
  # TARIFF QUESTIONS (8 intents)
  # =================================================================
  question_tariff_mini:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: high

  question_tariff_lite:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: high

  question_tariff_standard:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: high

  question_tariff_pro:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: high

  question_tariff_comparison:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: high

  question_installment:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: high

  question_trial_period:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: high

  question_ofd_payment:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: medium

  # =================================================================
  # TIS QUESTIONS (10 intents)
  # =================================================================
  question_tis_general:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_tis_limits:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_tis_price:
    category: question
    super_category: user_input
    semantic_domain: pricing
    fallback_action: answer_with_pricing
    priority: high

  question_tis_requirements:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_tis_benefits:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_tis_2026:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_tis_components:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_tis_multi_location:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_tis_transition:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_tis_reports:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  # =================================================================
  # TAX QUESTIONS (8 intents)
  # =================================================================
  question_retail_tax_general:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_retail_tax_rates:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_retail_tax_oked:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_retail_tax_reports:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_retail_tax_transition:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_snr_comparison:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_vat_registration:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_tax_optimization:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  # =================================================================
  # ACCOUNTING QUESTIONS (8 intents)
  # =================================================================
  question_accounting_services:
    category: question
    super_category: user_input
    semantic_domain: service
    fallback_action: answer_with_facts
    priority: medium

  question_esf_snt:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_form_910:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_form_200:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_form_300:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_business_registration:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_business_closure:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_document_flow:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  # =================================================================
  # PURCHASE STAGES (8 intents)
  # =================================================================
  request_proposal:
    category: purchase_stage
    super_category: user_action
    semantic_domain: purchase
    fallback_action: provide_proposal
    fallback_transition: close
    priority: high

  request_contract:
    category: purchase_stage
    super_category: user_action
    semantic_domain: purchase
    fallback_action: provide_contract
    fallback_transition: close
    priority: high

  request_invoice:
    category: purchase_stage
    super_category: user_action
    semantic_domain: purchase
    fallback_action: provide_invoice
    fallback_transition: close
    priority: high

  request_discount:
    category: purchase_stage
    super_category: user_action
    semantic_domain: purchase
    fallback_action: handle_discount_request
    fallback_transition: null
    priority: high

  negotiate_terms:
    category: purchase_stage
    super_category: user_action
    semantic_domain: purchase
    fallback_action: negotiate_terms
    fallback_transition: null
    priority: high

  request_trial_extension:
    category: purchase_stage
    super_category: user_action
    semantic_domain: purchase
    fallback_action: handle_trial_extension
    fallback_transition: null
    priority: medium

  request_sla:
    category: purchase_stage
    super_category: user_action
    semantic_domain: purchase
    fallback_action: provide_sla
    fallback_transition: close
    priority: medium

  # =================================================================
  # BUSINESS SCENARIOS (18 intents)
  # =================================================================
  question_grocery_store:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_restaurant_cafe:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_pharmacy:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_clothing_store:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_small_business:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_network_stores:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_market_stall:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_alcohol_tobacco:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_beauty_salon:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_construction:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_wholesale:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_auto_parts:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_electronics:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_pet_shop:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_flower_shop:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_hotel:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_service_center:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_sports_shop:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  # =================================================================
  # TECHNICAL PROBLEMS (6 intents)
  # =================================================================
  problem_technical:
    category: technical_problem
    super_category: user_action
    semantic_domain: support
    fallback_action: offer_support
    fallback_transition: escalated
    priority: high

  problem_connection:
    category: technical_problem
    super_category: user_action
    semantic_domain: support
    fallback_action: offer_support
    fallback_transition: escalated
    priority: high

  problem_sync:
    category: technical_problem
    super_category: user_action
    semantic_domain: support
    fallback_action: offer_support
    fallback_transition: escalated
    priority: high

  problem_fiscal:
    category: technical_problem
    super_category: user_action
    semantic_domain: support
    fallback_action: offer_support
    fallback_transition: escalated
    priority: high

  request_technical_support:
    category: technical_problem
    super_category: user_action
    semantic_domain: support
    fallback_action: connect_to_support
    fallback_transition: escalated
    priority: critical

  request_configuration:
    category: technical_problem
    super_category: user_action
    semantic_domain: support
    fallback_action: offer_configuration_help
    fallback_transition: null
    priority: medium

  # =================================================================
  # FISCAL QUESTIONS (8 intents)
  # =================================================================
  question_fiscal_general:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_fiscal_receipt:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_fiscal_z_report:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_fiscal_x_report:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_fiscal_kkm:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_fiscal_ofd_wipon:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_fiscal_correction:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_fiscal_replacement:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  # =================================================================
  # ANALYTICS QUESTIONS (8 intents)
  # =================================================================
  question_analytics_sales:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_analytics_abc:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_analytics_profit:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_analytics_comparison:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_analytics_realtime:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_analytics_export:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_analytics_custom:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_analytics_dashboard:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  # =================================================================
  # WIPON PRODUCTS (6 intents)
  # =================================================================
  question_wipon_pro:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_wipon_desktop:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_wipon_kassa:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_wipon_consulting:
    category: question
    super_category: user_input
    semantic_domain: service
    fallback_action: answer_with_facts
    priority: medium

  question_wipon_cashback_app:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_product_comparison:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  # =================================================================
  # INTEGRATION QUESTIONS (8 intents)
  # =================================================================
  question_bank_terminal:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_kaspi_integration:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_halyk_integration:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_1c_integration:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_iiko_integration:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_ofd_connection:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_marking_ismet:
    category: question
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    priority: medium

  question_cashback_loyalty:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  # =================================================================
  # OPERATIONS QUESTIONS (10 intents)
  # =================================================================
  question_inventory:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_revision:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_purchase_mgmt:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_sales_mgmt:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_cash_operations:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_returns_mgmt:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_employee_control:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_multi_location:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_promo_discounts:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_price_labels:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  # =================================================================
  # DELIVERY & SERVICE (6 intents)
  # =================================================================
  question_delivery:
    category: question
    super_category: user_input
    semantic_domain: service
    fallback_action: answer_with_facts
    priority: medium

  question_delivery_time:
    category: question
    super_category: user_input
    semantic_domain: service
    fallback_action: answer_with_facts
    priority: medium

  question_office_location:
    category: question
    super_category: user_input
    semantic_domain: service
    fallback_action: answer_with_facts
    priority: low

  question_working_hours:
    category: question
    super_category: user_input
    semantic_domain: service
    fallback_action: answer_with_facts
    priority: low

  request_refund:
    category: purchase_stage
    super_category: user_action
    semantic_domain: support
    fallback_action: handle_refund_request
    fallback_transition: escalated
    priority: high

  request_equipment_return:
    category: purchase_stage
    super_category: user_action
    semantic_domain: support
    fallback_action: handle_return_request
    fallback_transition: escalated
    priority: high

  # =================================================================
  # EMPLOYEE QUESTIONS (6 intents)
  # =================================================================
  question_employees_salary:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_employees_schedule:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_employees_permissions:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_employees_tracking:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_employees_motivation:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_employees_onboarding:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  # =================================================================
  # PROMO & LOYALTY (6 intents)
  # =================================================================
  question_loyalty_program:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_bonus_system:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_discount_cards:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_gift_cards:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_customer_database:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_sms_marketing:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  # =================================================================
  # STABILITY QUESTIONS (6 intents)
  # =================================================================
  question_backup_restore:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_uptime_sla:
    category: question
    super_category: user_input
    semantic_domain: service
    fallback_action: answer_with_facts
    priority: medium

  question_server_location:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: low

  question_data_encryption:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_disaster_recovery:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_system_requirements:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  # =================================================================
  # REGION QUESTIONS (6 intents)
  # =================================================================
  question_region_almaty:
    category: question
    super_category: user_input
    semantic_domain: service
    fallback_action: answer_with_facts
    priority: low

  question_region_astana:
    category: question
    super_category: user_input
    semantic_domain: service
    fallback_action: answer_with_facts
    priority: low

  question_region_shymkent:
    category: question
    super_category: user_input
    semantic_domain: service
    fallback_action: answer_with_facts
    priority: low

  question_region_other:
    category: question
    super_category: user_input
    semantic_domain: service
    fallback_action: answer_with_facts
    priority: low

  question_pickup_office:
    category: question
    super_category: user_input
    semantic_domain: service
    fallback_action: answer_with_facts
    priority: low

  question_courier_service:
    category: question
    super_category: user_input
    semantic_domain: service
    fallback_action: answer_with_facts
    priority: low

  # =================================================================
  # ADDITIONAL INTEGRATIONS (6 intents)
  # =================================================================
  question_glovo_wolt:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_telegram_bot:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_whatsapp_business:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_instagram_shop:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_website_widget:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  question_delivery_services:
    category: question
    super_category: user_input
    semantic_domain: product
    fallback_action: answer_with_facts
    priority: medium

  # =================================================================
  # COMPANY INFO (4 intents)
  # =================================================================
  company_info_question:
    category: question
    super_category: user_input
    semantic_domain: company
    fallback_action: answer_with_facts
    priority: low

  experience_question:
    category: question
    super_category: user_input
    semantic_domain: company
    fallback_action: answer_with_facts
    priority: low

  case_study_request:
    category: purchase_stage
    super_category: user_action
    semantic_domain: purchase
    fallback_action: provide_case_studies
    fallback_transition: null
    priority: medium

  roi_question:
    category: question
    super_category: user_input
    semantic_domain: value
    fallback_action: answer_with_facts
    priority: high

  # =================================================================
  # CONVERSATIONAL/EMOTIONAL (10 intents)
  # =================================================================
  compliment:
    category: conversational
    super_category: user_action
    semantic_domain: social
    fallback_action: acknowledge_gratitude
    fallback_transition: null
    priority: low

  joke_response:
    category: conversational
    super_category: user_action
    semantic_domain: social
    fallback_action: acknowledge_and_continue
    fallback_transition: null
    priority: low

  surprise_expression:
    category: conversational
    super_category: user_action
    semantic_domain: social
    fallback_action: acknowledge_and_continue
    fallback_transition: null
    priority: low

  frustration_expression:
    category: frustration
    super_category: user_concern
    semantic_domain: emotion
    fallback_action: empathize_and_help
    fallback_transition: null
    priority: high

  skepticism_expression:
    category: conversational
    super_category: user_concern
    semantic_domain: emotion
    fallback_action: address_skepticism
    fallback_transition: null
    priority: medium

  curiosity_expression:
    category: conversational
    super_category: user_action
    semantic_domain: social
    fallback_action: acknowledge_and_continue
    fallback_transition: null
    priority: low

  empathy_request:
    category: conversational
    super_category: user_action
    semantic_domain: emotion
    fallback_action: show_empathy
    fallback_transition: null
    priority: medium

  confusion_expression:
    category: conversational
    super_category: user_concern
    semantic_domain: emotion
    fallback_action: clarify_one_question
    fallback_transition: null
    priority: medium

  impatience_expression:
    category: frustration
    super_category: user_concern
    semantic_domain: emotion
    fallback_action: empathize_and_help
    fallback_transition: null
    priority: high

  relief_expression:
    category: conversational
    super_category: user_action
    semantic_domain: social
    fallback_action: acknowledge_and_continue
    fallback_transition: null
    priority: low

  # =================================================================
  # SENSITIVE INTENTS (7 intents)
  # =================================================================
  legal_question:
    category: sensitive
    super_category: user_action
    semantic_domain: escalation
    fallback_action: escalate_to_human
    fallback_transition: escalated
    priority: critical

  compliance_question:
    category: sensitive
    super_category: user_input
    semantic_domain: compliance
    fallback_action: answer_with_facts
    fallback_transition: null
    priority: high

  formal_complaint:
    category: sensitive
    super_category: user_action
    semantic_domain: escalation
    fallback_action: escalate_to_human
    fallback_transition: escalated
    priority: critical

  request_refund:
    category: sensitive
    super_category: user_action
    semantic_domain: support
    fallback_action: handle_refund_request
    fallback_transition: escalated
    priority: high

  contract_dispute:
    category: sensitive
    super_category: user_action
    semantic_domain: escalation
    fallback_action: escalate_to_human
    fallback_transition: escalated
    priority: critical

  data_deletion:
    category: sensitive
    super_category: user_action
    semantic_domain: escalation
    fallback_action: escalate_to_human
    fallback_transition: escalated
    priority: critical

  gdpr_request:
    category: sensitive
    super_category: user_action
    semantic_domain: escalation
    fallback_action: escalate_to_human
    fallback_transition: escalated
    priority: critical

# Category-level fallback actions
taxonomy_category_defaults:
  question:
    fallback_action: answer_and_continue
  positive:
    fallback_action: acknowledge_and_continue
  objection:
    fallback_action: handle_objection
  purchase_stage:
    fallback_action: guide_to_next_step
    fallback_transition: close
  meta:
    fallback_action: acknowledge_and_continue
  dialogue_repair:
    fallback_action: clarify_one_question
  exit:
    fallback_action: say_goodbye
    fallback_transition: soft_close
  escalation:
    fallback_action: escalate_to_human
    fallback_transition: escalated
  frustration:
    fallback_action: empathize_and_help
  sensitive:
    fallback_action: escalate_to_human
    fallback_transition: escalated
  technical_problem:
    fallback_action: offer_support
    fallback_transition: escalated
  conversational:
    fallback_action: acknowledge_and_continue

# Super-category fallback
taxonomy_super_category_defaults:
  user_input:
    fallback_action: acknowledge_and_continue
  user_action:
    fallback_action: guide_to_next_step
  dialogue_control:
    fallback_action: acknowledge_and_continue
  user_concern:
    fallback_action: empathize_and_help

# Domain fallback (strongest semantic signal)
taxonomy_domain_defaults:
  pricing:
    fallback_action: answer_with_pricing
  product:
    fallback_action: answer_with_facts
  purchase:
    fallback_action: guide_to_next_step
    fallback_transition: close
  support:
    fallback_action: offer_support
    fallback_transition: escalated
  escalation:
    fallback_action: escalate_to_human
    fallback_transition: escalated
  compliance:
    fallback_action: answer_with_facts
  service:
    fallback_action: answer_with_facts
  company:
    fallback_action: answer_with_facts
  value:
    fallback_action: answer_with_facts
  social:
    fallback_action: acknowledge_and_continue
  emotion:
    fallback_action: empathize_and_help
  clarification:
    fallback_action: clarify_one_question
  termination:
    fallback_action: say_goodbye
    fallback_transition: soft_close

# =============================================================================
# DIALOGUE POLICY SETTINGS
# =============================================================================
policy:
  # DEPRECATED: overlay logic now uses blacklist via protected_states.
  # Kept for reference. Any state NOT in protected_states gets overlays.
  # FIX: Добавлены BANT states для поддержки policy overlays в BANT flow
  overlay_allowed_states:
    # SPIN states
    - spin_situation
    - spin_problem
    - spin_implication
    - spin_need_payoff
    # BANT states (FIX: были пропущены, вызывало потерю вопросов в BANT flow)
    - bant_budget
    - bant_authority
    - bant_need
    - bant_timeline
    # Common states
    - presentation
    - handle_objection
    # Other flow states (для универсальности)
    - discovery
    - qualification
    - needs_analysis
    - solution_presentation

  # Защищённые состояния (без оверлеев)
  protected_states:
    - greeting
    - close
    - success
    - soft_close
    - escalated

  # Агрессивные действия (требуют осторожности)
  aggressive_actions:
    - transition_to_presentation
    - transition_to_close
    - ask_for_demo
    - ask_for_contact

  # Mapping для repair mode
  repair_actions:
    stuck: clarify_one_question
    oscillation: summarize_and_clarify
    repeated_question: answer_with_summary
    mirroring: summarize_and_clarify
    stall: nudge_progress

  # Actions protected from repair override (already answer the user's question)
  repair_protected_actions:
    - answer_with_pricing
    - answer_with_pricing_direct
    - answer_with_facts
    - answer_pricing_details
    - answer_with_knowledge
    - answer_question
    - answer_and_continue
    - answer_with_summary
    - handle_objection
    - handle_repeated_objection
    - reframe_value
    - empathize_and_redirect
    - offer_options
    - explain_feature
    - demonstrate_feature

  # Порог: после N подряд одного action repair protection снимается
  repair_action_repeat_threshold: 2

  # SSOT: Actions that correctly handle pricing.
  # Used by: price overlay (dialogue_policy), generator price template selection.
  pricing_correct_actions:
    - answer_with_pricing
    - answer_with_pricing_direct
    - answer_pricing_details
    - answer_with_facts
    - answer_with_roi
    - calculate_roi_response

  # Narrow intent groups for repeated-question detection.
  # Only semantically equivalent intents should be grouped.
  # discount_request, payment_terms, etc. are NOT the same as price_question.
  repeatable_intent_groups:
    price_core:
      - price_question
      - cost_inquiry

  # Mapping для возражений
  objection_actions:
    reframe: reframe_value
    escalate: handle_repeated_objection
    empathize: empathize_and_redirect

# =============================================================================
# LEAD SCORER SETTINGS
# =============================================================================
lead_scoring:
  # Веса положительных сигналов
  positive_weights:
    demo_request: 30
    price_with_size: 25
    callback_request: 25
    consultation_request: 20
    contact_provided: 35
    explicit_problem: 15
    competitor_comparison: 12
    budget_mentioned: 10
    timeline_mentioned: 10
    multiple_questions: 8
    features_question: 5
    integrations_question: 5
    general_interest: 3
    price_question: 5

  # Веса негативных сигналов
  negative_weights:
    objection_price: -15
    objection_competitor: -10
    objection_no_time: -20
    objection_think: -10
    objection_no_need: -25
    unclear_repeated: -5
    rejection_soft: -25
    frustration: -15

  # Пороги температуры [min, max]
  thresholds:
    cold: [0, 29]
    warm: [30, 49]
    hot: [50, 69]
    very_hot: [70, 100]

  # КРИТИЧНО: Какие SPIN фазы пропускать по температуре
  # Это напрямую влияет на flow диалога!
  skip_phases:
    cold: []  # Полный SPIN
    warm:     # Пропустить I, N
      - spin_implication
      - spin_need_payoff
    hot:      # Только S
      - spin_problem
      - spin_implication
      - spin_need_payoff
    very_hot: # Сразу close
      - spin_situation
      - spin_problem
      - spin_implication
      - spin_need_payoff

  # Рекомендуемые пути по температуре
  paths:
    cold: full_spin           # S → P → I → N → presentation
    warm: short_spin          # S → P → presentation (skip I, N)
    hot: direct_present       # S → presentation
    very_hot: direct_close    # presentation → close

# =============================================================================
# CONVERSATION GUARD SETTINGS
# =============================================================================
guard:
  # Основные лимиты
  max_turns: 25                         # Средний sales диалог: 8-15 turns
  max_phase_attempts: 3                 # LivePerson recommendation
  max_same_state: 4                     # Loop detection
  max_same_message: 2                   # Exact repeat detection
  timeout_seconds: 1800                 # 30 минут

  # Пороги прогресса
  progress_check_interval: 5            # Каждые 5 turns проверяем прогресс
  min_unique_states_for_progress: 2     # Минимум уникальных состояний за интервал

  # КРИТИЧНО: Должен быть равен frustration.thresholds.high
  high_frustration_threshold: 7

  # Предустановленные профили
  profiles:
    strict:
      max_turns: 15
      max_phase_attempts: 2
      max_same_state: 3
      timeout_seconds: 900              # 15 минут
    relaxed:
      max_turns: 40
      max_phase_attempts: 5
      max_same_state: 6
      timeout_seconds: 3600             # 1 час

# =============================================================================
# FRUSTRATION TRACKER SETTINGS
# =============================================================================
frustration:
  # Максимальный уровень frustration (0-10 шкала)
  max_level: 10

  # Веса для накопления frustration (по тону сообщения)
  # NOTE: These are BASE weights. Actual delta is calculated with intensity multipliers.
  weights:
    frustrated: 3      # Сильно увеличивает
    skeptical: 1       # Немного увеличивает
    rushed: 2          # UPDATED from 1 to 2: RUSHED users need faster response
    confused: 1        # Долгое непонимание = frustration

  # Веса для снижения frustration (decay)
  decay:
    neutral: 1         # Немного снижает
    positive: 2        # Хорошо снижает
    interested: 2      # Хорошо снижает

  # Пороги frustration (Single Source of Truth)
  # Все компоненты ДОЛЖНЫ использовать эти пороги через src.frustration_thresholds!
  #
  # Шкала (0-10):
  #   0-1:     Normal - нет раздражения
  #   2:       Elevated - лёгкое раздражение, быть осторожнее
  #   3:       Moderate - заметное раздражение, эмпатичный тон
  #   4:       Warning - сокращать ответы
  #   5-6:     High-Warning - сильное раздражение, рассмотреть intervention
  #   7-8:     High - guard intervention срабатывает
  #   9:       Critical - рекомендовать soft close
  #   10:      Maximum - немедленный выход
  #
  # ВАЖНО: thresholds.high ДОЛЖЕН быть равен guard.high_frustration_threshold!
  thresholds:
    elevated: 2        # Лёгкое раздражение, скорректировать подход
    moderate: 3        # Заметное раздражение, эмпатичный тон
    warning: 4         # Начать сокращать ответы
    high: 7            # Предложить помощь/выход (= guard.high_frustration_threshold)
    critical: 9        # Мягкое завершение

  # Tone-aware apology thresholds
  # Tones listed here use elevated threshold instead of default WARNING(4)
  # Rationale: skepticism is a business question, not frustration
  apology:
    default_threshold: 4            # = thresholds.warning
    tone_overrides:
      skeptical: 7                  # = FRUSTRATION_HIGH: скептицизм ≠ фрустрация на бота
      rushed: 7                     # = FRUSTRATION_HIGH: спешка ≠ фрустрация на бота
      confused: 7                   # = FRUSTRATION_HIGH: непонимание ≠ фрустрация на бота
    # Semantic domains where generic canned apology is allowed.
    # All other domains get LLM contextual empathy via tone_instruction.
    apology_allowed_domains:
      - emotion       # фрустрация, гнев, негативные эмоции
      - escalation    # "дайте оператора", "хочу с человеком"

  # =============================================================================
  # INTENSITY-BASED FRUSTRATION CALCULATION
  # =============================================================================
  # Calculates frustration delta based on signal count (intensity).
  # Multiple signals of same tone = higher weight.
  #
  # Example: "быстрее, не тяни, некогда" (3 RUSHED signals)
  #   - Base weight for RUSHED: 2
  #   - Intensity multiplier for 3 signals: 2.0
  #   - Delta: 2 * 2.0 = 4
  #   - After 2 turns: frustration = 8 (above HIGH threshold of 7)
  #   - Result: Intervention triggered!
  #
  # Root cause fix: Original bug counted only ONE signal per tone per message.
  # With intensity calculation, explicit frustration ("быстрее, не тяни, некогда")
  # is properly detected and escalated.
  # =============================================================================
  intensity:
    # Base weights (override defaults from frustration.weights)
    base_weights:
      frustrated: 3    # Matches weights.frustrated
      rushed: 2        # Higher than original (1) - RUSHED users need faster response
      skeptical: 1     # Matches weights.skeptical
      confused: 1      # Matches weights.confused

    # Intensity multipliers based on signal count
    # Format: {min_signals: multiplier}
    # Higher signal count = stronger expression of frustration
    intensity_multipliers:
      1: 1.0           # 1 signal = base weight (no multiplier)
      2: 1.5           # 2 signals = 1.5x base weight
      3: 2.0           # 3+ signals = 2x base weight

    # Consecutive turn bonus
    # Frustration escalates faster with repeated negative tones
    consecutive_turn_multiplier: 1.2   # 20% bonus per consecutive turn
    consecutive_turn_threshold: 2      # Start bonus after 2+ consecutive turns

    # Decay weights for positive tones
    decay_weights:
      neutral: 1
      positive: 2
      interested: 2

    # Pre-intervention configuration
    # Pre-intervention provides early guidance (shorter responses, offer exit)
    # before reaching the HIGH threshold for full guard intervention.
    #
    # Trigger: RUSHED tone with >= rushed_pre_intervention_threshold signals
    # OR: WARNING level frustration with any negative tone
    rushed_pre_intervention_threshold: 2  # signals to trigger pre-intervention for RUSHED

    # Urgency levels for response guidance
    # Used by get_response_guidance() to determine how short/urgent response should be
    urgency_thresholds:
      low: 2           # = elevated threshold
      medium: 4        # = warning threshold
      high: 7          # = high threshold
      critical: 9      # = critical threshold

# =============================================================================
# CIRCULAR FLOW (Go Back) SETTINGS
# =============================================================================
circular_flow:
  # Разрешённые переходы назад
  allowed_gobacks:
    spin_problem: spin_situation
    spin_implication: spin_problem
    spin_need_payoff: spin_implication
    presentation: spin_need_payoff
    close: presentation
    handle_objection: presentation
    soft_close: greeting  # Новая попытка

# =============================================================================
# CONTEXT WINDOW SETTINGS
# =============================================================================
context:
  # Порядок состояний для расчёта прогресса (funnel_delta)
  state_order:
    greeting: 0
    spin_situation: 1
    spin_problem: 2
    spin_implication: 3
    spin_need_payoff: 4
    presentation: 5
    handle_objection: 5  # Параллельно с presentation
    close: 6
    success: 7
    soft_close: -1  # Негативный прогресс

  # Порядок фаз (для phase progress calculation)
  phase_order:
    greeting: 0
    situation: 1
    problem: 2
    implication: 3
    need_payoff: 4
    presentation: 5
    close: 6
    success: 7

# =============================================================================
# FALLBACK TEMPLATES
# =============================================================================
fallback:
  # Tier 1: Переформулировки по состояниям
  rephrase_templates:
    greeting:
      - "Добрый день! Чем могу помочь?"
      - "Здравствуйте! Расскажите, что вас интересует?"
    spin_situation:
      - "Давайте я спрошу иначе — сколько примерно человек работает с клиентами?"
      - "Можете подсказать хотя бы порядок — 5-10 человек, 10-20, или больше?"
      - "Просто для понимания: вы работаете один или есть команда?"
      - "Подскажите размер вашей команды — это поможет подобрать решение."
    spin_problem:
      - "Попробую по-другому: что сейчас отнимает больше всего времени в работе?"
      - "Скажите, какая задача самая «больная» прямо сейчас?"
      - "Если одним словом — что хотелось бы улучшить в первую очередь?"
      - "С какими сложностями чаще всего сталкиваетесь в работе?"
    spin_implication:
      - "А если примерно — сколько клиентов/заказов теряется из-за этого?"
      - "Как это влияет на выручку, хотя бы приблизительно?"
      - "Это случается часто или скорее редко?"
      - "Насколько серьёзно это влияет на бизнес?"
    spin_need_payoff:
      - "Если бы это решилось — что изменилось бы в первую очередь?"
      - "Что было бы идеальным результатом?"
      - "Какой результат вас бы устроил?"
      - "Что должно измениться, чтобы вы были довольны?"
    presentation:
      - "Хотите расскажу подробнее как это работает?"
      - "Может покажу на примере?"
      - "Интересует что-то конкретное?"
    close:
      - "Оставьте контакт — пришлю детали."
      - "Куда удобнее прислать информацию?"
      - "Как с вами лучше связаться?"
    handle_objection:
      - "Слышу вас. Что именно смущает?"
      - "Какой момент вызывает вопросы?"
      - "Давайте разберём что беспокоит."

  # Tier 2: Варианты (кнопки) по состояниям
  options_templates:
    spin_situation:
      question: "Подскажите размер команды:"
      options:
        - "1-5 человек"
        - "6-15 человек"
        - "16-30 человек"
        - "Больше 30"
    spin_problem:
      question: "Какая основная сложность?"
      options:
        - "Теряем клиентов"
        - "Много ручной работы"
        - "Нет контроля"
        - "Другое"
    spin_implication:
      question: "Как часто это происходит?"
      options:
        - "Ежедневно"
        - "Несколько раз в неделю"
        - "Редко"
        - "Не знаю"
    spin_need_payoff:
      question: "Что для вас важнее всего?"
      options:
        - "Экономия времени"
        - "Рост продаж"
        - "Контроль команды"
        - "Всё вместе"
    presentation:
      question: "Что хотите узнать?"
      options:
        - "Как работает"
        - "Сколько стоит"
        - "Как внедрить"
        - "Показать демо"
    # BANT states
    bant_budget:
      question: "Какой бюджет рассматриваете?"
      options:
        - "До 100 000₸/мес"
        - "100-300 000₸/мес"
        - "Больше 300 000₸/мес"
        - "Пока не определились"
    bant_authority:
      question: "Кто принимает решение о покупке?"
      options:
        - "Я принимаю решение"
        - "Руководитель отдела"
        - "Директор/собственник"
        - "Коллегиальное решение"
    bant_need:
      question: "Какая задача для вас главная?"
      options:
        - "Учёт клиентов и сделок"
        - "Автоматизация процессов"
        - "Контроль команды"
        - "Аналитика и отчёты"
    bant_timeline:
      question: "Когда планируете внедрение?"
      options:
        - "В ближайший месяц"
        - "В течение квартала"
        - "В течение полугода"
        - "Пока изучаем варианты"
    # MEDDIC states
    meddic_metrics:
      question: "Какие метрики для вас важнее?"
      options:
        - "Рост выручки"
        - "Экономия времени"
        - "Снижение потерь"
        - "Эффективность команды"
    meddic_buyer:
      question: "Кто принимает решение?"
      options:
        - "Я сам(а)"
        - "Мой руководитель"
        - "Финансовый директор"
        - "IT-отдел"
    meddic_criteria:
      question: "Что важнее при выборе системы?"
      options:
        - "Функциональность"
        - "Простота внедрения"
        - "Цена"
        - "Поддержка и обучение"
    meddic_process:
      question: "Как обычно принимаете решения?"
      options:
        - "Быстро, за неделю"
        - "Нужно согласование"
        - "Тестируем сначала"
        - "Сравниваем несколько решений"
    meddic_pain:
      question: "Какая главная проблема?"
      options:
        - "Теряем клиентов"
        - "Нет системности"
        - "Не видим воронку"
        - "Другое"
    meddic_champion:
      question: "Кто поддержит внедрение внутри?"
      options:
        - "Я лично"
        - "Коллега из отдела продаж"
        - "IT-специалист"
        - "Пока непонятно"
    # Relationship states
    rel_connect:
      question: "Как вы о нас узнали?"
      options:
        - "Рекомендация"
        - "Поиск в интернете"
        - "Реклама"
        - "Другое"
    rel_rapport:
      question: "Чем занимается ваша компания?"
      options:
        - "Услуги"
        - "Торговля"
        - "Производство"
        - "IT/Технологии"
    rel_nurture:
      question: "Что вас интересует в CRM?"
      options:
        - "Управление клиентами"
        - "Автоматизация продаж"
        - "Аналитика"
        - "Всё вместе"
    rel_partnership:
      question: "Какой результат хотите получить?"
      options:
        - "Рост продаж"
        - "Систематизация процессов"
        - "Лучший сервис клиентам"
        - "Всё вместе"
    close:
      question: "Как удобнее продолжить?"
      options:
        - "Оставить номер для связи"
        - "Отправьте информацию на email"
        - "Запишите на демо"
        - "Пока не интересует"

  # Дефолтные значения
  # FIX: Добавлена вариативность в default_rephrase (было одна фраза, повторялась 123 раза)
  default_rephrase:
    - "Давайте попробую спросить иначе..."
    - "Уточню вопрос по-другому..."
    - "Перефразирую..."
    - "Хорошо, спрошу проще..."
    - "Понял, давайте иначе..."
    - "Окей, переформулирую..."
    - "Попробую яснее..."
  default_options:
    question: "Что вас интересует?"
    options:
      - "Подробнее о системе"
      - "Цены"
      - "Демо"
      - "Связаться позже"

# =============================================================================
# LLM FALLBACK SETTINGS
# =============================================================================
# Ответы при технической ошибке LLM (circuit breaker, timeout, etc.)
llm:
  fallback_responses:
    greeting: "Здравствуйте! Чем могу помочь?"
    spin_situation: "Расскажите, сколько человек работает в вашей команде?"
    spin_problem: "С какими сложностями сталкиваетесь сейчас?"
    spin_implication: "Как это влияет на бизнес?"
    spin_need_payoff: "Что было бы идеальным решением?"
    presentation: "Наша CRM помогает автоматизировать работу с клиентами. Хотите узнать подробнее?"
    close: "Оставьте контакт — свяжусь с деталями."
    soft_close: "Спасибо за разговор! Если вопросы появятся — пишите."
    handle_objection: "Слышу вас. Давайте разберём подробнее?"
  default_fallback: "Произошла техническая ошибка. Попробуйте ещё раз или оставьте контакт."

# =============================================================================
# CTA (Call-to-Action) SETTINGS
# =============================================================================
cta:
  # Состояния где CTA не добавляется (ранние состояния)
  early_states:
    - greeting
    - spin_situation
    - spin_problem

  # Actions where CTA is semantically forbidden (answers/clarifications).
  blocked_actions:
    - answer_with_facts
    - answer_and_continue
    - answer_with_summary
    - answer_with_pricing
    - answer_with_pricing_direct
    - answer_pricing_details
    - answer_question
    - ask_clarification
    - respond_briefly

  # CTA по состояниям
  templates:
    greeting: []
    spin_situation: []
    spin_problem: []
    spin_implication:
      - "Хотите посмотреть как это можно решить?"
      - "Интересно увидеть решение?"
    spin_need_payoff:
      - "Хотите покажу как это работает?"
      - "Интересно увидеть систему в действии?"
      - "Показать на демо?"
    presentation:
      - "Готовы попробовать?"
      - "Запланируем демо?"
      - "Хотите тестовый доступ?"
      - "Оставите контакт для связи?"
    handle_objection:
      - "Может всё-таки глянем демо? Это бесплатно и ни к чему не обязывает."
      - "Давайте просто покажу — 15 минут, и всё станет понятнее."
    close:
      - "Какой контакт для связи удобнее?"
      - "На какой email прислать информацию?"
      - "Когда удобно созвониться?"

  # CTA по типу действия
  by_action:
    demo:
      - "Запланируем демо?"
      - "Показать на демо?"
      - "Хотите увидеть в действии?"
    contact:
      - "Оставите контакт?"
      - "Какой контакт для связи?"
      - "Куда прислать информацию?"
    trial:
      - "Хотите тестовый доступ?"
      - "Попробовать бесплатно?"

  # CTA по фазам (универсально для всех flows)
  by_phase:
    early: []
    mid:
      - "Хотите посмотреть как это решается на демо?"
      - "Могу показать на примере — буквально 10 минут."
      - "Интересно увидеть решение?"
    late:
      - "Готовы попробовать?"
      - "Запланируем демо?"
      - "Хотите тестовый доступ?"
      - "Оставите контакт для связи?"
    close:
      - "Какой контакт для связи удобнее?"
      - "На какой email прислать информацию?"
      - "Когда удобно созвониться?"

# =============================================================================
# RESPONSE DIRECTIVES SETTINGS
# =============================================================================
# Настройки для ResponseDirectives (Phase 2: Естественность диалога)
# ResponseDirectives управляют стилем ответа, не меняя логику state machine.

response_directives:
  # === Пороги для определения тона ===
  tone_thresholds:
    # Between WARNING(4) and HIGH(7) by design: real frustration hits 5 fast
    # (FRUSTRATED +3 + 2×SKEPTICAL +2 = 5), false positives stay at 3
    empathetic_frustration: 5

    # Matches FRUSTRATION_WARNING from frustration_thresholds.py
    validate_frustration: 4

  # === Лимиты длины ответа (max_words) ===
  max_words:
    # При высокой фрустрации
    high_frustration: 40

    # При низком engagement
    low_engagement: 50

    # При repair mode
    repair_mode: 50

    # Стандартный лимит
    default: 60

    # Порог для добавления инструкции "не более N слов"
    instruction_threshold: 50

  # === Лимит строк в context summary ===
  max_summary_lines: 6

  # === Перевод типов возражений для display ===
  objection_translations:
    objection_price: "цена"
    objection_competitor: "конкурент"
    objection_no_time: "нет времени"
    objection_think: "подумать"
    objection_timing: "не сейчас"
    objection_complexity: "сложно"
    objection_no_need: "не нужно"
    objection_trust: "доверие"

  # === Поля для do_not_repeat (collected_data -> readable name) ===
  collected_field_names:
    company_size: "размер компании"
    company_name: "название компании"
    business_type: "тип бизнеса"
    pain_point: "проблема"
    current_tools: "текущие инструменты"

  # === Tone instructions (русские тексты) ===
  tone_instructions:
    empathetic: "Используй эмпатичный тон, признай ситуацию клиента."
    confident: "Используй уверенный тон, подчеркни преимущества."
    supportive: "Используй поддерживающий тон, помоги разобраться."
    neutral: ""

# =============================================================================
# DATA EXTRACTION RULES (Single Source of Truth)
# =============================================================================
# Правила извлечения данных из сообщений пользователя.
# Используется LLM Classifier для валидации extracted_data.
#
# Архитектура:
#   constants.yaml (THIS SECTION)
#        |
#        v
#   extraction_ssot.py (loads, validates, exports)
#        |
#        +--> extraction_validator.py (validates extracted fields)
#        +--> classifier/llm/prompts.py (uses rules in prompts)
#        +--> classifier/llm/classifier.py (post-processing)
#
# КРИТИЧНО: Эти правила предотвращают галлюцинации LLM при заполнении полей.
# =============================================================================

extraction:
  # =========================================================================
  # FIELD DEFINITIONS
  # =========================================================================
  # Каждое поле содержит:
  #   - description: что это за поле (для LLM промпта)
  #   - type: тип данных (int, str, bool, enum)
  #   - validation: правила валидации
  #   - examples: примеры (valid/invalid) для LLM и тестов
  #   - spin_phase: в какой SPIN-фазе извлекается (опционально)
  # =========================================================================

  fields:
    # =========================================================================
    # SITUATION PHASE FIELDS
    # =========================================================================

    company_size:
      description: "Количество сотрудников в компании (только число)"
      type: int
      spin_phase: situation
      validation:
        min: 1
        max: 10000
        # Паттерны для извлечения числа из текста
        extract_patterns:
          - '(\d+)\s*(?:человек|чел\.?|сотрудник|менеджер|продавец|официант)'
          - 'нас\s*(\d+)'
          - 'команда?\s*(?:из|в|на)?\s*(\d+)'
          - 'штат[еа]?\s*(\d+)'
      examples:
        valid:
          - value: 5
            source: "у нас 5 человек"
          - value: 15
            source: "команда из 15 менеджеров"
          - value: 100
            source: "100 сотрудников"
        invalid:
          - value: "пять"
            reason: "Должно быть число, не текст"
          - value: "много"
            reason: "Неопределённое количество"
          - value: 0
            reason: "Не может быть 0 сотрудников"

    current_tools:
      description: "Текущие инструменты для ведения клиентской базы/CRM (НЕ количество людей!)"
      type: enum
      spin_phase: situation
      validation:
        # Допустимые значения - конкретные инструменты
        allowed_values:
          - "Excel"
          - "Google Таблицы"
          - "1С"
          - "Битрикс24"
          - "AmoCRM"
          - "Мегаплан"
          - "Notion"
          - "Trello"
          - "на бумаге"
          - "в блокноте"
          - "в головах"
          - "вручную"
          - "никак не ведём"
          - "другая CRM"
        # Паттерны для извлечения
        extract_patterns:
          - '(?:в\s+)?excel'
          - '(?:в\s+)?эксел'
          - '(?:в\s+)?гугл\s*(?:табли|докс|sheets|docs)'
          - '(?:в\s+)?1[сc]'
          - '(?:в\s+)?битрикс'
          - '(?:в\s+)?амо'
          - '(?:в\s+)?мегаплан'
          - '(?:в\s+)?notion'
          - '(?:в\s+)?trello'
          - '(?:на\s+)?бумаг'
          - '(?:в\s+)?блокнот'
          - '(?:в\s+)?голов'
          - 'вручную|руками'
          - 'никак|нигде|ничего'
      examples:
        valid:
          - value: "Excel"
            source: "всё в Excel ведём"
          - value: "1С"
            source: "используем 1С"
          - value: "в головах"
            source: "всё в головах держим"
        invalid:
          - value: "два-три человека"
            reason: "Это количество людей, не инструмент. Должно быть в company_size."
          - value: "5 сотрудников"
            reason: "Это количество людей, не инструмент"
          - value: "теряем клиентов"
            reason: "Это боль, не инструмент. Должно быть в pain_point."

    business_type:
      description: "Тип бизнеса или отрасль компании"
      type: enum
      spin_phase: situation
      validation:
        allowed_values:
          - "розничная торговля"
          - "оптовые продажи"
          - "общепит"
          - "сфера услуг"
          - "салон красоты"
          - "медицина"
          - "недвижимость"
          - "логистика"
          - "производство"
          - "IT"
          - "строительство"
          - "образование"
          - "другое"
        extract_patterns:
          - 'магазин|розни[цч]|ритейл'
          - 'опт(?:ов)?|b2b'
          - 'ресторан|кафе|общепит|еда'
          - 'услуг|сервис'
          - 'салон|красот|spa'
          - 'клиник|медицин|врач'
          - 'недвижим|риэлтор'
          - 'склад|логистик|доставк'
          - 'производств|завод|фабрик'
          - 'it|айти|программ|разработ'
          - 'строител|ремонт'
          - 'образован|обучен|курс'
      examples:
        valid:
          - value: "розничная торговля"
            source: "у нас магазин"
          - value: "общепит"
            source: "ресторан на 50 мест"
        invalid:
          - value: "большая компания"
            reason: "Это размер, не тип бизнеса"

    # =========================================================================
    # PROBLEM PHASE FIELDS
    # =========================================================================

    pain_point:
      description: "Бизнес-проблема или боль клиента (конкретная проблема, не инструмент)"
      type: str
      spin_phase: problem
      validation:
        # Категории болей для нормализации
        pain_categories:
          losing_clients:
            - 'теря[ею]м?\s*клиент'
            - 'клиент\w*\s*(?:ухо|уш[её]л)'
            - 'отток\w*\s*клиент'
            - 'упуска[ею]м?\s*(?:сделк|лид|клиент)'
          no_control:
            - 'нет\s*контрол'
            - 'не\s*вид[и|е][мт]'
            - 'не\s*понима[юем]'
            - 'чёрн\w*\s*ящик'
          manual_work:
            - 'ручн\w*\s*(?:работ|ввод|труд)'
            - 'excel|эксел'
            - 'всё\s*вручную'
            - 'рутин'
          manager_issues:
            - 'забыва[ею]т?\s*(?:перезвон|звон|задач)'
            - 'менеджер\w*\s*(?:не\s*)?(?:перезван|звон)'
            - 'менеджер\w*\s*(?:косяч|ошиба)'
          chaos:
            - 'хаос'
            - 'беспоряд|бардак'
            - 'разброс|раскидан'
        min_length: 3
      examples:
        valid:
          - value: "теряем клиентов"
            source: "постоянно теряем клиентов"
            category: "losing_clients"
          - value: "нет контроля"
            source: "не можем контролировать менеджеров"
            category: "no_control"
          - value: "много ручной работы"
            source: "всё делаем руками, очень долго"
            category: "manual_work"
        invalid:
          - value: "+7 999 123-45-67"
            reason: "Это контакт, не боль. Должно быть в contact_info."
          - value: "Excel"
            reason: "Это инструмент, не боль. Должно быть в current_tools."
          - value: "типа это бы помогло бы контролировать"
            reason: "Это желаемый результат, не боль. Должно быть в desired_outcome."

    pain_category:
      description: "Категория боли (одна из предопределённых)"
      type: enum
      spin_phase: problem
      validation:
        allowed_values:
          - "losing_clients"
          - "no_control"
          - "manual_work"
          - "manager_issues"
          - "chaos"
      examples:
        valid:
          - value: "losing_clients"
            source: "теряем клиентов из-за забывчивости"
        invalid:
          - value: "плохо"
            reason: "Неизвестная категория"

    # =========================================================================
    # IMPLICATION PHASE FIELDS
    # =========================================================================

    pain_impact:
      description: "Последствия проблемы для бизнеса (количественные или качественные)"
      type: str
      spin_phase: implication
      validation:
        # Паттерны для извлечения количественных данных
        quantitative_patterns:
          - '(\d+)\s*(?:клиент|покупател|заказ)\w*\s*(?:теря|упуска)'
          - '(\d+)\s*(?:час|минут)\w*\s*(?:в\s*день|ежедневно)'
          - '(\d+)\s*(?:тысяч|млн|%)'
        min_length: 3
      examples:
        valid:
          - value: "теряем ~5 клиентов в месяц"
            source: "примерно 5 клиентов в месяц уходят"
          - value: "тратим ~3 часа/день на рутину"
            source: "3 часа каждый день на ручную работу"
        invalid:
          - value: "плохо"
            reason: "Слишком абстрактно, нужна конкретика"

    financial_impact:
      description: "Финансовые потери (число в рублях)"
      type: str
      spin_phase: implication
      validation:
        extract_patterns:
          - '(\d+)\s*(?:тысяч|т\.?р\.?|к)\s*(?:руб|₽)?'
          - '(\d+)\s*(?:миллион|млн|м)\s*(?:руб|₽)?'
      examples:
        valid:
          - value: "100000"
            source: "теряем около 100 тысяч в месяц"
          - value: "1000000"
            source: "это примерно миллион в год"
        invalid:
          - value: "много"
            reason: "Нужна конкретная сумма"

    # =========================================================================
    # NEED-PAYOFF PHASE FIELDS
    # =========================================================================

    desired_outcome:
      description: "Желаемый результат от внедрения CRM (что хочет клиент)"
      type: str
      spin_phase: need_payoff
      validation:
        # Нормализованные outcomes
        normalized_outcomes:
          - "прозрачность и контроль"
          - "автоматизация процессов"
          - "контроль работы"
          - "экономия времени/денег"
          - "упрощение работы"
          - "систематизация"
          - "решение проблемы"
        extract_patterns:
          - '(?:хотел|хочу|хотим)\s*(?:бы\s*)?(?:видеть|знать|понима)'
          - '(?:хотел|хочу|хотим)\s*(?:бы\s*)?автоматиз'
          - '(?:хотел|хочу|хотим)\s*(?:бы\s*)?(?:контролир|отслежива)'
          - '(?:хотел|хочу|хотим)\s*(?:бы\s*)?(?:экономи|сберечь)'
          - '(?:помогло|решило|избавило)\s*(?:бы)?'
        min_length: 5
      examples:
        valid:
          - value: "прозрачность и контроль"
            source: "хотел бы видеть что происходит с клиентами"
          - value: "автоматизация процессов"
            source: "хочу автоматизировать рутину"
        invalid:
          - value: "да"
            reason: "Слишком коротко, нужно конкретное желание"
          - value: "+7 999 123-45-67"
            reason: "Это контакт, не желаемый результат"

    value_acknowledged:
      description: "Признал ли клиент ценность решения (да/нет)"
      type: bool
      spin_phase: need_payoff
      validation:
        # Паттерны подтверждения
        positive_patterns:
          - '^да[,!.]?\s*$'
          - '^конечно'
          - '^естественно'
          - 'было\s*бы\s*(?:здорово|отлично|супер)'
          - 'помогло\s*бы'
      examples:
        valid:
          - value: true
            source: "да, это было бы здорово"
          - value: false
            source: "не уверен"
        invalid:
          - value: "может быть"
            reason: "Должно быть true или false"

    # =========================================================================
    # CONTACT FIELDS (любая фаза)
    # =========================================================================

    contact_info:
      description: "Контактные данные: ТОЛЬКО телефон (+7...) или email (xxx@xxx.xx)"
      type: str
      spin_phase: null  # Может быть в любой фазе
      validation:
        # КРИТИЧНО: contact_info это ТОЛЬКО телефон или email!
        # НЕ записывать сюда текст, фразы, боли и т.д.
        patterns:
          phone:
            - '^\+7[\s\-\.]?\(?\d{3}\)?[\s\-\.]?\d{3}[\s\-\.]?\d{2}[\s\-\.]?\d{2}$'
            - '^8[\s\-\.]?\(?\d{3}\)?[\s\-\.]?\d{3}[\s\-\.]?\d{2}[\s\-\.]?\d{2}$'
          email:
            - '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        # Валидные мобильные префиксы (Россия)
        valid_phone_prefixes:
          - 900
          - 999  # Диапазон 900-999
        # Валидные городские коды
        valid_city_codes:
          - 495  # Москва
          - 499  # Москва
          - 812  # СПб
      examples:
        valid:
          - value: "+79991234567"
            source: "+7 999 123-45-67"
            type: "phone"
          - value: "user@example.com"
            source: "пишите на user@example.com"
            type: "email"
        invalid:
          - value: "теряем клиентов"
            reason: "Это боль, не контакт! Должно быть в pain_point."
          - value: "типа это бы помогло бы контролировать процесс"
            reason: "Это текст о процессе, не контакт! Должно быть в desired_outcome или ignored."
          - value: "два-три человека"
            reason: "Это количество людей, не контакт! Должно быть в company_size."
          - value: "да, интересно"
            reason: "Это согласие, не контакт!"

    contact_type:
      description: "Тип контакта (phone или email)"
      type: enum
      spin_phase: null
      validation:
        allowed_values:
          - "phone"
          - "email"

    # =========================================================================
    # SHARED FIELDS (used across MEDDIC/BANT/Sandler/NEAT/etc.)
    # =========================================================================

    decision_maker:
      description: "Лицо принимающее решение (ЛПР, руководитель, директор)"
      type: str
      spin_phase: authority
      validation:
        min_length: 2
      examples:
        valid:
          - { source: "Решение принимает директор", value: "директор" }
          - { source: "Я сам решаю", value: "клиент (сам принимает)" }
          - { source: "Нужно обсудить с руководством", value: "руководство" }
        invalid:
          - { value: "5 человек", reason: "Это company_size, не decision_maker" }
          - { value: "проблемы с учётом", reason: "Это pain_point" }

    budget_range:
      description: "Бюджет или ценовые ожидания клиента"
      type: str
      spin_phase: budget
      validation:
        min_length: 2
      examples:
        valid:
          - { source: "Бюджет около 500 тысяч", value: "~500 000 руб" }
          - { source: "До миллиона готовы", value: "до 1 000 000 руб" }
          - { source: "Пока не определились", value: "не определён" }
        invalid:
          - { value: "10 человек", reason: "Это company_size" }

    decision_timeline:
      description: "Сроки принятия решения (когда планируют внедрять)"
      type: str
      spin_phase: timeline
      validation:
        min_length: 2
      examples:
        valid:
          - { source: "До конца квартала хотим решить", value: "до конца квартала" }
          - { source: "В ближайший месяц", value: "1 месяц" }
          - { source: "Пока просто смотрим", value: "не определён" }
        invalid:
          - { value: "теряем клиентов", reason: "Это pain_point" }

    decision_criteria:
      description: "Критерии выбора решения (что важно при выборе)"
      type: str
      spin_phase: criteria
      validation:
        min_length: 2
      examples:
        valid:
          - { source: "Нам важна интеграция с 1С", value: "интеграция с 1С" }
          - { source: "Главное чтобы было простое", value: "простота использования" }
        invalid:
          - { value: "Excel", reason: "Это current_tools" }

    success_metrics:
      description: "Метрики успеха клиента (KPI, целевые показатели)"
      type: str
      spin_phase: metrics
      validation:
        min_length: 2
      examples:
        valid:
          - { source: "Хотим увеличить продажи на 20%", value: "рост продаж на 20%" }
          - { source: "Важно сократить потери клиентов", value: "сокращение оттока клиентов" }
        invalid:
          - { value: "10 менеджеров", reason: "Это company_size" }

    champion_info:
      description: "Внутренний чемпион — кто поддержит внедрение внутри компании"
      type: str
      spin_phase: champion
      validation:
        min_length: 2
      examples:
        valid:
          - { source: "Мария из отдела продаж будет вести", value: "Мария, отдел продаж" }
          - { source: "Я сам буду продвигать", value: "клиент (сам)" }
        invalid:
          - { value: "директор", reason: "Это decision_maker, не champion" }

    decision_process:
      description: "Процесс принятия решения (шаги, согласования)"
      type: str
      spin_phase: process
      validation:
        min_length: 2
      examples:
        valid:
          - { source: "Сначала тест, потом совет директоров", value: "тест → совет директоров" }
          - { source: "Я решу сам, без согласований", value: "без согласований" }
        invalid:
          - { value: "в течение месяца", reason: "Это decision_timeline" }

    # =========================================================================
    # AUTONOMOUS FLOW FIELDS
    # =========================================================================

    role:
      description: "Роль/должность контактного лица"
      type: str
      spin_phase: null
      validation:
        min_length: 2
      examples:
        valid:
          - { source: "Я руководитель отдела продаж", value: "руководитель отдела продаж" }
          - { source: "Я директор", value: "директор" }
        invalid:
          - { value: "5", reason: "Это число, не должность" }

    users_count:
      description: "Количество пользователей, которые будут работать с CRM"
      type: str
      spin_phase: null
      validation:
        min_length: 1
      examples:
        valid:
          - { source: "5 менеджеров будут работать", value: "5" }
          - { source: "Вся команда, человек 10", value: "10" }
        invalid:
          - { value: "теряем клиентов", reason: "Это боль, не количество пользователей" }

    urgency:
      description: "Срочность решения проблемы"
      type: enum
      spin_phase: null
      validation:
        allowed_values:
          - "high"
          - "medium"
          - "low"
      examples:
        valid:
          - { source: "Нам срочно нужно решение", value: "high" }
          - { source: "Не горит, но хотелось бы", value: "medium" }
        invalid:
          - { value: "Excel", reason: "Это инструмент, не срочность" }

  # =========================================================================
  # FIELD GROUPS BY SPIN PHASE
  # =========================================================================
  # Определяет какие поля ожидаются в какой фазе SPIN.
  # Используется для контекстной валидации.

  phase_fields:
    # Existing SPIN phases
    situation:
      - company_size
      - current_tools
      - business_type
    problem:
      - pain_point
      - pain_category
    implication:
      - pain_impact
      - financial_impact
    need_payoff:
      - desired_outcome
      - value_acknowledged
    any:
      - contact_info
      - contact_type

    # MEDDIC phases
    metrics:
      - success_metrics
      - company_size
      - business_type
    buyer:
      - decision_maker
    criteria:
      - decision_criteria
    process:
      - decision_process
    pain:
      - pain_point
      - pain_category
    champion:
      - champion_info

    # BANT phases
    budget:
      - budget_range
      - company_size
    authority:
      - decision_maker
    need:
      - pain_point
    timeline:
      - decision_timeline

    # Shared phases (used by multiple flows)
    discover:
      - company_size
      - current_tools
      - business_type
    interest:
      - company_size
      - business_type
    desire:
      - pain_point
      - desired_outcome
    features:
      - company_size
      - current_tools
    advantages:
      - pain_point
    benefits:
      - desired_outcome
    simple:
      - company_size
    align:
      - pain_point
    understand:
      - company_size
      - current_tools
    advise:
      - pain_point
    recommend:
      - desired_outcome
    quantify:
      - pain_impact
      - financial_impact
    engage:
      - company_size

    # Autonomous flow phases
    discovery:
      - business_type
      - company_size
      - current_tools
      - contact_info
      - role
    qualification:
      - company_size
      - budget_range
      - decision_maker
      - decision_timeline
      - users_count
      - contact_info
    presentation:
      - pain_point
      - desired_outcome
      - pain_category
      - urgency
      - contact_info
    objection_handling:
      - pain_point
      - pain_category
      - urgency
      - budget_range
      - contact_info
    negotiation:
      - budget_range
      - decision_timeline
      - users_count
      - contact_info
    closing:
      - contact_info
      - decision_timeline

  # =========================================================================
  # VALIDATION RULES
  # =========================================================================
  # Глобальные правила валидации для предотвращения ошибок LLM.

  validation_rules:
    # Правило 1: contact_info должен содержать только телефон или email
    contact_info_strict: true

    # Правило 2: current_tools не может содержать числа людей
    current_tools_no_people: true

    # Правило 3: pain_point не может быть контактом или инструментом
    pain_point_no_contacts: true

    # Правило 4: Пустой extracted_data лучше неправильного
    prefer_empty_over_wrong: true

    # Правило 5: Валидировать типы данных
    strict_types: true

  # =========================================================================
  # LLM PROMPT INSTRUCTIONS
  # =========================================================================
  # Инструкции для LLM промпта по извлечению данных.
  # Используется в classifier/llm/prompts.py

  prompt_instructions:
    header: |
      ## Правила извлечения данных (extracted_data)

      КРИТИЧНО: Заполняй extracted_data ТОЛЬКО если данные соответствуют полю!
      Пустой extracted_data лучше неправильного.

    field_rules: |
      ### Поля и правила:

      1. **company_size** (int): ТОЛЬКО число сотрудников
         - ✅ "5 человек" → company_size: 5
         - ❌ "два-три человека" в current_tools — НЕПРАВИЛЬНО!

      2. **current_tools** (str): ТОЛЬКО инструменты CRM/учёта
         - ✅ "в Excel", "1С", "в блокноте", "вручную"
         - ❌ "два-три человека" — это company_size!
         - ❌ "теряем клиентов" — это pain_point!

      3. **contact_info** (str): ТОЛЬКО телефон или email
         - ✅ "+7 999 123-45-67", "user@example.com"
         - ❌ "теряем клиентов" — это pain_point!
         - ❌ "типа это бы помогло контролировать" — это desired_outcome!
         - ❌ Любой текст без @ или +7/8 — НЕ контакт!

      4. **pain_point** (str): Бизнес-проблема клиента
         - ✅ "теряем клиентов", "нет контроля", "хаос"
         - ❌ "+7 999..." — это contact_info!
         - ❌ "Excel" — это current_tools!

      5. **desired_outcome** (str): Желаемый результат
         - ✅ "хочу контролировать", "автоматизировать"
         - ❌ Контакты, инструменты, боли

    examples: |
      ### Примеры правильного извлечения:

      Сообщение: "У нас 5 человек, всё в Excel, теряем клиентов"
      extracted_data:
        company_size: 5
        current_tools: "Excel"
        pain_point: "теряем клиентов"

      Сообщение: "Мой номер +7 999 123-45-67"
      extracted_data:
        contact_info: "+79991234567"

      Сообщение: "Да, это было бы здорово"
      extracted_data:
        value_acknowledged: true

      ### Примеры НЕПРАВИЛЬНОГО извлечения (НЕ ДЕЛАЙ ТАК!):

      ❌ "два-три человека" → current_tools (НЕПРАВИЛЬНО! Это company_size)
      ❌ "теряем клиентов" → contact_info (НЕПРАВИЛЬНО! Это pain_point)
      ❌ "типа это помогло бы" → contact_info (НЕПРАВИЛЬНО! Это desired_outcome)

# =============================================================================
# OBJECTION RETURN CONFIGURATION (Knowledge Source for Phase Preservation)
# =============================================================================
# Возврат к предыдущей фазе после успешной обработки возражения.
#
# ПРОБЛЕМА, которую решает:
#   Бот застревал в handle_objection без возврата к sales flow:
#   bant_budget → handle_objection → close (фаза потеряна!)
#
# РЕШЕНИЕ:
#   ObjectionReturnSource предлагает переход обратно к сохранённому состоянию:
#   bant_budget → handle_objection → bant_budget (фаза сохранена!)
#
# МЕХАНИЗМ:
#   1. При входе в handle_objection, orchestrator сохраняет prev_state
#   2. При позитивном intent (agreement, interest), этот source
#      предлагает переход обратно с HIGH приоритетом
#   3. HIGH > NORMAL, поэтому return-переход побеждает YAML-переходы
#
# Часть фундаментального исправления Objection Stuck Bug
# =============================================================================
objection_return:
  # Включить возврат к предыдущей фазе после objection handling
  enabled: true

  # Использовать POSITIVE_INTENTS как триггеры для возврата
  # Если true, используются intents.categories.positive из этого файла
  # Если false, можно задать кастомный список в return_intents
  use_positive_intents: true

  # Кастомный список интентов для возврата (используется если use_positive_intents: false)
  # По умолчанию пустой - используется POSITIVE_INTENTS
  return_intents: []

# =============================================================================
# FIRST CONTACT REFINEMENT CONFIGURATION (Single Source of Truth)
# =============================================================================
# Рефайнмент классификаций на первом ходу диалога (turn 0-2).
#
# Проблема: LLM классифицирует осторожный интерес как objection.
# Пример: "слушайте мне тут посоветовали... но я не уверен"
#         LLM возвращает objection_trust/objection_think → бот идёт в handle_objection
#         Ожидание: consultation_request → бот приветствует и начинает диалог
#
# Семантическое различие по turn_number:
#   turn=1: "не уверен" = скромность, осторожный интерес (хочу узнать больше)
#   turn>3: "не уверен" = сомнение в продукте после презентации (реальное возражение)
#
# Этот слой обрабатывает ТОЛЬКО первый случай (turn ≤ max_turn).
# =============================================================================
first_contact_refinement:
  # Включить рефайнмент первого контакта
  enabled: true

  # Максимальный номер хода для применения слоя
  # turn_number <= max_turn_number → слой применяется
  max_turn_number: 2

  # Состояния, в которых слой активен
  # Первый контакт обычно происходит в greeting
  active_states:
    - "greeting"
    - "initial"

  # Интенты, которые подозрительны на первом ходу и могут быть переклассифицированы
  # Objection на turn=1 в greeting — скорее всего неправильная классификация
  suspicious_intents:
    - "objection_think"
    - "objection_trust"
    - "objection_no_need"
    - "objection_risk"

  # Паттерны рекомендации (кто-то посоветовал обратиться)
  # Указывают на осторожный интерес, НЕ возражение
  referral_patterns:
    - "посоветовали"
    - "рекомендовали"
    - "сказали обратиться"
    - "направили"
    - "знакомый сказал"
    - "друг посоветовал"
    - "коллега рекомендовал"
    - "узнал от"
    - "услышал о вас"

  # Паттерны осторожного интереса (скромность, желание узнать)
  # На turn=1 это НЕ возражение, а просьба о консультации
  cautious_interest_patterns:
    - "не уверен"
    - "не уверена"
    - "хочу понять"
    - "хочу узнать"
    - "хочу разобраться"
    - "интересно узнать"
    - "подскажите"
    - "расскажите"
    - "можете рассказать"
    - "хотел бы узнать"
    - "хотела бы узнать"
    - "сомневаюсь"
    - "не знаю"
    - "пока не понимаю"

  # Паттерны первого контакта (приветствие + вопрос)
  first_contact_patterns:
    - "слушайте"
    - "здравствуйте"
    - "добрый день"
    - "привет"
    - "скажите"
    - "подскажите пожалуйста"

  # Целевой интент при рефайнменте
  # consultation_request = осторожная просьба о консультации
  target_intent: "consultation_request"

  # Confidence для refined результата
  refined_confidence: 0.75

# =============================================================================
# OBJECTION REFINEMENT CONFIGURATION (Single Source of Truth)
# =============================================================================
# Контекстная валидация и рефайнмент objection классификаций.
# Предотвращает ложноположительные objection детекции путём проверки:
# - Совпадения темы с последним вопросом бота
# - Наличия вопросительных маркеров в сообщении
# - Паттернов интереса vs реальных возражений
# - Порогов confidence
#
# Часть Phase 5: Objection Stuck Fix (OBJECTION_STUCK_FIX_PLAN.md)
# =============================================================================
objection_refinement:
  # Включить рефайнмент objection классификаций
  enabled: true

  # Минимальная confidence для принятия objection без дополнительной проверки
  # Если confidence >= этого порога И нет явных сигналов ложноположительного,
  # objection принимается как есть
  min_confidence_to_accept: 0.85

  # Паттерны, указывающие что это скорее ВОПРОС, а не возражение
  # Если сообщение содержит эти маркеры, objection переклассифицируется
  question_markers:
    - "?"
    - "какой"
    - "какая"
    - "какие"
    - "сколько"
    - "как"
    - "когда"
    - "где"
    - "почему"
    - "зачем"
    - "что"
    - "расскажите"
    - "покажите"
    - "объясните"

  # Паттерны callback_request, маскирующиеся под objection_no_time
  # "сейчас занят, позвоните завтра" → callback_request, НЕ objection_no_time
  callback_patterns:
    - "позвони"
    - "перезвони"
    - "напиши"
    - "свяжи"
    - "завтра"
    - "потом"
    - "позже"
    - "на неделе"
    - "через час"
    - "через день"
    - "вечером"
    - "утром"
    - "после обеда"

  # Паттерны интереса, маскирующиеся под objection_think
  # "подумать над предложением" → interest, НЕ objection_think
  interest_patterns:
    - "подумать над"
    - "подумаю о"
    - "подумаю над"
    - "обдумать"
    - "рассмотр"
    - "изучить"
    - "посмотреть"
    - "ознакомиться"
    - "пришлите"
    - "отправьте"
    - "скиньте"
    # Паттерны неуверенности (skeptic persona) - FIX for handle_objection stuck
    - "не уверен"
    - "не уверена"
    - "сомневаюсь"
    - "сомнева"
    - "не знаю"
    - "понять"
    - "разобраться"
    - "хочу понять"

  # Паттерны неуверенности, указывающие на implicit вопрос
  # "не уверен нужно ли" → скрытый вопрос, НЕ objection_think
  # FIX: Root Cause #2 - нет rule для "uncertainty → question"
  uncertainty_patterns:
    - "надо ли"
    - "нужно ли"
    - "стоит ли"
    - "а смысл"
    - "толк какой"
    - "зачем это"
    - "нужно это"
    - "надо это"
    - "в чём смысл"
    - "какой смысл"
    - "есть ли смысл"

  # Маппинг objection → альтернативный intent при рефайнменте
  # question_context: intent если сообщение похоже на вопрос
  # info_context: intent если сообщение — ответ на вопрос бота
  refinement_mapping:
    objection_price:
      question_context: price_question
      info_context: info_provided
    objection_no_time:
      callback_context: callback_request
      schedule_context: consultation_request
    objection_think:
      interest_context: agreement
      question_context: question_features
      uncertainty_context: question_features  # "не уверен нужно ли" → question
    objection_competitor:
      question_context: comparison
      info_context: info_provided
    objection_complexity:
      question_context: question_implementation
      info_context: info_provided
    objection_timing:
      callback_context: callback_request
      info_context: info_provided

  # Действия бота, после которых ответ на ту же тему НЕ возражение
  # Если бот спросил о бюджете и клиент упомянул бюджет — это ответ, не возражение
  topic_alignment_actions:
    budget:
      - ask_about_budget
      - ask_pricing_context
      - discuss_pricing
      - answer_with_facts
      - answer_with_price_range
    time:
      - ask_about_timeline
      - schedule_demo
      - ask_availability
      - ask_for_callback
    competitor:
      - ask_about_current_tools
      - compare_features
      - ask_about_experience
    complexity:
      - ask_about_team_size
      - ask_about_implementation
      - discuss_onboarding

  # Cooldown настройки — предотвращение спама возражений
  cooldown:
    # Минимум ходов между любыми возражениями
    min_turns_between_objections: 2
    # Минимум ходов между одинаковыми типами возражений
    min_turns_same_type: 3

# =============================================================================
# COMPOSITE MESSAGE REFINEMENT CONFIGURATION (Single Source of Truth)
# =============================================================================
# Контекстно-зависимый рефайнмент для составных сообщений.
# Предотвращает ошибочную классификацию сообщений типа
# "5 человек, больше не нужно, быстрее" как objection_think.
#
# Ключевой принцип: когда бот задал вопрос о данных и пользователь ответил
# с извлекаемыми данными, приоритет отдаётся data intent над meta-intents.
#
# Архитектура (UNIVERSAL - работает с любым flow):
#   - Работает с SPIN, BANT, custom flows или любой структурой диалога
#   - Основной механизм: action_expects_data (действие бота → ожидаемый тип данных)
#   - Fallback: data_expecting_states, data_expecting_phases
#   - Fail-safe: возвращает оригинальный результат при любой ошибке
#
# Pipeline позиция:
#   message → LLM/Hybrid → ClassificationRefinement → CompositeMessageRefinement →
#   → ObjectionRefinement → DisambiguationLayer → result
# =============================================================================
composite_refinement:
  # Включить рефайнмент составных сообщений
  enabled: true

  # Минимальная confidence для refined результата
  min_confidence_for_refinement: 0.75

  # Default intent когда данные извлечены в data-expecting контексте
  default_data_intent: info_provided

  # =========================================================================
  # ACTION → EXPECTED DATA TYPE MAPPING (Primary Mechanism)
  # =========================================================================
  # Маппинг: действие бота → какой тип данных ожидаем в ответе
  # Это основной механизм для определения контекста.
  # Работает с любым flow, не только SPIN.
  action_expects_data:
    # Вопросы о компании/команде
    ask_about_company: company_size
    ask_about_team_size: company_size
    ask_situation: company_size
    transition_to_spin_situation: company_size

    # Вопросы об инструментах
    ask_about_current_tools: current_tools

    # Вопросы о проблемах
    ask_about_problem: pain_point
    ask_problem: pain_point
    transition_to_spin_problem: pain_point

    # Вопросы о влиянии/последствиях
    ask_about_impact: pain_impact
    ask_implication: pain_impact
    transition_to_spin_implication: pain_impact

    # Вопросы о желаемом результате
    ask_about_outcome: desired_outcome
    ask_need_payoff: desired_outcome
    transition_to_spin_need_payoff: desired_outcome

    # Общие вопросы о данных
    ask_for_clarification: any
    clarify_one_question: any
    continue_current_goal: any

    # answer_with_pricing template asks "Сколько сотрудников?",
    # so next user message in this context may contain company_size
    answer_with_pricing: company_size

  # =========================================================================
  # ACTION → TARGET INTENT MAPPING
  # =========================================================================
  # Маппинг: действие бота → какой intent использовать при успешной экстракции
  action_data_intent:
    # Situation-related actions → situation_provided
    ask_about_company: situation_provided
    ask_about_team_size: situation_provided
    ask_situation: situation_provided
    transition_to_spin_situation: situation_provided
    ask_about_current_tools: situation_provided

    # Problem-related actions → problem_revealed
    ask_about_problem: problem_revealed
    ask_problem: problem_revealed
    transition_to_spin_problem: problem_revealed

    # Implication-related actions → implication_acknowledged
    ask_about_impact: implication_acknowledged
    ask_implication: implication_acknowledged
    transition_to_spin_implication: implication_acknowledged

    # Need-payoff-related actions → need_expressed
    ask_about_outcome: need_expressed
    ask_need_payoff: need_expressed
    transition_to_spin_need_payoff: need_expressed

    # Default for other data-collecting actions
    ask_for_clarification: info_provided
    clarify_one_question: info_provided
    continue_current_goal: info_provided

    # CRITICAL — map to price_question, NOT info_provided.
    # This PRESERVES the intent so price template selection still fires.
    # Without this, CompositeMessageLayer would change price_question → info_provided,
    # breaking the entire price response chain.
    answer_with_pricing: price_question

  # =========================================================================
  # DATA EXPECTING STATES (Fallback for state-based detection)
  # =========================================================================
  # Состояния, в которых мы ожидаем данные от пользователя
  data_expecting_states:
    - spin_situation
    - spin_problem
    - spin_implication
    - spin_need_payoff
    - data_collection
    - qualification
    - discovery

  # =========================================================================
  # DATA EXPECTING PHASES (Fallback for phase-based detection)
  # =========================================================================
  # Фазы диалога, в которых мы ожидаем данные
  # Поддерживает SPIN, BANT и custom flows
  data_expecting_phases:
    # SPIN phases
    - situation
    - problem
    - implication
    - need_payoff
    # BANT phases
    - budget
    - authority
    - need
    - timeline
    # Generic phases
    - data_collection
    - qualification
    - discovery

  # =========================================================================
  # DATA FIELDS CONFIGURATION
  # =========================================================================
  # Конфигурация полей данных для извлечения
  data_fields:
    company_size:
      type: int
      min: 1
      max: 10000
      extract_patterns:
        - '(\d+)\s*(?:человек|чел\.?|сотрудник|менеджер|продавец|официант)'
        - '(?:нас|у нас)\s*(\d+)'
        - '(?:команда?|штат[еа]?)\s*(?:из|в|на)?\s*(\d+)'
        - '^(\d+)\s*[,.]'
        - '^(\d+)$'

    current_tools:
      type: enum
      allowed_values:
        - "Excel"
        - "Google Таблицы"
        - "1С"
        - "Битрикс24"
        - "AmoCRM"
        - "вручную"
        - "на бумаге"
        - "в головах"
        - "никак"
      extract_patterns:
        - '(?:в\s+)?excel'
        - '(?:в\s+)?эксел'
        - '(?:в\s+)?1[сc]'
        - '(?:в\s+)?битрикс'
        - '(?:в\s+)?амо'
        - 'вручную|руками'
        - '(?:на\s+)?бумаг'
        - '(?:в\s+)?голов'
        - 'никак|нигде'

  # =========================================================================
  # META SIGNALS CONFIGURATION
  # =========================================================================
  # Мета-сигналы которые НЕ являются основным интентом, но полезны
  meta_signals:
    request_brevity:
      patterns:
        - 'быстр'
        - 'коротк'
        - 'кратк'
        - 'без лишн'
        - 'по делу'
        - 'короче'
        - 'покороче'
      intent_hint: request_brevity

    impatience:
      patterns:
        - 'давай'
        - 'давайте'
        - 'скорее'
        - 'уже'
        - 'побыстр'
      intent_hint: impatience_expression

    confirmation:
      patterns:
        - '^да[,.]?\s'
        - '^ок[,.]?\s'
        - '^хорошо[,.]?\s'
        - '^ладно[,.]?\s'
      intent_hint: agreement

  # =========================================================================
  # AMBIGUOUS PATTERNS CONFIGURATION
  # =========================================================================
  # Амбигуозные фразы, которые требуют контекстного разрешения
  ambiguous_patterns:
    bolshe_ne_nuzhno:
      # "больше не нужно" может означать:
      # - "достаточно" (quantity clarification) - после вопроса о количестве
      # - "не нужно вообще" (rejection) - в другом контексте
      patterns:
        - 'больше\s+не\s+(?:нужно|надо)'
        - 'не\s+нужно\s+больше'
        - 'хватит'
        - 'достаточно'
      # Действия, при которых это → data response (quantity clarification)
      data_resolving_actions:
        - ask_about_company
        - ask_about_team_size
        - ask_situation
        - ask_for_clarification
        - clarify_one_question
      # Действия, при которых это → rejection
      rejection_resolving_actions:
        - offer_demo
        - ask_for_contact
        - transition_to_close
        - propose_next_steps

    ne_interesno:
      patterns:
        - 'не\s+интересно'
        - 'не\s+интересует'
      # Обычно rejection, но после демо может быть feedback
      data_resolving_actions:
        - show_feature
        - demonstrate_product
      rejection_resolving_actions:
        - offer_demo
        - ask_for_contact
        - transition_to_presentation

    poka_ne:
      # "пока не знаю/готов" - может быть hesitation или info
      patterns:
        - 'пока\s+не\s+(?:знаю|готов|решил)'
        - 'пока\s+не\s+могу\s+сказать'
      data_resolving_actions:
        - ask_about_budget
        - ask_about_timeline
        - ask_about_decision
      rejection_resolving_actions:
        - ask_for_commitment
        - transition_to_close

# =============================================================================
# REFINEMENT PIPELINE CONFIGURATION (Single Source of Truth)
# =============================================================================
# Универсальная архитектура Refinement Pipeline для post-classification refinement.
# Все слои рефайнмента управляются через этот конфиг.
#
# Архитектура:
#   message → Classifier → RefinementPipeline → [Layer1] → [Layer2] → ... → result
#
# Слои выполняются в порядке приоритета (highest first).
# Каждый слой может уточнить intent, confidence, extracted_data.
# При ошибке слоя pipeline продолжает работу (fail-safe).
#
# SSoT: src/classifier/refinement_pipeline.py
# =============================================================================
refinement_pipeline:
  # Master switch для всего pipeline
  enabled: true

  # Список слоёв в порядке выполнения
  # Каждый слой должен быть зарегистрирован в RefinementLayerRegistry
  # priority: CRITICAL (100) → HIGH (75) → NORMAL (50) → LOW (25) → FALLBACK (0)
  layers:
    # Слой -1: Disambiguation Resolution (CRITICAL priority)
    # Обрабатывает ответы пользователя ("1", "2", "первое") на меню disambiguation.
    # Должен идти ДО confidence_calibration — если resolved, калибровка не нужна.
    - name: disambiguation_resolution
      enabled: true
      priority: CRITICAL
      feature_flag: unified_disambiguation

    # Слой 0: Confidence Calibration (CRITICAL priority)
    # Калибрует confidence ПЕРЕД другими слоями
    # Решает проблему overconfident LLM (0.85-0.95 при неверной классификации)
    - name: confidence_calibration
      enabled: true
      priority: CRITICAL  # 100 - runs first
      feature_flag: confidence_calibration

    # Слой 1: Secondary Intent Detection (Lost Question Fix)
    # FIX: Детектирует вторичные интенты (вопросы) в составных сообщениях
    # Решает проблему потери вопросов при классификации "100 человек. Сколько стоит?"
    - name: secondary_intent_detection
      enabled: true
      priority: HIGH  # 75 - runs early, after confidence calibration
      feature_flag: secondary_intent_detection

    # Слой 2: Short Answer Refinement (State Loop Fix)
    # Уточняет короткие ответы типа "1", "да", "первое"
    - name: short_answer
      enabled: true
      priority: HIGH  # 75
      feature_flag: classification_refinement

    # Слой 3: Composite Message Refinement
    # Обрабатывает составные сообщения "5 человек, больше не нужно, быстрее"
    - name: composite_message
      enabled: true
      priority: HIGH  # 75
      feature_flag: composite_refinement

    # Слой 4: Objection Refinement (Objection Stuck Fix)
    # Валидирует objection классификации
    - name: objection
      enabled: true
      priority: NORMAL  # 50
      feature_flag: objection_refinement

    # Слой 5: Option Selection Refinement (Disambiguation Assist Fix)
    # Обрабатывает короткие ответы ("1", "2", "первое") на вопросы с вариантами
    # FIX: Решает проблему когда бот задаёт вопрос "скорость или функционал?"
    # и клиент отвечает "1" - LLM неверно классифицирует как request_brevity
    - name: option_selection
      enabled: true
      priority: HIGH  # 75 - runs before objection refinement
      feature_flag: option_selection_refinement

    # Слой 6: Data-Aware Refinement (Stall Prevention Layer 1)
    # Promotes 'unclear' → 'info_provided' when DataExtractor found meaningful data
    # Defense-in-depth: catches cases where patterns miss but DataExtractor succeeds
    - name: data_aware
      enabled: true
      priority: NORMAL  # 50 - runs after pattern-based layers
      feature_flag: data_aware_refinement

  # Глобальные настройки pipeline
  settings:
    # Логировать каждое решение слоя
    verbose_logging: false

    # Максимальное время на весь pipeline (ms)
    max_pipeline_time_ms: 100

    # Продолжать при ошибке слоя
    continue_on_error: true

# =============================================================================
# OPTION SELECTION REFINEMENT (Disambiguation Assist Fix)
# =============================================================================
# Архитектурное решение проблемы "выбора варианта":
# - Бот задаёт вопрос с вариантами: "скорость или функционал?"
# - Клиент отвечает "1" или "первое"
# - LLM неверно классифицирует как request_brevity (0.9)
# - Этот слой детектирует паттерн и рефайнит к info_provided
#
# Research basis:
# - Grice's Cooperative Principle: short answers carry implicature of answering
# - Conversational repair: numeric responses to binary questions = selections
#
# SSoT: src/classifier/refinement_layers.py (OptionSelectionRefinementLayer)
# =============================================================================
option_selection_refinement:
  # Master switch
  enabled: true

  # Target intent when option selection detected
  target_intent: info_provided

  # Confidence for refined result
  refined_confidence: 0.75

  # Secondary signal added to result
  secondary_signal: option_selection

  # Паттерны для детекции вопросов с вариантами в сообщении бота
  option_question_patterns:
    - "(.+?)\\s+или\\s+(.+?)\\?"  # "X или Y?"
    - "что\\s+(?:для\\s+вас\\s+)?(?:важн|приоритетн|лучше)"  # Priority questions
    - "(?:вам|вас)\\s+(?:важн|интересн|нужн)"  # "Вам важнее..."
    - "(?:выбер|предпочт)"  # "Выберите" / "Предпочитаете"

  # Паттерны для детекции ответов-выборов
  selection_answer_patterns:
    - "^1$"  # Just "1"
    - "^2$"  # Just "2"
    - "^3$"  # Just "3"
    - "^перв"  # "первое", "первый"
    - "^втор"  # "второе", "второй"
    - "^трет"  # "третье", "третий"
    - "^один$"
    - "^два$"
    - "^три$"

  # Интенты, которые подозрительны при ответе на вопрос с вариантами
  suspicious_intents:
    - request_brevity  # Main culprit
    - greeting
    - unclear
    - small_talk
    - gratitude
    - objection_no_time

# =============================================================================
# SECONDARY INTENT DETECTION (Lost Question Fix)
# =============================================================================
# Архитектурное решение проблемы "потерянных вопросов":
# - Когда пользователь отправляет "100 человек. Сколько стоит?",
#   LLM выбирает info_provided как primary intent
# - Вопрос о цене ТЕРЯЕТСЯ
# - Этот слой детектирует вторичные интенты и сохраняет их как metadata
# - FactQuestionSource затем может ответить на вопрос
#
# SSoT: src/classifier/secondary_intent_detection.py
# =============================================================================
secondary_intent_detection:
  # Master switch
  enabled: true

  # Минимальная длина сообщения для детекции (короткие маловероятно composite)
  min_message_length: 10

  # Паттерны для детекции вторичных интентов
  # Каждый паттерн: intent -> {patterns, keywords, min_confidence, priority}
  # Высокий priority = проверяется первым
  #
  # РАСШИРЕННЫЙ НАБОР: покрывает максимум вариаций русского языка
  patterns:
    # =========================================================================
    # ЦЕНОВЫЕ ВОПРОСЫ (высший приоритет - часто теряются)
    # =========================================================================
    price_question:
      enabled: true
      priority: 100
      min_confidence: 0.9
      patterns:
        # Прямые вопросы о цене
        - "сколько\\s+стоит"
        - "сколько\\s+(?:это|оно|всё)\\s+стоит"
        - "сколько\\s+будет\\s+стоить"
        - "сколько\\s+(?:это|оно)\\s+будет\\s+стоить"
        - "почём"
        - "по\\s+чём"
        - "какая\\s+цена"
        - "какие\\s+цены"
        - "какова\\s+цена"
        - "какова\\s+стоимость"
        - "какая\\s+стоимость"
        - "во\\s+сколько\\s+обойд[её]тся"
        - "во\\s+сколько\\s+(?:это|мне)\\s+обойд[её]тся"
        - "во\\s+что\\s+обойд[её]тся"
        # Тарифы и прайс
        - "прайс"
        - "прайс-лист"
        - "price"
        - "тариф[ыа]?\\b"
        - "тарифн[ыа][яе]"
        - "расценк[иа]"
        - "ценник"
        # Вопросы о стоимости
        - "стоимость"
        - "по\\s+цен[еам]"
        - "цен[ау]\\s+скаж"
        - "скаж[иу](?:те)?\\s+цен[у|ы]"
        - "назов[иу](?:те)?\\s+цен[у|ы]"
        - "озвуч[иу](?:те)?\\s+цен[уы]"
        # Бюджет
        - "бюджет\\s+какой"
        - "какой\\s+бюджет"
        - "в\\s+какой\\s+бюджет"
        - "какой\\s+(?:будет\\s+)?бюджет"
        - "уложиться\\s+в\\s+бюджет"
        # Требования перейти к цене
        - "давай(?:те)?\\s+(?:уже\\s+)?(?:по\\s+)?(?:цене|ценам|стоимости)"
        - "говорите\\s+(?:уже\\s+)?цен[уы]"
        - "переходи(?:те)?\\s+к\\s+цен"
        - "хватит\\s+(?:уже\\s+)?(?:болтать|говорить)[,.]?\\s*(?:сколько|цен)"
        # Косвенные вопросы
        - "денег\\s+(?:это\\s+)?сколько"
        - "сколько\\s+денег"
        - "сколько\\s+(?:нужно\\s+)?заплатить"
        - "(?:сумма|сумму)\\s+скаж"
        - "какая\\s+сумма"
        - "что\\s+по\\s+деньгам"
        - "как\\s+по\\s+деньгам"
        # Платежи и оплата
        - "сколько\\s+платить"
        - "как\\s+(?:много\\s+)?платить"
        - "ежемесячн[аоы][яе]?\\s+плат[ёе]ж"
        - "месячн[аоы][яе]?\\s+оплат"
        - "абонент(?:ская|скую)?\\s+плат"
        - "подписк[ау]\\s+стоит"
        - "стоимость\\s+подписки"
        # Скидки и акции (связаны с ценой)
        - "ест[ьь]\\s+(?:какие[--]?(?:то|нибудь)\\s+)?скидк[иа]"
        - "какие\\s+скидки"
        - "дадите\\s+скидк[у|у]"
        - "скинете\\s+(?:что[--]то|немного)"
        - "акции\\s+(?:есть|какие)"
        - "спец(?:иальное)?\\s+предложение"
      keywords:
        - цена
        - цену
        - цены
        - ценой
        - ценам
        - ценами
        - ценник
        - стоит
        - стоить
        - стоимость
        - стоимости
        - прайс
        - тариф
        - тарифы
        - тарифа
        - тарифный
        - расценки
        - расценка
        - почём
        - почем
        - бюджет
        - денег
        - деньги
        - платить
        - оплата
        - оплатить
        - заплатить
        - сумма
        - сумму
        - абонентская
        - подписка
        - скидка
        - скидки
        - акция
        - акции

    # =========================================================================
    # ДЕМО/ПОКАЗ (сигналы закрытия - важно не потерять)
    # =========================================================================
    demo_request:
      enabled: true
      priority: 95
      min_confidence: 0.9
      patterns:
        # Демонстрация
        - "(?:покажите|показать)\\s+(?:как|демо|систему|программу)"
        - "(?:покажите|показать)\\s+(?:мне|нам)"
        - "можно\\s+(?:посмотреть|увидеть|глянуть)"
        - "хочу\\s+(?:посмотреть|увидеть|глянуть)"
        - "демонстраци[яию]"
        - "демо[--]?версия"
        - "демо\\s+(?:покажите|давайте|хочу)"
        # Пробный период
        - "попробовать"
        - "можно\\s+попробовать"
        - "хочу\\s+попробовать"
        - "дайте\\s+попробовать"
        - "тест(?:овый|ировать|овая)"
        - "тестовый\\s+(?:период|доступ|аккаунт)"
        - "тестовую\\s+версию"
        - "пробн(?:ый|ая|ую|ое)"
        - "пробный\\s+(?:период|доступ)"
        - "пробную\\s+версию"
        - "триал"
        - "trial"
        - "бесплатн(?:ый|ая|о)\\s+(?:период|доступ|попробовать)"
        # Посмотреть в действии
        - "в\\s+действии"
        - "(?:как|где)\\s+(?:это\\s+)?работает"
        - "увидеть\\s+(?:как|в\\s+работе)"
        - "онлайн[--]?демо"
        - "живой\\s+показ"
        - "презентаци[яию]"
      keywords:
        - демо
        - демонстрация
        - показать
        - покажите
        - покажи
        - посмотреть
        - попробовать
        - тестовый
        - тестовая
        - пробный
        - пробная
        - триал
        - trial
        - презентация
        - глянуть
        - увидеть

    # =========================================================================
    # CALLBACK/ЗВОНОК (сигналы закрытия)
    # =========================================================================
    callback_request:
      enabled: true
      priority: 95
      min_confidence: 0.9
      patterns:
        # Перезвон
        - "перезвон(?:ите|ить|и)"
        - "можете\\s+перезвонить"
        - "позвон(?:ите|ить|и)"
        - "можете\\s+позвонить"
        - "наберите\\s+(?:меня|мне)"
        # Связаться
        - "свяж(?:итесь|усь)"
        - "(?:можете|могу)\\s+(?:связаться|созвониться)"
        - "как\\s+(?:с\\s+вами\\s+)?связаться"
        - "хочу\\s+(?:связаться|созвониться|поговорить)"
        # Контакты
        - "(?:ваш[иа]?|оставить|дать)\\s+(?:номер|телефон|контакт)"
        - "контакт(?:ы|ный)"
        - "номер\\s+телефон"
        - "телефон\\s+(?:ваш|для\\s+связи)"
        # Менеджер
        - "(?:соедините|переключите)\\s+(?:с\\s+)?менеджер"
        - "(?:позовите|дайте)\\s+менеджера"
        - "(?:хочу|могу)\\s+(?:поговорить\\s+)?с\\s+менеджером"
        - "живой\\s+(?:человек|оператор|менеджер)"
        - "(?:с\\s+)?человеком\\s+(?:поговорить|пообщаться)"
        # Консультация
        - "(?:нужна|хочу)\\s+консультаци[яию]"
        - "проконсультир(?:уйте|овать)"
        - "(?:записаться|запишите)\\s+на\\s+(?:консультацию|встречу|звонок)"
      keywords:
        - перезвоните
        - перезвонить
        - позвоните
        - позвонить
        - звонок
        - свяжитесь
        - связаться
        - созвониться
        - контакт
        - контакты
        - телефон
        - номер
        - менеджер
        - оператор
        - консультация
        - консультант
        - человек

    # =========================================================================
    # ВОПРОСЫ О ФУНКЦИЯХ/ВОЗМОЖНОСТЯХ
    # =========================================================================
    question_features:
      enabled: true
      priority: 80
      min_confidence: 0.85
      patterns:
        # Прямые вопросы о функциях
        - "какие\\s+функци[ияй]"
        - "какой\\s+функционал"
        - "что\\s+(?:может|умеет|делает)"
        - "что\\s+(?:она|оно|система|программа)\\s+(?:может|умеет)"
        - "(?:какие\\s+)?возможност[иь]"
        - "какие\\s+(?:есть\\s+)?возможности"
        - "есть\\s+(?:ли\\s+)?(?:функция|возможность)"
        # Описание работы
        - "как\\s+(?:это\\s+)?работает"
        - "как\\s+(?:система|программа)\\s+работает"
        - "как\\s+устроен[оа]?"
        - "(?:расскажите|объясните)\\s+(?:про|о|об)"
        - "(?:расскажите|объясните)\\s+(?:как|что)"
        - "что\\s+(?:система|программа)\\s+умеет"
        - "что\\s+(?:входит|включено)"
        - "что\\s+включает"
        # Фичи и опции
        - "фич[иа]"
        - "(?:какие\\s+)?опции"
        - "дополнительн(?:ые|ых)\\s+(?:функции|возможности|опции)"
        - "(?:основные|главные)\\s+(?:функции|возможности)"
        - "(?:полный|весь)\\s+(?:функционал|набор)"
        # Модули
        - "(?:какие\\s+)?модул[иья]"
        - "(?:есть\\s+)?модуль\\s+(?:для|по)"
        - "(?:входит|включён)\\s+(?:ли\\s+)?модуль"
        # Сравнение возможностей
        - "чем\\s+(?:это\\s+)?(?:лучше|отличается)"
        - "(?:преимуществ[аоы]|плюс[ыа])"
        - "почему\\s+(?:вас|вы|это)"
      keywords:
        - функции
        - функция
        - функционал
        - возможности
        - возможность
        - умеет
        - может
        - работает
        - какие
        - фичи
        - опции
        - опция
        - модуль
        - модули
        - расскажите
        - объясните
        - преимущества
        - плюсы
        - включает
        - входит

    # =========================================================================
    # ВОПРОСЫ ОБ ИНТЕГРАЦИЯХ
    # =========================================================================
    question_integrations:
      enabled: true
      priority: 70
      min_confidence: 0.85
      patterns:
        # Общие интеграции
        - "интеграци[яию]"
        - "интегрир(?:уется|оваться|овать)"
        - "(?:какие\\s+)?интеграции\\s+(?:есть|поддерживаете)"
        - "(?:есть\\s+)?интеграция\\s+(?:с|для)"
        - "подключ(?:ить|ение|ается|ена)"
        - "синхрониз(?:ация|ировать|ируется)"
        - "совместим(?:ость|о|а)\\s+(?:с|для)"
        - "(?:работает|совместима?)\\s+(?:с|вместе)"
        # API
        - "api\\b"
        - "апи\\b"
        - "(?:есть\\s+)?(?:открытый|публичный)\\s+api"
        - "(?:доступ\\s+)?(?:к|через)\\s+api"
        # Конкретные интеграции: Kaspi
        - "касп[иы]"
        - "kaspi"
        - "каспи\\s+(?:qr|пей|pay)"
        - "интеграция\\s+(?:с\\s+)?каспи"
        - "(?:подключить|есть)\\s+каспи"
        # Конкретные интеграции: 1C
        - "1с\\b"
        - "1c\\b"
        - "одинэс"
        - "один\\s*эс"
        - "интеграция\\s+(?:с\\s+)?1[сc]"
        - "(?:выгрузка|загрузка|синхронизация)\\s+(?:в|из|с)\\s+1[сc]"
        - "(?:обмен|связь)\\s+(?:с\\s+)?1[сc]"
        # Другие системы
        - "(?:excel|эксель|экселем)"
        - "(?:google|гугл)\\s+(?:sheets|таблиц)"
        - "телегр(?:ам|амм)"
        - "telegram"
        - "whatsapp"
        - "(?:bitrix|битрикс)"
        - "(?:amocrm|амо)"
        - "iiko"
        - "poster"
        - "r[--]?keeper"
        # Оборудование
        - "(?:подключить|работает)\\s+(?:с\\s+)?(?:принтер|сканер|весы|терминал)"
        - "(?:совместимость|совместим)\\s+(?:с\\s+)?оборудовани"
      keywords:
        - интеграция
        - интеграции
        - интегрируется
        - подключить
        - подключение
        - подключается
        - синхронизация
        - синхронизировать
        - совместимость
        - совместим
        - каспи
        - kaspi
        - 1с
        - 1c
        - одинэс
        - api
        - апи
        - excel
        - эксель
        - google
        - гугл
        - телеграм
        - telegram
        - whatsapp
        - битрикс
        - bitrix
        - iiko
        - poster
        - выгрузка
        - загрузка
        - обмен

    # =========================================================================
    # ВОПРОСЫ О ТЕХПОДДЕРЖКЕ
    # =========================================================================
    question_support:
      enabled: true
      priority: 65
      min_confidence: 0.85
      patterns:
        # Поддержка
        - "(?:какая|есть\\s+ли)\\s+(?:тех)?поддержк"
        - "(?:как\\s+)?(?:работает|устроена)\\s+поддержк"
        - "(?:служба|отдел)\\s+поддержки"
        - "(?:куда|кому)\\s+(?:обращаться|писать|звонить)"
        - "(?:как|где)\\s+получить\\s+(?:помощь|поддержку)"
        # Обучение
        - "(?:есть\\s+ли|какое)\\s+обучение"
        - "(?:обучите|научите)\\s+(?:нас|персонал|сотрудников)"
        - "(?:как\\s+)?(?:обучить|научить)\\s+(?:персонал|сотрудников)"
        - "(?:инструкции|документация|мануал)"
        - "(?:видео[--]?)?(?:уроки|курсы|туториал)"
        # Время работы
        - "(?:круглосуточн|24[/\\s]?7|двадцать\\s+четыре)"
        - "(?:время|часы)\\s+работы\\s+(?:поддержки|техподдержки)"
        - "(?:как\\s+быстро|за\\s+сколько)\\s+отвечаете"
        - "(?:скорость|время)\\s+ответа"
        # Гарантии
        - "(?:какие\\s+)?гарантии"
        - "(?:что|как)\\s+(?:если|когда)\\s+(?:сломается|не\\s+работает)"
      keywords:
        - поддержка
        - техподдержка
        - саппорт
        - support
        - помощь
        - обучение
        - научить
        - обучить
        - инструкция
        - инструкции
        - документация
        - мануал
        - туториал
        - уроки
        - курсы
        - гарантия
        - гарантии
        - круглосуточно

    # =========================================================================
    # ВОПРОСЫ ОБ ОБОРУДОВАНИИ
    # =========================================================================
    question_equipment:
      enabled: true
      priority: 65
      min_confidence: 0.85
      patterns:
        # Общие вопросы
        - "(?:какое|нужно\\s+ли)\\s+оборудовани"
        - "(?:список|перечень)\\s+оборудовани"
        - "что\\s+(?:нужно|требуется)\\s+(?:из\\s+)?оборудовани"
        - "(?:минимальн|необходим)[оеы][еы]?\\s+оборудовани"
        # Кассы и POS
        - "(?:какую|нужна\\s+ли)\\s+касс[ау]"
        - "(?:pos|пос)[--]?(?:терминал|система|оборудование)"
        - "(?:кассов(?:ый|ое|ая)|pos)\\s+(?:аппарат|оборудование)"
        - "моноблок"
        # Терминалы
        - "(?:банк(?:овский)?|платёжный|платежный)\\s+терминал"
        - "(?:терминал|эквайринг)\\s+(?:для\\s+)?(?:оплаты|карт)"
        # Принтеры
        - "(?:чеков(?:ый)?|фискальный)\\s+принтер"
        - "принтер\\s+(?:чеков|этикеток)"
        - "(?:нужен\\s+ли|какой)\\s+принтер"
        # Сканеры
        - "(?:штрих[--]?код(?:ов(?:ый)?)?|qr)\\s+сканер"
        - "сканер\\s+(?:штрих[--]?код|qr)"
        - "(?:нужен\\s+ли|какой)\\s+сканер"
        # Весы
        - "(?:торгов(?:ые|ых)|электронн(?:ые|ых))\\s+вес(?:ы|ов)"
        - "вес(?:ы|ов)\\s+(?:для\\s+)?(?:магазина|товаров)"
        - "(?:нужны\\s+ли|какие)\\s+весы"
        # Требования
        - "(?:системные|технические)\\s+требовани"
        - "(?:на\\s+каком|какое)\\s+(?:устройстве|железо)"
        - "(?:на\\s+чём|где)\\s+(?:будет\\s+)?работать"
        - "(?:планшет|телефон|компьютер|ноутбук)"
        - "(?:android|ios|windows)"
      keywords:
        - оборудование
        - касса
        - кассы
        - pos
        - пос
        - терминал
        - терминалы
        - моноблок
        - принтер
        - принтеры
        - сканер
        - сканеры
        - весы
        - эквайринг
        - планшет
        - телефон
        - компьютер
        - ноутбук
        - android
        - ios
        - windows
        - устройство
        - железо

    # =========================================================================
    # СИГНАЛЫ СРОЧНОСТИ/НЕТЕРПЕНИЯ (мета-интенты)
    # =========================================================================
    request_brevity:
      enabled: true
      priority: 50
      min_confidence: 0.85
      patterns:
        # Прямые требования
        - "короче"
        - "(?:по)?короче"
        - "быстрее"
        - "(?:по)?быстрее"
        - "давай(?:те)?\\s+(?:уже\\s+)?(?:по\\s+делу|к\\s+делу|ближе)"
        - "(?:переходи(?:те)?|перейд[её]м)\\s+к\\s+(?:делу|сути)"
        - "ближе\\s+к\\s+(?:делу|сути|теме)"
        # Нетерпение
        - "не\\s+тян[иу](?:те)?"
        - "не\\s+затягивай(?:те)?"
        - "хватит\\s+(?:болтать|воды|разговоров)"
        - "(?:меньше|без)\\s+воды"
        - "(?:конкретн(?:о|ее)|по\\s+существу)"
        - "сразу\\s+(?:к\\s+делу|говори(?:те)?)"
        - "без\\s+(?:прелюдий|вступлений|предисловий)"
        # Ограничение времени
        - "(?:у\\s+меня\\s+)?мало\\s+времени"
        - "(?:я\\s+)?(?:спешу|тороплюсь)"
        - "(?:нет|нету)\\s+времени"
        - "(?:быстро|коротко)\\s+(?:и|да)\\s+(?:по\\s+делу|ясно)"
        # Выражение раздражения
        - "(?:хорош|заканчивай(?:те)?|прекращай(?:те)?)"
        - "(?:достаточно|хватит)\\s+(?:уже|вопросов)"
        - "(?:сколько\\s+можно|опять)"
        - "(?:надоело|устал[аи]?)"
      keywords:
        - короче
        - покороче
        - быстрее
        - побыстрее
        - конкретно
        - конкретнее
        - сразу
        - давайте
        - давай
        - хватит
        - достаточно
        - спешу
        - тороплюсь
        - надоело
        - устал
        - сути
        - существу

    # =========================================================================
    # ВОПРОСЫ ОБ АНАЛИТИКЕ (analytics)
    # =========================================================================
    question_analytics:
      enabled: true
      priority: 60
      min_confidence: 0.85
      patterns:
        - "(?:какая|есть\\s+ли)\\s+аналитик[аи]"
        - "(?:какие\\s+)?отчёт[ыа]"
        - "(?:какие\\s+)?отчет[ыа]"
        - "(?:статистик[аи]|дашборд)"
        - "(?:как\\s+)?(?:отслеживать|смотреть|видеть)\\s+(?:продажи|статистику)"
        - "(?:выручк[ау]|доход|прибыль)\\s+(?:посмотреть|видеть|анализ)"
        - "(?:графики|диаграммы)"
        - "(?:kpi|кпи)"
        - "(?:воронка|конверсия)"
        - "(?:abc|xyz)[--]?анализ"
        - "(?:средний\\s+чек|товарооборот)"
      keywords:
        - аналитика
        - отчёты
        - отчеты
        - статистика
        - дашборд
        - графики
        - диаграммы
        - выручка
        - прибыль
        - kpi
        - воронка
        - конверсия
        - анализ

    # =========================================================================
    # ВОПРОСЫ О КОНКУРЕНТАХ (competitors)
    # =========================================================================
    question_competitors:
      enabled: true
      priority: 60
      min_confidence: 0.85
      patterns:
        - "(?:чем\\s+)?(?:лучше|отличаетесь|отличие)\\s+(?:от|чем)"
        - "(?:сравн(?:ить|ение)|разниц[ау])\\s+(?:с|между)"
        - "(?:почему\\s+)?(?:вас|вы|wipon)\\s+(?:а\\s+не|лучше\\s+чем)"
        - "(?:у\\s+конкурентов|у\\s+других)"
        - "(?:poster|iiko|r[--]?keeper|syrve|joinposter)"
        - "(?:1с[--]?розница|мой\\s+склад|subtotal)"
        - "(?:касса\\s+эвотор|эвотор)"
        - "(?:почему\\s+не|зачем\\s+менять)"
        - "(?:преимуществ[аоы]\\s+)?(?:перед|над|по\\s+сравнению)"
      keywords:
        - лучше
        - отличие
        - отличается
        - сравнение
        - сравнить
        - конкуренты
        - конкурент
        - poster
        - iiko
        - rkeeper
        - syrve
        - joinposter
        - эвотор
        - subtotal

    # =========================================================================
    # ВОПРОСЫ О СОТРУДНИКАХ/ПЕРСОНАЛЕ (employees)
    # =========================================================================
    question_employees:
      enabled: true
      priority: 55
      min_confidence: 0.85
      patterns:
        - "(?:учёт|учет)\\s+(?:сотрудников|персонала|кадров)"
        - "(?:сколько\\s+)?(?:сотрудников|пользователей|кассиров)\\s+(?:можно|добавить)"
        - "(?:права|роли|доступ)\\s+(?:сотрудников|пользователей)"
        - "(?:смены|график|расписание)\\s+(?:работы|сотрудников)"
        - "(?:зарплат[аы]|оклад|выплаты)\\s+(?:сотрудников|персонала)"
        - "(?:ограничить|разграничить)\\s+(?:права|доступ)"
        - "(?:кто\\s+что\\s+)?(?:продал|сделал|изменил)"
        - "(?:история|журнал)\\s+(?:действий|изменений)"
      keywords:
        - сотрудники
        - сотрудников
        - персонал
        - кассир
        - кассиры
        - пользователи
        - права
        - роли
        - доступ
        - смены
        - график
        - зарплата
        - история

    # =========================================================================
    # ВОПРОСЫ О ФИСКАЛИЗАЦИИ (fiscal)
    # =========================================================================
    question_fiscal:
      enabled: true
      priority: 60
      min_confidence: 0.85
      patterns:
        - "(?:фискал(?:изация|ьный)|офд)"
        - "(?:онлайн[--]?)?(?:касс[ау]|ккм|ккт)"
        - "(?:54[--]?фз|закон\\s+о\\s+кассах)"
        - "(?:чеки?|фискальн(?:ый|ые)\\s+чек)"
        - "(?:огд|орд|налогов(?:ая|ые))"
        - "(?:регистрация|зарегистрировать)\\s+(?:кассу|ккт)"
        - "(?:как\\s+)?(?:пробить|выбить)\\s+чек"
        - "(?:электронн(?:ый|ые)\\s+)?чек(?:и)?\\s+(?:покупателю|клиенту)"
        - "(?:qr[--]?код|код)\\s+(?:на\\s+)?чек[еи]?"
        - "(?:маркировка|честный\\s+знак)"
      keywords:
        - фискализация
        - фискальный
        - офд
        - ккм
        - ккт
        - чек
        - чеки
        - налоговая
        - регистрация
        - маркировка
        - честный знак
        - 54-фз

    # =========================================================================
    # ВОПРОСЫ О ТОВАРАХ/СКЛАДЕ (inventory)
    # =========================================================================
    question_inventory:
      enabled: true
      priority: 55
      min_confidence: 0.85
      patterns:
        - "(?:учёт|учет)\\s+(?:товаров|остатков|склада)"
        - "(?:складской|товарный)\\s+учёт"
        - "(?:остатки|наличие)\\s+(?:товаров|на\\s+складе)"
        - "(?:приход|списание|перемещение)\\s+(?:товаров|товара)"
        - "(?:инвентаризация|ревизия)"
        - "(?:штрих[--]?код|баркод)\\s+(?:товара|товаров)"
        - "(?:номенклатура|каталог|справочник)\\s+(?:товаров)?"
        - "(?:цены\\s+)?(?:на\\s+товары|товаров)"
        - "(?:импорт|загрузка)\\s+(?:товаров|номенклатуры|каталога)"
        - "(?:минимальн(?:ый|ые)|критическ(?:ий|ие))\\s+(?:остаток|остатки)"
      keywords:
        - товары
        - товар
        - склад
        - остатки
        - остаток
        - приход
        - списание
        - инвентаризация
        - ревизия
        - номенклатура
        - каталог
        - штрихкод
        - баркод
        - учёт
        - учет

    # =========================================================================
    # ВОПРОСЫ О МОБИЛЬНОМ ПРИЛОЖЕНИИ (mobile)
    # =========================================================================
    question_mobile:
      enabled: true
      priority: 55
      min_confidence: 0.85
      patterns:
        - "(?:мобильн(?:ое|ый|ая)|телефон(?:ное|ный)?)\\s+приложени"
        - "(?:приложение|апп?)\\s+(?:для\\s+)?(?:телефона|смартфона|мобильного)"
        - "(?:на\\s+)?(?:android|андроид|ios|айфон|iphone)"
        - "(?:работает|есть)\\s+(?:на\\s+)?(?:телефоне|смартфоне|планшете)"
        - "(?:скачать|установить)\\s+(?:приложение|на\\s+телефон)"
        - "(?:play\\s+market|app\\s+store|google\\s+play)"
        - "(?:удалённ(?:ый|ая|о)|дистанционн(?:ый|о))\\s+(?:доступ|управление|контроль)"
        - "(?:смотреть|следить|контролировать)\\s+(?:с\\s+телефона|удалённо)"
      keywords:
        - мобильное
        - мобильный
        - приложение
        - телефон
        - смартфон
        - планшет
        - android
        - андроид
        - ios
        - айфон
        - iphone
        - удалённо
        - дистанционно

    # =========================================================================
    # ВОПРОСЫ О ПРОДУКТАХ/ВЕРСИЯХ (products)
    # =========================================================================
    question_products:
      enabled: true
      priority: 55
      min_confidence: 0.85
      patterns:
        - "(?:какие\\s+)?(?:продукты|версии|решения)\\s+(?:есть|у\\s+вас)"
        - "(?:wipon|випон)\\s+(?:desktop|kassa|касса|mobile|мобайл)"
        - "(?:какая|какую)\\s+(?:версия|версию)\\s+(?:выбрать|подойдёт|лучше)"
        - "(?:чем\\s+)?(?:отличается|разница)\\s+(?:между\\s+)?(?:версиями|продуктами)"
        - "(?:облачн(?:ая|ое|ый)|локальн(?:ая|ое|ый))\\s+(?:версия|решение)"
        - "(?:saas|сервис|подписка)\\s+(?:или|vs|против)\\s+(?:коробка|локальн)"
        - "(?:для\\s+)?(?:малого|среднего|крупного)\\s+бизнеса"
        - "(?:для\\s+)?(?:ип|ооо|тоо|индивидуальн)"
      keywords:
        - продукты
        - продукт
        - версия
        - версии
        - решение
        - решения
        - wipon
        - випон
        - desktop
        - kassa
        - облачная
        - облачный
        - локальная
        - локальный
        - saas

    # =========================================================================
    # ВОПРОСЫ ОБ АКЦИЯХ/СКИДКАХ (promotions)
    # =========================================================================
    question_promotions:
      enabled: true
      priority: 55
      min_confidence: 0.85
      patterns:
        - "(?:есть\\s+ли|какие)\\s+(?:акции|скидки|спецпредложения)"
        - "(?:сейчас|текущие)\\s+(?:акции|скидки)"
        - "(?:промокод|купон|промо)"
        - "(?:бесплатн(?:ый|ая|о)|триал|trial)"
        - "(?:бонус|подарок|в\\s+подарок)"
        - "(?:при\\s+оплате|за\\s+год|годов(?:ая|ой))\\s+(?:скидка|дешевле)"
        - "(?:партнёрск(?:ая|ие)|реферальн(?:ая|ые))\\s+(?:программа|скидки)"
        - "(?:для\\s+новых|новым)\\s+(?:клиентов|пользователей)"
      keywords:
        - акции
        - акция
        - скидки
        - скидка
        - промокод
        - купон
        - промо
        - бесплатно
        - бонус
        - подарок
        - спецпредложение

    # =========================================================================
    # ВОПРОСЫ О РЕГИОНАХ/ДОСТАВКЕ (regions)
    # =========================================================================
    question_regions:
      enabled: true
      priority: 50
      min_confidence: 0.85
      patterns:
        - "(?:работаете|есть)\\s+(?:в|по)\\s+(?:городу|региону|области)"
        - "(?:доставка|доставляете)\\s+(?:в|по)"
        - "(?:в\\s+)?(?:алматы|астана|нурсултан|шымкент|караганда)"
        - "(?:в\\s+)?(?:москв[ае]|спб|санкт[--]?петербург|россия|казахстан)"
        - "(?:по\\s+всему?|по\\s+)?(?:казахстану|снг|рф|россии)"
        - "(?:региональн(?:ый|ые)|филиал(?:ы)?)"
        - "(?:представитель|офис)\\s+(?:в|по)"
        - "(?:установка|настройка)\\s+(?:на\\s+месте|выездная)"
      keywords:
        - доставка
        - регион
        - регионы
        - город
        - область
        - филиал
        - офис
        - представитель
        - выезд
        - выездная
        - алматы
        - астана
        - казахстан
        - россия

    # =========================================================================
    # ВОПРОСЫ О НАДЁЖНОСТИ/СТАБИЛЬНОСТИ (stability)
    # =========================================================================
    question_stability:
      enabled: true
      priority: 50
      min_confidence: 0.85
      patterns:
        - "(?:насколько\\s+)?(?:надёжн(?:о|ая|ый)|стабильн(?:о|ая|ый))"
        - "(?:сбои|падения|зависания|глюки|баги)"
        - "(?:что\\s+если|если)\\s+(?:интернет|свет|электричество)"
        - "(?:работает\\s+)?(?:без\\s+интернета|оффлайн|offline)"
        - "(?:резервн(?:ое|ая)|бэкап|backup)\\s+(?:копирование|копия|хранение)"
        - "(?:сохранность|безопасность)\\s+(?:данных)"
        - "(?:uptime|аптайм|доступность)"
        - "(?:cloud|облако|облачн)\\s+(?:хранение|сервер)"
        - "(?:sla|гарантия\\s+доступности)"
      keywords:
        - надёжность
        - надежность
        - стабильность
        - сбои
        - падения
        - оффлайн
        - offline
        - бэкап
        - backup
        - безопасность
        - сохранность
        - uptime
        - доступность

    # =========================================================================
    # ВОПРОСЫ О ТИС (tis - трёхкомпонентная система)
    # =========================================================================
    question_tis:
      enabled: true
      priority: 55
      min_confidence: 0.85
      patterns:
        - "(?:что\\s+такое\\s+)?тис\\b"
        - "(?:трёх|трех)[--]?компонентн(?:ая|ый)"
        - "(?:для\\s+)?(?:ип|индивидуальн(?:ый|ого)\\s+предприниматель)"
        - "(?:ип|ип[--]?шник)\\s+(?:какой|какую|нужн)"
        - "(?:без\\s+)?(?:онлайн[--]?)?ккм"
        - "(?:упрощ[её]нн(?:ая|ый)|упрощёнка)"
        - "(?:малый\\s+бизнес|микробизнес)"
        - "(?:пкс|птс)\\s+(?:терминал|система)"
      keywords:
        - тис
        - трёхкомпонентная
        - трехкомпонентная
        - ип
        - индивидуальный
        - предприниматель
        - упрощёнка
        - упрощенка
        - малый бизнес
        - микробизнес
        - ккм

    # =========================================================================
    # ВОПРОСЫ О МИГРАЦИИ ДАННЫХ (data migration)
    # FIX: Критический паттерн - ранее отсутствовал, вопросы терялись
    # =========================================================================
    question_data_migration:
      enabled: true
      priority: 70
      min_confidence: 0.85
      patterns:
        # Прямые вопросы о переносе
        - "(?:как|каким\\s+образом)\\s+(?:перенес[её]те|переносите|мигрируете)"
        - "(?:как)\\s+(?:происходит|работает)\\s+(?:перенос|миграция)"
        - "(?:можно|можете)\\s+(?:перенести|мигрировать)"
        - "(?:поможете|помогаете)\\s+(?:с\\s+)?(?:переносом|миграцией)"
        - "(?:что)\\s+(?:насч[её]т|по\\s+поводу)\\s+(?:переноса|миграции)"
        # Вопросы об импорте
        - "(?:можно|как)\\s+(?:импортировать|загрузить)\\s+(?:данные|из)"
        - "(?:как)\\s+(?:перенести|импортировать)\\s+(?:из\\s+)?(?:excel|1с|битрикс)"
        - "(?:есть|поддерживается)\\s+(?:импорт|экспорт)"
        # Процесс миграции
        - "(?:сколько)\\s+(?:займ[её]т|занимает)\\s+(?:перенос|миграция)"
        - "(?:кто)\\s+(?:будет)?\\s*(?:переносить|мигрировать)"
        - "(?:данные)\\s+(?:как)\\s+(?:перенести|перенес[её]те)"
      keywords:
        - перенос
        - перенести
        - перенесёте
        - миграция
        - мигрировать
        - импорт
        - импортировать
        - экспорт
        - загрузить данные
        - выгрузить данные

    # =========================================================================
    # ВОПРОСЫ О ВНЕДРЕНИИ (implementation)
    # FIX: Критический паттерн - ранее отсутствовал
    # =========================================================================
    question_implementation:
      enabled: true
      priority: 65
      min_confidence: 0.85
      patterns:
        - "(?:как)\\s+(?:происходит|проходит|ид[её]т)\\s+(?:внедрение|настройка|установка)"
        - "(?:как)\\s+(?:внедряете|настраиваете|устанавливаете)"
        - "(?:сколько)\\s+(?:времени)?\\s*(?:займ[её]т|занимает)\\s+(?:внедрение|настройка)"
        - "(?:какие)\\s+(?:этапы|шаги)\\s+(?:внедрения|настройки)"
        - "(?:помогаете|поможете)\\s+(?:с\\s+)?(?:внедрением|настройкой)"
        - "(?:есть\\s+ли)\\s+(?:обучение|поддержка)\\s+(?:при)?\\s*(?:внедрении)?"
        - "(?:кто)\\s+(?:будет)?\\s*(?:внедрять|настраивать|обучать)"
        - "(?:как\\s+быстро|за\\s+сколько)\\s+(?:можно)?\\s*(?:внедрить|запустить)"
        - "(?:сроки|дедлайн)\\s+(?:внедрения|запуска)"
      keywords:
        - внедрение
        - внедрить
        - внедряете
        - установка
        - установить
        - настройка
        - настроить
        - запуск
        - запустить
        - обучение

    # =========================================================================
    # ВОПРОСЫ ОБ ОБНОВЛЕНИЯХ (updates)
    # =========================================================================
    question_updates:
      enabled: true
      priority: 50
      min_confidence: 0.85
      patterns:
        - "(?:как)\\s+(?:часто)\\s+(?:выходят|бывают)\\s+(?:обновления|апдейты)"
        - "(?:обновления)\\s+(?:автоматические|платные|бесплатные)"
        - "(?:нужно\\s+ли|как)\\s+(?:обновлять|обновляться)"
        - "(?:что\\s+нового|какие\\s+обновления)\\s+(?:в|были)"
      keywords:
        - обновления
        - обновление
        - обновлять
        - апдейт
        - апдейты
        - версия
        - релиз

    # =========================================================================
    # ВОПРОСЫ ОБ ОФЛАЙН-РЕЖИМЕ (offline)
    # =========================================================================
    question_offline:
      enabled: true
      priority: 85  # Higher than question_features (80) to detect offline questions first
      min_confidence: 0.85
      patterns:
        - "(?:работает\\s+ли|можно\\s+ли)\\s+(?:без)?\\s*(?:интернета|оффлайн|offline)"
        - "(?:что)\\s+(?:если|когда)\\s+(?:нет)?\\s*(?:интернета|связи|сети)"
        - "(?:офлайн|оффлайн|offline)\\s+(?:режим|работа|функционал)"
        - "(?:без\\s+интернета)\\s+(?:работает|можно)"
      keywords:
        - оффлайн
        - офлайн
        - offline
        - без интернета
        - локально
        - автономно
        - нет связи
        - нет сети
        # Single-word keywords to trigger pattern check (multi-word keywords won't match)
        - интернета
        - интернет
        - связи
        - сети

    # =========================================================================
    # ВОПРОСЫ О КАСТОМИЗАЦИИ (customization)
    # =========================================================================
    question_customization:
      enabled: true
      priority: 50
      min_confidence: 0.85
      patterns:
        - "(?:можно\\s+ли|как)\\s+(?:настроить|кастомизировать|адаптировать)"
        - "(?:есть\\s+ли)\\s+(?:гибкость|возможность)\\s+(?:настройки|кастомизации)"
        - "(?:можно\\s+ли|как)\\s+(?:добавить|создать)\\s+(?:свои|кастомные)\\s+(?:поля|процессы)"
        - "(?:можно)\\s+(?:под\\s+себя|под\\s+нас)\\s+(?:настроить|адаптировать)"
      keywords:
        - кастомизация
        - кастомизировать
        - настроить под себя
        - адаптировать
        - свои поля
        - кастомные поля
        - гибкость

    # =========================================================================
    # ВОПРОСЫ ОБ АВТОМАТИЗАЦИИ (automation)
    # =========================================================================
    question_automation:
      enabled: true
      priority: 50
      min_confidence: 0.85
      patterns:
        - "(?:какие|есть\\s+ли)\\s+(?:автоматизации|автоматические\\s+действия|триггеры)"
        - "(?:можно\\s+ли)\\s+(?:автоматизировать|настроить\\s+автоматически)"
        - "(?:как\\s+работает)\\s+(?:автоматизация|автоматические\\s+действия)"
        - "(?:есть)\\s+(?:автоматические)\\s+(?:уведомления|напоминания|рассылки)"
      keywords:
        - автоматизация
        - автоматизировать
        - автоматический
        - автоматически
        - триггеры
        - триггер
        - автодействия
        - автоуведомления

    # =========================================================================
    # ВОПРОСЫ О МАСШТАБИРУЕМОСТИ (scalability)
    # =========================================================================
    question_scalability:
      enabled: true
      priority: 50
      min_confidence: 0.85
      patterns:
        - "(?:как)\\s+(?:система)?\\s*(?:справляется|работает)\\s+(?:с)?\\s*(?:ростом|нагрузкой)"
        - "(?:можно\\s+ли|как)\\s+(?:масштабировать|расширять)"
        - "(?:есть\\s+ли)\\s+(?:ограничения|лимиты)\\s+(?:по|на)"
        - "(?:сколько)\\s+(?:пользователей|клиентов|записей)\\s+(?:можно|поддерживает)"
        - "(?:потянет|справится)\\s+(?:с)?\\s*(?:нагрузкой|ростом)"
      keywords:
        - масштабирование
        - масштабировать
        - масштаб
        - расширять
        - рост
        - нагрузка
        - лимиты
        - ограничения

# =============================================================================
# FACT QUESTION SOURCE (Universal Fact-Based Question Handler)
# =============================================================================
# Универсальный Knowledge Source для всех fact-based вопросов.
# Работает совместно с SecondaryIntentDetectionLayer:
# 1. SecondaryIntentDetectionLayer детектирует вопросы в composite messages
# 2. FactQuestionSource проверяет secondary_intents и отвечает
#
# SSoT: src/blackboard/sources/fact_question.py
# =============================================================================
fact_question_source:
  # Master switch
  enabled: true

  # Интенты, требующие фактического ответа
  # Эти интенты проверяются и как primary, и как secondary
  # Соответствует 17 категориям в БД знаний
  fact_intents:
    # =========================================================================
    # FEATURES (features) - функции и возможности
    # =========================================================================
    - question_features
    - question_capabilities

    # =========================================================================
    # INTEGRATIONS (integrations) - интеграции
    # =========================================================================
    - question_integrations
    - question_kaspi_integration
    - question_bank_terminal
    - question_1c_integration

    # =========================================================================
    # SUPPORT (support) - техподдержка
    # =========================================================================
    - question_support
    - question_training
    - question_documentation

    # =========================================================================
    # EQUIPMENT (equipment) - оборудование
    # =========================================================================
    - question_equipment
    - question_equipment_general
    - question_pos_monoblock
    - question_scales
    - question_scanner
    - question_printer
    - question_terminal

    # =========================================================================
    # ANALYTICS (analytics) - аналитика и отчёты
    # =========================================================================
    - question_analytics
    - question_reports
    - question_statistics

    # =========================================================================
    # COMPETITORS (competitors) - сравнение с конкурентами
    # =========================================================================
    - question_competitors
    - question_competitor
    - comparison

    # =========================================================================
    # EMPLOYEES (employees) - сотрудники и кадры
    # =========================================================================
    - question_employees
    - question_staff
    - question_permissions
    - question_roles

    # =========================================================================
    # FISCAL (fiscal) - фискализация
    # =========================================================================
    - question_fiscal
    - question_fiscal_general
    - question_ofd
    - question_kkm
    - question_checks

    # =========================================================================
    # INVENTORY (inventory) - товары и склад
    # =========================================================================
    - question_inventory
    - question_stock
    - question_warehouse
    - question_goods
    - question_nomenclature

    # =========================================================================
    # MOBILE (mobile) - мобильное приложение
    # =========================================================================
    - question_mobile
    - question_mobile_app
    - question_remote_access

    # =========================================================================
    # PRODUCTS (products) - продукты Wipon
    # =========================================================================
    - question_products
    - question_versions
    - question_editions
    - question_wipon_desktop
    - question_wipon_kassa

    # =========================================================================
    # PROMOTIONS (promotions) - акции и скидки
    # =========================================================================
    - question_promotions
    - question_discounts
    - question_promo
    - question_bonus

    # =========================================================================
    # REGIONS (regions) - регионы и доставка
    # =========================================================================
    - question_regions
    - question_delivery
    - question_cities
    - question_coverage

    # =========================================================================
    # STABILITY (stability) - надёжность и стабильность
    # =========================================================================
    - question_stability
    - question_reliability
    - question_uptime
    - question_backup
    - question_security

    # =========================================================================
    # TIS (tis) - трёхкомпонентная система для ИП
    # =========================================================================
    - question_tis
    - question_tis_general
    - question_ip_solution
    - question_micro_business

    # =========================================================================
    # TECHNICAL (technical) - технические вопросы
    # =========================================================================
    - question_technical
    - question_requirements
    - question_installation
    - question_configuration

    # =========================================================================
    # TARIFFS (pricing-related but about structure, not price)
    # =========================================================================
    - question_tariff_comparison
    - question_tariff_mini
    - question_tariff_lite
    - question_tariff_standard
    - question_tariff_details

    # =========================================================================
    # BUSINESS SCENARIOS
    # =========================================================================
    - question_grocery_store
    - question_restaurant_cafe
    - question_retail
    - question_horeca

    # =========================================================================
    # IMPLEMENTATION & ONBOARDING (внедрение и миграция)
    # FIX: Добавлены пропущенные интенты для полного покрытия вопросов
    # =========================================================================
    - question_data_migration     # Вопросы о миграции/переносе данных
    - question_implementation     # Вопросы о процессе внедрения
    - question_updates            # Вопросы об обновлениях системы
    - question_offline            # Вопросы об офлайн-режиме
    - question_customization      # Вопросы о кастомизации
    - question_automation         # Вопросы об автоматизации
    - question_scalability        # Вопросы о масштабируемости

  # Действия по умолчанию для специфичных интентов
  # Если нет YAML rule, используется это
  default_actions:
    question_technical: answer_technical_question
    question_security: answer_security_question
    question_stability: answer_reliability_question
    question_support: explain_support_options
    question_competitors: compare_with_competitor
    comparison: compare_with_competitor
    question_tis: explain_tis_solution
    question_fiscal: explain_fiscal_requirements
    question_mobile: explain_mobile_features
    question_analytics: explain_analytics_features
    # FIX: Добавлены действия для новых интентов
    question_data_migration: answer_with_facts
    question_implementation: explain_implementation_process
    question_updates: answer_with_facts
    question_offline: answer_with_facts
    question_customization: answer_with_facts
    question_automation: answer_with_facts
    question_scalability: answer_with_facts

  # Fallback action если нет специфичного
  fallback_action: answer_with_facts

# =============================================================================
# CONFIDENCE CALIBRATION (Scientific LLM Confidence Calibration)
# =============================================================================
# Решает фундаментальную проблему overconfident LLM:
# - LLM генерирует confidence как текст, а не вычисляет алгоритмически
# - Few-shot примеры учат высокой уверенности (0.85-0.98)
# - Результат: confidence 0.85-0.95 даже при неверной классификации
#
# Научные основы:
# - Entropy-based calibration (Shannon, 1948)
# - Post-hoc calibration (Guo et al., 2017)
# - Verbal confidence calibration (Tian et al., 2023)
#
# SSoT: src/classifier/confidence_calibration.py
# =============================================================================
confidence_calibration:
  # Master switch
  enabled: true

  # Пороги confidence (floor/ceiling)
  min_confidence_floor: 0.1      # Минимальный confidence после калибровки
  max_confidence_ceiling: 0.95   # Максимальный confidence (нельзя быть 100% уверенным)

  # =============================================================================
  # ENTROPY STRATEGY
  # =============================================================================
  # Использует Shannon entropy для оценки неопределённости:
  # - Высокая entropy = высокая неопределённость = понижаем confidence
  # - Формула: H = -sum(p_i * log(p_i))
  # =============================================================================
  entropy_enabled: true
  entropy_threshold: 0.5         # Выше этого порога - применяем штраф
  entropy_penalty_factor: 0.15   # Множитель штрафа: penalty = excess_entropy * factor

  # =============================================================================
  # GAP STRATEGY
  # =============================================================================
  # Анализирует разрыв между top-1 и top-2 интентами:
  # - Маленький gap = неоднозначная классификация = понижаем confidence
  # =============================================================================
  gap_enabled: true
  gap_threshold: 0.2             # Минимальный gap для высокого confidence
  gap_penalty_factor: 0.2        # Множитель штрафа за маленький gap
  no_alternatives_penalty: 0.1   # Штраф если нет alternatives (подозрительно)
  min_gap_for_high_confidence: 0.15  # Минимальный gap для confidence >= 0.85
  high_confidence_small_gap_penalty: 0.1  # Доп. штраф за high conf + small gap

  # =============================================================================
  # HEURISTIC STRATEGY
  # =============================================================================
  # Pattern-based правила для известных ошибок LLM
  # =============================================================================
  heuristic_enabled: true

  # Short message penalty
  short_message_words: 3         # Сообщения <= N слов считаются короткими
  short_message_penalty: 0.15    # Штраф за короткие сообщения с высоким confidence

  # Overconfident intent penalty
  overconfident_intent_penalty: 0.1
  overconfident_intents:
    - greeting
    - farewell
    - small_talk
    - agreement
    - gratitude

  # Context mismatch penalty
  context_mismatch_penalty: 0.1
  data_expecting_actions:
    - ask_about_company
    - ask_about_problem
    - ask_situation
    - ask_problem
    - ask_implication
    - ask_need_payoff
    - ask_for_clarification
    - transition_to_spin_situation
    - transition_to_spin_problem

  data_intents:
    - info_provided
    - situation_provided
    - problem_revealed
    - implication_acknowledged
    - need_expressed

  # Objection overconfidence penalty (Rule 4)
  # FIX: Порог понижен с 0.9 до 0.8 в коде для обработки objection_think
  objection_overconfidence_penalty: 0.1
  objection_intents:
    - objection_price
    - objection_no_time
    - objection_think
    - objection_no_need
    - objection_competitor
    - objection_timing
    - objection_complexity

  # Objection without alternatives penalty (Rule 5) - NEW
  # FIX: LLM часто не возвращает alternatives для objection интентов
  # Это делает entropy и gap стратегии неэффективными
  # Добавляем специальный штраф для такого случая
  objection_no_alternatives_penalty: 0.15     # Штраф за objection без alternatives
  objection_no_alternatives_threshold: 0.75   # Порог confidence для применения

# =============================================================================
# STALL DETECTION (Phase 5: Flow State Stall Detection)
# =============================================================================
# Detects when dialog is stuck in the same state without data progress.
# Different from is_stuck (unclear intents) — this is about off-topic questions.
stall_detection:
  enabled: true
  stall_threshold: 3
  # RC3 FIX: presentation REMOVED — was causing 34 stuck dialogs (Bug 3.1)
  # Soft nudge (is_stalled) now fires at threshold=3 for presentation
  # StallGuardSource fires later as hard ejection at max_turns_in_state=5
  exempt_states: [greeting, handle_objection, close, soft_close, success, escalated]

# =============================================================================
# SIMULATION DIAGNOSTIC MODE
# =============================================================================
# Higher limits for simulation runs to expose real stuck durations.
# Controlled by feature flag: simulation_diagnostic_mode (default: False)
simulation:
  diagnostic:
    handle_objection_max_consecutive: 10
    soft_close_max_visits: 5

# =============================================================================
# GREETING CONTEXT REFINEMENT (Phase 3: Category-Driven Refinement Layer)
# =============================================================================
# Refines misclassified intents in greeting context to safe targets.
# Uses SSOT categories — adding intent to technical_problems → auto-included.
greeting_context_refinement:
  enabled: true
  max_turn_number: 3
  active_states: [greeting]
  # SSOT: Load suspicious intents from categories (not hardcoded list)
  suspicious_intent_categories:
    - technical_problems          # problem_sync, problem_connection, etc.
  additional_suspicious_intents:
    - request_references          # Not in technical_problems but needs refinement
  # Default: any suspicious intent → problem_revealed
  default_target: problem_revealed
  # Overrides for intents that map to different targets
  target_overrides:
    request_references: need_expressed
    request_technical_support: consultation_request
    request_configuration: consultation_request
  refined_confidence: 0.75

# =============================================================================
# GREETING STATE SAFETY (Phase 1: Category-Based Mixin Override)
# =============================================================================
# Overrides greeting-state transitions for intents that would otherwise
# lead to terminal states (escalated/success) via _universal_base.
# Uses greeting_redirect_intents composed category from SSOT.
greeting_state_safety:
  enabled: true
  redirect_to: "{{entry_state}}"

# =============================================================================
# BLACKBOARD CONFIGURATION
# =============================================================================
# Source enablement for Dialogue Orchestrator pipeline.
# All sources are enabled by default (see SourceRegistry).
# Use this section to DISABLE specific sources or pass source-specific config.
# SSoT: src/blackboard/source_registry.py (registration with defaults)
blackboard:
  sources: {}

# =============================================================================
# СОГЛАСОВАННОСТЬ ПОРОГОВ (ВАЖНО!)
# =============================================================================
# guard.high_frustration_threshold ДОЛЖЕН быть равен frustration.thresholds.high
# Это обеспечивает единообразное поведение:
# - FrustrationTracker определяет уровень
# - ConversationGuard реагирует на тот же порог
# - DialoguePolicy использует те же пороги в условиях
