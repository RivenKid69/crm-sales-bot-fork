# =============================================================================
# ЕДИНАЯ ТОЧКА ИСТИНЫ ДЛЯ ВСЕХ КОНСТАНТ STATE MACHINE
# =============================================================================
# Версия: 1.0
# Этот файл является источником истины для всех констант,
# связанных с state machine и диалоговой логикой.
# =============================================================================

# =============================================================================
# SPIN SELLING CONFIGURATION
# =============================================================================
spin:
  # Порядок SPIN фаз (можно изменить!)
  phases:
    - situation
    - problem
    - implication
    - need_payoff

  # Маппинг фаза -> состояние
  states:
    situation: spin_situation
    problem: spin_problem
    implication: spin_implication
    need_payoff: spin_need_payoff

  # Интенты которые указывают на прогресс в соответствующей фазе
  progress_intents:
    situation_provided: situation
    problem_revealed: problem
    implication_acknowledged: implication
    need_expressed: need_payoff

  # Конфигурация классификации по фазам
  # Определяет какие extracted данные означают прогресс в каждой фазе
  phase_classification:
    situation:
      data_fields:
        - company_size
        - current_tools
        - business_type
      intent: situation_provided
      confidence: 0.9
    problem:
      data_fields:
        - pain_point
      intent: problem_revealed
      confidence: 0.9
    implication:
      data_fields:
        - pain_impact
        - financial_impact
      intent: implication_acknowledged
      confidence: 0.9
    need_payoff:
      data_fields:
        - desired_outcome
        - value_acknowledged
      intent: need_expressed
      confidence: 0.9

  # Конфигурация классификации коротких ответов по фазам
  # Определяет какой интент возвращать при положительном/негативном ответе
  short_answer_classification:
    situation:
      positive_intent: situation_provided
      positive_confidence: 0.7
    problem:
      positive_intent: problem_revealed
      positive_confidence: 0.75
      negative_intent: no_problem
      negative_confidence: 0.7
    implication:
      positive_intent: implication_acknowledged
      positive_confidence: 0.8
    need_payoff:
      positive_intent: need_expressed
      positive_confidence: 0.85
      negative_intent: no_need
      negative_confidence: 0.7

# =============================================================================
# LIMITS
# =============================================================================
limits:
  # Максимум возражений подряд до soft_close
  max_consecutive_objections: 3
  # Максимум возражений за весь диалог
  max_total_objections: 5
  # Максимум возвратов назад по SPIN
  max_gobacks: 2

# =============================================================================
# DISAMBIGUATION (Unified Disambiguation Decision Engine)
# =============================================================================
# Конфигурация для унифицированного механизма уточнения намерений.
# Работает с обоими классификаторами (LLM и Hybrid).
#
# Decision matrix:
# | Confidence | Gap      | Decision     |
# |------------|----------|--------------|
# | >= 0.85    | >= 0.20  | EXECUTE      |
# | >= 0.85    | < 0.20   | CONFIRM      |
# | >= 0.65    | >= 0.20  | EXECUTE      |
# | >= 0.65    | < 0.20   | CONFIRM      |
# | >= 0.45    | any      | DISAMBIGUATE |
# | >= 0.30    | any      | DISAMBIGUATE |
# | < 0.30     | any      | FALLBACK     |
# =============================================================================
disambiguation:
  # Пороги confidence для принятия решений
  thresholds:
    high_confidence: 0.85      # EXECUTE если gap достаточный
    medium_confidence: 0.65    # EXECUTE или CONFIRM в зависимости от gap
    low_confidence: 0.45       # DISAMBIGUATE
    min_confidence: 0.30       # Ниже → FALLBACK

  # Порог gap между top-1 и top-2 интентами
  # Маленький gap = близкие альтернативы = нужно уточнить
  gap_threshold: 0.20

  # Настройки опций для показа пользователю
  options:
    max_options: 3             # Максимум вариантов (+ "Другое")
    min_option_confidence: 0.25  # Минимальная confidence для включения в опции

  # Интенты которые bypass disambiguation (критические действия)
  # Для них не показываем уточнение даже при низкой уверенности
  bypass_intents:
    - rejection         # Жёсткий отказ - сразу обрабатываем
    - contact_provided  # Дали контакт - сразу фиксируем
    - demo_request      # Хотят демо - сразу записываем

  # Интенты которые исключаются из опций disambiguation
  # Не показываем их пользователю как варианты
  excluded_intents:
    - unclear           # Не предлагаем "непонятно" как выбор
    - small_talk        # Не предлагаем "поболтать" как выбор

  # Cooldown: сколько ходов ждать между disambiguation
  # Чтобы не раздражать пользователя частыми уточнениями
  cooldown_turns: 3

# =============================================================================
# INTENT CATEGORIES
# =============================================================================
intents:
  # Интенты для возврата назад по flow
  go_back:
    - go_back
    - correct_info

  # Категории интентов (source of truth)
  categories:
    # =================================================================
    # БАЗОВЫЕ ВОЗРАЖЕНИЯ (18 интентов)
    # ВАЖНО: rejection НЕ является возражением!
    # - Возражение = "дорого", "нет времени" → можно обработать
    # - Rejection = "не интересует" → финальный отказ
    # =================================================================
    objection:
      - objection_price
      - objection_competitor
      - objection_no_time
      - objection_think
      - objection_timing
      - objection_complexity
      - objection_trust
      - objection_no_need
      - objection_risk
      - objection_team_resistance
      - objection_security
      - objection_bad_experience
      - objection_priority
      - objection_scale
      - objection_change_management
      - objection_contract_bound
      - objection_company_policy
      - objection_roi_doubt

    # =================================================================
    # ИНТЕНТЫ ЗАВЕРШЕНИЯ ДИАЛОГА (exit intents)
    # Используются для перехода в soft_close
    # =================================================================
    exit:
      - rejection
      - farewell

    # =================================================================
    # ПОЗИТИВНЫЕ СИГНАЛЫ (включая новые 8)
    # =================================================================
    positive:
      - agreement
      - demo_request
      - callback_request
      - contact_provided
      - consultation_request
      - situation_provided
      - problem_revealed
      - implication_acknowledged
      - need_expressed
      - info_provided
      - question_features
      - question_integrations
      - comparison
      - greeting
      - gratitude
      # Новые позитивные сигналы
      - ready_to_buy
      - budget_approved
      - decision_maker_identified
      - urgency_expressed
      - competitor_dissatisfied
      - expansion_planned
      - positive_feedback
      - internal_champion

    # =================================================================
    # БАЗОВЫЕ ВОПРОСЫ
    # =================================================================
    question:
      - price_question
      - pricing_details
      - question_features
      - question_integrations
      - question_technical
      - comparison
      - question_security
      - question_support
      - question_implementation
      - question_training
      - question_updates
      - question_mobile
      - question_offline
      - question_data_migration
      - question_customization
      - question_reports
      - question_automation
      - question_scalability

    # НОВОЕ: Вопросы о цене (требуют ответа с ценой)
    price_related:
      - price_question
      - pricing_details

    # НОВОЕ: Вопросы требующие ответа фактами (не deflect)
    question_requires_facts:
      - price_question
      - pricing_details
      - question_features
      - question_integrations

    spin_progress:
      - situation_provided
      - problem_revealed
      - implication_acknowledged
      - need_expressed

    # BUG-001 FIX: Информативные интенты (клиент предоставляет данные, не застрял)
    # Используется ConversationGuard для проверки перед срабатыванием TIER_3
    informative:
      # SPIN situation
      - situation_provided
      - info_provided
      # SPIN problem
      - problem_revealed
      - problem_mentioned
      - pain_mentioned
      # SPIN implication
      - implication_acknowledged
      - consequence_mentioned
      # SPIN need-payoff
      - need_expressed
      - benefit_acknowledged
      # General informative
      - question_answered
      - data_provided
      - clarification_provided
      - details_shared
      # Budget/timeline related
      - budget_mentioned
      - timeline_mentioned
      - decision_process_shared

    # =================================================================
    # COMPOSED CATEGORY: negative
    # Определяется через composed_categories (см. ниже)
    # НЕ РЕДАКТИРОВАТЬ ЗДЕСЬ - это placeholder для обратной совместимости
    # Реальное содержимое генерируется автоматически в constants.py
    # =================================================================
    # negative: [] - будет заполнено автоматически из composed_categories

    # =================================================================
    # ВОПРОСЫ ОБ ОБОРУДОВАНИИ (12 интентов)
    # =================================================================
    equipment_questions:
      - question_equipment_general
      - question_pos_monoblock
      - question_scales
      - question_scanner
      - question_printer
      - question_cash_drawer
      - question_equipment_bundle
      - question_equipment_specs
      - question_equipment_warranty
      - question_equipment_install
      - question_equipment_compat
      - question_second_screen

    # =================================================================
    # ВОПРОСЫ О ТАРИФАХ (8 интентов)
    # =================================================================
    tariff_questions:
      - question_tariff_mini
      - question_tariff_lite
      - question_tariff_standard
      - question_tariff_pro
      - question_tariff_comparison
      - question_installment
      - question_trial_period
      - question_ofd_payment

    # =================================================================
    # ВОПРОСЫ О ТИС (10 интентов)
    # =================================================================
    tis_questions:
      - question_tis_general
      - question_tis_limits
      - question_tis_price
      - question_tis_requirements
      - question_tis_benefits
      - question_tis_2026
      - question_tis_components
      - question_tis_multi_location
      - question_tis_transition
      - question_tis_reports

    # =================================================================
    # ВОПРОСЫ О НАЛОГАХ (8 интентов)
    # =================================================================
    tax_questions:
      - question_retail_tax_general
      - question_retail_tax_rates
      - question_retail_tax_oked
      - question_retail_tax_reports
      - question_retail_tax_transition
      - question_snr_comparison
      - question_vat_registration
      - question_tax_optimization

    # =================================================================
    # БУХГАЛТЕРИЯ И ДОКУМЕНТЫ (8 интентов)
    # =================================================================
    accounting_questions:
      - question_accounting_services
      - question_esf_snt
      - question_form_910
      - question_form_200
      - question_form_300
      - question_business_registration
      - question_business_closure
      - question_document_flow

    # =================================================================
    # ИНТЕГРАЦИИ СПЕЦИФИЧНЫЕ (8 интентов)
    # =================================================================
    integration_specific:
      - question_bank_terminal
      - question_kaspi_integration
      - question_halyk_integration
      - question_1c_integration
      - question_iiko_integration
      - question_ofd_connection
      - question_marking_ismet
      - question_cashback_loyalty

    # =================================================================
    # УЧЁТ И ОПЕРАЦИИ (10 интентов)
    # =================================================================
    operations_questions:
      - question_inventory
      - question_revision
      - question_purchase_mgmt
      - question_sales_mgmt
      - question_cash_operations
      - question_returns_mgmt
      - question_employee_control
      - question_multi_location
      - question_promo_discounts
      - question_price_labels

    # =================================================================
    # ДОСТАВКА И СЕРВИС (6 интентов)
    # =================================================================
    delivery_service:
      - question_delivery
      - question_delivery_time
      - question_office_location
      - question_working_hours
      - request_refund
      - request_equipment_return

    # =================================================================
    # БИЗНЕС-СЦЕНАРИИ (18 интентов)
    # =================================================================
    business_scenarios:
      # Основные (10)
      - question_grocery_store
      - question_restaurant_cafe
      - question_pharmacy
      - question_clothing_store
      - question_small_business
      - question_network_stores
      - question_market_stall
      - question_alcohol_tobacco
      - question_beauty_salon
      - question_construction
      # Дополнительные (8)
      - question_wholesale
      - question_auto_parts
      - question_electronics
      - question_pet_shop
      - question_flower_shop
      - question_hotel
      - question_service_center
      - question_sports_shop

    # =================================================================
    # ТЕХНИЧЕСКИЕ ПРОБЛЕМЫ (6 интентов)
    # =================================================================
    technical_problems:
      - problem_technical
      - problem_connection
      - problem_sync
      - problem_fiscal
      - request_technical_support
      - request_configuration

    # =================================================================
    # РАЗГОВОРНЫЕ/ЭМОЦИОНАЛЬНЫЕ (10 интентов)
    # =================================================================
    conversational:
      - compliment
      - joke_response
      - surprise_expression
      - frustration_expression
      - skepticism_expression
      - curiosity_expression
      - empathy_request
      - confusion_expression
      - impatience_expression
      - relief_expression

    # =================================================================
    # ФИСКАЛИЗАЦИЯ (8 интентов)
    # =================================================================
    fiscal_questions:
      - question_fiscal_general
      - question_fiscal_receipt
      - question_fiscal_z_report
      - question_fiscal_x_report
      - question_fiscal_kkm
      - question_fiscal_ofd_wipon
      - question_fiscal_correction
      - question_fiscal_replacement

    # =================================================================
    # АНАЛИТИКА (8 интентов)
    # =================================================================
    analytics_questions:
      - question_analytics_sales
      - question_analytics_abc
      - question_analytics_profit
      - question_analytics_comparison
      - question_analytics_realtime
      - question_analytics_export
      - question_analytics_custom
      - question_analytics_dashboard

    # =================================================================
    # ПРОДУКТЫ WIPON (6 интентов)
    # =================================================================
    wipon_products:
      - question_wipon_pro
      - question_wipon_desktop
      - question_wipon_kassa
      - question_wipon_consulting
      - question_wipon_cashback_app
      - question_product_comparison

    # =================================================================
    # СОТРУДНИКИ/КАДРЫ (6 интентов)
    # =================================================================
    employee_questions:
      - question_employees_salary
      - question_employees_schedule
      - question_employees_permissions
      - question_employees_tracking
      - question_employees_motivation
      - question_employees_onboarding

    # =================================================================
    # ПРОМО/ЛОЯЛЬНОСТЬ (6 интентов)
    # =================================================================
    promo_loyalty:
      - question_loyalty_program
      - question_bonus_system
      - question_discount_cards
      - question_gift_cards
      - question_customer_database
      - question_sms_marketing

    # =================================================================
    # СТАБИЛЬНОСТЬ/НАДЁЖНОСТЬ (6 интентов)
    # =================================================================
    stability_questions:
      - question_backup_restore
      - question_uptime_sla
      - question_server_location
      - question_data_encryption
      - question_disaster_recovery
      - question_system_requirements

    # =================================================================
    # РЕГИОНЫ/ПРИСУТСТВИЕ (6 интентов)
    # =================================================================
    region_questions:
      - question_region_almaty
      - question_region_astana
      - question_region_shymkent
      - question_region_other
      - question_pickup_office
      - question_courier_service

    # =================================================================
    # ДОПОЛНИТЕЛЬНЫЕ ИНТЕГРАЦИИ (6 интентов)
    # =================================================================
    additional_integrations:
      - question_glovo_wolt
      - question_telegram_bot
      - question_whatsapp_business
      - question_instagram_shop
      - question_website_widget
      - question_delivery_services

    # =================================================================
    # ЭТАПЫ ПОКУПКИ (8 интентов)
    # =================================================================
    purchase_stages:
      - request_proposal
      - request_contract
      - request_invoice
      - request_discount
      - negotiate_terms
      - request_trial_extension
      - request_references
      - request_sla

    # =================================================================
    # ВОПРОСЫ О КОМПАНИИ (4 интента)
    # =================================================================
    company_info:
      - company_info_question
      - experience_question
      - case_study_request
      - roi_question

    # =================================================================
    # УПРАВЛЕНИЕ ДИАЛОГОМ (8 интентов)
    # =================================================================
    dialogue_control:
      - unclear
      - go_back
      - correct_info
      - request_brevity
      - clarification_request
      - repeat_request
      - example_request
      - summary_request

  # =================================================================
  # COMPOSED CATEGORIES - Декларативная композиция категорий
  # =================================================================
  # Эти категории создаются автоматически путём объединения базовых категорий.
  # Преимущества:
  # 1. Single Source of Truth - базовые категории определены один раз
  # 2. Автоматическая синхронизация - изменение objection обновляет negative
  # 3. Нет дублирования - нет ручного копирования списков
  # 4. Валидация - проверка что все referenced категории существуют
  #
  # Формат:
  #   category_name:
  #     includes: [list of base categories to merge]
  #     description: "Human-readable description"
  # =================================================================
  composed_categories:
    # negative = все негативные сигналы (возражения + exit)
    negative:
      includes:
        - objection
        - exit
      description: "Все негативные сигналы (возражения + отказы/прощания)"

    # blocking = интенты которые блокируют прогресс
    blocking:
      includes:
        - objection
        - exit
        - technical_problems
      description: "Интенты блокирующие прогресс диалога"

    # all_questions = все типы вопросов (для fallback/routing)
    all_questions:
      includes:
        - question
        - price_related
        - equipment_questions
        - tariff_questions
        - tis_questions
        - tax_questions
        - accounting_questions
        - fiscal_questions
        - analytics_questions
        - stability_questions
        - region_questions
        - operations_questions
      description: "Все категории вопросов для универсальной обработки"

  # =================================================================
  # МАППИНГ intent → preferred action (override default behavior)
  # NOTE: price_question/pricing_details используют условную логику в mixins,
  # поэтому НЕ указываем их здесь как безусловный override
  # =================================================================
  intent_action_overrides:
    question_features: answer_with_facts
    question_integrations: answer_with_facts
    # Технические вопросы
    question_equipment_general: answer_with_facts
    question_tariff_comparison: answer_with_facts
    question_tis_general: answer_with_facts
    question_fiscal_general: answer_with_facts
    # Бизнес-сценарии
    question_grocery_store: answer_with_facts
    question_restaurant_cafe: answer_with_facts
    # Технические проблемы → поддержка
    problem_technical: offer_support
    request_technical_support: connect_to_support

# =============================================================================
# DIALOGUE POLICY SETTINGS
# =============================================================================
policy:
  # Состояния где разрешены оверлеи DialoguePolicy
  overlay_allowed_states:
    - spin_situation
    - spin_problem
    - spin_implication
    - spin_need_payoff
    - presentation
    - handle_objection

  # Защищённые состояния (без оверлеев)
  protected_states:
    - greeting
    - close
    - success
    - soft_close

  # Агрессивные действия (требуют осторожности)
  aggressive_actions:
    - transition_to_presentation
    - transition_to_close
    - ask_for_demo
    - ask_for_contact

  # Mapping для repair mode
  repair_actions:
    stuck: clarify_one_question
    oscillation: summarize_and_clarify
    repeated_question: answer_with_summary

  # Mapping для возражений
  objection_actions:
    reframe: reframe_value
    escalate: handle_repeated_objection
    empathize: empathize_and_redirect

# =============================================================================
# LEAD SCORER SETTINGS
# =============================================================================
lead_scoring:
  # Веса положительных сигналов
  positive_weights:
    demo_request: 30
    price_with_size: 25
    callback_request: 25
    consultation_request: 20
    contact_provided: 35
    explicit_problem: 15
    competitor_comparison: 12
    budget_mentioned: 10
    timeline_mentioned: 10
    multiple_questions: 8
    features_question: 5
    integrations_question: 5
    general_interest: 3
    price_question: 5

  # Веса негативных сигналов
  negative_weights:
    objection_price: -15
    objection_competitor: -10
    objection_no_time: -20
    objection_think: -10
    objection_no_need: -25
    unclear_repeated: -5
    rejection_soft: -25
    frustration: -15

  # Пороги температуры [min, max]
  thresholds:
    cold: [0, 29]
    warm: [30, 49]
    hot: [50, 69]
    very_hot: [70, 100]

  # ⚠️ КРИТИЧНО: Какие SPIN фазы пропускать по температуре
  # Это напрямую влияет на flow диалога!
  skip_phases:
    cold: []  # Полный SPIN
    warm:     # Пропустить I, N
      - spin_implication
      - spin_need_payoff
    hot:      # Только S
      - spin_problem
      - spin_implication
      - spin_need_payoff
    very_hot: # Сразу close
      - spin_situation
      - spin_problem
      - spin_implication
      - spin_need_payoff

  # Рекомендуемые пути по температуре
  paths:
    cold: full_spin           # S → P → I → N → presentation
    warm: short_spin          # S → P → presentation (skip I, N)
    hot: direct_present       # S → presentation
    very_hot: direct_close    # presentation → close

# =============================================================================
# CONVERSATION GUARD SETTINGS
# =============================================================================
guard:
  # Основные лимиты
  max_turns: 25                         # Средний sales диалог: 8-15 turns
  max_phase_attempts: 3                 # LivePerson recommendation
  max_same_state: 4                     # Loop detection
  max_same_message: 2                   # Exact repeat detection
  timeout_seconds: 1800                 # 30 минут

  # Пороги прогресса
  progress_check_interval: 5            # Каждые 5 turns проверяем прогресс
  min_unique_states_for_progress: 2     # Минимум уникальных состояний за интервал

  # ⚠️ КРИТИЧНО: Должен быть равен frustration.thresholds.high
  high_frustration_threshold: 7

  # Предустановленные профили
  profiles:
    strict:
      max_turns: 15
      max_phase_attempts: 2
      max_same_state: 3
      timeout_seconds: 900              # 15 минут
    relaxed:
      max_turns: 40
      max_phase_attempts: 5
      max_same_state: 6
      timeout_seconds: 3600             # 1 час

# =============================================================================
# FRUSTRATION TRACKER SETTINGS
# =============================================================================
frustration:
  # Максимальный уровень frustration (0-10 шкала)
  max_level: 10

  # Веса для накопления frustration (по тону сообщения)
  weights:
    frustrated: 3      # Сильно увеличивает
    skeptical: 1       # Немного увеличивает
    rushed: 1          # Немного увеличивает
    confused: 1        # Долгое непонимание = frustration

  # Веса для снижения frustration (decay)
  decay:
    neutral: 1         # Немного снижает
    positive: 2        # Хорошо снижает
    interested: 2      # Хорошо снижает

  # ⚠️ Пороги frustration (Single Source of Truth)
  # Все компоненты ДОЛЖНЫ использовать эти пороги через src.frustration_thresholds!
  #
  # Шкала (0-10):
  #   0-1:     Normal - нет раздражения
  #   2:       Elevated - лёгкое раздражение, быть осторожнее
  #   3:       Moderate - заметное раздражение, эмпатичный тон
  #   4:       Warning - сокращать ответы
  #   5-6:     High-Warning - сильное раздражение, рассмотреть intervention
  #   7-8:     High - guard intervention срабатывает
  #   9:       Critical - рекомендовать soft close
  #   10:      Maximum - немедленный выход
  #
  # ВАЖНО: thresholds.high ДОЛЖЕН быть равен guard.high_frustration_threshold!
  thresholds:
    elevated: 2        # Лёгкое раздражение, скорректировать подход
    moderate: 3        # Заметное раздражение, эмпатичный тон
    warning: 4         # Начать сокращать ответы
    high: 7            # Предложить помощь/выход (= guard.high_frustration_threshold)
    critical: 9        # Мягкое завершение

# =============================================================================
# CIRCULAR FLOW (Go Back) SETTINGS
# =============================================================================
circular_flow:
  # Разрешённые переходы назад
  allowed_gobacks:
    spin_problem: spin_situation
    spin_implication: spin_problem
    spin_need_payoff: spin_implication
    presentation: spin_need_payoff
    close: presentation
    handle_objection: presentation
    soft_close: greeting  # Новая попытка

# =============================================================================
# CONTEXT WINDOW SETTINGS
# =============================================================================
context:
  # Порядок состояний для расчёта прогресса (funnel_delta)
  state_order:
    greeting: 0
    spin_situation: 1
    spin_problem: 2
    spin_implication: 3
    spin_need_payoff: 4
    presentation: 5
    handle_objection: 5  # Параллельно с presentation
    close: 6
    success: 7
    soft_close: -1  # Негативный прогресс

  # Порядок фаз (для phase progress calculation)
  phase_order:
    greeting: 0
    situation: 1
    problem: 2
    implication: 3
    need_payoff: 4
    presentation: 5
    close: 6
    success: 7

# =============================================================================
# FALLBACK TEMPLATES
# =============================================================================
fallback:
  # Tier 1: Переформулировки по состояниям
  rephrase_templates:
    greeting:
      - "Добрый день! Чем могу помочь?"
      - "Здравствуйте! Расскажите, что вас интересует?"
    spin_situation:
      - "Давайте я спрошу иначе — сколько примерно человек работает с клиентами?"
      - "Можете подсказать хотя бы порядок — 5-10 человек, 10-20, или больше?"
      - "Просто для понимания: вы работаете один или есть команда?"
      - "Подскажите размер вашей команды — это поможет подобрать решение."
    spin_problem:
      - "Попробую по-другому: что сейчас отнимает больше всего времени в работе?"
      - "Скажите, какая задача самая «больная» прямо сейчас?"
      - "Если одним словом — что хотелось бы улучшить в первую очередь?"
      - "С какими сложностями чаще всего сталкиваетесь в работе?"
    spin_implication:
      - "А если примерно — сколько клиентов/заказов теряется из-за этого?"
      - "Как это влияет на выручку, хотя бы приблизительно?"
      - "Это случается часто или скорее редко?"
      - "Насколько серьёзно это влияет на бизнес?"
    spin_need_payoff:
      - "Если бы это решилось — что изменилось бы в первую очередь?"
      - "Что было бы идеальным результатом?"
      - "Какой результат вас бы устроил?"
      - "Что должно измениться, чтобы вы были довольны?"
    presentation:
      - "Хотите расскажу подробнее как это работает?"
      - "Может покажу на примере?"
      - "Интересует что-то конкретное?"
    close:
      - "Оставьте контакт — пришлю детали."
      - "Куда удобнее прислать информацию?"
      - "Как с вами лучше связаться?"
    handle_objection:
      - "Понимаю ваши сомнения. Что именно смущает?"
      - "Какой момент вызывает вопросы?"
      - "Давайте разберём что беспокоит."

  # Tier 2: Варианты (кнопки) по состояниям
  options_templates:
    spin_situation:
      question: "Подскажите размер команды:"
      options:
        - "1-5 человек"
        - "6-15 человек"
        - "16-30 человек"
        - "Больше 30"
    spin_problem:
      question: "Какая основная сложность?"
      options:
        - "Теряем клиентов"
        - "Много ручной работы"
        - "Нет контроля"
        - "Другое"
    spin_implication:
      question: "Как часто это происходит?"
      options:
        - "Ежедневно"
        - "Несколько раз в неделю"
        - "Редко"
        - "Не знаю"
    spin_need_payoff:
      question: "Что для вас важнее всего?"
      options:
        - "Экономия времени"
        - "Рост продаж"
        - "Контроль команды"
        - "Всё вместе"
    presentation:
      question: "Что хотите узнать?"
      options:
        - "Как работает"
        - "Сколько стоит"
        - "Как внедрить"
        - "Показать демо"

  # Дефолтные значения
  # FIX: Добавлена вариативность в default_rephrase (было одна фраза, повторялась 123 раза)
  default_rephrase:
    - "Давайте попробую спросить иначе..."
    - "Уточню вопрос по-другому..."
    - "Перефразирую..."
    - "Хорошо, спрошу проще..."
    - "Понял, давайте иначе..."
    - "Окей, переформулирую..."
    - "Попробую яснее..."
  default_options:
    question: "Что вас интересует?"
    options:
      - "Подробнее о системе"
      - "Цены"
      - "Демо"
      - "Связаться позже"

# =============================================================================
# LLM FALLBACK SETTINGS
# =============================================================================
# Ответы при технической ошибке LLM (circuit breaker, timeout, etc.)
llm:
  fallback_responses:
    greeting: "Здравствуйте! Чем могу помочь?"
    spin_situation: "Расскажите, сколько человек работает в вашей команде?"
    spin_problem: "С какими сложностями сталкиваетесь сейчас?"
    spin_implication: "Как это влияет на бизнес?"
    spin_need_payoff: "Что было бы идеальным решением?"
    presentation: "Наша CRM помогает автоматизировать работу с клиентами. Хотите узнать подробнее?"
    close: "Оставьте контакт — свяжусь с деталями."
    soft_close: "Спасибо за разговор! Если вопросы появятся — пишите."
    handle_objection: "Понимаю ваши сомнения. Давайте разберём подробнее?"
  default_fallback: "Произошла техническая ошибка. Попробуйте ещё раз или оставьте контакт."

# =============================================================================
# CTA (Call-to-Action) SETTINGS
# =============================================================================
cta:
  # Состояния где CTA не добавляется (ранние состояния)
  early_states:
    - greeting
    - spin_situation
    - spin_problem

  # CTA по состояниям
  templates:
    greeting: []
    spin_situation: []
    spin_problem: []
    spin_implication:
      - "Хотите посмотреть как это можно решить?"
      - "Интересно увидеть решение?"
    spin_need_payoff:
      - "Хотите покажу как это работает?"
      - "Интересно увидеть систему в действии?"
      - "Показать на демо?"
    presentation:
      - "Готовы попробовать?"
      - "Запланируем демо?"
      - "Хотите тестовый доступ?"
      - "Оставите контакт для связи?"
    handle_objection:
      - "Может всё-таки глянем демо? Это бесплатно и ни к чему не обязывает."
      - "Давайте просто покажу — 15 минут, и всё станет понятнее."
    close:
      - "Какой контакт для связи удобнее?"
      - "На какой email прислать информацию?"
      - "Когда удобно созвониться?"

  # CTA по типу действия
  by_action:
    demo:
      - "Запланируем демо?"
      - "Показать на демо?"
      - "Хотите увидеть в действии?"
    contact:
      - "Оставите контакт?"
      - "Какой контакт для связи?"
      - "Куда прислать информацию?"
    trial:
      - "Хотите тестовый доступ?"
      - "Попробовать бесплатно?"

# =============================================================================
# RESPONSE DIRECTIVES SETTINGS
# =============================================================================
# Настройки для ResponseDirectives (Phase 2: Естественность диалога)
# ResponseDirectives управляют стилем ответа, не меняя логику state machine.

response_directives:
  # === Пороги для определения тона ===
  tone_thresholds:
    # Порог frustration для EMPATHETIC тона (>= threshold)
    empathetic_frustration: 3

    # Порог frustration для VALIDATE (>= threshold)
    validate_frustration: 2

  # === Лимиты длины ответа (max_words) ===
  max_words:
    # При высокой фрустрации
    high_frustration: 40

    # При низком engagement
    low_engagement: 50

    # При repair mode
    repair_mode: 50

    # Стандартный лимит
    default: 60

    # Порог для добавления инструкции "не более N слов"
    instruction_threshold: 50

  # === Лимит строк в context summary ===
  max_summary_lines: 6

  # === Перевод типов возражений для display ===
  objection_translations:
    objection_price: "цена"
    objection_competitor: "конкурент"
    objection_no_time: "нет времени"
    objection_think: "подумать"
    objection_timing: "не сейчас"
    objection_complexity: "сложно"
    objection_no_need: "не нужно"
    objection_trust: "доверие"

  # === Поля для do_not_repeat (collected_data -> readable name) ===
  collected_field_names:
    company_size: "размер компании"
    company_name: "название компании"
    business_type: "тип бизнеса"
    pain_point: "проблема"
    current_tools: "текущие инструменты"

  # === Tone instructions (русские тексты) ===
  tone_instructions:
    empathetic: "Используй эмпатичный тон, признай ситуацию клиента."
    confident: "Используй уверенный тон, подчеркни преимущества."
    supportive: "Используй поддерживающий тон, помоги разобраться."
    neutral: ""

# =============================================================================
# DATA EXTRACTION RULES (Single Source of Truth)
# =============================================================================
# Правила извлечения данных из сообщений пользователя.
# Используется LLM Classifier для валидации extracted_data.
#
# Архитектура:
#   constants.yaml (THIS SECTION)
#        |
#        v
#   extraction_ssot.py (loads, validates, exports)
#        |
#        +--> extraction_validator.py (validates extracted fields)
#        +--> classifier/llm/prompts.py (uses rules in prompts)
#        +--> classifier/llm/classifier.py (post-processing)
#
# КРИТИЧНО: Эти правила предотвращают галлюцинации LLM при заполнении полей.
# =============================================================================

extraction:
  # =========================================================================
  # FIELD DEFINITIONS
  # =========================================================================
  # Каждое поле содержит:
  #   - description: что это за поле (для LLM промпта)
  #   - type: тип данных (int, str, bool, enum)
  #   - validation: правила валидации
  #   - examples: примеры (valid/invalid) для LLM и тестов
  #   - spin_phase: в какой SPIN-фазе извлекается (опционально)
  # =========================================================================

  fields:
    # =========================================================================
    # SITUATION PHASE FIELDS
    # =========================================================================

    company_size:
      description: "Количество сотрудников в компании (только число)"
      type: int
      spin_phase: situation
      validation:
        min: 1
        max: 10000
        # Паттерны для извлечения числа из текста
        extract_patterns:
          - '(\d+)\s*(?:человек|чел\.?|сотрудник|менеджер|продавец|официант)'
          - 'нас\s*(\d+)'
          - 'команда?\s*(?:из|в|на)?\s*(\d+)'
          - 'штат[еа]?\s*(\d+)'
      examples:
        valid:
          - value: 5
            source: "у нас 5 человек"
          - value: 15
            source: "команда из 15 менеджеров"
          - value: 100
            source: "100 сотрудников"
        invalid:
          - value: "пять"
            reason: "Должно быть число, не текст"
          - value: "много"
            reason: "Неопределённое количество"
          - value: 0
            reason: "Не может быть 0 сотрудников"

    current_tools:
      description: "Текущие инструменты для ведения клиентской базы/CRM (НЕ количество людей!)"
      type: enum
      spin_phase: situation
      validation:
        # Допустимые значения - конкретные инструменты
        allowed_values:
          - "Excel"
          - "Google Таблицы"
          - "1С"
          - "Битрикс24"
          - "AmoCRM"
          - "Мегаплан"
          - "Notion"
          - "Trello"
          - "на бумаге"
          - "в блокноте"
          - "в головах"
          - "вручную"
          - "никак не ведём"
          - "другая CRM"
        # Паттерны для извлечения
        extract_patterns:
          - '(?:в\s+)?excel'
          - '(?:в\s+)?эксел'
          - '(?:в\s+)?гугл\s*(?:табли|докс|sheets|docs)'
          - '(?:в\s+)?1[сc]'
          - '(?:в\s+)?битрикс'
          - '(?:в\s+)?амо'
          - '(?:в\s+)?мегаплан'
          - '(?:в\s+)?notion'
          - '(?:в\s+)?trello'
          - '(?:на\s+)?бумаг'
          - '(?:в\s+)?блокнот'
          - '(?:в\s+)?голов'
          - 'вручную|руками'
          - 'никак|нигде|ничего'
      examples:
        valid:
          - value: "Excel"
            source: "всё в Excel ведём"
          - value: "1С"
            source: "используем 1С"
          - value: "в головах"
            source: "всё в головах держим"
        invalid:
          - value: "два-три человека"
            reason: "Это количество людей, не инструмент. Должно быть в company_size."
          - value: "5 сотрудников"
            reason: "Это количество людей, не инструмент"
          - value: "теряем клиентов"
            reason: "Это боль, не инструмент. Должно быть в pain_point."

    business_type:
      description: "Тип бизнеса или отрасль компании"
      type: enum
      spin_phase: situation
      validation:
        allowed_values:
          - "розничная торговля"
          - "оптовые продажи"
          - "общепит"
          - "сфера услуг"
          - "салон красоты"
          - "медицина"
          - "недвижимость"
          - "логистика"
          - "производство"
          - "IT"
          - "строительство"
          - "образование"
          - "другое"
        extract_patterns:
          - 'магазин|розни[цч]|ритейл'
          - 'опт(?:ов)?|b2b'
          - 'ресторан|кафе|общепит|еда'
          - 'услуг|сервис'
          - 'салон|красот|spa'
          - 'клиник|медицин|врач'
          - 'недвижим|риэлтор'
          - 'склад|логистик|доставк'
          - 'производств|завод|фабрик'
          - 'it|айти|программ|разработ'
          - 'строител|ремонт'
          - 'образован|обучен|курс'
      examples:
        valid:
          - value: "розничная торговля"
            source: "у нас магазин"
          - value: "общепит"
            source: "ресторан на 50 мест"
        invalid:
          - value: "большая компания"
            reason: "Это размер, не тип бизнеса"

    # =========================================================================
    # PROBLEM PHASE FIELDS
    # =========================================================================

    pain_point:
      description: "Бизнес-проблема или боль клиента (конкретная проблема, не инструмент)"
      type: str
      spin_phase: problem
      validation:
        # Категории болей для нормализации
        pain_categories:
          losing_clients:
            - 'теря[ею]м?\s*клиент'
            - 'клиент\w*\s*(?:ухо|уш[её]л)'
            - 'отток\w*\s*клиент'
            - 'упуска[ею]м?\s*(?:сделк|лид|клиент)'
          no_control:
            - 'нет\s*контрол'
            - 'не\s*вид[и|е][мт]'
            - 'не\s*понима[юем]'
            - 'чёрн\w*\s*ящик'
          manual_work:
            - 'ручн\w*\s*(?:работ|ввод|труд)'
            - 'excel|эксел'
            - 'всё\s*вручную'
            - 'рутин'
          manager_issues:
            - 'забыва[ею]т?\s*(?:перезвон|звон|задач)'
            - 'менеджер\w*\s*(?:не\s*)?(?:перезван|звон)'
            - 'менеджер\w*\s*(?:косяч|ошиба)'
          chaos:
            - 'хаос'
            - 'беспоряд|бардак'
            - 'разброс|раскидан'
        min_length: 3
      examples:
        valid:
          - value: "теряем клиентов"
            source: "постоянно теряем клиентов"
            category: "losing_clients"
          - value: "нет контроля"
            source: "не можем контролировать менеджеров"
            category: "no_control"
          - value: "много ручной работы"
            source: "всё делаем руками, очень долго"
            category: "manual_work"
        invalid:
          - value: "+7 999 123-45-67"
            reason: "Это контакт, не боль. Должно быть в contact_info."
          - value: "Excel"
            reason: "Это инструмент, не боль. Должно быть в current_tools."
          - value: "типа это бы помогло бы контролировать"
            reason: "Это желаемый результат, не боль. Должно быть в desired_outcome."

    pain_category:
      description: "Категория боли (одна из предопределённых)"
      type: enum
      spin_phase: problem
      validation:
        allowed_values:
          - "losing_clients"
          - "no_control"
          - "manual_work"
          - "manager_issues"
          - "chaos"
      examples:
        valid:
          - value: "losing_clients"
            source: "теряем клиентов из-за забывчивости"
        invalid:
          - value: "плохо"
            reason: "Неизвестная категория"

    # =========================================================================
    # IMPLICATION PHASE FIELDS
    # =========================================================================

    pain_impact:
      description: "Последствия проблемы для бизнеса (количественные или качественные)"
      type: str
      spin_phase: implication
      validation:
        # Паттерны для извлечения количественных данных
        quantitative_patterns:
          - '(\d+)\s*(?:клиент|покупател|заказ)\w*\s*(?:теря|упуска)'
          - '(\d+)\s*(?:час|минут)\w*\s*(?:в\s*день|ежедневно)'
          - '(\d+)\s*(?:тысяч|млн|%)'
        min_length: 3
      examples:
        valid:
          - value: "теряем ~5 клиентов в месяц"
            source: "примерно 5 клиентов в месяц уходят"
          - value: "тратим ~3 часа/день на рутину"
            source: "3 часа каждый день на ручную работу"
        invalid:
          - value: "плохо"
            reason: "Слишком абстрактно, нужна конкретика"

    financial_impact:
      description: "Финансовые потери (число в рублях)"
      type: str
      spin_phase: implication
      validation:
        extract_patterns:
          - '(\d+)\s*(?:тысяч|т\.?р\.?|к)\s*(?:руб|₽)?'
          - '(\d+)\s*(?:миллион|млн|м)\s*(?:руб|₽)?'
      examples:
        valid:
          - value: "100000"
            source: "теряем около 100 тысяч в месяц"
          - value: "1000000"
            source: "это примерно миллион в год"
        invalid:
          - value: "много"
            reason: "Нужна конкретная сумма"

    # =========================================================================
    # NEED-PAYOFF PHASE FIELDS
    # =========================================================================

    desired_outcome:
      description: "Желаемый результат от внедрения CRM (что хочет клиент)"
      type: str
      spin_phase: need_payoff
      validation:
        # Нормализованные outcomes
        normalized_outcomes:
          - "прозрачность и контроль"
          - "автоматизация процессов"
          - "контроль работы"
          - "экономия времени/денег"
          - "упрощение работы"
          - "систематизация"
          - "решение проблемы"
        extract_patterns:
          - '(?:хотел|хочу|хотим)\s*(?:бы\s*)?(?:видеть|знать|понима)'
          - '(?:хотел|хочу|хотим)\s*(?:бы\s*)?автоматиз'
          - '(?:хотел|хочу|хотим)\s*(?:бы\s*)?(?:контролир|отслежива)'
          - '(?:хотел|хочу|хотим)\s*(?:бы\s*)?(?:экономи|сберечь)'
          - '(?:помогло|решило|избавило)\s*(?:бы)?'
        min_length: 5
      examples:
        valid:
          - value: "прозрачность и контроль"
            source: "хотел бы видеть что происходит с клиентами"
          - value: "автоматизация процессов"
            source: "хочу автоматизировать рутину"
        invalid:
          - value: "да"
            reason: "Слишком коротко, нужно конкретное желание"
          - value: "+7 999 123-45-67"
            reason: "Это контакт, не желаемый результат"

    value_acknowledged:
      description: "Признал ли клиент ценность решения (да/нет)"
      type: bool
      spin_phase: need_payoff
      validation:
        # Паттерны подтверждения
        positive_patterns:
          - '^да[,!.]?\s*$'
          - '^конечно'
          - '^естественно'
          - 'было\s*бы\s*(?:здорово|отлично|супер)'
          - 'помогло\s*бы'
      examples:
        valid:
          - value: true
            source: "да, это было бы здорово"
          - value: false
            source: "не уверен"
        invalid:
          - value: "может быть"
            reason: "Должно быть true или false"

    # =========================================================================
    # CONTACT FIELDS (любая фаза)
    # =========================================================================

    contact_info:
      description: "Контактные данные: ТОЛЬКО телефон (+7...) или email (xxx@xxx.xx)"
      type: str
      spin_phase: null  # Может быть в любой фазе
      validation:
        # КРИТИЧНО: contact_info это ТОЛЬКО телефон или email!
        # НЕ записывать сюда текст, фразы, боли и т.д.
        patterns:
          phone:
            - '^\+7[\s\-\.]?\(?\d{3}\)?[\s\-\.]?\d{3}[\s\-\.]?\d{2}[\s\-\.]?\d{2}$'
            - '^8[\s\-\.]?\(?\d{3}\)?[\s\-\.]?\d{3}[\s\-\.]?\d{2}[\s\-\.]?\d{2}$'
          email:
            - '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        # Валидные мобильные префиксы (Россия)
        valid_phone_prefixes:
          - 900
          - 999  # Диапазон 900-999
        # Валидные городские коды
        valid_city_codes:
          - 495  # Москва
          - 499  # Москва
          - 812  # СПб
      examples:
        valid:
          - value: "+79991234567"
            source: "+7 999 123-45-67"
            type: "phone"
          - value: "user@example.com"
            source: "пишите на user@example.com"
            type: "email"
        invalid:
          - value: "теряем клиентов"
            reason: "Это боль, не контакт! Должно быть в pain_point."
          - value: "типа это бы помогло бы контролировать процесс"
            reason: "Это текст о процессе, не контакт! Должно быть в desired_outcome или ignored."
          - value: "два-три человека"
            reason: "Это количество людей, не контакт! Должно быть в company_size."
          - value: "да, интересно"
            reason: "Это согласие, не контакт!"

    contact_type:
      description: "Тип контакта (phone или email)"
      type: enum
      spin_phase: null
      validation:
        allowed_values:
          - "phone"
          - "email"

  # =========================================================================
  # FIELD GROUPS BY SPIN PHASE
  # =========================================================================
  # Определяет какие поля ожидаются в какой фазе SPIN.
  # Используется для контекстной валидации.

  phase_fields:
    situation:
      - company_size
      - current_tools
      - business_type
    problem:
      - pain_point
      - pain_category
    implication:
      - pain_impact
      - financial_impact
    need_payoff:
      - desired_outcome
      - value_acknowledged
    any:
      - contact_info
      - contact_type

  # =========================================================================
  # VALIDATION RULES
  # =========================================================================
  # Глобальные правила валидации для предотвращения ошибок LLM.

  validation_rules:
    # Правило 1: contact_info должен содержать только телефон или email
    contact_info_strict: true

    # Правило 2: current_tools не может содержать числа людей
    current_tools_no_people: true

    # Правило 3: pain_point не может быть контактом или инструментом
    pain_point_no_contacts: true

    # Правило 4: Пустой extracted_data лучше неправильного
    prefer_empty_over_wrong: true

    # Правило 5: Валидировать типы данных
    strict_types: true

  # =========================================================================
  # LLM PROMPT INSTRUCTIONS
  # =========================================================================
  # Инструкции для LLM промпта по извлечению данных.
  # Используется в classifier/llm/prompts.py

  prompt_instructions:
    header: |
      ## Правила извлечения данных (extracted_data)

      КРИТИЧНО: Заполняй extracted_data ТОЛЬКО если данные соответствуют полю!
      Пустой extracted_data лучше неправильного.

    field_rules: |
      ### Поля и правила:

      1. **company_size** (int): ТОЛЬКО число сотрудников
         - ✅ "5 человек" → company_size: 5
         - ❌ "два-три человека" в current_tools — НЕПРАВИЛЬНО!

      2. **current_tools** (str): ТОЛЬКО инструменты CRM/учёта
         - ✅ "в Excel", "1С", "в блокноте", "вручную"
         - ❌ "два-три человека" — это company_size!
         - ❌ "теряем клиентов" — это pain_point!

      3. **contact_info** (str): ТОЛЬКО телефон или email
         - ✅ "+7 999 123-45-67", "user@example.com"
         - ❌ "теряем клиентов" — это pain_point!
         - ❌ "типа это бы помогло контролировать" — это desired_outcome!
         - ❌ Любой текст без @ или +7/8 — НЕ контакт!

      4. **pain_point** (str): Бизнес-проблема клиента
         - ✅ "теряем клиентов", "нет контроля", "хаос"
         - ❌ "+7 999..." — это contact_info!
         - ❌ "Excel" — это current_tools!

      5. **desired_outcome** (str): Желаемый результат
         - ✅ "хочу контролировать", "автоматизировать"
         - ❌ Контакты, инструменты, боли

    examples: |
      ### Примеры правильного извлечения:

      Сообщение: "У нас 5 человек, всё в Excel, теряем клиентов"
      extracted_data:
        company_size: 5
        current_tools: "Excel"
        pain_point: "теряем клиентов"

      Сообщение: "Мой номер +7 999 123-45-67"
      extracted_data:
        contact_info: "+79991234567"

      Сообщение: "Да, это было бы здорово"
      extracted_data:
        value_acknowledged: true

      ### Примеры НЕПРАВИЛЬНОГО извлечения (НЕ ДЕЛАЙ ТАК!):

      ❌ "два-три человека" → current_tools (НЕПРАВИЛЬНО! Это company_size)
      ❌ "теряем клиентов" → contact_info (НЕПРАВИЛЬНО! Это pain_point)
      ❌ "типа это помогло бы" → contact_info (НЕПРАВИЛЬНО! Это desired_outcome)

# =============================================================================
# СОГЛАСОВАННОСТЬ ПОРОГОВ (ВАЖНО!)
# =============================================================================
# guard.high_frustration_threshold ДОЛЖЕН быть равен frustration.thresholds.high
# Это обеспечивает единообразное поведение:
# - FrustrationTracker определяет уровень
# - ConversationGuard реагирует на тот же порог
# - DialoguePolicy использует те же пороги в условиях
