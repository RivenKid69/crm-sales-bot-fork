"""
Нормализатор текста для русскоязычных сообщений

Компоненты:
- TYPO_FIXES: словарь опечаток и сленга → нормализованные формы
- SPLIT_PATTERNS: regex для разбиения слипшихся слов
- TextNormalizer: класс для полной нормализации текста
"""

import re
import difflib
from typing import Dict, List, Tuple, Optional


# =============================================================================
# СЛОВАРИ ДЛЯ НОРМАЛИЗАЦИИ ТЕКСТА
# =============================================================================

# Словарь опечаток и разговорных форм → нормализованные варианты
TYPO_FIXES: Dict[str, str] = {
    # =================================================================
    # ЦЕНОВЫЕ СЛОВА
    # =================================================================
    "ценик": "ценник",
    "ценика": "ценника",
    "цена": "цена",
    "скока": "сколько",
    "скоко": "сколько",
    "скольк": "сколько",
    "почом": "почем",
    "почем": "почем",
    "скидон": "скидка",
    "скидос": "скидка",
    "прайс": "прайс",
    "прайслист": "прайс",
    "прайсик": "прайс",
    "тарифчик": "тариф",
    "тарифы": "тарифы",
    "стоимость": "стоимость",
    "стоит": "стоит",
    "денег": "денег",
    "деняг": "денег",
    "бабла": "денег",
    "бабло": "деньги",
    "бабок": "денег",

    # =================================================================
    # ПРИВЕТСТВИЯ И ПРОЩАНИЯ
    # =================================================================
    "прив": "привет",
    "превед": "привет",
    "приф": "привет",
    "прива": "привет",
    "привки": "привет",
    "хай": "привет",
    "хаюшки": "привет",
    "хеллоу": "привет",
    "здрасте": "здравствуйте",
    "здрасьте": "здравствуйте",
    "здаров": "здравствуйте",
    "здарова": "здравствуйте",
    "дратути": "здравствуйте",
    "доброго": "добрый",
    "добр": "добрый",
    "утречко": "утро",
    "вечерочек": "вечер",
    "денечек": "день",
    "пок": "пока",
    "покеда": "пока",
    "покедова": "пока",
    "бай": "пока",
    "бб": "пока",
    "удачки": "удачи",

    # =================================================================
    # РАЗГОВОРНЫЕ И СЛЕНГОВЫЕ
    # =================================================================
    "че": "что",
    "чо": "что",
    "шо": "что",
    "чего": "что",
    "чет": "что-то",
    "чето": "что-то",
    "чот": "что-то",
    "щас": "сейчас",
    "счас": "сейчас",
    "ща": "сейчас",
    "седня": "сегодня",
    "сегдня": "сегодня",
    "тока": "только",
    "ток": "только",
    "токо": "только",
    "тоже": "тоже",
    "тож": "тоже",
    "ваще": "вообще",
    "вапще": "вообще",
    "вобще": "вообще",
    "вопщем": "в общем",
    "короч": "короче",
    "кароч": "короче",
    "норм": "нормально",
    "нормик": "нормально",
    "ок": "хорошо",
    "окей": "хорошо",
    "океюшки": "хорошо",
    "лан": "ладно",
    "ладн": "ладно",
    "ладушки": "ладно",
    "спс": "спасибо",
    "спсб": "спасибо",
    "пасиб": "спасибо",
    "пасибо": "спасибо",
    "спасиб": "спасибо",
    "плз": "пожалуйста",
    "плиз": "пожалуйста",
    "пжлст": "пожалуйста",
    "пжл": "пожалуйста",
    "пж": "пожалуйста",
    "дап": "да",
    "ага": "да",
    "угу": "да",
    "неа": "нет",
    "непа": "нет",
    "нету": "нет",
    "ну": "ну",
    "нуну": "ну",
    "типо": "типа",
    "типа": "типа",
    "оч": "очень",
    "ооч": "очень",
    "оооч": "очень",
    "канеш": "конечно",
    "канешна": "конечно",
    "конеш": "конечно",
    "наверн": "наверное",
    "наврн": "наверное",
    "мб": "может быть",
    "возм": "возможно",
    "возмжно": "возможно",

    # =================================================================
    # БИЗНЕС-ТЕРМИНЫ
    # =================================================================
    "црм": "crm",
    "срм": "crm",
    "црмка": "crm",
    "цээрэм": "crm",
    "битрик": "битрикс",
    "битрикс24": "битрикс",
    "амо": "амо",
    "амоцрм": "амо crm",
    "эксель": "excel",
    "эксел": "excel",
    "ексель": "excel",
    "табличка": "таблица",
    "табличку": "таблицу",
    "менеджр": "менеджер",
    "манагер": "менеджер",
    "сейлз": "менеджер по продажам",
    "сэйлз": "менеджер по продажам",
    "продажник": "менеджер по продажам",
    "клиентов": "клиентов",
    "клиентоф": "клиентов",
    "заявка": "заявка",
    "заявочка": "заявка",
    "лид": "лид",
    "лидик": "лид",
    "лидов": "лидов",
    "сделка": "сделка",
    "сделочка": "сделка",
    "контракт": "контракт",
    "договор": "договор",
    "дкп": "договор",

    # =================================================================
    # ЧИСЛИТЕЛЬНЫЕ И ЕДИНИЦЫ
    # =================================================================
    "чел": "человек",
    "челов": "человек",
    "человеек": "человек",
    "человк": "человек",
    "чвек": "человек",
    "сотр": "сотрудник",
    "сотрудн": "сотрудник",
    "штук": "штук",
    "шт": "штук",
    "руб": "рублей",
    "р": "рублей",
    "тыс": "тысяч",
    "к": "тысяч",
    "кк": "миллион",
    "млн": "миллион",
    "лям": "миллион",
    "мес": "месяц",
    "мсц": "месяц",

    # =================================================================
    # ВОПРОСИТЕЛЬНЫЕ
    # =================================================================
    "скажите": "скажите",
    "подскажте": "подскажите",
    "падскажите": "подскажите",
    "подскжите": "подскажите",
    "расскажте": "расскажите",
    "раскажите": "расскажите",

    # =================================================================
    # ОТРИЦАНИЯ И ВОЗРАЖЕНИЯ
    # =================================================================
    "дорга": "дорого",
    "дорага": "дорого",
    "доргао": "дорого",
    "дешево": "дешево",
    "дешивле": "дешевле",
    "интерсно": "интересно",
    "интиресно": "интересно",
    "неинтересно": "не интересно",
    "неинтерсно": "не интересно",
    "ненужно": "не нужно",
    "ненадо": "не надо",

    # =================================================================
    # СЛИПШИЕСЯ СЛОВА (основные)
    # =================================================================
    "сколькостоит": "сколько стоит",
    "какаяцена": "какая цена",
    "какойценник": "какой ценник",
    "скинутьпрайс": "скинуть прайс",
    "естьскидки": "есть скидки",
    "подскажитецену": "подскажите цену",
    "чтопочем": "что почем",
    "какиетарифы": "какие тарифы",
    "какстоимость": "как стоимость",
    "естьдемо": "есть демо",
    "хочудемо": "хочу демо",
    "хочупопробовать": "хочу попробовать",
    "давайтепопробуем": "давайте попробуем",
    "расскажитеподробнее": "расскажите подробнее",
    "ненужноспасибо": "не нужно спасибо",
    "нетспасибо": "нет спасибо",
    "даинтересно": "да интересно",
    "добрыйдень": "добрый день",
    "доброеутро": "доброе утро",
    "добрыйвечер": "добрый вечер",

    # =================================================================
    # РАСКЛАДКА КЛАВИАТУРЫ (латиница → кириллица)
    # =================================================================
    "ghbdtn": "привет",
    "ghbd": "привет",
    "plfhfcndeqnt": "здравствуйте",
    "lj,hsq ltym": "добрый день",
    "crjkmrj cnjbn": "сколько стоит",
    "wtyf": "цена",
    "ghfqc": "прайс",
    "ljhjuj": "дорого",
    "bynthtcyj": "интересно",
    "yt ye;yj": "не нужно",
    "cgfcb,j": "спасибо",
    "lf": "да",
    "ytn": "нет",

    # =================================================================
    # ЭМОЦИИ И ОЦЕНКИ
    # =================================================================
    "збс": "отлично",
    "зашибись": "отлично",
    "заебись": "отлично",
    "заебато": "отлично",
    "четко": "чётко",
    "чётко": "хорошо",
    "чоткий": "чёткий",
    "ништяк": "хорошо",
    "огонь": "отлично",
    "бомба": "отлично",
    "пушка": "отлично",
    "топ": "отлично",
    "топчик": "отлично",
    "кайф": "хорошо",
    "кайфово": "хорошо",
    "изи": "легко",
    "изян": "легко",
    "хз": "не знаю",
    "хез": "не знаю",
    "хрен знает": "не знаю",
    "фиг знает": "не знаю",
    "бля": "",
    "блин": "",
    "блять": "",
    "нафиг": "",
    "нахрен": "",
    "пофиг": "неважно",
    "пофигу": "неважно",
    "похрен": "неважно",
    "похер": "неважно",
    "гавно": "плохо",
    "говно": "плохо",
    "отстой": "плохо",
    "хреново": "плохо",
    "хрень": "плохо",
    "фигня": "ерунда",
    "херня": "ерунда",
    "чушь": "ерунда",
    "бред": "ерунда",

    # =================================================================
    # СОГЛАСИЕ И ПОДТВЕРЖДЕНИЕ
    # =================================================================
    "дак": "да",
    "дада": "да",
    "даа": "да",
    "ну да": "да",
    "агась": "да",
    "угумс": "да",
    "ыгы": "да",
    "йеп": "да",
    "йес": "да",
    "еп": "да",
    "ес": "да",
    "есс": "да",
    "ессно": "естественно",
    "вроде да": "да",
    "думаю да": "да",
    "наверно да": "да",
    "скорее да": "да",
    "типо да": "да",
    "точняк": "точно",
    "точняра": "точно",
    "инфа сотка": "точно",
    "стопудово": "точно",
    "стопроц": "точно",
    "сто проц": "сто процентов",
    "сотка": "сто процентов",
    "базара нет": "конечно",
    "без базара": "конечно",
    "безусловн": "безусловно",
    "однозначн": "однозначно",

    # =================================================================
    # ОТРИЦАНИЕ
    # =================================================================
    "ноуп": "нет",
    "нет нет": "нет",
    "неее": "нет",
    "нееа": "нет",
    "не-а": "нет",
    "не а": "нет",
    "нее": "нет",
    "нет уж": "нет",
    "ни в коем случае": "нет",
    "ни за что": "нет",
    "нифига": "нет",
    "нихера": "нет",
    "нихрена": "нет",
    "врятли": "вряд ли",
    "врядли": "вряд ли",
    "врятле": "вряд ли",
    "наврядли": "вряд ли",
    "наврятли": "вряд ли",
    "сомневаюс": "сомневаюсь",
    "сомневаюсь": "сомневаюсь",
    "не уверен": "не уверен",
    "незнаю": "не знаю",
    "не знаю": "не знаю",
    "непонятно": "не понятно",

    # =================================================================
    # ВОПРОСЫ И УТОЧНЕНИЯ
    # =================================================================
    "ачо": "а что",
    "ачё": "а что",
    "ашо": "а что",
    "ащо": "а что",
    "чегой": "что",
    "чегой-то": "что-то",
    "чегото": "что-то",
    "кагбе": "как бы",
    "кагбы": "как бы",
    "как бы": "как бы",
    "типа того": "типа того",
    "ну типо": "ну типа",
    "воти": "вот и",
    "воть": "вот",
    "воот": "вот",
    "вооот": "вот",
    "эт": "это",
    "эта": "это",
    "ента": "это",
    "енто": "это",
    "ето": "это",
    "ну это": "ну это",
    "нут": "ну",
    "какбе": "как бы",
    "кароче": "короче",
    "вобщем": "в общем",
    "вобщемто": "в общем-то",
    "в общемто": "в общем-то",
    "короч говоря": "короче говоря",
    "если чо": "если что",
    "если шо": "если что",
    "если чё": "если что",
    "есличо": "если что",
    "кста": "кстати",
    "кстате": "кстати",

    # =================================================================
    # ВРЕМЯ И СРОКИ
    # =================================================================
    "завтро": "завтра",
    "завтрева": "завтра",
    "сёдня": "сегодня",
    "сичас": "сейчас",
    "прям щас": "прямо сейчас",
    "прямсейчас": "прямо сейчас",
    "вчера": "вчера",
    "вчира": "вчера",
    "надысь": "на днях",
    "намедни": "на днях",
    "позавчера": "позавчера",
    "позавчира": "позавчера",
    "попозже": "попозже",
    "попозжа": "попозже",
    "позжа": "позже",
    "чуть позже": "чуть позже",
    "черезчас": "через час",
    "черезнеделю": "через неделю",
    "на след неделе": "на следующей неделе",
    "на следнеделе": "на следующей неделе",
    "на след. неделе": "на следующей неделе",
    "вследующем": "в следующем",

    # =================================================================
    # КОЛИЧЕСТВО И РАЗМЕРЫ
    # =================================================================
    "пару": "пара",
    "парочку": "пару",
    "штуки": "штуки",
    "штучки": "штуки",
    "штучек": "штук",
    "несколко": "несколько",
    "нескольк": "несколько",
    "неско": "несколько",
    "много": "много",
    "дофига": "много",
    "дохрена": "много",
    "дохера": "много",
    "мало": "мало",
    "немного": "немного",
    "чуть чуть": "чуть-чуть",
    "чутка": "чуть-чуть",
    "чутьчуть": "чуть-чуть",
    "немножко": "немного",
    "маленько": "немного",
    "множко": "немного",
    "полно": "много",
    "полным полно": "очень много",
    "куча": "много",
    "тонна": "много",
    "туча": "много",
    "уйма": "много",
    "вагон": "много",
    "целый вагон": "очень много",
    "масса": "много",

    # =================================================================
    # ДЕЙСТВИЯ И ГЛАГОЛЫ
    # =================================================================
    "хотелосб": "хотелось бы",
    "хотелосьб": "хотелось бы",
    "хотелосьбы": "хотелось бы",
    "нуна": "нужна",
    "нуну бы": "нужно бы",
    "нада": "надо",
    "надо": "надо",
    "надоб": "надо бы",
    "надо бы": "надо бы",
    "дайти": "дайте",
    "скажити": "скажите",
    "покажыте": "покажите",
    "покажити": "покажите",
    "расскажыте": "расскажите",
    "раскажте": "расскажите",
    "обьясните": "объясните",
    "обясните": "объясните",
    "пришлити": "пришлите",
    "вышлите": "вышлите",
    "вышлити": "вышлите",
    "отправти": "отправьте",
    "отпрвте": "отправьте",
    "скинти": "скиньте",
    "скиньти": "скиньте",
    "кинти": "киньте",
    "киньти": "киньте",
    "записыте": "запишите",
    "запишити": "запишите",
    "запиши": "запиши",
    "записуй": "записывай",
    "перезвоните": "перезвоните",
    "перезвони": "перезвони",
    "набери": "набери",
    "наберу": "наберу",
    "напишу": "напишу",
    "напиш": "напишу",
    "звякну": "позвоню",
    "звякни": "позвони",
    "созвонимс": "созвонимся",
    "созвонимся": "созвонимся",
    "пообщаемс": "пообщаемся",
    "погодь": "подожди",
    "погодите": "подождите",
    "погодь-ка": "подожди-ка",
    "подожь": "подожди",
    "постой": "подожди",
    "постойте": "подождите",
    "погоди": "подожди",
    "сек": "секунду",
    "секунд": "секунду",
    "мин": "минуту",
    "минут": "минуту",
    "минутк": "минутку",

    # =================================================================
    # БИЗНЕС И ПРОДУКТ (расширенные)
    # =================================================================
    "продажники": "менеджеры по продажам",
    "сэйлзы": "менеджеры по продажам",
    "сейлзы": "менеджеры по продажам",
    "манагеры": "менеджеры",
    "менагеры": "менеджеры",
    "менеджера": "менеджеры",
    "рукли": "руководители",
    "ропы": "руководители отдела продаж",
    "роп": "руководитель отдела продаж",
    "директора": "директоры",
    "дир": "директор",
    "генди": "генеральный директор",
    "гендир": "генеральный директор",
    "кормдир": "коммерческий директор",
    "комдир": "коммерческий директор",
    "замдир": "заместитель директора",
    "бухи": "бухгалтеры",
    "бухгалтера": "бухгалтеры",
    "юристы": "юристы",
    "юрики": "юристы",
    "айтишники": "IT-специалисты",
    "программеры": "программисты",
    "прогеры": "программисты",
    "кодеры": "программисты",
    "девелоперы": "разработчики",
    "дизы": "дизайнеры",
    "маркетологи": "маркетологи",
    "маркетолухи": "маркетологи",
    "пиарщики": "PR-специалисты",
    "сммщики": "SMM-специалисты",
    "сммщик": "SMM-специалист",
    "логисты": "логисты",
    "закупщики": "специалисты по закупкам",
    "эйчары": "HR-специалисты",
    "эйчар": "HR-специалист",
    "хрюши": "HR-специалисты",

    # Системы и инструменты
    "амка": "AmoCRM",
    "амо crm": "AmoCRM",
    "амосрм": "AmoCRM",
    "бит24": "Битрикс24",
    "б24": "Битрикс24",
    "битрикс 24": "Битрикс24",
    "мегаплн": "Мегаплан",
    "мегаплан": "Мегаплан",
    "сейлсфорс": "Salesforce",
    "салесфорс": "Salesforce",
    "пайпдрайв": "Pipedrive",
    "хабспот": "HubSpot",
    "зохо": "Zoho",
    "свояcrm": "своя CRM",
    "самопис": "самописная система",
    "самописка": "самописная система",
    "экселька": "Excel",
    "эксельки": "Excel",
    "гугл доки": "Google Docs",
    "гугл докс": "Google Docs",
    "гугл шитс": "Google Sheets",
    "гугл таблица": "Google Sheets",
    "гугл таблицы": "Google Sheets",
    "ноушн": "Notion",
    "ноушен": "Notion",
    "трелло": "Trello",
    "асана": "Asana",
    "джира": "Jira",
    "слак": "Slack",
    "слэк": "Slack",
    "зум": "Zoom",
    "телега": "Telegram",
    "тг": "Telegram",
    "вотсап": "WhatsApp",
    "ватсап": "WhatsApp",
    "ватсапп": "WhatsApp",
    "вацап": "WhatsApp",
    "воцап": "WhatsApp",
    "инста": "Instagram",
    "вк": "VK",
    "вконтакте": "VK",
    "вконтакт": "VK",
    "контактик": "VK",
    "фб": "Facebook",
    "фейсбук": "Facebook",

    # Деньги и финансы
    "деньга": "деньги",
    "денюжка": "деньги",
    "денюшка": "деньги",
    "бабки": "деньги",
    "бабос": "деньги",
    "баблишко": "деньги",
    "капуста": "деньги",
    "лавэ": "деньги",
    "лаве": "деньги",
    "кэш": "деньги",
    "кеш": "деньги",
    "налик": "наличные",
    "наличка": "наличные",
    "безнал": "безналичный расчёт",
    "безналом": "безналичным расчётом",
    "картой": "картой",
    "переводом": "переводом",
    "предоплата": "предоплата",
    "предоплатой": "предоплатой",
    "постоплата": "постоплата",
    "постоплатой": "постоплатой",
    "рассрочка": "рассрочка",
    "рассрочкой": "рассрочкой",
    "кредит": "кредит",
    "лизинг": "лизинг",
    "рубасы": "рубли",
    "рублишки": "рубли",
    "рублики": "рубли",
    "тугрики": "деньги",
    "косарь": "тысяча рублей",
    "косарей": "тысяч рублей",
    "штука": "тысяча рублей",
    "ляма": "миллиона",
    "лямов": "миллионов",
    "лямчик": "миллион",
    "мульт": "миллион",
    "мультик": "миллион",
    "ярд": "миллиард",
    "ярдов": "миллиардов",

    # =================================================================
    # ТРАНСЛИТ (латиница → кириллица)
    # =================================================================
    "privet": "привет",
    "prevet": "привет",
    "hello": "привет",
    "hi": "привет",
    "hey": "привет",
    "skolko": "сколько",
    "skolko stoit": "сколько стоит",
    "cena": "цена",
    "price": "прайс",
    "prays": "прайс",
    "dorogo": "дорого",
    "deshevo": "дешево",
    "interesno": "интересно",
    "ne interesno": "не интересно",
    "ne nado": "не надо",
    "ne nuzhno": "не нужно",
    "da": "да",
    "net": "нет",
    "ok": "хорошо",
    "okay": "хорошо",
    "good": "хорошо",
    "cool": "круто",
    "nice": "хорошо",
    "super": "супер",
    "spasibo": "спасибо",
    "thanks": "спасибо",
    "thx": "спасибо",
    "tnx": "спасибо",
    "pozhaluysta": "пожалуйста",
    "please": "пожалуйста",
    "pls": "пожалуйста",
    "sorry": "извините",
    "demo": "демо",
    "test": "тест",
    "free": "бесплатно",
    "trial": "пробный период",
    "crm": "CRM",
    "manager": "менеджер",
    "sales": "продажи",
    "lead": "лид",
    "client": "клиент",
    "customer": "клиент",
    "deal": "сделка",
    "pipeline": "воронка",
    "funnel": "воронка",

    # =================================================================
    # РАСШИРЕННАЯ РАСКЛАДКА КЛАВИАТУРЫ (EN→RU)
    # =================================================================
    # Приветствия
    "ghbdtnbr": "приветик",
    "ljhjq ltym": "добрый день",
    "ljhjt enhj": "доброе утро",
    "ljhjq dtxth": "добрый вечер",
    "plfhfdcndeqnt": "здравствуйте",
    "plfhjdf": "здорова",
    "rfr ltkf": "как дела",

    # Вопросы о цене
    "nfhba": "тариф",
    "nfhbas": "тарифы",
    "crblrf": "скидка",
    "ltitdkt": "дешевле",

    # Возражения
    "yt yflj": "не надо",
    "yt bynthtcyj": "не интересно",
    "pfyzn": "занят",
    "ytn dhtvtyb": "нет времени",
    "ytn ,bl;tnf": "нет бюджета",

    # Согласие
    "jrfq": "окей",
    "kflyj": "ладно",
    "cjukfcty": "согласен",
    "lfdfqnt": "давайте",
    "gjrfpbnt": "покажите",
    "hfccrf;bnt": "расскажите",
    "ltvj": "демо",

    # Другое
    "gj;fkeqcnf": "пожалуйста",
    "gjrf": "пока",
    "ljcdblfybz": "до свидания",

    # =================================================================
    # ЭМОДЗИ-СЛОВА И СОКРАЩЕНИЯ
    # =================================================================
    "лол": "смешно",
    "lol": "смешно",
    "ржу": "смешно",
    "ржунемогу": "очень смешно",
    "кек": "смешно",
    "kek": "смешно",
    "ору": "смешно",
    "орнул": "засмеялся",
    "сасный": "классный",
    "красава": "молодец",
    "красавчик": "молодец",
    "красавец": "молодец",
    "респект": "уважение",
    "респ": "уважение",
    "рофл": "шутка",
    "изи катка": "легко",
    "имба": "круто",
    "чилл": "расслабься",
    "чилить": "отдыхать",
    "жиза": "жизненно",
    "лайк": "нравится",
    "лайкосик": "нравится",
    "фейл": "ошибка",
    "зафейлил": "ошибся",
    "войс": "голосовое сообщение",
    "скрин": "скриншот",
    "скриншот": "скриншот",
    "скриншотик": "скриншот",
    "ссыль": "ссылка",
    "ссылочка": "ссылка",
    "линк": "ссылка",
    "урл": "ссылка",
    "юрл": "ссылка",
    "qr": "QR-код",
    "кюар": "QR-код",
}

# Паттерны для разбиения слипшихся слов (regex)
SPLIT_PATTERNS: List[Tuple[str, str]] = [
    # =================================================================
    # ВОПРОСЫ О ЦЕНЕ И ХАРАКТЕРИСТИКАХ
    # =================================================================
    (r'сколько(\w)', r'сколько \1'),
    (r'какая(\w)', r'какая \1'),
    (r'какой(\w)', r'какой \1'),
    (r'какие(\w)', r'какие \1'),
    (r'какую(\w)', r'какую \1'),
    (r'каких(\w)', r'каких \1'),
    (r'почему(\w)', r'почему \1'),
    (r'почём(\w)', r'почём \1'),
    (r'зачем(\w)', r'зачем \1'),
    (r'откуда(\w)', r'откуда \1'),
    (r'куда(\w{3,})', r'куда \1'),
    (r'когда(\w)', r'когда \1'),
    (r'где(\w{3,})', r'где \1'),
    (r'кто(\w{3,})', r'кто \1'),

    # =================================================================
    # ГЛАГОЛЫ ДЕЙСТВИЙ
    # =================================================================
    (r'есть(\w)', r'есть \1'),
    (r'хочу(\w)', r'хочу \1'),
    (r'хотим(\w)', r'хотим \1'),
    # КРИТИЧЕСКИЙ FIX: (?!ось) чтобы не разбивать "хотелось"
    (r'хотел(?!ось)(\w)', r'хотел \1'),
    (r'хотелось(\w)', r'хотелось \1'),
    (r'нужно(\w)', r'нужно \1'),
    (r'нужна(\w)', r'нужна \1'),
    (r'нужны(\w)', r'нужны \1'),
    (r'можно(\w)', r'можно \1'),
    (r'можете(\w)', r'можете \1'),
    (r'могу(\w)', r'могу \1'),
    (r'давайте(\w)', r'давайте \1'),
    (r'давай(\w{3,})', r'давай \1'),
    (r'скинуть(\w)', r'скинуть \1'),
    (r'скиньте(\w)', r'скиньте \1'),
    # =================================================================
    # КРИТИЧЕСКИЙ FIX: Negative lookahead чтобы не разбивать "-те" формы
    # =================================================================
    # Проблема: "покажи(\w)" матчило "покажиТЕ" → "покажи те" (НЕВЕРНО!)
    # Решение: (?!те) - не матчить если после идёт "те"
    # =================================================================
    (r'расскажите(\w)', r'расскажите \1'),
    (r'расскажи(?!те)(\w)', r'расскажи \1'),
    (r'подскажите(\w)', r'подскажите \1'),
    (r'подскажи(?!те)(\w)', r'подскажи \1'),
    (r'покажите(\w)', r'покажите \1'),
    (r'покажи(?!те)(\w)', r'покажи \1'),
    (r'объясните(\w)', r'объясните \1'),
    (r'объясни(?!те)(\w)', r'объясни \1'),
    (r'пришлите(\w)', r'пришлите \1'),
    (r'отправьте(\w)', r'отправьте \1'),
    (r'вышлите(\w)', r'вышлите \1'),
    (r'запишите(\w)', r'запишите \1'),
    (r'запиши(?!те)(\w)', r'запиши \1'),
    (r'позвоните(\w)', r'позвоните \1'),
    (r'перезвоните(\w)', r'перезвоните \1'),
    (r'напишите(\w)', r'напишите \1'),
    (r'скажите(\w)', r'скажите \1'),
    (r'уточните(\w)', r'уточните \1'),

    # =================================================================
    # МОДАЛЬНЫЕ И ВСПОМОГАТЕЛЬНЫЕ
    # =================================================================
    (r'буду(\w)', r'буду \1'),
    (r'будем(\w)', r'будем \1'),
    (r'будет(\w)', r'будет \1'),
    (r'будут(\w)', r'будут \1'),
    (r'было(\w{3,})', r'было \1'),
    (r'была(\w{3,})', r'была \1'),
    (r'были(\w{3,})', r'были \1'),
    (r'надо(\w{3,})', r'надо \1'),
    (r'пора(\w{3,})', r'пора \1'),
    (r'стоит(\w{3,})', r'стоит \1'),

    # =================================================================
    # ПРИВЕТСТВИЯ И ПРОЩАНИЯ
    # =================================================================
    (r'добрый(\w)', r'добрый \1'),
    (r'доброе(\w)', r'доброе \1'),
    (r'доброго(\w)', r'доброго \1'),
    (r'привет(\w{3,})', r'привет \1'),
    (r'здравствуйте(\w)', r'здравствуйте \1'),
    (r'здрасте(\w)', r'здрасте \1'),
    # КРИТИЧЕСКИЙ FIX: (?![жз]) чтобы не разбивать "показать/покажите"
    (r'пока(?![жз])(\w{3,})', r'пока \1'),
    (r'досвидания(\w)', r'до свидания \1'),

    # =================================================================
    # ОТРИЦАНИЯ
    # =================================================================
    (r'не(\w{3,})', r'не \1'),  # минимум 3 буквы после "не"
    (r'нет(\w{3,})', r'нет \1'),
    (r'ни(\w{3,})', r'ни \1'),
    (r'без(\w{3,})', r'без \1'),

    # =================================================================
    # СОЮЗЫ И ПРЕДЛОГИ
    # =================================================================
    (r'что(\w{3,})', r'что \1'),
    (r'как(\w{3,})', r'как \1'),
    (r'так(\w{3,})', r'так \1'),
    (r'чтобы(\w)', r'чтобы \1'),
    (r'потому(\w)', r'потому \1'),
    (r'поэтому(\w)', r'поэтому \1'),
    (r'если(\w{3,})', r'если \1'),
    (r'когда(\w)', r'когда \1'),
    # КРИТИЧЕСКИЙ FIX: (?![жз]) чтобы не разбивать "показать/покажите"
    (r'пока(?![жз])(\w{4,})', r'пока \1'),
    (r'чем(\w{3,})', r'чем \1'),
    (r'или(\w{3,})', r'или \1'),
    (r'либо(\w{3,})', r'либо \1'),
    (r'также(\w)', r'также \1'),
    (r'тоже(\w{3,})', r'тоже \1'),
    (r'вот(\w{3,})', r'вот \1'),
    (r'это(\w{3,})', r'это \1'),
    (r'этот(\w{3,})', r'этот \1'),
    (r'эта(\w{3,})', r'эта \1'),

    # =================================================================
    # НАРЕЧИЯ ВРЕМЕНИ И МЕСТА
    # =================================================================
    (r'сейчас(\w)', r'сейчас \1'),
    (r'потом(\w{3,})', r'потом \1'),
    (r'завтра(\w)', r'завтра \1'),
    (r'сегодня(\w)', r'сегодня \1'),
    (r'вчера(\w)', r'вчера \1'),
    (r'здесь(\w)', r'здесь \1'),
    (r'тут(\w{3,})', r'тут \1'),
    (r'там(\w{3,})', r'там \1'),
    (r'везде(\w)', r'везде \1'),
    (r'всегда(\w)', r'всегда \1'),
    (r'никогда(\w)', r'никогда \1'),
    (r'иногда(\w)', r'иногда \1'),

    # =================================================================
    # ОЦЕНОЧНЫЕ И ЭМОЦИОНАЛЬНЫЕ
    # =================================================================
    (r'очень(\w)', r'очень \1'),
    (r'слишком(\w)', r'слишком \1'),
    (r'просто(\w{3,})', r'просто \1'),
    (r'только(\w)', r'только \1'),
    (r'уже(\w{3,})', r'уже \1'),
    (r'ещё(\w{3,})', r'ещё \1'),
    (r'еще(\w{3,})', r'еще \1'),
    (r'вообще(\w)', r'вообще \1'),
    (r'конечно(\w)', r'конечно \1'),
    (r'наверное(\w)', r'наверное \1'),
    (r'возможно(\w)', r'возможно \1'),
    (r'обязательно(\w)', r'обязательно \1'),
    (r'действительно(\w)', r'действительно \1'),

    # =================================================================
    # СОГЛАСИЕ И ПОДТВЕРЖДЕНИЕ
    # =================================================================
    # НЕ добавляем (r'да(\w)', r'да \1') - ломает "давайте" → "да вайте"
    (r'ладно(\w)', r'ладно \1'),
    (r'хорошо(\w)', r'хорошо \1'),
    (r'отлично(\w)', r'отлично \1'),
    (r'супер(\w{3,})', r'супер \1'),
    (r'окей(\w)', r'окей \1'),
    (r'согласен(\w)', r'согласен \1'),
    (r'понял(\w{3,})', r'понял \1'),
    (r'понятно(\w)', r'понятно \1'),

    # =================================================================
    # БИЗНЕС-ТЕРМИНЫ
    # =================================================================
    (r'прайс(\w)', r'прайс \1'),
    (r'тариф(\w{3,})', r'тариф \1'),
    (r'цена(\w)', r'цена \1'),
    (r'стоимость(\w)', r'стоимость \1'),
    (r'скидка(\w)', r'скидка \1'),
    (r'демо(\w{3,})', r'демо \1'),
    # КРИТИЧЕСКИЙ FIX: не разбивать "потестировать", "тестировать"
    (r'(?<![а-яё])тест(\w{3,})', r'тест \1'),
    (r'пробный(\w)', r'пробный \1'),
    (r'бесплатно(\w)', r'бесплатно \1'),
    (r'интеграция(\w)', r'интеграция \1'),
    (r'функция(\w)', r'функция \1'),
    (r'возможность(\w)', r'возможность \1'),
    (r'поддержка(\w)', r'поддержка \1'),

    # =================================================================
    # ЧАСТЫЕ СЛИПАНИЯ (конкретные фразы)
    # =================================================================
    # Эти обрабатываются в TYPO_FIXES, но дублируем для надёжности
    (r'добрыйдень', r'добрый день'),
    (r'доброеутро', r'доброе утро'),
    (r'добрыйвечер', r'добрый вечер'),
    (r'сколькостоит', r'сколько стоит'),
    (r'какаяцена', r'какая цена'),
    (r'естьскидки', r'есть скидки'),
    (r'хочупопробовать', r'хочу попробовать'),
    (r'давайтепопробуем', r'давайте попробуем'),
    (r'неинтересно', r'не интересно'),
    (r'ненужно', r'не нужно'),
    (r'ненадо', r'не надо'),
    (r'нетспасибо', r'нет спасибо'),
    (r'дазапишите', r'да запишите'),
    (r'даинтересно', r'да интересно'),
    (r'хочудемо', r'хочу демо'),
    (r'расскажитеподробнее', r'расскажите подробнее'),
    (r'покажитекакработает', r'покажите как работает'),
    (r'скинутьпрайс', r'скинуть прайс'),
    (r'какиетарифы', r'какие тарифы'),
    (r'естьдемо', r'есть демо'),
    (r'естьпробный', r'есть пробный'),
    (r'сколькоменеджеров', r'сколько менеджеров'),
    (r'сколькочеловек', r'сколько человек'),
    (r'вашисистемы', r'ваши системы'),
    (r'вашпродукт', r'ваш продукт'),
    (r'вашаcrm', r'ваша crm'),
    (r'какподключить', r'как подключить'),
    (r'какначать', r'как начать'),
    (r'какработает', r'как работает'),
    (r'чтовходит', r'что входит'),
    (r'чтоумеет', r'что умеет'),
    (r'чтоможет', r'что может'),
    (r'какиефункции', r'какие функции'),
    (r'какиевозможности', r'какие возможности'),
    (r'естьинтеграция', r'есть интеграция'),
    (r'работаетс1с', r'работает с 1с'),
    (r'интеграциястелефонией', r'интеграция с телефонией'),
]


class TextNormalizer:
    """
    Нормализатор текста для русскоязычных сообщений

    Обрабатывает:
    - Регистр и пробелы
    - Ё → Е
    - Повторяющиеся буквы
    - Опечатки и сленг
    - Слипшиеся слова
    """

    def __init__(self):
        self.typo_fixes = TYPO_FIXES
        self.split_patterns = SPLIT_PATTERNS
        # Предкомпилированные regex для производительности
        self._compiled_splits = [(re.compile(p), r) for p, r in self.split_patterns]
        # Regex для повторяющихся БУКВ (3+ подряд → 2), НЕ цифр!
        self._repeated_chars = re.compile(r'([а-яёa-z])\1{2,}', re.IGNORECASE)
        # Regex для множественных пробелов
        self._multiple_spaces = re.compile(r'\s+')

    def normalize(self, text: str) -> str:
        """
        Полная нормализация текста

        Этапы:
        1. lower() + strip()
        2. Ё → Е
        3. Убрать повторяющиеся буквы: "приииивет" → "привет"
        4. Убрать лишние пробелы
        5. Исправить слипшиеся слова
        6. Исправить опечатки

        Args:
            text: Исходный текст

        Returns:
            Нормализованный текст
        """
        if not text:
            return ""

        # 1. Базовая нормализация
        result = text.lower().strip()

        # 2. Ё → Е
        result = result.replace('ё', 'е')

        # 3. Убираем повторяющиеся буквы (3+ → 1, потом слово проверим)
        # Сначала сжимаем до 2 букв, потом до 1 если слово не в словаре
        result = self._reduce_repeated_chars(result)

        # 4. Нормализуем пробелы
        result = self._multiple_spaces.sub(' ', result).strip()

        # 5. Разбиваем слипшиеся слова (regex паттерны)
        result = self._apply_split_patterns(result)

        # 6. Исправляем опечатки (по словарю)
        result = self._fix_typos(result)

        # Финальная очистка пробелов
        result = self._multiple_spaces.sub(' ', result).strip()

        return result

    def _reduce_repeated_chars(self, text: str) -> str:
        """
        Убираем повторяющиеся буквы

        "приииивет" → "привет"
        "скооолько" → "сколько"
        "даааа" → "да"
        """
        # Сначала сжимаем 3+ повторов до 2
        result = self._repeated_chars.sub(r'\1\1', text)

        # Затем пробуем сжать до 1, если это даёт валидное слово
        words = result.split()
        normalized_words = []

        for word in words:
            # Пробуем варианты с одинарными буквами (только буквы, не цифры!)
            single_char = re.sub(r'([а-яёa-z])\1+', r'\1', word, flags=re.IGNORECASE)

            # Если слово в словаре опечаток — берём его
            if single_char in self.typo_fixes:
                normalized_words.append(single_char)
            elif word in self.typo_fixes:
                normalized_words.append(word)
            else:
                # Пробуем single_char как более вероятный вариант
                # для русских слов двойные буквы редки
                normalized_words.append(single_char)

        return ' '.join(normalized_words)

    def _apply_split_patterns(self, text: str) -> str:
        """Применяем паттерны разбиения слипшихся слов"""
        result = text

        # Сначала проверяем полные слова в словаре
        words = result.split()
        fixed_words = []

        for word in words:
            # Если слово целиком есть в словаре опечаток — подставляем
            if word in self.typo_fixes:
                fixed_words.append(self.typo_fixes[word])
            else:
                fixed_words.append(word)

        result = ' '.join(fixed_words)

        # Затем применяем regex паттерны
        for pattern, replacement in self._compiled_splits:
            result = pattern.sub(replacement, result)

        return result

    def _fix_typos(self, text: str) -> str:
        """Исправляем опечатки по словарю"""
        words = text.split()
        fixed_words = []

        for word in words:
            # Убираем пунктуацию для поиска
            clean_word = re.sub(r'[^\w]', '', word)

            if clean_word in self.typo_fixes:
                # Сохраняем пунктуацию
                prefix = ''
                suffix = ''
                if word and not word[0].isalnum():
                    prefix = word[0]
                if word and not word[-1].isalnum():
                    suffix = word[-1]
                fixed_words.append(prefix + self.typo_fixes[clean_word] + suffix)
            else:
                fixed_words.append(word)

        return ' '.join(fixed_words)

    def fuzzy_match(self, word: str, targets: List[str], threshold: float = 0.75) -> Optional[str]:
        """
        Нечёткий поиск ближайшего слова

        Args:
            word: Искомое слово
            targets: Список целевых слов
            threshold: Минимальный порог схожести (0.0-1.0)

        Returns:
            Ближайшее слово если similarity >= threshold, иначе None
        """
        if not word or not targets:
            return None

        best_match = None
        best_ratio = 0.0

        for target in targets:
            ratio = difflib.SequenceMatcher(None, word.lower(), target.lower()).ratio()
            if ratio > best_ratio and ratio >= threshold:
                best_ratio = ratio
                best_match = target

        return best_match

    def suggest_correction(self, word: str, threshold: float = 0.7) -> Optional[str]:
        """
        Предлагает исправление для неизвестного слова

        Использует fuzzy matching по словарю опечаток
        """
        return self.fuzzy_match(word, list(self.typo_fixes.keys()), threshold)

