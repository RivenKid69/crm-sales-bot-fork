"""
Извлечение структурированных данных из сообщений

Компоненты:
- DataExtractor: извлекает company_size, pain_point, contact_info,
  SPIN-данные и другую структурированную информацию из текста
"""

import re
from typing import Dict


class DataExtractor:
    """Извлекаем структурированные данные из сообщения (включая SPIN-данные)"""

    def extract(self, message: str, context: Dict = None) -> Dict:
        """
        Извлекаем данные из сообщения

        Args:
            message: Сообщение пользователя
            context: Контекст (missing_data, collected_data, spin_phase) для понимания коротких ответов
        """
        extracted = {}
        message_lower = message.lower().strip()
        context = context or {}
        missing_data = context.get("missing_data", [])
        spin_phase = context.get("spin_phase")

        # Распознавание номерных ответов для fallback options
        number_responses = {
            "1": 0, "первое": 0, "первый": 0, "один": 0,
            "2": 1, "второе": 1, "второй": 1, "два": 1,
            "3": 2, "третье": 2, "третий": 2, "три": 2,
            "4": 3, "четвёртое": 3, "четвертое": 3, "четвёртый": 3, "четвертый": 3, "четыре": 3,
        }

        msg_stripped = message_lower.strip()
        if msg_stripped in number_responses:
            extracted["option_index"] = number_responses[msg_stripped]

        # === Размер компании ===
        size_patterns = [
            r'(\d+)\s*(?:человек|чел\.?|менеджер|сотрудник|продаж|продавц|официант|повар|работник|кассир)',
            r'нас\s*(\d+)',
            r'команд[аы]?\s*(?:из|в|на)?\s*(\d+)',
            r'отдел[еа]?\s*(\d+)',
            r'(\d+)\s*(?:в команде|в отделе|человек|продавц|официант)',
            r'штат[еа]?\s*(\d+)',
            r'работа[ею]т?\s*(\d+)',
        ]
        for pattern in size_patterns:
            match = re.search(pattern, message_lower)
            if match:
                size = int(match.group(1))
                if 1 <= size <= 10000:
                    extracted["company_size"] = size
                    break

        # Контекстное извлечение: если просто число и спрашивали о размере
        if "company_size" not in extracted and "company_size" in missing_data:
            # Проверяем что сообщение — просто число (возможно со словами)
            just_number = re.match(r'^(\d+)\s*(?:человек|чел)?\.?$', message_lower)
            if just_number:
                size = int(just_number.group(1))
                if 1 <= size <= 10000:
                    extracted["company_size"] = size

        # === Боль клиента ===
        pain_patterns = {
            # =================================================================
            # ПОТЕРЯ КЛИЕНТОВ И ОТТОК
            # =================================================================
            r'теря[ею]м?\s*клиент': "потеря клиентов",
            r'клиент\w*\s*(?:ухо|уш[её]л|сбеж|ушли)': "клиенты уходят",
            r'(?:отток|утечк)\w*\s*клиент': "отток клиентов",
            r'клиент\w*\s*(?:недовольн|жалу|ругают)': "недовольные клиенты",
            r'не\s*(?:возвращ|удержива)\w*\s*клиент': "не удерживаем клиентов",
            r'уход\w*\s*клиент': "клиенты уходят",
            r'клиент\w*\s*(?:уход|теря|бег)': "клиенты уходят",
            r'(?:мало|нет)\s*повторн': "нет повторных продаж",
            r'не\s*(?:возвращаются|приходят\s*снова)': "клиенты не возвращаются",
            r'(?:потерял|упустил)\w*\s*(?:клиент|заказ|сделк)': "упускаем клиентов",
            # Дополнительные паттерны
            r'клиент\w*\s*(?:сливают|слив)': "сливаем клиентов",
            r'(?:сливают|слив)\w*\s*клиент': "сливаем клиентов",
            r'(?:портим|испортил)\w*\s*(?:отношен|репутац)\w*\s*(?:с\s*)?клиент': "портим отношения с клиентами",
            r'клиент\w*\s*(?:злят|злит|бесит|раздражён)': "клиенты недовольны",
            r'(?:негатив|плох)\w*\s*(?:отзыв|обратн\w*\s*связ)': "негативные отзывы",
            r'клиент\w*\s*(?:пишут|оставля)\w*\s*(?:негатив|плох)': "негативные отзывы",
            r'(?:рейтинг|оценк)\w*\s*(?:пада|сниж|низк|плох)': "падает рейтинг",
            r'(?:nps|нпс|лояльн)\w*\s*(?:низк|пада|плох)': "низкая лояльность",

            # =================================================================
            # УПУЩЕННЫЕ СДЕЛКИ И ЛИДЫ
            # =================================================================
            r'упуска[ею]м?\s*(?:сделк|лид|заявк|клиент)?': "упускаем сделки",
            r'(?:сделк|лид|заявк)\w*\s*(?:теря|пропа|упуск)': "теряем заявки",
            r'(?:пропуск|теря)\w*\s*(?:заявк|лид|обращен)': "пропускаем заявки",
            r'заявк\w*\s*(?:не\s*)?(?:обрабат|отвеча)': "заявки не обрабатываются",
            r'(?:долго|медленно)\s*(?:отвеча|реагир)\w*\s*(?:на\s*)?(?:заявк|лид)?': "медленная обработка заявок",
            r'лид\w*\s*(?:остыва|протуха|умира)': "лиды остывают",
            r'(?:горяч|тёпл|тепл)\w*\s*(?:лид|клиент)\w*\s*(?:остыва|теря)': "теряем горячих клиентов",
            r'не\s*(?:дозванива|дозвон)': "не дозваниваемся",
            # Дополнительные паттерны
            r'(?:заявк|лид|обращен)\w*\s*вис': "заявки зависают",
            r'(?:заявк|лид)\w*\s*(?:без\s*)?(?:ответ|реакц)': "заявки без ответа",
            r'(?:заявк|лид)\w*\s*(?:копят|накаплива|скаплива)': "копятся заявки",
            r'(?:очередь|куч)\w*\s*(?:заявк|лид|обращен)': "очередь заявок",
            r'(?:входящ|поток)\w*\s*(?:не\s*)?(?:справля|обрабат)': "не справляемся с входящими",
            r'(?:упуст|проморга|прозева)\w*\s*(?:сделк|лид|заявк|клиент)': "упускаем возможности",
            r'(?:сделк|возможност)\w*\s*(?:упуст|проморга|прозева)': "упускаем возможности",
            r'(?:воронк|пайплайн)\w*\s*(?:пуст|нет|дыряв)': "пустая воронка",
            r'(?:мало|нет)\s*(?:входящ|заявок|лидов|обращен)': "мало входящих",

            # =================================================================
            # ПРОБЛЕМЫ С МЕНЕДЖЕРАМИ
            # =================================================================
            r'забыва[ею]т?\s*(?:перезвон|позвон|задач|клиент)?': "забывают задачи",
            r'менеджер\w*\s*(?:не\s*)?(?:перезван|звон)': "менеджеры не перезванивают",
            r'менеджер\w*\s*(?:косяч|лажа|ошиба)': "ошибки менеджеров",
            r'менеджер\w*\s*(?:забыва|пропуска|теря)': "менеджеры забывают",
            r'менеджер\w*\s*(?:не\s*работа|халтур|ленят)': "менеджеры не работают",
            r'менеджер\w*\s*(?:увол|уш[её]л|ушли)': "уход менеджеров",
            r'(?:новый|нов\w*)\s*менеджер\w*\s*(?:долго|не\s*мо)': "адаптация менеджеров",
            r'пропуска[ею]т?\s*(?:задач|звонк|встреч)?': "пропускают задачи",
            r'не\s*перезванива': "не перезванивают",
            r'сотрудник\w*\s*(?:не\s*)?(?:работа|выполня)': "проблемы с сотрудниками",
            r'(?:саботаж|саботир)': "саботаж сотрудников",
            r'(?:текучк|текучест)\w*\s*кадр': "текучка кадров",
            # Дополнительные паттерны
            r'менеджер\w*\s*(?:сливают|слив|гоняют)': "менеджеры сливают",
            r'менеджер\w*\s*(?:не\s*)?(?:фиксир|запис|вносят)': "менеджеры не фиксируют",
            r'менеджер\w*\s*(?:воруют|крадут|уводят)\w*\s*(?:клиент|базу)?': "менеджеры уводят клиентов",
            r'(?:воруют|крадут|уводят)\w*\s*(?:клиент|базу)': "уводят базу клиентов",
            r'менеджер\w*\s*(?:левач|подраб|калым)': "левые подработки",
            r'(?:отмаз|оправд|отговор)': "отмазываются",
            r'менеджер\w*\s*(?:врут|обманыва|лукав)': "менеджеры обманывают",
            r'(?:не\s*)?(?:доверя|верю)\w*\s*менеджер': "не доверяем менеджерам",
            r'менеджер\w*\s*(?:работают\s*)?(?:в\s*)?(?:своих|свои)\s*(?:интерес|карман)': "работают на себя",
            r'(?:продаж|сейлз)\w*\s*(?:не\s*)?(?:продают|закрыва)': "менеджеры не продают",
            r'(?:плох|слаб)\w*\s*(?:продаж|сейлз)\w*\s*навык': "слабые навыки продаж",
            r'(?:не\s*)?(?:умеют|могут)\s*продава': "не умеют продавать",
            r'продавц\w*\s*(?:слаб|плох|не\s*(?:умеют|могут))': "слабые продавцы",
            r'(?:обуч|тренир)\w*\s*(?:нет|не\s*было|не\s*провод)': "нет обучения",
            r'(?:новичк|стажёр|новен)\w*\s*(?:долго|не\s*мо|не\s*справля)': "проблемы с новичками",

            # =================================================================
            # НЕТ КОНТРОЛЯ И ПРОЗРАЧНОСТИ
            # =================================================================
            r'нет\s*контрол': "нет контроля",
            r'не\s*(?:могу|можем)\s*контролир': "нет контроля",
            r'не\s*вид[и|е][мт]\s*(?:что|как|чем)?': "нет видимости",
            r'контроль\s*(?:за|над)?\s*(?:менеджер|продаж|сотрудник)': "контроль продаж",
            r'(?:не\s*)?(?:понима|зна)[юем]\s*(?:что|как|сколько)': "нет понимания процессов",
            r'(?:чёрн|черн)\w*\s*ящик': "чёрный ящик",
            r'не\s*(?:отслежива|трек|мониторим)': "нет отслеживания",
            r'(?:непрозрачн|непонятн)\w*\s*(?:процесс|работ)?': "непрозрачные процессы",
            r'(?:кто|что)\s*(?:делает|работает|занят)': "неясно кто чем занят",
            r'не\s*(?:знаю|понимаю)\s*(?:чем|что|как)': "нет понимания",
            # Дополнительные паттерны
            r'(?:слеп|вслепую)\s*(?:работа|управля)': "работаем вслепую",
            r'руковод\w*\s*(?:не\s*)?(?:вид|знает|понима)': "руководство не видит",
            r'(?:собственник|директор|босс)\w*\s*(?:не\s*)?(?:вид|знает|понима)': "руководство не видит",
            r'(?:невозможн|не\s*мог)\w*\s*(?:провер|контролир|отслед)': "невозможно проверить",
            r'(?:верим|доверя)\w*\s*(?:на\s*слово|словам)': "верим на слово",
            r'(?:нет|отсутств)\w*\s*(?:учёт|учет)': "нет учёта",
            r'(?:нет|отсутств)\w*\s*(?:фиксац|протокол|логиров)': "ничего не фиксируется",

            # =================================================================
            # ХАОС В ДАННЫХ И ИНСТРУМЕНТАХ
            # =================================================================
            r'excel|эксел|табличк': "работа в Excel",
            r'гугл\s*(?:табли|докс)|google\s*(?:sheet|doc)': "работа в Google Docs",
            r'блокнот|записк|стикер': "записи в блокнотах",
            r'всё\s*в\s*голов': "всё в головах",
            r'нигде\s*не\s*(?:фикс|запис)': "ничего не фиксируется",
            r'разброс|раскидан': "данные разбросаны",
            r'хаос': "хаос в данных",
            r'беспоряд|бардак|бедлам': "беспорядок",
            r'(?:кажд|разн)\w*\s*(?:сво[йяеи]|по.своему|ведёт|ведет)': "каждый ведёт по-своему",
            r'по.своему\s*(?:вед|дела|работа)': "каждый ведёт по-своему",
            r'(?:вед[её]т|ведут)\w*\s*(?:\w+\s+)?по.своему': "каждый ведёт по-своему",
            r'нет\s*(?:единой|общей)\s*(?:базы|системы)': "нет единой базы",
            r'(?:разн|много)\w*\s*(?:систем|программ|инструмент)': "много разных систем",
            r'(?:информац|данн)\w*\s*(?:тер|пропа)': "данные теряются",
            r'(?:дубл|повтор)\w*\s*(?:данн|информ|ввод)': "дублирование данных",
            r'ручн\w*\s*(?:ввод|работ|труд)': "много ручной работы",
            # Дополнительные паттерны
            r'(?:бумаг|бумажк)\w*\s*(?:много|куч|завал)': "работа с бумагами",
            r'(?:вс[её]\s*)?(?:на\s*)?бумаг': "на бумаге",
            r'(?:в\s*)?(?:тетрад|блокнот)\w*\s*(?:пиш|вед|запис)': "записи в тетрадях",
            r'(?:word|ворд)\w*\s*(?:докум|файл)': "работа в Word",
            r'(?:куч|завал|мног)\w*\s*(?:файл|документ|папок)': "много файлов",
            r'(?:файл|документ)\w*\s*(?:где.то|потеря|не\s*найд)': "файлы теряются",
            r'(?:найти|искать)\s*(?:файл|документ|информац)\w*\s*(?:долго|сложно|невозможн)': "сложно найти файлы",
            r'(?:всё|все)\s*(?:раскидано|разбросано|в\s*разн)': "всё разбросано",
            r'(?:каш|месиво|свалк)\w*\s*(?:в\s*)?(?:данн|информац|файл)': "каша в данных",
            r'(?:зоопарк|винегрет)\w*\s*(?:систем|программ|инструмент)': "зоопарк систем",

            # =================================================================
            # ДУБЛИ И ОШИБКИ
            # =================================================================
            r'дубл[иеяь]': "дубли клиентов",
            r'путаниц': "путаница в данных",
            r'ошиб[ко]': "ошибки в работе",
            r'(?:один|одного)\s*клиент\w*\s*(?:несколько|много|двое)': "дубли клиентов",
            r'(?:повторн|дважды)\w*\s*(?:звон|пиш|обраща)': "повторные обращения",
            r'(?:перепут|смеша|спута)': "путаница",
            r'(?:неточн|некорректн|неправильн)\w*\s*данн': "некорректные данные",
            r'(?:устарел|старые|неактуальн)\w*\s*(?:данн|информ|контакт)': "устаревшие данные",
            # Дополнительные паттерны
            r'(?:одному|одного)\s*клиент\w*\s*(?:звоня|обраща)\w*\s*(?:несколько|много|двое)': "звоним одному клиенту несколько раз",
            r'(?:базе|данн)\w*\s*(?:грязн|мусор|шлак)': "грязная база",
            r'(?:чист|актуализ)\w*\s*(?:баз|данн)': "нужна чистка базы",
            r'(?:контакт|телефон|email)\w*\s*(?:неверн|некорректн|ошиб|устар)': "неверные контакты",
            r'(?:данн|информац)\w*\s*(?:противореч|не\s*совпад|расход)': "данные противоречат",
            r'(?:разн|противореч)\w*\s*(?:информац|данн)\w*\s*(?:об\s*одном|по\s*одному)': "разная информация",
            r'(?:накоп|скоп)\w*\s*(?:мусор|хлам|шлак)': "мусор в данных",

            # =================================================================
            # ОБЩАЯ НЕЭФФЕКТИВНОСТЬ
            # =================================================================
            r'долго\s*(?:иск|наход)': "долго ищут информацию",
            r'не\s*успева[ею]': "не успевают",
            r'много\s*времен': "много времени на рутину",
            r'неэффективн': "неэффективность",
            r'медленн': "медленная работа",
            r'рутин': "много рутины",
            r'(?:убива|трат|жр[её]т)\w*\s*врем': "тратят много времени",
            r'(?:отнима|занима)\w*\s*(?:много\s*)?врем': "занимает много времени",
            r'(?:низк|плох)\w*\s*(?:производительн|эффективн)': "низкая эффективность",
            r'(?:простаива|просто[йи])': "простои в работе",
            r'(?:затягива|задержива|опаздыва)': "задержки",
            # Дополнительные паттерны
            r'(?:копипаст|копировать)\w*\s*(?:данн|информац)?': "много копипаста",
            r'(?:переключа|прыга)\w*\s*между\s*(?:програм|систем|окн)': "переключение между системами",
            r'(?:перенос|дублир)\w*\s*(?:данн|информац)\w*\s*(?:вручную|руками)': "ручной перенос данных",
            r'(?:одно\s*и\s*то\s*же|одинаков)\w*\s*(?:вводи|заполня|делае)': "повторный ввод",
            r'(?:куч|мног)\w*\s*(?:кликов|действ|шагов)': "много действий",
            r'(?:сложн|непонятн)\w*\s*(?:интерфейс|систем|програм)': "сложный интерфейс",
            r'(?:неудобн|громоздк)\w*\s*(?:систем|програм|интерфейс)': "неудобная система",
            r'(?:тормоз|лагает|виснет|глюч)': "тормозит система",
            r'(?:падает|вылетает|крашит)': "падает система",
            r'(?:баги|глюки|ошибки)\w*\s*(?:в\s*)?(?:систем|програм)': "баги в системе",

            # =================================================================
            # ПРОДАЖИ
            # =================================================================
            r'плох\w*\s*продаж': "плохие продажи",
            r'слаб\w*\s*продаж': "слабые продажи",
            r'низк\w*\s*продаж': "низкие продажи",
            r'продаж[иа]?\s*(?:пада|упа|снижа|плох|низк)': "падение продаж",
            r'(?:пада|упа|снижа)\w*\s*продаж': "падение продаж",
            r'мало\s*(?:продаж|клиент|сделок)': "мало продаж",
            r'(?:увеличить|поднять|нарастить)\s*продаж': "рост продаж",
            r'проблем\w*\s*(?:с\s*)?продаж': "проблемы с продажами",
            r'(?:низк|плох|мал)\w*\s*конверси': "низкая конверсия",
            r'(?:мал|низк)\w*\s*(?:средн|чек|сумм)': "низкий средний чек",
            r'(?:длинн|долг)\w*\s*(?:цикл|сделк)': "длинный цикл сделки",
            r'не\s*(?:выполня|закрыва)\w*\s*план': "не выполняют план",
            r'план\w*\s*(?:не\s*)?(?:выполня|горит|срыва)': "срыв плана продаж",
            r'(?:выручк|доход|оборот)\w*\s*(?:пада|сниж|мал)': "падение выручки",
            r'(?:маржа|маржинальн|прибыл)\w*\s*(?:пада|сниж|мал|низк)': "низкая маржа",
            # Дополнительные паттерны
            r'(?:стагнац|застой)\w*\s*(?:в\s*)?(?:продаж|бизнес)': "стагнация продаж",
            r'продаж\w*\s*(?:встал|стоят|не\s*идут)': "продажи встали",
            r'(?:сезон|спад)\w*\s*(?:продаж)?': "сезонный спад",
            r'(?:кризис|провал)\w*\s*(?:в\s*)?продаж': "кризис продаж",
            r'(?:допродаж|апселл|кросс.сел)\w*\s*(?:нет|мало|не\s*(?:делаем|работа))': "нет допродаж",
            r'(?:не\s*)?(?:предлага|продаём|продаем)\w*\s*(?:доп|сопутств)': "не предлагают допы",
            r'(?:средн|среднемес)\w*\s*(?:чек|сумм)\w*\s*(?:не\s*)?рас': "средний чек не растёт",
            r'(?:количеств|числ)\w*\s*(?:сделок|продаж)\w*\s*(?:пада|сниж|мал)': "мало сделок",
            r'(?:редк|мал)\w*\s*(?:покупа|заказыва)': "редко покупают",
            r'(?:клиент|покупател)\w*\s*(?:экономят|не\s*готов|отказыва)': "клиенты экономят",
            r'(?:ценов|цен)\w*\s*(?:давлен|конкурен)': "ценовое давление",

            # =================================================================
            # АНАЛИТИКА И ОТЧЁТЫ
            # =================================================================
            r'нет\s*(?:статистик|аналитик|отчёт|отчет)': "нет аналитики",
            r'(?:хочу|нужн|надо)\s*(?:вид|знать)\w*\s*(?:статистик|цифр|показател)': "нужна аналитика",
            r'(?:не\s*)?(?:понима|зна)[юем]\s*(?:цифр|показател|статистик)': "непонятна статистика",
            r'(?:собира|формиру|делаю)\w*\s*отчёт\w*\s*(?:вручную|руками)': "ручные отчёты",
            r'отчёт\w*\s*(?:долго|сложно|трудно)': "сложные отчёты",
            r'(?:kpi|кпи|метрик)\w*\s*(?:нет|не\s*(?:счита|отслежива))': "нет KPI",
            r'воронк\w*\s*(?:не\s*)?(?:вид|отслежива|понима)': "не видим воронку",
            r'(?:прогноз|планирован)\w*\s*(?:нет|сложн|невозможн)': "нет прогнозирования",
            # Дополнительные паттерны
            r'(?:дашборд|dashboard)\w*\s*(?:нет|нужен|хотим)': "нужен дашборд",
            r'(?:графики|диаграм|визуализац)\w*\s*(?:нет|нужн|хотим)': "нужна визуализация",
            r'(?:цифр|данн|показател)\w*\s*(?:собира|сводим)\w*\s*(?:вручную|руками|из\s*разн)': "собираем данные вручную",
            r'(?:сверк|сводк|свед[её]|сводим)\w*\s*(?:данн|цифр)': "сводим данные",
            r'(?:отчёт|отчет|данн)\w*\s*(?:в\s*)?(?:excel|эксел|табли)': "отчёты в Excel",
            r'(?:считаем|считаю|подсч[её]т)\w*\s*(?:вручную|руками|на\s*калькулятор)': "считаем вручную",
            r'(?:данн|показател|цифр)\w*\s*(?:устарел|неактуальн|вчерашн)': "устаревшие данные",
            r'(?:realtime|реалтайм|оперативн)\w*\s*(?:данн|показател)\w*\s*(?:нет|нужн)': "нужны оперативные данные",
            r'(?:принима|оцени|проанализ)\w*\s*(?:решен)\w*\s*(?:сложн|не\s*(?:на\s*чем|можем))': "сложно принимать решения",
            r'(?:бизнес|управленч)\w*\s*(?:решен)\w*\s*(?:на\s*)?(?:интуиц|авось|глазок)': "решения на интуиции",

            # =================================================================
            # КОММУНИКАЦИЯ И КОМАНДА
            # =================================================================
            r'(?:плох|нет)\w*\s*коммуникац': "плохая коммуникация",
            r'(?:не\s*)?(?:знаю|понима)[юем]\s*(?:что|как)\s*(?:делает|работает)\s*(?:коллег|команд)': "нет коммуникации в команде",
            r'(?:передач|переда[ёе])\w*\s*(?:клиент|дел|информац)': "проблемы с передачей дел",
            r'(?:команд|отдел)\w*\s*(?:не\s*)?(?:работа|координир)': "проблемы координации",
            r'(?:между\s*)?отдел\w*\s*(?:не\s*)?(?:взаимодейств|общ|коммуник)': "нет связи между отделами",
            r'(?:конфликт|спор|выясн)\w*\s*(?:менеджер|сотрудник)?': "конфликты в команде",
            # Дополнительные паттерны
            r'(?:информац|данн)\w*\s*(?:не\s*)?(?:дох|доход|переда)\w*\s*(?:до|между)': "информация не доходит",
            r'(?:кто|один)\w*\s*(?:не\s*)?(?:зна|в\s*курс)\w*\s*(?:что|как)\w*\s*(?:друг)': "не знаем что делает коллега",
            r'(?:дублир|пересек)\w*\s*(?:работ|задач|функц)': "дублирование работы",
            r'(?:делаем|делают)\s*одн[оу]\s*(?:и\s*то\s*же|работу)': "делаем одно и то же",
            r'(?:маркетинг|продаж)\w*\s*(?:не\s*)?(?:работают\s*)?(?:вместе|сообща)': "маркетинг и продажи не работают вместе",
            r'(?:передал|передач)\w*\s*(?:клиент|лид)\w*\s*(?:потерял|забыл|провал)': "теряем при передаче",
            r'(?:замен|подмен|отпуск|больничн)\w*\s*(?:никто\s*не|не\s*кому)': "некому заменить",
            r'(?:ключев|един)\w*\s*(?:сотрудник|специалист|человек)\w*\s*(?:увол|уш[её]л|уйд)': "уход ключевого сотрудника",
            r'(?:всё|все)\s*(?:завис|держит)\w*\s*(?:на\s*одном|один\s*человек)': "всё на одном человеке",

            # =================================================================
            # ЗВОНКИ И ТЕЛЕФОНИЯ
            # =================================================================
            r'звонк\w*\s*(?:тер|пропуск|пропада)': "теряем звонки",
            r'(?:пропущ|пропуска)\w*\s*звонк': "пропущенные звонки",
            r'(?:не\s*)?(?:записыва|сохраня)\w*\s*звонк': "не записываем звонки",
            r'(?:нет|не\s*вед[её])\w*\s*истор\w*\s*(?:звонк|общен|переговор)': "нет истории звонков",
            r'(?:не\s*)?(?:слуша|анализ)\w*\s*звонк': "не анализируем звонки",
            r'(?:скрипт|сценар)\w*\s*(?:нет|не\s*(?:работ|соблюд))': "нет скриптов продаж",
            # Дополнительные паттерны
            r'(?:ручн|вручную)\w*\s*(?:набор|набира|звон)': "ручной набор номеров",
            r'(?:авто|автомат)\w*\s*(?:дозвон|набор|обзвон)\w*\s*(?:нет|нужен)': "нужен автодозвон",
            r'(?:долго|много\s*времен)\w*\s*(?:на\s*)?(?:набор|дозвон)': "много времени на набор",
            r'(?:callback|обратн\w*\s*звон)\w*\s*(?:нет|долго|не\s*работа)': "проблемы с callback",
            r'(?:ivr|голосов\w*\s*меню)\w*\s*(?:нет|нужен|хотим)': "нужен IVR",
            r'(?:очередь|распредел)\w*\s*звонк\w*\s*(?:нет|плохо|не\s*работа)': "нет очереди звонков",
            r'(?:входящ|исходящ)\w*\s*звонк\w*\s*(?:не\s*)?(?:вид|контрол|отслежива)': "не видим статистику звонков",
            r'(?:качеств|оценк)\w*\s*(?:звонк|разговор)\w*\s*(?:не\s*)?(?:контрол|оценива)': "не оцениваем качество звонков",

            # =================================================================
            # АВТОМАТИЗАЦИЯ И ПРОЦЕССЫ
            # =================================================================
            r'автоматизир': "автоматизация",
            r'систематизир': "систематизация",
            r'(?:навести|нужен)\s*порядок': "навести порядок",
            r'(?:оптимиз|улучш)\w*\s*процесс': "оптимизация процессов",
            r'(?:выстро|постро|настро)\w*\s*(?:процесс|систем|работ)': "выстроить процессы",
            r'(?:нет|отсутств)\w*\s*(?:процесс|регламент|стандарт)': "нет процессов",
            r'(?:всё|все)\s*(?:вручную|руками|делаем\s*вручную)': "всё делается вручную",
            r'(?:делаем|делают|работаем)\s*(?:всё\s*)?вручную': "всё делается вручную",
            r'(?:автоматич|автомат)\w*\s*(?:напоминан|задач|уведомлен)': "нужна автоматизация",
            r'(?:нужн|хотим|надо)\s*(?:crm|црм|систем)': "нужна CRM",
            r'(?:внедр|запуст)\w*\s*(?:crm|црм|систем)': "внедрение CRM",
            # Дополнительные паттерны
            r'(?:триггер|автомат)\w*\s*(?:действ|задач|напоминан)\w*\s*(?:нет|нужн)': "нужны триггеры",
            r'(?:авто|автомат)\w*\s*(?:рассылк|письм|уведомлен)\w*\s*(?:нет|нужн)': "нужны авторассылки",
            r'(?:напомина|уведомлен)\w*\s*(?:нет|забыва|не\s*приход)': "нет напоминаний",
            r'(?:шаблон|темплейт)\w*\s*(?:нет|мало|устарел)': "нет шаблонов",
            r'(?:кажд|постоянн)\w*\s*раз\w*\s*(?:с\s*нуля|заново|писать|создава)': "каждый раз с нуля",
            r'(?:типов|стандартн|однотипн)\w*\s*(?:задач|действ|операц)\w*\s*(?:много|куча|вручную)': "много типовых задач",
            r'(?:бизнес|рабоч)\w*\s*(?:процесс)\w*\s*(?:не\s*)?(?:описан|формализ|стандартиз)': "процессы не описаны",

            # =================================================================
            # МАСШТАБИРОВАНИЕ И РОСТ
            # =================================================================
            r'(?:не\s*)?(?:мож|получа)\w*\s*(?:масштаб|расти|вырасти)': "проблемы масштабирования",
            r'(?:рост|развити)\w*\s*(?:ограничен|невозможен|сложн)': "ограничения роста",
            r'(?:упир|упёрл|упер)\w*\s*(?:в\s*)?(?:потолок|стену|границ)': "упёрлись в потолок",
            r'(?:бизнес|компани)\w*\s*(?:не\s*)?(?:раст|развива)': "бизнес не растёт",
            r'(?:больше|много)\s*(?:клиент|заказ)\w*\s*(?:не\s*)?(?:справля|обрабат)': "не справляемся с потоком",
            # Дополнительные паттерны
            r'(?:расшир|нанима|набира)\w*\s*(?:команд|штат|персонал)\w*\s*(?:сложн|не\s*мож)': "сложно расширяться",
            r'(?:новый|нов)\w*\s*(?:клиент|направлен|продукт)\w*\s*(?:не\s*мож|сложн)': "сложно добавить новое",
            r'(?:систем|процесс)\w*\s*(?:не\s*)?(?:готов|рассчитан)\w*\s*(?:на\s*)?рост': "система не готова к росту",
            r'(?:узк|бутылочн)\w*\s*(?:место|горл|горлышк)': "бутылочное горлышко",
            r'(?:предел|лимит|ограничен)\w*\s*(?:возможност|мощност|ёмкост)': "предел возможностей",
            r'(?:людей|рук|человек)\w*\s*(?:не\s*хватает|мало)': "не хватает людей",
            r'(?:перегруж|загруж|заваленн)\w*\s*(?:команд|сотрудник|менеджер)': "перегруженная команда",

            # =================================================================
            # ЖЕЛАНИЯ И ПОТРЕБНОСТИ (косвенные)
            # =================================================================
            r'(?:хочу|хотим|нужн|надо)\s*(?:видеть|знать)\s*(?:статистик|аналитик|цифр)': "нужна аналитика",
            r'(?:хочу|хотим|нужн|надо)\s*(?:контролир|отслежива|мониторить)': "нужен контроль",
            r'(?:хочу|хотим|нужн|надо)\s*(?:понима|знать)\s*(?:что|как|где)': "нужна прозрачность",
            r'(?:хочу|хотим|нужн|надо)\s*(?:автоматиз|упростить|ускорить)': "нужна автоматизация",
            r'(?:хочу|хотим|нужн|надо)\s*(?:порядок|систем|структур)': "нужна систематизация",
            r'(?:хочу|хотим|нужн\w*|надо)\s+(?:един|общ)\w*\s+(?:баз|систем|место)': "нужна единая система",
            r'нужн\w*\s+(?:един|общ)\w*\s+баз': "нужна единая база",
            r'(?:един|общ)\w*\s+(?:баз|систем)\w*\s+(?:нет|нужн)': "нужна единая система",
            r'(?:устал|надоел)\w*\s*(?:от\s*)?(?:бардак|хаос|беспоряд|рутин)': "устали от хаоса",
            r'(?:хочу|хотим)\s*(?:как\s*у\s*)?(?:нормальн|взросл|больш)': "хотим нормальные процессы",
            # Дополнительные паттерны
            r'(?:хочу|хотим|нужн|надо)\s*(?:сэконом|сберечь|оптимизир)\w*\s*(?:врем|ресурс)': "хотим экономить время",
            r'(?:хочу|хотим|нужн|надо)\s*(?:больше|увеличить|поднять)\s*(?:продаж|выручк|прибыл)': "хотим больше продаж",
            r'(?:хочу|хотим|нужн|надо)\s*(?:понятн|прозрачн)\w*\s*(?:процесс|систем|картин)': "хотим прозрачность",
            r'(?:хочу|хотим|нужн|надо)\s*(?:быстр|оперативн)\w*\s*(?:реагир|обрабат|отвеча)': "хотим быстрее работать",
            r'(?:хочу|хотим|нужн|надо)\s*(?:избав|уйти)\w*\s*(?:от\s*)?(?:рутин|ручн|excel)': "хотим избавиться от рутины",
            r'(?:хочу|хотим|нужн|надо)\s*(?:собрать|объединить|консолидир)\w*\s*(?:всё|все|данн|информац)': "хотим собрать всё в одном месте",

            # =================================================================
            # АБСТРАКТНЫЕ ЖАЛОБЫ
            # =================================================================
            r'всё\s*плохо': "всё плохо",
            r'ничего\s*не\s*работ': "ничего не работает",
            r'не\s*работает\s*(?:нормальн|как\s*надо)': "не работает нормально",
            r'полный\s*(?:бардак|хаос|трэш|треш|пипец|капец)': "полный бардак",
            r'(?:сплошн|одни)\s*(?:проблем|головн\w*\s*бол)': "сплошные проблемы",
            r'(?:замуч|задолб|достал)': "замучились",
            r'(?:невозможн|нереальн|нельзя)\s*(?:работ|так\s*дальше)': "невозможно работать",
            r'(?:тонем|зашива|захлёб)': "захлёбываемся",
            r'(?:горим|пожар|срочн|аврал)': "постоянные авралы",
            # Дополнительные паттерны
            r'(?:ад|кошмар|ужас)': "кошмар",
            r'(?:надоело|достало|заколебало)': "надоело",
            r'(?:бесит|раздражает|выводит\s*из\s*себя)': "бесит",
            r'(?:нервы|стресс|выгорание)\w*\s*(?:на\s*)?пред': "стресс",
            r'(?:сплошн|постоянн|вечн)\w*\s*(?:стресс|напряг|нервы)': "постоянный стресс",
            r'(?:устал|вымотал|измотал)\w*\s*(?:все|весь\s*отдел|команд)': "все устали",
            r'(?:так|это)\s*больше\s*(?:не\s*мож|продолжа)\w*\s*(?:нельзя|не\s*будет)': "так дальше нельзя",
            r'(?:нужн|пора|давно\s*пора)\s*что.то\s*(?:менять|делать|решать)': "пора что-то менять",

            # =================================================================
            # СПЕЦИФИЧНЫЕ ОТРАСЛЕВЫЕ БОЛИ
            # =================================================================
            r'(?:сервис|поддержк|support)\w*\s*(?:плох|медленн|не\s*отвеча)': "плохой сервис",
            r'(?:клиент\w*\s*)?(?:ждут|ожида)\w*\s*(?:долго|часами)': "клиенты долго ждут",
            r'(?:время|срок)\w*\s*(?:ответ|реакц|обработк)\w*\s*(?:большое|долг|медленн)': "долгое время ответа",
            r'(?:sla|слa|времен\w*\s*норматив)\w*\s*(?:не\s*)?(?:выполня|соблюда|нарушае)': "нарушаем SLA",
            r'(?:тикет|заявк|обращен)\w*\s*(?:копят|накаплива|не\s*закрыва)': "копятся тикеты",
            r'(?:повторн|одинаков)\w*\s*(?:вопрос|проблем|обращен)': "повторные обращения",
            r'(?:faq|база\s*знаний|документац)\w*\s*(?:нет|устарел|не\s*полн)': "нет базы знаний",

            # =================================================================
            # ВРЕМЯ И ОТЧЁТЫ
            # =================================================================
            r'(?:нет|много)\s*времен\w*\s*(?:на\s*)?отчёт': "нет времени на отчёты",
            r'(?:времен\w*\s*)?(?:на\s*)?отчёт\w*\s*(?:нет|много|уход)': "много времени на отчёты",
            r'отчёт\w*\s*(?:отним|заним|тр[её]б)\w*\s*(?:много\s*)?врем': "отчёты занимают много времени",

            # =================================================================
            # КОНТРОЛЬ ПРОДАВЦОВ
            # =================================================================
            r'(?:сложн|труд|невозможн)\w*\s*контролир\w*\s*(?:продавц|продажник|менеджер)': "сложно контролировать продавцов",
            r'контрол\w*\s*(?:продавц|продажник|менеджер)\w*\s*(?:сложн|труд|невозможн)': "сложно контролировать продавцов",
            r'(?:продавц|продажник)\w*\s*(?:не\s*)?(?:контрол|отслежива)': "нет контроля продавцов",

            # =================================================================
            # ШТРАФЫ И АЛКОГОЛЬ (ЕГАИС)
            # =================================================================
            r'(?:бо[юя]|страш|опас)\w*\s*(?:штраф|провер)\w*\s*(?:за\s*)?(?:алкогол|егаис)?': "боимся штрафов за алкоголь",
            r'штраф\w*\s*(?:за\s*)?(?:алкогол|егаис)': "штрафы за алкоголь",
            r'(?:егаис|алкогол)\w*\s*(?:штраф|провер|нарушен)': "проблемы с ЕГАИС",
            r'(?:алкогол|спиртн)\w*\s*(?:учёт|контрол)\w*\s*(?:сложн|проблем)': "проблемы с учётом алкоголя",

            # =================================================================
            # KASPI И МАРКЕТПЛЕЙСЫ
            # =================================================================
            r'(?:kaspi|каспи)\w*\s*(?:заказ\w*\s*)?(?:теря|пропа|путаниц)': "теряем заказы Kaspi",
            r'(?:заказ\w*\s*)?(?:kaspi|каспи)\w*\s*(?:теря|пропа|путаниц)': "теряем заказы Kaspi",
            r'(?:kaspi|каспи)\w*\s*(?:не\s*)?(?:синхрониз|интегр|связ)': "проблемы с Kaspi",
            r'(?:маркетплейс|озон|wildberries|вайлдберриз)\w*\s*(?:заказ\w*\s*)?(?:теря|пропа)': "теряем заказы маркетплейса",

            # =================================================================
            # ИНВЕНТАРИЗАЦИЯ
            # =================================================================
            r'инвентаризац\w*\s*(?:заним|дл|долг|много\s*врем)': "инвентаризация занимает много времени",
            r'(?:долг|много\s*врем)\w*\s*(?:на\s*)?инвентаризац': "долгая инвентаризация",
            r'инвентаризац\w*\s*(?:сложн|труд|проблем)': "проблемы с инвентаризацией",
            r'(?:остатк|товар)\w*\s*(?:не\s*)?(?:сходят|совпад)': "остатки не сходятся",
            r'(?:пересч[её]т|пересчит)\w*\s*(?:долг|сложн|много)': "долгий пересчёт",
        }

        for pattern, pain in pain_patterns.items():
            if re.search(pattern, message_lower):
                extracted["pain_point"] = pain
                break

        # Контекстное: если спрашивали о проблемах, а клиент ответил коротко
        if "pain_point" not in extracted and "pain_point" in missing_data:
            # Короткие ответы о сфере деятельности = проблема в этой сфере
            short_answers = {
                # =================================================================
                # СФЕРЫ ДЕЯТЕЛЬНОСТИ
                # =================================================================
                # Продажи
                "продажи": "улучшение продаж",
                "продажами": "улучшение продаж",
                "сейлз": "улучшение продаж",
                "sales": "улучшение продаж",
                "продажниками": "контроль продавцов",
                "продавцами": "контроль продавцов",
                "выручка": "рост выручки",
                "выручкой": "рост выручки",
                "прибыль": "рост прибыли",
                "прибылью": "рост прибыли",
                "доход": "рост дохода",
                "доходом": "рост дохода",

                # Маркетинг
                "маркетинг": "маркетинг и лиды",
                "маркетингом": "маркетинг и лиды",
                "реклама": "работа с рекламой",
                "рекламой": "работа с рекламой",
                "трафик": "управление трафиком",
                "трафиком": "управление трафиком",
                "лидогенерация": "генерация лидов",
                "лидген": "генерация лидов",
                "контент": "контент-маркетинг",
                "контентом": "контент-маркетинг",
                "smm": "SMM продвижение",
                "соцсети": "работа с соцсетями",
                "соцсетями": "работа с соцсетями",
                "рассылки": "email-маркетинг",
                "рассылками": "email-маркетинг",

                # Клиенты
                "клиенты": "работа с клиентами",
                "клиентами": "работа с клиентами",
                "заказчики": "работа с заказчиками",
                "заказчиками": "работа с заказчиками",
                "покупатели": "работа с покупателями",
                "покупателями": "работа с покупателями",
                "клиентская база": "ведение базы клиентов",
                "клиентской базой": "ведение базы клиентов",
                "отток": "удержание клиентов",
                "оттоком": "удержание клиентов",
                "удержание": "удержание клиентов",
                "удержанием": "удержание клиентов",
                "лояльность": "повышение лояльности",
                "лояльностью": "повышение лояльности",

                # HR и персонал
                "hr": "управление персоналом",
                "кадры": "работа с кадрами",
                "кадрами": "работа с кадрами",
                "персонал": "управление персоналом",
                "персоналом": "управление персоналом",
                "сотрудники": "управление сотрудниками",
                "сотрудниками": "управление сотрудниками",
                "менеджеры": "контроль менеджеров",
                "менеджерами": "контроль менеджеров",
                "команда": "управление командой",
                "командой": "управление командой",
                "найм": "подбор персонала",
                "наймом": "подбор персонала",
                "онбординг": "адаптация сотрудников",
                "онбордингом": "адаптация сотрудников",
                "адаптация": "адаптация сотрудников",
                "адаптацией": "адаптация сотрудников",
                "обучение": "обучение сотрудников",
                "обучением": "обучение сотрудников",
                "мотивация": "мотивация сотрудников",
                "мотивацией": "мотивация сотрудников",

                # Логистика и склад
                "логистика": "управление логистикой",
                "логистикой": "управление логистикой",
                "доставка": "управление доставкой",
                "доставкой": "управление доставкой",
                "склад": "учёт склада",
                "складом": "учёт склада",
                "остатки": "учёт остатков",
                "остатками": "учёт остатков",
                "запасы": "управление запасами",
                "запасами": "управление запасами",
                "отгрузки": "контроль отгрузок",
                "отгрузками": "контроль отгрузок",
                "поставки": "контроль поставок",
                "поставками": "контроль поставок",

                # Финансы
                "финансы": "финансовый учёт",
                "финансами": "финансовый учёт",
                "деньги": "учёт финансов",
                "деньгами": "учёт финансов",
                "оплаты": "контроль оплат",
                "оплатами": "контроль оплат",
                "дебиторка": "контроль дебиторки",
                "дебиторкой": "контроль дебиторки",
                "долги": "контроль задолженностей",
                "долгами": "контроль задолженностей",
                "платежи": "контроль платежей",
                "платежами": "контроль платежей",
                "бюджет": "контроль бюджета",
                "бюджетом": "контроль бюджета",
                "расходы": "контроль расходов",
                "расходами": "контроль расходов",
                "касса": "учёт кассы",
                "кассой": "учёт кассы",

                # Сервис и поддержка
                "поддержка": "клиентская поддержка",
                "поддержкой": "клиентская поддержка",
                "сервис": "клиентский сервис",
                "сервисом": "клиентский сервис",
                "саппорт": "клиентская поддержка",
                "саппортом": "клиентская поддержка",
                "тикеты": "обработка тикетов",
                "тикетами": "обработка тикетов",
                "жалобы": "работа с жалобами",
                "жалобами": "работа с жалобами",
                "рекламации": "работа с рекламациями",
                "рекламациями": "работа с рекламациями",

                # =================================================================
                # ДЕЙСТВИЯ И ПРОЦЕССЫ
                # =================================================================
                # Коммуникации
                "звонки": "учёт звонков",
                "звонками": "учёт звонков",
                "переговоры": "ведение переговоров",
                "переговорами": "ведение переговоров",
                "общение": "коммуникация с клиентами",
                "общением": "коммуникация с клиентами",
                "переписка": "ведение переписки",
                "перепиской": "ведение переписки",
                "телефония": "телефония и звонки",
                "телефонией": "телефония и звонки",
                "чаты": "работа с чатами",
                "чатами": "работа с чатами",
                "мессенджеры": "работа с мессенджерами",
                "мессенджерами": "работа с мессенджерами",
                "email": "email-коммуникация",
                "почта": "email-коммуникация",
                "почтой": "email-коммуникация",

                # Заявки и лиды
                "заявки": "обработка заявок",
                "заявками": "обработка заявок",
                "лиды": "обработка лидов",
                "лидами": "обработка лидов",
                "обращения": "обработка обращений",
                "обращениями": "обработка обращений",
                "запросы": "обработка запросов",
                "запросами": "обработка запросов",
                "входящие": "обработка входящих",
                "входящими": "обработка входящих",
                "холодные": "работа с холодными",
                "холодными": "работа с холодными",
                "тёплые": "работа с тёплыми",
                "теплыми": "работа с тёплыми",

                # Сделки
                "сделки": "ведение сделок",
                "сделками": "ведение сделок",
                "заказы": "обработка заказов",
                "заказами": "обработка заказов",
                "договоры": "ведение договоров",
                "договорами": "ведение договоров",
                "контракты": "ведение контрактов",
                "контрактами": "ведение контрактов",
                "счета": "выставление счетов",
                "счетами": "выставление счетов",
                "документы": "документооборот",
                "документами": "документооборот",
                "акты": "работа с актами",
                "актами": "работа с актами",

                # Задачи
                "задачи": "управление задачами",
                "задачами": "управление задачами",
                "дела": "управление делами",
                "делами": "управление делами",
                "напоминания": "система напоминаний",
                "напоминаниями": "система напоминаний",
                "планирование": "планирование задач",
                "планированием": "планирование задач",
                "дедлайны": "контроль дедлайнов",
                "дедлайнами": "контроль дедлайнов",
                "расписание": "управление расписанием",
                "расписанием": "управление расписанием",
                "календарь": "ведение календаря",
                "календарём": "ведение календаря",
                "календарем": "ведение календаря",

                # =================================================================
                # УЧЁТ И ОТЧЁТНОСТЬ
                # =================================================================
                "учёт": "учёт клиентов",
                "учет": "учёт клиентов",
                "учётом": "учёт клиентов",
                "учетом": "учёт клиентов",
                "контроль": "контроль менеджеров",
                "контролем": "контроль менеджеров",
                "отчёты": "отчётность",
                "отчеты": "отчётность",
                "отчётами": "отчётность",
                "отчетами": "отчётность",
                "отчётность": "отчётность",
                "отчетность": "отчётность",
                "аналитика": "аналитика продаж",
                "аналитикой": "аналитика продаж",
                "статистика": "статистика продаж",
                "статистикой": "статистика продаж",
                "метрики": "отслеживание метрик",
                "метриками": "отслеживание метрик",
                "kpi": "контроль KPI",
                "кпи": "контроль KPI",
                "дашборд": "визуализация данных",
                "дашбордом": "визуализация данных",
                "dashboard": "визуализация данных",
                "графики": "визуализация данных",
                "графиками": "визуализация данных",
                "цифры": "работа с данными",
                "цифрами": "работа с данными",
                "показатели": "контроль показателей",
                "показателями": "контроль показателей",

                # Воронка
                "воронка": "воронка продаж",
                "воронкой": "воронка продаж",
                "конверсия": "повышение конверсии",
                "конверсией": "повышение конверсии",
                "пайплайн": "управление пайплайном",
                "пайплайном": "управление пайплайном",
                "pipeline": "управление пайплайном",
                "стадии": "настройка стадий",
                "стадиями": "настройка стадий",
                "этапы": "настройка этапов",
                "этапами": "настройка этапов",

                # =================================================================
                # СОСТОЯНИЯ И ПРОБЛЕМЫ
                # =================================================================
                "бардак": "наведение порядка",
                "хаос": "устранение хаоса",
                "беспорядок": "наведение порядка",
                "путаница": "устранение путаницы",
                "неразбериха": "устранение неразберихи",
                "каша": "наведение порядка",
                "бедлам": "наведение порядка",
                "завал": "разбор завалов",
                "завалом": "разбор завалов",
                "трэш": "наведение порядка",
                "треш": "наведение порядка",
                "кошмар": "решение проблем",
                "кошмаром": "решение проблем",
                "ужас": "решение проблем",
                "ужасом": "решение проблем",
                "стресс": "снижение стресса",
                "стрессом": "снижение стресса",
                "выгорание": "предотвращение выгорания",
                "выгоранием": "предотвращение выгорания",

                # Потери
                "потери": "сокращение потерь",
                "потерями": "сокращение потерь",
                "упущения": "сокращение упущений",
                "упущениями": "сокращение упущений",
                "утечки": "устранение утечек",
                "утечками": "устранение утечек",
                "дубли": "устранение дублей",
                "дублями": "устранение дублей",
                "дублирование": "устранение дублирования",
                "дублированием": "устранение дублирования",
                "ошибки": "сокращение ошибок",
                "ошибками": "сокращение ошибок",
                "косяки": "устранение косяков",
                "косяками": "устранение косяков",
                "факапы": "устранение факапов",
                "факапами": "устранение факапов",

                # Эффективность
                "эффективность": "повышение эффективности",
                "эффективностью": "повышение эффективности",
                "производительность": "повышение производительности",
                "производительностью": "повышение производительности",
                "скорость": "увеличение скорости работы",
                "скоростью": "увеличение скорости работы",
                "оптимизация": "оптимизация процессов",
                "оптимизацией": "оптимизация процессов",
                "рутина": "сокращение рутины",
                "рутиной": "сокращение рутины",
                "время": "экономия времени",
                "временем": "экономия времени",
                "ресурсы": "экономия ресурсов",
                "ресурсами": "экономия ресурсов",

                # Автоматизация
                "автоматизация": "автоматизация процессов",
                "автоматизацией": "автоматизация процессов",
                "систематизация": "систематизация работы",
                "систематизацией": "систематизация работы",
                "стандартизация": "стандартизация процессов",
                "стандартизацией": "стандартизация процессов",
                "регламенты": "создание регламентов",
                "регламентами": "создание регламентов",
                "процессы": "выстраивание процессов",
                "процессами": "выстраивание процессов",
                "порядок": "наведение порядка",
                "порядком": "наведение порядка",

                # =================================================================
                # ИНСТРУМЕНТЫ И БАЗА
                # =================================================================
                "база": "ведение базы клиентов",
                "базой": "ведение базы клиентов",
                "crm": "внедрение CRM",
                "црм": "внедрение CRM",
                "система": "внедрение системы",
                "системой": "внедрение системы",
                "excel": "уход от Excel",
                "эксель": "уход от Excel",
                "экселем": "уход от Excel",
                "таблицы": "уход от таблиц",
                "таблицами": "уход от таблиц",
                "блокноты": "уход от блокнотов",
                "блокнотами": "уход от блокнотов",
                "бумажки": "уход от бумаг",
                "бумажками": "уход от бумаг",
                "интеграция": "настройка интеграций",
                "интеграцией": "настройка интеграций",
                "интеграции": "настройка интеграций",
                "интеграциями": "настройка интеграций",
                "1с": "интеграция с 1С",
                "телефония": "интеграция телефонии",
                "телефонией": "интеграция телефонии",

                # =================================================================
                # МАСШТАБИРОВАНИЕ
                # =================================================================
                "рост": "масштабирование бизнеса",
                "ростом": "масштабирование бизнеса",
                "масштаб": "масштабирование бизнеса",
                "масштабом": "масштабирование бизнеса",
                "масштабирование": "масштабирование бизнеса",
                "масштабированием": "масштабирование бизнеса",
                "расширение": "расширение бизнеса",
                "расширением": "расширение бизнеса",
                "развитие": "развитие бизнеса",
                "развитием": "развитие бизнеса",
            }
            if message_lower in short_answers:
                extracted["pain_point"] = short_answers[message_lower]

        # === Контактная информация ===
        # Email
        email_match = re.search(r'[\w\.-]+@[\w\.-]+\.\w{2,}', message)
        if email_match:
            extracted["contact_info"] = email_match.group(0)

        # Телефон (если email не найден)
        if "contact_info" not in extracted:
            phone_patterns = [
                # +7 с разными разделителями: +7 999 123-45-67, +7(999)123-45-67, +79991234567
                r'\+7[\s\-\.]?\(?\d{3}\)?[\s\-\.]?\d{3}[\s\-\.]?\d{2}[\s\-\.]?\d{2}',
                # 8 с разными разделителями: 8 999 123-45-67, 8(999)123-45-67
                r'8[\s\-\.]?\(?\d{3}\)?[\s\-\.]?\d{3}[\s\-\.]?\d{2}[\s\-\.]?\d{2}',
                # 10 цифр подряд (без кода страны): 9991234567
                r'\b\d{10}\b',
                # Формат XXX-XXX-XX-XX или XXX XXX XX XX
                r'\d{3}[\s\-\.]\d{3}[\s\-\.]\d{2}[\s\-\.]\d{2}',
            ]
            for pattern in phone_patterns:
                phone_match = re.search(pattern, message)
                if phone_match:
                    extracted["contact_info"] = phone_match.group(0).strip()
                    break

        # === Имя клиента ===
        name_patterns = [
            r'(?:меня\s*зовут|я\s+)\s*([А-ЯЁ][а-яё]+)',
            r'(?:это\s+)?([А-ЯЁ][а-яё]+)\s*(?:на связи|пишу|беспокоит)',
        ]
        for pattern in name_patterns:
            name_match = re.search(pattern, message)
            if name_match:
                extracted["client_name"] = name_match.group(1)
                break

        # =================================================================
        # SPIN-специфичное извлечение данных
        # =================================================================

        # === Текущие инструменты (для Situation) ===
        tool_patterns = {
            r'(?:в\s+)?excel': "Excel",
            r'(?:в\s+)?эксел': "Excel",
            r'(?:в\s+)?табли[цч]': "таблицы",
            r'(?:в\s+)?гугл\s*(?:табли|докс|sheets|docs)': "Google Таблицы",
            r'(?:в\s+)?1[сc]': "1С",
            r'(?:в\s+)?битрикс': "Битрикс24",
            r'(?:в\s+)?амо': "AmoCRM",
            r'(?:в\s+)?notion': "Notion",
            r'(?:в\s+)?trello': "Trello",
            r'(?:на\s+)?бумаг': "на бумаге",
            r'(?:в\s+)?блокнот': "в блокноте",
            r'(?:в\s+)?голов': "в головах",
            r'вручную|руками': "вручную",
            r'никак|нигде|ничего': "никак не ведём",
        }
        for pattern, tool in tool_patterns.items():
            if re.search(pattern, message_lower):
                extracted["current_tools"] = tool
                break

        # === Тип бизнеса (для Situation) ===
        business_patterns = {
            r'магазин|розни[цч]|ритейл|retail': "розничная торговля",
            r'опт(?:ов)?|b2b': "оптовые продажи",
            r'ресторан|кафе|общепит|еда': "общепит",
            r'услуг|сервис|service': "сфера услуг",
            r'салон|красот|spa|спа': "салон красоты",
            r'клиник|медицин|врач': "медицина",
            r'недвижим|агентств|риэлтор': "недвижимость",
            r'склад|логистик|доставк': "логистика",
            r'производств|завод|фабрик': "производство",
            r'it|айти|программ|разработ': "IT",
            r'строител|ремонт': "строительство",
            r'образован|обучен|курс': "образование",
        }
        for pattern, btype in business_patterns.items():
            if re.search(pattern, message_lower):
                extracted["business_type"] = btype
                break

        # === Последствия проблемы (для Implication) ===
        if spin_phase == "implication" or "pain_impact" in missing_data:
            impact_patterns = [
                # Количество потерянных клиентов
                (r'(\d+)\s*(?:клиент|покупател|заказ)\w*\s*(?:теря|упуска|уход)', 'clients_lost'),
                (r'(?:теря|упуска)\w*\s*(\d+)\s*(?:клиент|покупател|заказ)', 'clients_lost'),
                (r'(?:примерно|около|где-то)\s*(\d+)\s*(?:клиент|покупател)', 'clients_lost'),
                # Время
                (r'(\d+)\s*(?:час|минут)\w*\s*(?:в\s*день|каждый\s*день|ежедневно)', 'time_daily'),
                (r'(?:тратим|уходит|занимает)\s*(\d+)\s*(?:час|минут)', 'time_daily'),
                (r'(\d+)\s*(?:час|минут)\w*\s*(?:в\s*недел|еженедельно)', 'time_weekly'),
                # Деньги
                (r'(\d+)\s*(?:тысяч|т\.?р\.?|к)\s*(?:руб|₽)?', 'money_k'),
                (r'(\d+)\s*(?:миллион|млн|м)\s*(?:руб|₽)?', 'money_m'),
                (r'(\d+)\s*%\s*(?:выручк|продаж|прибыл)', 'percent'),
            ]

            for pattern, impact_type in impact_patterns:
                match = re.search(pattern, message_lower)
                if match:
                    value = match.group(1)
                    if impact_type == 'clients_lost':
                        extracted["pain_impact"] = f"теряем ~{value} клиентов"
                    elif impact_type == 'time_daily':
                        extracted["pain_impact"] = f"тратим ~{value} часов/день"
                    elif impact_type == 'time_weekly':
                        extracted["pain_impact"] = f"тратим ~{value} часов/неделю"
                    elif impact_type == 'money_k':
                        extracted["pain_impact"] = f"теряем ~{value}к рублей"
                        extracted["financial_impact"] = f"{value}000"
                    elif impact_type == 'money_m':
                        extracted["pain_impact"] = f"теряем ~{value}млн рублей"
                        extracted["financial_impact"] = f"{value}000000"
                    elif impact_type == 'percent':
                        extracted["pain_impact"] = f"теряем ~{value}% выручки"
                    break

            # Качественные маркеры осознания последствий
            acknowledgment_patterns = [
                r'да[,.]?\s*(?:это|согласен|верно|точно)',
                r'к\s*сожалени',
                r'(?:серьёзн|критичн|важн)\s*(?:проблем|вопрос)',
                r'(?:много|часто|постоянно|регулярно)',
            ]
            for pattern in acknowledgment_patterns:
                if re.search(pattern, message_lower):
                    if "pain_impact" not in extracted:
                        extracted["pain_impact"] = "осознаёт последствия"
                    break

        # === Желаемый результат (для Need-Payoff) ===
        if spin_phase == "need_payoff" or "desired_outcome" in missing_data:
            need_patterns = {
                r'(?:хотел|хочу|хотим|хочется)\s*(?:бы\s*)?(?:видеть|знать|понима)': "прозрачность и контроль",
                r'(?:хотел|хочу|хотим)\s*(?:бы\s*)?автоматиз': "автоматизация процессов",
                r'(?:хотел|хочу|хотим)\s*(?:бы\s*)?(?:контролир|отслежива)': "контроль работы",
                r'(?:хотел|хочу|хотим)\s*(?:бы\s*)?(?:экономи|сберечь|сэкономи)': "экономия времени/денег",
                r'(?:хотел|хочу|хотим)\s*(?:бы\s*)?(?:упрост|ускор)': "упрощение работы",
                r'(?:хотел|хочу|хотим)\s*(?:бы\s*)?(?:систематиз|наладить|навести\s*порядок)': "систематизация",
                r'(?:помогло|решило|избавило)\s*(?:бы)?': "решение проблемы",
                r'было\s*бы\s*(?:отлично|супер|здорово|идеально|круто)': "положительный результат",
                r'(?:да|конечно|естественно|определённо),?\s*(?:это|помогло|упростило)': "подтверждение ценности",
            }

            for pattern, outcome in need_patterns.items():
                if re.search(pattern, message_lower):
                    extracted["desired_outcome"] = outcome
                    extracted["value_acknowledged"] = True
                    break

            # Простые утвердительные ответы на N-вопросы
            simple_yes = [
                r'^да[,!.]?\s*$',
                r'^конечно[,!.]?\s*$',
                r'^естественно[,!.]?\s*$',
                r'^было\s*бы\s*(?:здорово|отлично|супер)',
                r'^(?:да\s*)?помогло\s*бы',
            ]
            for pattern in simple_yes:
                if re.search(pattern, message_lower):
                    if "desired_outcome" not in extracted:
                        extracted["desired_outcome"] = "подтверждает ценность решения"
                        extracted["value_acknowledged"] = True
                    break

        # === Высокий интерес (для ускорения SPIN) ===
        high_interest_patterns = [
            r'(?:очень|сильно|крайне)\s*(?:интересн|нужн|важн)',
            r'(?:срочно|скорее|быстрее)\s*(?:нужн|надо|хотим)',
            r'готов\w*\s*(?:сейчас|сразу|прямо)',
            r'давайте\s*(?:сразу|прямо|начн)',
            r'хочу\s*(?:демо|попробова|подключи)',
        ]
        for pattern in high_interest_patterns:
            if re.search(pattern, message_lower):
                extracted["high_interest"] = True
                break

        # =================================================================
        # СРОЧНОСТЬ (urgency)
        # =================================================================
        urgency_patterns = {
            # Очень срочно
            r'(?:очень\s*)?срочн[оа]?': "very_urgent",
            r'горит': "very_urgent",
            r'(?:прям[оа]?\s*)?сейчас': "very_urgent",
            r'(?:нужн[оа]?|надо)\s*(?:вчера|срочно|немедленно)': "very_urgent",
            r'(?:asap|асап)': "very_urgent",
            r'(?:экстренн|критичн|аварийн)': "very_urgent",
            r'(?:дедлайн|deadline)\s*(?:гор|завтра|сегодня|на\s*нос)': "very_urgent",
            r'(?:времени?\s*)?(?:нет|мало)\s*(?:совсем)?': "very_urgent",
            r'(?:кровь\s*из\s*носа|любой\s*ценой|во\s*что\s*бы\s*то\s*ни\s*стало)': "very_urgent",

            # Срочно
            r'(?:на\s*)?(?:этой|ближайш)\w*\s*недел': "urgent",
            r'(?:в\s*)?(?:ближайш|скор)\w*\s*(?:врем|буду|дн)': "urgent",
            r'(?:как\s*можно\s*)?(?:скорее|быстрее|раньше)': "urgent",
            r'(?:до\s*конца\s*)?(?:недел|месяц|квартал)': "urgent",
            r'(?:не\s*)?терпит\s*(?:отлагательств)?': "urgent",
            r'(?:важно|критично|необходимо)': "urgent",
            r'(?:побыстрее|поскорее)': "urgent",

            # Не срочно
            r'(?:не\s*)?(?:очень\s*)?(?:срочн|горит)\s*(?:не|нет)': "not_urgent",
            r'(?:когда\s*)?удобно': "not_urgent",
            r'(?:не\s*)?(?:торопимся|спешим)': "not_urgent",
            r'(?:присматриваемся|изучаем|сравниваем)': "not_urgent",
            r'(?:на\s*)?будущее': "not_urgent",
            r'(?:в\s*)?(?:след|будущ)\w*\s*(?:месяц|квартал|полугод|год)': "not_urgent",
            r'(?:планируем|думаем|рассматриваем)': "not_urgent",
            r'(?:пока\s*)?(?:просто\s*)?(?:интересуюсь|смотрю|изучаю)': "not_urgent",
        }
        for pattern, urgency in urgency_patterns.items():
            if re.search(pattern, message_lower):
                extracted["urgency"] = urgency
                break

        # =================================================================
        # БЮДЖЕТ (budget_range)
        # =================================================================
        budget_patterns = [
            # Конкретные суммы
            (r'бюджет\w*\s*(?:около|примерно|до|от)?\s*(\d+)\s*(?:тысяч|т\.?р\.?|к|тыс)', 'thousands'),
            (r'(\d+)\s*(?:тысяч|т\.?р\.?|к|тыс)\w*\s*(?:бюджет|выделен|есть|готов)', 'thousands'),
            (r'бюджет\w*\s*(?:около|примерно|до|от)?\s*(\d+)\s*(?:миллион|млн|м)', 'millions'),
            (r'(\d+)\s*(?:миллион|млн|м)\w*\s*(?:бюджет|выделен|есть|готов)', 'millions'),
            (r'готов\w*\s*(?:платить|заплатить|отдать)\s*(?:до\s*)?(\d+)', 'thousands'),
            (r'(?:до|от)\s*(\d+)\s*(?:руб|₽|рублей)', 'rubles'),
        ]
        for pattern, scale in budget_patterns:
            match = re.search(pattern, message_lower)
            if match:
                amount = int(match.group(1))
                if scale == 'thousands':
                    extracted["budget_range"] = f"{amount}k"
                elif scale == 'millions':
                    extracted["budget_range"] = f"{amount}m"
                elif scale == 'rubles' and amount > 1000:
                    extracted["budget_range"] = f"{amount // 1000}k"
                break

        # Качественные оценки бюджета
        budget_quality_patterns = {
            r'бюджет\w*\s*(?:большой|серьёзн|нормальн|достаточн)': "high",
            r'бюджет\w*\s*(?:ограничен|небольш|маленьк|скромн)': "low",
            r'(?:неограничен|любой)\s*бюджет': "unlimited",
            r'денег\s*(?:нет|мало)': "very_low",
            r'(?:готов|могу|можем)\s*(?:платить|заплатить)': "has_budget",
            r'(?:не\s*)?(?:выделен|заложен|запланирован)\w*\s*бюджет': "planned",
        }
        for pattern, quality in budget_quality_patterns.items():
            if re.search(pattern, message_lower):
                if "budget_range" not in extracted:
                    extracted["budget_range"] = quality
                break

        # =================================================================
        # РОЛЬ / ДОЛЖНОСТЬ (role)
        # =================================================================
        role_patterns = {
            # Руководство
            r'(?:я\s*)?(?:директор|генеральн|гендир|ген\.?\s*дир)': "director",
            r'(?:я\s*)?(?:собственник|владелец|основатель|учредитель)': "owner",
            r'(?:я\s*)?(?:руководитель|руковожу|начальник|глава)': "head",
            r'(?:я\s*)?(?:управляющ|управленец|топ.менеджер)': "top_manager",
            r'(?:я\s*)?(?:rop|роп|рук\w*\s*отдел\w*\s*продаж)': "sales_head",
            r'(?:я\s*)?(?:ком\.?\s*дир|коммерч\w*\s*директор)': "commercial_director",

            # Средний менеджмент
            r'(?:я\s*)?(?:менеджер|специалист|сотрудник)': "employee",
            r'(?:я\s*)?(?:продавец|продажник|сейлз|sales)': "sales",
            r'(?:я\s*)?(?:маркетолог|smm|пиарщик)': "marketing",
            r'(?:я\s*)?(?:бухгалтер|финансист|экономист)': "finance",
            r'(?:я\s*)?(?:hr|эйчар|кадровик|рекрутер)': "hr",
            r'(?:я\s*)?(?:айтишник|программист|разработчик|it|ит)': "it",
            r'(?:я\s*)?(?:администратор|админ|секретарь|ассистент)': "admin",

            # IT-специфичные
            r'(?:я\s*)?(?:cto|cio|технич\w*\s*директор)': "cto",
            r'(?:я\s*)?(?:devops|девопс|сисадмин|системн\w*\s*администратор)': "devops",
            r'(?:я\s*)?(?:аналитик|bi|data)': "analyst",

            # Контекст принятия решений
            r'(?:принима|решаю|отвечаю\s*за)\w*\s*(?:решен|закупк|выбор)': "decision_maker",
            r'(?:изуча|сравнива|собираю\s*информац)\w*\s*(?:для\s*)?(?:руковод|директор|босс)': "researcher",
            r'(?:мне\s*)?(?:поручили|сказали|попросили)\s*(?:изучить|найти|подобрать)': "researcher",
        }
        for pattern, role in role_patterns.items():
            if re.search(pattern, message_lower):
                extracted["role"] = role
                break

        # =================================================================
        # ПРЕДПОЧИТАЕМЫЙ КАНАЛ СВЯЗИ (preferred_channel)
        # =================================================================
        channel_patterns = {
            # Телефон
            r'(?:лучше|удобнее|предпочитаю)\s*(?:позвон|по\s*телефон|созвон)': "phone",
            r'(?:звоните|позвоните|перезвоните)\s*(?:на|мне)': "phone",
            r'(?:по\s*)?телефон\w*\s*(?:удобн|лучше|предпочит)': "phone",

            # WhatsApp
            r'(?:whatsapp|ватсап|вотсап|вацап|воцап)': "whatsapp",
            r'(?:лучше|удобнее|пишите)\s*в\s*(?:whatsapp|ватсап|вотсап)': "whatsapp",

            # Telegram
            r'(?:telegram|телеграм|телега|тг)\s*(?:удобн|лучше|пишите)?': "telegram",
            r'(?:лучше|удобнее|пишите)\s*в\s*(?:telegram|телеграм|телегу|тг)': "telegram",

            # Email
            r'(?:email|почт[уае]|mail|мейл)\s*(?:удобн|лучше|пишите)?': "email",
            r'(?:лучше|удобнее|пишите)\s*на\s*(?:почту|email|mail)': "email",
            r'(?:напишите|пришлите)\s*на\s*(?:почту|email)': "email",

            # Любой
            r'(?:любой|любым)\s*(?:способ|канал|путь)': "any",
            r'(?:как\s*)?удобно\s*(?:вам|будет)': "any",
        }
        for pattern, channel in channel_patterns.items():
            if re.search(pattern, message_lower):
                extracted["preferred_channel"] = channel
                break

        # =================================================================
        # КОЛИЧЕСТВО ПОЛЬЗОВАТЕЛЕЙ (если не извлечено как company_size)
        # =================================================================
        if "company_size" not in extracted:
            user_patterns = [
                r'(\d+)\s*(?:пользовател|юзер|user|оператор|рабоч\w*\s*мест)',
                r'(?:на\s*)?(\d+)\s*(?:лицензи|место|аккаунт)',
                r'(?:лицензи|место|аккаунт)\w*\s*(?:на\s*)?(\d+)',
            ]
            for pattern in user_patterns:
                match = re.search(pattern, message_lower)
                if match:
                    count = int(match.group(1))
                    if 1 <= count <= 10000:
                        extracted["users_count"] = count
                        break

        # =================================================================
        # TIMELINE / СРОКИ ВНЕДРЕНИЯ
        # =================================================================
        timeline_patterns = {
            r'(?:сегодня|завтра|на\s*днях)': "immediate",
            r'(?:на\s*)?(?:этой|ближайш)\w*\s*недел': "this_week",
            r'(?:в\s*)?(?:этом|ближайш)\w*\s*месяц': "this_month",
            r'(?:в\s*)?(?:след|будущ)\w*\s*месяц': "next_month",
            r'(?:в\s*)?(?:этом|ближайш)\w*\s*квартал': "this_quarter",
            r'(?:в\s*)?(?:след|будущ)\w*\s*квартал': "next_quarter",
            r'(?:в\s*)?(?:этом|ближайш)\w*\s*году?': "this_year",
            r'(?:в\s*)?(?:след|будущ|нов)\w*\s*году?': "next_year",
            r'(?:не\s*)?(?:определено|понятно|знаю)\s*(?:когда)?': "undefined",
        }
        for pattern, timeline in timeline_patterns.items():
            if re.search(pattern, message_lower):
                extracted["timeline"] = timeline
                break

        return extracted

