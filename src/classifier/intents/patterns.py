"""
Приоритетные паттерны для классификации интентов

Эти паттерны проверяются ПЕРЕД обычной классификацией по корням.
Решают проблему когда "не интересно" ловится как "agreement"
из-за корня "интересн", хотя по смыслу это rejection.
"""

import re
from typing import List, Tuple


# =============================================================================
# ПРИОРИТЕТНЫЕ ПАТТЕРНЫ (проверяются ПЕРЕД обычной классификацией)
# =============================================================================

PRIORITY_PATTERNS: List[Tuple[str, str, float]] = [
    # (pattern, intent, confidence)
    # ВАЖНО: Порядок паттернов имеет значение! Первый совпавший выигрывает.

    # =================================================================
    # CRITICAL PATTERNS (проверяются первыми!)
    # ВАЖНО: Паттерны должны работать с НОРМАЛИЗОВАННЫМ текстом!
    # Нормализатор: "умеет"→"умет", "программа"→"програма", "расскажите"→"расскажи те", "iiko"→"iko"
    # =================================================================
    # Сравнение с конкурентами - до question_features!
    (r'(?:а\s+)?чем\s+(?:вы\s+)?лучше\s+(?:iiko|iko|ийко|айко)', "objection_competitor", 0.99),
    (r'чем\s+лучше\s+(?:iiko|iko|ийко|айко|poster|постер|1с|1c)', "objection_competitor", 0.99),
    # Вопросы о продукте - специфичные фразы (с учётом нормализации)
    (r'что\s+ум\w*\s+програ', "question_features", 0.99),  # "что умет програма"
    (r'расскаж\w*\s+(?:те\s+)?о\s+систем', "question_features", 0.99),  # "расскажи те о системе"
    (r'^что\s+(?:вы\s+)?предлагаете[?!.\s]*$', "question_features", 0.99),

    # =================================================================
    # CALLBACK REQUEST (запрос обратного звонка)
    # =================================================================
    (r'(?:перезвон|позвон)\w*\s*(?:мне|нам)', "callback_request", 0.95),
    (r'(?:можете|можно)\s*(?:перезвон|позвон)', "callback_request", 0.9),
    (r'(?:жду|ожидаю)\s*(?:звонк|вашего?\s*звонк)', "callback_request", 0.9),
    (r'(?:свяжитесь|связаться)\s*(?:со?\s*мной|с\s*нами)', "callback_request", 0.9),
    (r'(?:набери|наберите)\s*(?:меня|мне|нас)', "callback_request", 0.9),
    (r'вот\s*(?:мой\s*)?(?:номер|телефон|контакт)', "callback_request", 0.85),
    (r'(?:звони|звоните)\s*(?:на|по)\s*(?:этот|этому)', "callback_request", 0.85),
    (r'запиши\w*\s*(?:мой\s*)?(?:номер|телефон)', "callback_request", 0.85),
    # Дополнительные паттерны callback_request
    (r'(?:давайте|хочу)\s*(?:созвониться|созвонимся)', "callback_request", 0.9),
    (r'(?:лучше|удобнее)\s*(?:по\s*)?(?:телефон|голосом)', "callback_request", 0.85),
    (r'(?:когда|во\s*сколько)\s*(?:можете|удобно)\s*(?:позвонить|перезвонить)', "callback_request", 0.9),
    (r'(?:напиши|напишите)\s*(?:в\s*)?(?:ватсап|вотсап|whatsapp|телеграм|тг)', "callback_request", 0.85),
    (r'(?:стукни|черкани|тукни)\s*(?:в\s*)?(?:личку|лс|pm)', "callback_request", 0.85),

    # =================================================================
    # DEMO REQUEST (запрос демо)
    # =================================================================
    (r'(?:хочу|хотим|нужн\w*|дайте|покажите)\s*демо', "demo_request", 0.95),
    (r'(?:можно|можете)\s*(?:показать|провести)\s*демо', "demo_request", 0.9),
    (r'демо\s*(?:версию?|доступ|период)', "demo_request", 0.9),
    (r'(?:запишите|запиши)\s*(?:на|меня\s*на)\s*демо', "demo_request", 0.95),
    (r'(?:хочу|хотим)\s*посмотреть\s*(?:как\s*работает|систему|продукт)', "demo_request", 0.85),
    (r'(?:покажите|покажи)\s*(?:как\s*работает|в\s*действии|на\s*примере)', "demo_request", 0.9),
    # КРИТИЧЕСКИЙ FIX: negative lookahead исключает НЕ-демо контексты
    (r'(?:можно|хочу)\s*(?:попробовать|потестить|потестировать)(?!\s+(?:сам|решить|документ|конкурент|вариант|друг))', "demo_request", 0.9),
    (r'(?:есть|дайте)\s*(?:пробн\w*|тестов\w*)\s*(?:период|версию?|доступ)', "demo_request", 0.9),
    (r'(?:trial|триал|тест\w*\s*драйв)', "demo_request", 0.9),
    (r'бесплатн\w*\s*(?:период|доступ|версию?)', "demo_request", 0.85),
    # Дополнительные паттерны demo_request
    (r'(?:хочу|хотим)\s*(?:пощупать|покрутить|поюзать|потыкать)', "demo_request", 0.9),
    (r'(?:дайте|давайте)\s*(?:тестовый|пробный)\s*(?:аккаунт|доступ)', "demo_request", 0.9),
    (r'(?:freemium|фримиум|free\s*trial|фри\s*триал)', "demo_request", 0.9),
    (r'(?:пилот|пилотный|poc)\s*(?:проект|запуск|внедрен)', "demo_request", 0.85),
    (r'(?:онлайн|личн\w*)\s*(?:показ|демонстрац|презентац)', "demo_request", 0.85),
    (r'(?:забукать|забронировать|назначить)\s*(?:демо|встречу|показ)', "demo_request", 0.9),

    # =================================================================
    # CONSULTATION REQUEST (запрос консультации)
    # =================================================================
    (r'(?:нужн\w*|хочу|хотим)\s*консультаци', "consultation_request", 0.9),
    (r'(?:можно|можете)\s*проконсультировать', "consultation_request", 0.9),
    (r'(?:хотел|хотела)\s*бы\s*(?:обсудить|поговорить|посоветоваться)', "consultation_request", 0.85),
    (r'(?:нужен|нужна)\s*(?:совет|помощь|консультант)', "consultation_request", 0.85),
    (r'(?:посоветуйте|порекомендуйте|подскажите)\s*(?:что|как|какой)', "consultation_request", 0.85),
    (r'(?:помогите|помоги)\s*(?:разобраться|понять|выбрать)', "consultation_request", 0.85),
    (r'(?:у\s*меня|есть)\s*(?:вопрос|вопросы)\s*(?:по|о|про)', "consultation_request", 0.8),
    # Дополнительные паттерны consultation_request
    (r'(?:объясните|объясни|разъясните)\s*(?:пожалуйста|как|что)', "consultation_request", 0.85),
    (r'(?:не\s*могу|не\s*получается)\s*(?:разобраться|понять|выбрать)', "consultation_request", 0.85),
    # Примечание: "хочу узнать больше" без "нет" — consultation_request, с "нет" — agreement (см. CLARIFICATION)
    (r'^(?:хочу|хотим)\s*(?:разобраться|понять|узнать)\s*(?:подробнее|больше|детальнее)', "consultation_request", 0.85),
    (r'(?:нужен|нужна)\s*(?:эксперт|специалист|менеджер)', "consultation_request", 0.85),
    (r'(?:поговорить|пообщаться)\s*(?:со\s*)?(?:специалист|менеджер|эксперт)', "consultation_request", 0.9),
    (r'(?:запутался|не\s*понимаю|сложно)\s*(?:в\s*)?(?:этом|выборе|вопросе)', "consultation_request", 0.8),

    # =================================================================
    # COMPARISON (сравнение с конкурентами)
    # =================================================================
    (r'(?:чем\s*)?(?:лучше|хуже|отличаетесь?)\s*(?:от|чем)\s*(?:\w+)', "comparison", 0.9),
    (r'(?:сравн\w*|разниц\w*)\s*(?:с|между|от)\s*(?:амо|битрикс|мегаплан)', "comparison", 0.9),
    (r'(?:почему|зачем)\s*(?:вы|вас|ваш\w*)\s*(?:а\s*не|вместо)', "comparison", 0.85),
    (r'(?:амо|битрикс|мегаплан|salesforce)\s*(?:или|vs|против)\s*(?:вы|вас|ваш)', "comparison", 0.9),
    (r'(?:вы|ваш\w*)\s*(?:или|vs|против)\s*(?:амо|битрикс|мегаплан)', "comparison", 0.9),
    (r'(?:преимуществ\w*|плюс\w*)\s*(?:перед|над|по\s*сравнению)', "comparison", 0.85),
    (r'(?:минус\w*|недостатк\w*)\s*(?:по\s*сравнению|относительно)', "comparison", 0.85),
    (r'(?:что\s*)?(?:есть|умеет)\s*(?:у\s*вас|ваш\w*)\s*(?:чего\s*нет|что\s*нет)\s*(?:у|в)', "comparison", 0.9),

    # =================================================================
    # PRICE QUESTION (короткие ценовые вопросы)
    # =================================================================
    (r'^(?:почём|почем|по\s*чём|по\s*чем)[?!.\s]*$', "price_question", 0.95),
    (r'^(?:цена|ценник|прайс|стоимость)[?!.\s]*$', "price_question", 0.95),
    (r'^(?:сколько|скока|скоко)[?!.\s]*$', "price_question", 0.9),

    # =================================================================
    # PRICING DETAILS (детали по ценообразованию)
    # =================================================================
    (r'(?:из\s*чего|как)\s*складывается\s*(?:цена|стоимость)', "pricing_details", 0.9),
    (r'(?:что\s*)?входит\s*в\s*(?:стоимость|цену|тариф|пакет)', "pricing_details", 0.9),
    (r'(?:есть|дайте)\s*(?:прайс|прайс-лист|расчёт|расчет)', "pricing_details", 0.9),
    (r'(?:скидк\w*|акци\w*)\s*(?:есть|какие|бывают)', "pricing_details", 0.85),
    (r'(?:минимальн\w*|базов\w*)\s*(?:пакет|тариф|цена|стоимость)', "pricing_details", 0.85),
    (r'(?:сколько|какая\s*цена)\s*(?:за|на)\s*(?:одного|одно|1)\s*(?:пользовател|рабочее\s*место|лицензи)', "pricing_details", 0.9),
    (r'(?:оплата|платёж)\s*(?:помесячн\w*|ежемесячн\w*|годов\w*|разов\w*)', "pricing_details", 0.85),
    (r'(?:рассрочк\w*|кредит\w*|отсрочк\w*)\s*(?:есть|возможн\w*|даёте)', "pricing_details", 0.85),
    (r'(?:условия|способ\w*)\s*оплат', "pricing_details", 0.8),

    # =================================================================
    # PRODUCT QUESTIONS (вопросы о продукте)
    # =================================================================
    (r'что\s+такое', "question_features", 0.9),
    (r'что\s+это\s+за', "question_features", 0.9),
    (r'что\s+за\s+\w+', "question_features", 0.85),
    (r'рас+каж\w*\s+(?:о|про|об)\b', "question_features", 0.9),
    (r'подробн\w*\s+(?:о|про|об)\b', "question_features", 0.85),
    (r'\w+\s+что\s+это', "question_features", 0.85),
    (r'хо[чт]\w*\s+узнать\s+(?:о|про|об)\b', "question_features", 0.85),
    (r'что\s+(?:вы\s+)?предлага', "question_features", 0.85),
    (r'чем\s+(?:вы\s+)?заним', "question_features", 0.9),
    (r'(?:ваша\s+)?компани[яю]\s+(?:делает|заним)', "question_features", 0.9),
    (r'чем\s+(?:вы\s+)?(?:делаете|занят)', "question_features", 0.9),
    # Вопросы о возможностях системы/программы
    (r'что\s+умеет\s+(?:ваш\w*\s+)?(?:программ\w*|систем\w*|продукт\w*|crm|црм)', "question_features", 0.95),
    (r'что\s+умеет\s+программ', "question_features", 0.95),  # "Что умеет программа?"
    (r'(?:программ\w*|систем\w*|продукт\w*)\s+(?:что\s+)?умеет', "question_features", 0.9),
    (r'расскаж\w*\s+о\s+(?:систем\w*|программ\w*|продукт\w*|сервис\w*)', "question_features", 0.95),
    (r'расскажите\s+о\s+систем', "question_features", 0.95),  # "Расскажите о системе"
    (r'что\s+(?:вы\s+)?предлага', "question_features", 0.95),  # "Что вы предлагаете?"
    # Дополнительные вопросы о продукте
    (r'(?:как|каким\s*образом)\s*(?:это\s*)?работает', "question_features", 0.85),
    (r'(?:какие|что\s*за)\s*(?:функци\w*|возможност\w*|фич\w*)', "question_features", 0.85),
    (r'(?:умеет|может|способн\w*)\s*(?:ли|ваш\w*)', "question_features", 0.8),
    (r'(?:для\s*чего|зачем)\s*(?:это|нужн\w*|использу)', "question_features", 0.85),
    (r'(?:кому|для\s*кого)\s*(?:подходит|предназначен|это)', "question_features", 0.85),
    (r'(?:есть\s*ли|имеется?\s*ли)\s*\w+', "question_features", 0.8),
    (r'(?:поддержива\w*|работает\s*ли)\s*(?:с|на|в)\s*\w+', "question_features", 0.8),

    # =================================================================
    # QUESTION_INTEGRATIONS (вопросы об интеграциях)
    # =================================================================
    (r'(?:работает|подключ|интегр|связ)\w*\s*(?:с\s*)?(?:kaspi|каспи|каспий)', "question_integrations", 0.95),
    (r'(?:kaspi|каспи|каспий)\s*(?:работает|подключ|интегр|связ)', "question_integrations", 0.95),
    (r'(?:подключ|связ|интегр)\w*\s*(?:с\s*)?(?:банк|эквайринг)', "question_integrations", 0.9),
    (r'(?:банк|эквайринг)\w*\s*(?:подключ|связ|интегр)', "question_integrations", 0.9),
    (r'(?:работает|подключает|есть)\w*\s*(?:к\s*)?(?:банку|эквайрингу|терминал)', "question_integrations", 0.9),

    # =================================================================
    # CLARIFICATION (уточнение — "нет" + позитивный контекст)
    # =================================================================
    (r'нет,?\s*кое[\s\-]?(?:что|чего)', "agreement", 0.9),
    (r'нет,?\s*(?:мне|нам)\s*(?:нужн|интересн|хоч)', "agreement", 0.9),
    (r'нет,?\s*я\s*хо[чт]', "agreement", 0.9),
    (r'нет,?\s*(?:я|мы)\s*хо[чт]\w*\s*(?:узнать|понять|разобраться)', "agreement", 0.95),
    (r'нет,?\s*но\s', "agreement", 0.85),
    (r'нет,?\s*не\s*вс[еёо]', "agreement", 0.85),
    (r'нет,?\s*(?:только|конкретн|именно|определ)', "agreement", 0.9),
    (r'нет,?\s*друг', "agreement", 0.85),
    (r'нет,?\s*(?:расскажите|покажите|объясните)', "agreement", 0.9),
    # Дополнительные уточнения
    (r'нет,?\s*(?:подожди|подождите|стоп|погоди)', "agreement", 0.85),
    (r'нет,?\s*(?:я\s*имел|имею)\s*в\s*виду', "agreement", 0.9),
    (r'нет,?\s*(?:не\s*так|не\s*то|не\s*это)', "agreement", 0.85),
    (r'нет,?\s*(?:вопрос\s*)?(?:в\s*другом|о\s*другом)', "agreement", 0.85),
    (r'нет,?\s*(?:а\s*)?(?:можно|можете)\s*\w+', "agreement", 0.85),

    # =================================================================
    # REJECTION (отказы с отрицанием)
    # FIX: Добавлены word boundaries (?:^|\s) чтобы "мне нужна" не матчилось как "не нужн"
    # =================================================================
    (r'(?:^|\s)не\s+интересн', "rejection", 0.9),
    (r'неинтересн', "rejection", 0.9),
    (r'(?:^|\s)не\s+нужн', "rejection", 0.9),
    (r'ненужн', "rejection", 0.9),
    # FIX: negative lookahead - "не надо объяснять/рассказывать" это не rejection
    # Учитываем опечатки: обяснять (без ъ), расказывать (одна с) и т.д.
    (r'(?:^|\s)не\s*надо(?!\s*(?:об[ъь]?ясн|рас+каз|повтор|долго|подробн|детал|ждать|торопи))', "rejection", 0.9),
    (r'^ненадо', "rejection", 0.9),
    (r'(?:^|\s)не\s+хо[чт]', "rejection", 0.85),
    (r'(?:^|\s)не\s+буд', "rejection", 0.85),
    (r'нет,?\s*спасибо', "rejection", 0.9),
    (r'спасибо,?\s*не\s*(?:надо|нужн)', "rejection", 0.9),
    # Дополнительные отказы
    (r'(?:это\s*)?(?:спам|реклама|развод)', "rejection", 0.95),
    (r'(?:отписать|удалить|исключить)\s*(?:меня|нас|мой)', "rejection", 0.95),
    (r'(?:больше\s*)?(?:не\s*пишите|не\s*звоните|не\s*беспокойте)', "rejection", 0.95),
    (r'(?:уберите|удалите)\s*(?:мой|меня|наш)', "rejection", 0.9),
    (r'(?:в\s*бан|заблокиру|блокиру)', "rejection", 0.95),
    (r'(?:отстань|отвали|отвяжи|достал|надоел)', "rejection", 0.95),
    (r'(?:прекрати|хватит|стоп)\s*(?:писать|звонить|спамить)', "rejection", 0.95),
    (r'(?:не\s*)?(?:актуальн\w*\s*)?(?:больше\s*)?не\s*(?:актуальн|релевантн)', "rejection", 0.85),
    (r'(?:мимо|не\s*по\s*адресу|не\s*туда)', "rejection", 0.85),
    (r'(?:вы\s*)?(?:ошиблись|не\s*тот|не\s*туда|не\s*ко\s*мне)', "rejection", 0.85),
    (r'у\s*(?:меня|нас)\s*(?:всё|все)\s*(?:есть|хорошо|норм)', "rejection", 0.8),
    (r'(?:справля|обход)\w*\s*(?:сами|без\s*вас|своими)', "rejection", 0.8),
    # Дополнительные паттерны rejection
    # FIX: \b и negative lookahead исключают "отказоустойчивость", "безотказный"
    # Добавлены формы: отказываемся (мы), отказался, отказалась, отказались
    (r'(?:категорическ\w*\s*)?\b(?:отказываюсь|отказываемся|отказал\w*|отказ)\b(?![оа-я])', "rejection", 0.9),
    (r'(?:категорическ\w*\s+нет)[.!?\s]*$', "rejection", 0.95),
    (r'(?:ни\s*за\s*что|никогда|ни\s*при\s*каких)', "rejection", 0.95),
    (r'(?:однозначн\w*|определённ\w*|точно)\s*нет[.!?\s]*$', "rejection", 0.95),
    (r'(?:пошли?\s*вы|идите\s*лесом|идите\s*нафиг)', "rejection", 0.95),
    (r'(?:сколько\s*можно|да\s*сколько\s*раз|опять\s*вы|снова\s*вы)', "rejection", 0.9),
    # FIX: word boundaries исключают "закрытие сделки", "закрытый канал"
    (r'\b(?:закрыты?|закрылись|закрываемся|банкроты?|ликвидируемся|ликвидирован\w*)\b', "rejection", 0.9),
    # FIX: "не" обязателен, иначе ловится просто "клиент" (ложные rejection)
    (r'(?:мы\s+)?не\s+(?:ваш\w*\s+)?(?:целевая\s+)?(?:аудитори?|клиент)', "rejection", 0.85),
    (r'(?:не\s*наш|не\s*для\s*нас|не\s*подходит)', "rejection", 0.85),
    (r'(?:пас|pass|пасс)[.!?\s]*$', "rejection", 0.85),

    # =================================================================
    # OBJECTION_PRICE (возражения по цене)
    # =================================================================
    # Одиночные слова "дорого", "дороговато"
    (r'^(?:дорого|дороговато|накладно)[.!?\s]*$', "objection_price", 0.95),
    (r'^(?:это\s+)?(?:дорого|дороговато)[.!?\s]*$', "objection_price", 0.95),
    # Бюджетные возражения
    (r'нет\s*бюджет', "objection_price", 0.9),
    (r'бюджет\w*\s*нет', "objection_price", 0.9),
    (r'без\s*бюджет', "objection_price", 0.85),
    (r'не\s*залож\w*\s*(?:в\s*)?бюджет', "objection_price", 0.85),
    (r'денег\s*нет', "objection_price", 0.9),
    (r'нет\s*денег', "objection_price", 0.9),
    # FIX: word boundary чтобы "мне потянет" не матчилось
    (r'(?:^|\s)не\s+потян', "objection_price", 0.85),
    # Дополнительные ценовые возражения
    (r'(?:слишком|очень|чересчур)\s*(?:дорого|дороговато)', "objection_price", 0.9),
    (r'(?:цена|ценник|прайс)\s*(?:кусается|кусачий|жирный|высокий)', "objection_price", 0.9),
    (r'(?:для\s*нас|нам)\s*(?:дорого|дороговато|накладно)', "objection_price", 0.9),
    (r'(?:не\s*)?по\s*карман', "objection_price", 0.85),
    (r'(?:финанс\w*|средств)\s*(?:нет|не\s*хватает|ограничен)', "objection_price", 0.85),
    (r'(?:урезали|сократили|нет)\s*(?:бюджет|финансирован)', "objection_price", 0.85),
    (r'(?:экономим|режем|сокращаем)\s*(?:расход|затрат|бюджет)', "objection_price", 0.85),
    (r'(?:у\s*конкурент|другие)\w*\s*дешевл', "objection_price", 0.85),
    (r'(?:видел|нашёл|есть)\s*(?:дешевл|подешевл)', "objection_price", 0.85),
    (r'(?:много|слишком)\s*(?:хотите|просите|берёте)', "objection_price", 0.85),
    (r'(?:неоправданн|завышенн)\w*\s*(?:цена|стоимость)', "objection_price", 0.85),
    (r'(?:не\s*)?(?:стоит|окуп\w*|отобь)\w*\s*(?:таких|этих|своих)\s*денег', "objection_price", 0.85),
    (r'(?:можно|можете|давайте)\s*(?:дешевл|скидк|подешевл)', "objection_price", 0.8),
    # Дополнительные паттерны objection_price
    (r'(?:грабёж|грабительск|космическ\w*|заоблачн\w*)\s*(?:цен|ценник)', "objection_price", 0.9),
    (r'(?:ценник|цена)\s*(?:лютый|конский|космос|нереальн)', "objection_price", 0.9),
    (r'(?:кризис|тяжёл\w*\s*времена|сложн\w*\s*период)', "objection_price", 0.85),
    (r'(?:касса\s*пуст\w*|оборотки?\s*нет|выручк\w*\s*упала)', "objection_price", 0.85),
    (r'(?:в\s*два\s*раза|вдвое|втрое)\s*дороже', "objection_price", 0.9),
    (r'(?:нашёл|нашли|видел)\s*(?:дешевле|за\s*меньше)', "objection_price", 0.85),
    (r'(?:торг|скидка|дисконт)\s*(?:возможен|уместен|есть)', "objection_price", 0.8),

    # =================================================================
    # OBJECTION_NO_TIME (возражения по времени)
    # =================================================================
    (r'нет\s*времен', "objection_no_time", 0.9),
    (r'сейчас\s*не\s*мог', "objection_no_time", 0.85),
    # Дополнительные временные возражения
    # FIX: Добавлен контекст чтобы исключить "занятие", "занятость" (существительные), "файл загружен"
    # Поддержка форм: занят/заняты/занята, загружен/загружены/загружена
    # Исключаем: занятость, занятие (negative lookahead на "ост" и "ие")
    (r'(?:я|мы|сейчас)\s*(?:очень\s*)?(?:занят(?:ы|а|о)?|загружен(?:ы|а|о)?)\b', "objection_no_time", 0.85),
    (r'\b(?:запара|завал|аврал)\b', "objection_no_time", 0.85),
    (r'(?:некогда|не\s*до\s*этого|не\s*до\s*вас)', "objection_no_time", 0.85),
    (r'(?:позвоните|напишите|свяжитесь)\s*(?:позже|потом|завтра|в\s*другой)', "objection_no_time", 0.85),
    (r'(?:позже|потом)\s*(?:свяж\w*|созвон\w*|напиш\w*|поговор\w*)', "objection_no_time", 0.9),
    (r'(?:давайте|может)\s*(?:позже|потом|в\s*другой|на\s*след)', "objection_no_time", 0.85),
    (r'(?:сейчас\s*)?(?:горят|горящ\w*)\s*(?:дедлайн|сроки|задачи)', "objection_no_time", 0.85),
    (r'(?:конец|начало)\s*(?:года|квартала|месяца|отчётност)', "objection_no_time", 0.8),
    (r'(?:после\s*)?(?:праздник|отпуск|выходн|нового\s*года)', "objection_no_time", 0.8),
    (r'(?:разгреб|освобож|выберу|найду)\w*\s*(?:время|момент|окно)', "objection_no_time", 0.8),
    (r'(?:сезон|высокий\s*сезон|пик\s*нагрузки)', "objection_no_time", 0.8),
    (r'(?:руки|голова)\s*(?:не\s*доход|забит)', "objection_no_time", 0.8),
    (r'(?:сейчас\s*)?(?:тяжёл\w*|сложн\w*)\s*(?:период|время|момент)', "objection_no_time", 0.8),
    # Дополнительные паттерны objection_no_time
    (r'(?:командировка|в\s*поездке|в\s*отъезде|в\s*разъездах)', "objection_no_time", 0.85),
    (r'(?:проект\s*горит|релиз|сдача\s*проекта)', "objection_no_time", 0.85),
    (r'(?:инвентаризац|ревизия|аудит)', "objection_no_time", 0.8),
    (r'(?:совещания|митинги|встречи)\s*(?:весь\s*день|расписан)', "objection_no_time", 0.85),
    (r'(?:давайте\s*)?(?:в\s*понедельник|во\s*вторник|на\s*след\w*\s*недел)', "objection_no_time", 0.8),
    (r'(?:щас|ща|сейчас)\s*(?:не\s*до\s*этого|не\s*могу|никак)', "objection_no_time", 0.85),
    (r'(?:времечка|минутки|секунды)\s*(?:нет|ни)', "objection_no_time", 0.85),
    (r'(?:загруз\w*|заваленн\w*)\s*(?:полный|полностью|по\s*горло)', "objection_no_time", 0.85),

    # =================================================================
    # OBJECTION_COMPETITOR (уже есть конкурент)
    # =================================================================
    # NOTE: Сравнение "чем лучше iiko/poster" уже в CRITICAL PATTERNS (строки 27-28)
    # Здесь только уникальные паттерны, не покрытые CRITICAL PATTERNS
    # Паттерны "почему не X" - уникальные (вопрос "почему не используете конкурента")
    (r'(?:почему|зачем)\s*(?:вы\s*)?(?:а\s*)?не\s*(?:1с|1c|iiko|iko|ийко|poster|постер)', "objection_competitor", 0.9),
    # "у iiko дешевле/лучше" - уникальный паттерн
    (r'(?:у\s*)?(?:iiko|iko|ийко|айко|poster|постер)\s*(?:дешевл|лучше)', "objection_competitor", 0.9),
    # POS и ресторанные системы
    (r'(?:уже\s*)?(?:есть|используем|работаем\s*в|сидим\s*на)\s*(?:iiko|iko|ийко|айко|poster|постер|r.keeper)', "objection_competitor", 0.9),
    # CRM системы
    (r'(?:уже\s*)?(?:есть|используем|работаем\s*в|сидим\s*на)\s*(?:crm|црм|система)', "objection_competitor", 0.85),
    (r'(?:уже\s*)?(?:есть|используем|работаем\s*в|сидим\s*на)\s*(?:амо|битрикс|мегаплан|salesforce|pipedrive)', "objection_competitor", 0.9),
    (r'(?:внедрили|подключили|купили|перешли\s*на)\s*(?:crm|црм|амо|битрикс|мегаплан)', "objection_competitor", 0.9),
    (r'(?:нас\s*)?устраивает\s*(?:текущ\w*|нынешн\w*|наш\w*)', "objection_competitor", 0.85),
    (r'(?:менять|переходить|мигрировать)\s*(?:не\s*)?(?:хотим|планируем|собираемся)', "objection_competitor", 0.85),
    (r'(?:уже\s*)?(?:вложили|потратили|заплатили)\s*(?:деньги|много|немало)', "objection_competitor", 0.85),
    (r'(?:команда|все|сотрудники)\s*(?:привыкли|обучены|знают)', "objection_competitor", 0.8),
    (r'(?:у\s*нас|есть)\s*(?:своя|собственн\w*|самописн\w*)', "objection_competitor", 0.85),
    # Дополнительные паттерны objection_competitor
    (r'(?:kommo|комо|коммо|roistat|ройстат|calltouch)', "objection_competitor", 0.85),
    (r'(?:юздеск|usedesk|омнидеск|omnidesk|helpdesk)', "objection_competitor", 0.85),
    (r'(?:всё\s*настроено|всё\s*налажено|система\s*работает)', "objection_competitor", 0.85),
    (r'(?:нет\s*смысла\s*менять|зачем\s*менять|не\s*вижу\s*смысла)', "objection_competitor", 0.85),
    (r'(?:переучив\w*|переобуч\w*|обучать\s*заново)', "objection_competitor", 0.85),
    (r'(?:только\s*внедрили|недавно\s*купили|договор\s*заключ)', "objection_competitor", 0.85),
    (r'(?:1с\s*бухгалтер|1с\s*предприят|1с\s*торговл)', "objection_competitor", 0.85),
    (r'(?:эвотор|evotor|дримкас|dreamkas|атол)', "objection_competitor", 0.85),

    # =================================================================
    # OBJECTION_THINK (надо подумать)
    # =================================================================
    (r'(?:надо|нужно|дайте)\s*(?:подумать|посовещаться|обсудить)', "objection_think", 0.85),
    (r'(?:должен|должны|нужно)\s*(?:обсудить|посоветоваться|согласовать)', "objection_think", 0.85),
    (r'(?:с\s*)?(?:руководств\w*|начальств\w*|директор\w*)\s*(?:обсуди|согласу|посовету)', "objection_think", 0.85),
    (r'(?:решение|вопрос)\s*(?:принима\w*|решае\w*)\s*(?:не\s*)?(?:я|мы)', "objection_think", 0.8),
    (r'(?:это\s*)?(?:не\s*)?(?:в\s*)?(?:моей|нашей)\s*(?:компетенции|власти)', "objection_think", 0.85),
    (r'(?:нужно\s*)?(?:время\s*)?(?:на\s*)?(?:раздум\w*|обдум\w*|размышлен)', "objection_think", 0.8),
    (r'(?:дайте|дай)\s*(?:подумать|время|пару\s*дней)', "objection_think", 0.85),
    (r'(?:перезвон|вернусь|свяжусь)\w*\s*(?:сам|позже|потом|когда\s*решу)', "objection_think", 0.8),
    (r'(?:пока\s*)?(?:не\s*готов|не\s*готовы)\s*(?:к|принять|дать)', "objection_think", 0.8),
    # Дополнительные паттерны objection_think
    (r'(?:спрошу|уточню|согласую)\s*(?:у\s*)?(?:шефа|директор|собственник|партнёр)', "objection_think", 0.85),
    (r'(?:покажу|обсужу)\s*(?:коллег\w*|команд\w*|партнёр\w*)', "objection_think", 0.85),
    (r'(?:это\s*)?(?:не\s*моё?\s*решен|выше\s*моего\s*уровня)', "objection_think", 0.85),
    (r'(?:взвесить|сравнить|обдумать)\s*(?:все\s*)?(?:за\s*и\s*против|вариант)', "objection_think", 0.85),
    (r'(?:переспать\s*с\s*мыслью|переварить\s*информац|осмыслить)', "objection_think", 0.85),
    (r'(?:пока\s*рано|ещё\s*не\s*созрел|нужно\s*дозреть)', "objection_think", 0.8),
    (r'(?:не\s*уполномоч\w*|не\s*имею\s*права|не\s*могу\s*решать)', "objection_think", 0.85),

    # =================================================================
    # AGREEMENT (согласие)
    # =================================================================
    (r'давай\w*\s*попробу', "agreement", 0.9),
    (r'хочу\s*попробо', "agreement", 0.9),
    (r'да,?\s*интересн', "agreement", 0.9),
    (r'да,?\s*давайте', "agreement", 0.9),
    (r'расскажите\s*подробн', "agreement", 0.85),
    (r'хо[чт]\w*\s*демо', "agreement", 0.9),
    # Дополнительные согласия
    (r'(?:^|\s)да[,!.\s]*$', "agreement", 0.8),  # просто "да"
    (r'(?:да|ага|угу),?\s*(?:конечно|разумеется|естественно)', "agreement", 0.9),
    (r'(?:звучит|выглядит)\s*(?:интересн|хорош|неплох|здорово)', "agreement", 0.85),
    (r'(?:заинтересова|заинтригова|любопытн)', "agreement", 0.85),
    (r'(?:хотел|хотела)\s*бы\s*(?:узнать|попробова|посмотре)', "agreement", 0.85),
    (r'(?:можно|можем|давайте)\s*(?:созвониться|пообщаться|обсудить)', "agreement", 0.85),
    (r'(?:когда\s*)?(?:можно|удобно)\s*(?:созвониться|встретиться|показать)', "agreement", 0.85),
    (r'(?:отлично|супер|класс|круто|здорово)[,!.\s]*(?:давайте|жду)', "agreement", 0.9),
    (r'(?:принял|понял|услышал)[,.\s]*(?:жду|давайте|запишите)', "agreement", 0.85),
    (r'(?:записывайте|записывай|пишите|пиши)[,.\s]*(?:меня|мой|нас)', "agreement", 0.9),
    (r'(?:бронируй|бронирую|бронируйте)\s*(?:время|слот|встречу)', "agreement", 0.9),
    (r'(?:готов|готовы|готова)\s*(?:посмотреть|попробовать|обсудить|слушать)', "agreement", 0.9),
    (r'(?:в\s*деле|погнали|поехали|(?:^|\s)го(?:\s|$|!)|погоди\s*вау)', "agreement", 0.85),
    (r'(?:почему\s*бы\s*и\s*нет|можно\s*попробовать|давай\s*попробуем)', "agreement", 0.85),
    # Заявки
    (r'оставлю\s*заявк', "agreement", 0.95),
    (r'(?:оставить|оформить|подать|отправить)\s*заявк', "agreement", 0.9),
    (r'заявк\w*\s*(?:оставлю|оформлю|подам|отправлю)', "agreement", 0.9),
    # Дополнительные паттерны agreement
    (r'(?:топ|огонь|бомба|зашибись|вау|wow|кайф|найс|nice)[!.\s]*$', "agreement", 0.85),
    (r'(?:выставляй|выставляйте|пришлите|присылайте)\s*(?:счёт|счет|договор)', "agreement", 0.95),
    (r'(?:берём|берем|оформляем|оформляй)\s*(?:это|систему|подписку)', "agreement", 0.95),
    (r'(?:это\s*то\s*что\s*нужно|именно\s*то\s*что\s*искали|под\s*нас\s*подходит)', "agreement", 0.9),
    (r'(?:нам\s*актуально|нам\s*релевантно|то\s*что\s*надо)', "agreement", 0.85),
    (r'(?:как\s*записаться|как\s*начать|как\s*подключиться|куда\s*платить)', "agreement", 0.9),
    (r'(?:какие\s*документы|что\s*нужно\s*для|как\s*оформить)', "agreement", 0.85),
    (r'(?:склоняюсь|больше\s*склон\w*|скорее\s*да|наверн\w*\s*да)', "agreement", 0.8),

    # =================================================================
    # GREETING (приветствия — с уточнением)
    # =================================================================
    (r'^(?:привет|здравствуй\w*|добрый\s*(?:день|утро|вечер)|доброе\s*утро|доброго\s*времени)[,!.\s]*$', "greeting", 0.95),
    (r'^(?:хай|хелло|здарова?|дарова|салют|приветик|ку)[,!.\s]*$', "greeting", 0.9),
    # Казахские/мусульманские приветствия
    (r'^(?:салам|ассалам\w*|салем|сәлем)[,!.\s]*$', "greeting", 0.95),

    # =================================================================
    # FAREWELL (прощания)
    # =================================================================
    # FIX: "пока" вынесен в отдельные паттерны с end-of-line контекстом
    # чтобы не матчить "пока используем excel", "пока изучаю вопрос"
    (r'(?:до\s*свидания|до\s*связи|до\s*встречи|всего\s*доброго|всего\s*хорошего)', "farewell", 0.9),
    # "пока" как прощание - только в конце предложения или с запятой перед другим прощанием
    (r'\bпока\b[,!.\s]*$', "farewell", 0.9),
    (r'(?:хорошего|удачного|отличного)\s*(?:дня|вечера|времени)', "farewell", 0.85),
    (r'(?:спасибо|благодарю)[,.\s]*(?:\bпока\b|до\s*свидания|до\s*связи)', "farewell", 0.9),
    (r'(?:бай|бб|покедова|покеда|чао|адьёс)', "farewell", 0.85),
    (r'(?:на\s*этом|на\s*сегодня|пока\s*что)\s*(?:всё|все|достаточно)', "farewell", 0.8),

    # =================================================================
    # GRATITUDE (благодарность)
    # =================================================================
    (r'^(?:спасибо|благодарю|спс|пасибо)[,!.\s]*$', "gratitude", 0.9),
    (r'(?:большое|огромное|искреннее)\s*спасибо', "gratitude", 0.9),
    (r'(?:спасибо|благодарю)\s*(?:за|вам|тебе)', "gratitude", 0.85),
    (r'(?:очень\s*)?(?:благодарен|благодарна|признателен|признательна)', "gratitude", 0.85),

    # =================================================================
    # SMALL TALK (болтовня — нужно перенаправить)
    # =================================================================
    (r'как\s*(?:дела|жизнь|настроение|сам|сама)', "small_talk", 0.85),
    (r'(?:что|как)\s*(?:нового|новенького|интересного)', "small_talk", 0.85),
    (r'(?:как\s*)?(?:погода|настроен\w*|выходн\w*|праздник\w*)', "small_talk", 0.7),

    # =================================================================
    # UNCLEAR (непонятные сообщения)
    # =================================================================
    (r'^[?!.]+$', "unclear", 0.9),  # только знаки препинания
    (r'^(?:что|ась|чего|а)[?]*$', "unclear", 0.85),  # короткие вопросы
    (r'^(?:не\s*понял|не\s*понятно|что\s*это)[?]*$', "unclear", 0.85),
    (r'^(?:\?\?\?|\.\.\.|\!\!\!)$', "unclear", 0.9),
]

# Компилируем паттерны для производительности
COMPILED_PRIORITY_PATTERNS = [(re.compile(p, re.IGNORECASE), intent, conf)
                               for p, intent, conf in PRIORITY_PATTERNS]
