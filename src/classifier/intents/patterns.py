"""
Приоритетные паттерны для классификации интентов

Эти паттерны проверяются ПЕРЕД обычной классификацией по корням.
Решают проблему когда "не интересно" ловится как "agreement"
из-за корня "интересн", хотя по смыслу это rejection.
"""

import re
from typing import List, Tuple


# =============================================================================
# ПРИОРИТЕТНЫЕ ПАТТЕРНЫ (проверяются ПЕРЕД обычной классификацией)
# =============================================================================

PRIORITY_PATTERNS: List[Tuple[str, str, float]] = [
    # (pattern, intent, confidence)
    # ВАЖНО: Порядок паттернов имеет значение! Первый совпавший выигрывает.

    # =================================================================
    # CRITICAL PATTERNS (проверяются первыми!)
    # ВАЖНО: Паттерны должны работать с НОРМАЛИЗОВАННЫМ текстом!
    # Нормализатор: "умеет"→"умет", "программа"→"програма", "расскажите"→"расскажи те", "iiko"→"iko"
    # =================================================================

    # =================================================================
    # FIX: ОТВЕТ + ТОРОПИТ → info_provided/price_question (НЕ objection_no_time!)
    # Проблема: "5 человек. Цена? Некогда." детектилось как objection_no_time
    # Решение: Если клиент даёт данные И торопит — это info_provided
    # =================================================================
    # Число + торопит → situation_provided
    (r'\d+\s*(?:человек|чел|люд\w*|сотрудник\w*)[.\s]*(?:некогда|нет\s*времени|быстр\w*)', "situation_provided", 0.95),
    (r'\d+\s*(?:человек|чел|люд\w*)[.\s]*(?:цена|почём|сколько)[?.\s]*(?:некогда|нет\s*времени)?', "situation_provided", 0.95),
    # Ответ на вопрос + торопит → info_provided
    (r'(?:да|нет|есть|нету)[,.\s]+(?:некогда|нет\s*времени|быстр\w*)', "info_provided", 0.9),
    # Цена? + торопит → price_question (не objection_no_time!)
    (r'(?:цена|почём|сколько|стоимость)[?!.\s]+(?:некогда|нет\s*времени|быстр\w*)', "price_question", 0.95),
    (r'(?:цена|почём|сколько)\s*(?:и|,)?\s*функци\w*[?.\s]*(?:некогда|быстр\w*)?', "price_question", 0.95),
    # "не грузите, скажите суть" → question_features (требование конкретики, не возражение)
    (r'(?:не\s*)?(?:грузи\w*|нагружай\w*)[,.\s]*(?:скажи\w*|говори\w*)\s*(?:суть|главн\w*|коротко)', "question_features", 0.95),
    (r'(?:давайте|давай)\s*(?:по\s*)?(?:делу|сути|быстр\w*|коротко)', "question_features", 0.9),
    (r'(?:короче|быстрее|конкретн\w*)[,!.\s]*(?:что\s*)?(?:предлага\w*|умее\w*|можете)', "question_features", 0.9),

    # Сравнение с конкурентами - до question_features!
    (r'(?:а\s+)?чем\s+(?:вы\s+)?лучше\s+(?:iiko|iko|ийко|айко)', "objection_competitor", 0.99),
    (r'чем\s+лучше\s+(?:iiko|iko|ийко|айко|poster|постер|1с|1c)', "objection_competitor", 0.99),
    # Вопросы о продукте - специфичные фразы (с учётом нормализации)
    (r'что\s+ум\w*\s+програ', "question_features", 0.99),  # "что умет програма"
    (r'расскаж\w*\s+(?:те\s+)?о\s+систем', "question_features", 0.99),  # "расскажи те о системе"
    (r'^что\s+(?:вы\s+)?предлагаете[?!.\s]*$', "question_features", 0.99),

    # =================================================================
    # CONTACT_PROVIDED (предоставление контакта) - ПЕРЕД callback_request!
    # Приоритет: если есть фактический контакт (телефон, email), это contact_provided
    # =================================================================
    # Телефон - разные форматы
    (r'(?:мой\s*)?(?:номер|телефон)\s*[+\d\s\-()]{7,}', "contact_provided", 0.95),
    (r'(?:звони\w*|пиши\w*)\s*(?:на|по)\s*[+\d\s\-()]{7,}', "contact_provided", 0.95),
    (r'[+]?[78]\s*[\d\s\-()]{10,}', "contact_provided", 0.9),  # номер телефона
    # Email
    (r'(?:моя?\s*)?(?:почта|email|e-mail|мейл|имейл)\s*\S+@\S+', "contact_provided", 0.95),
    (r'(?:пиши\w*|отправ\w*)\s*(?:на|по)\s*(?:почту?|email)', "contact_provided", 0.9),
    (r'\S+@\S+\.\S+', "contact_provided", 0.85),  # email формат
    # Мессенджеры с контактом
    (r'(?:мой\s*)?(?:телеграм|тг|telegram)\s*@?\w+', "contact_provided", 0.95),
    (r'(?:в\s*)?(?:ватсап|вотсап|whatsapp|вайбер|viber)\s*[+\d\s\-()]{7,}', "contact_provided", 0.95),
    (r'(?:пиши\w*|стукни\w*|напиши\w*)\s*(?:в\s*)?(?:телеграм|тг|ватсап|вотсап)\s*[+@\d]', "contact_provided", 0.95),
    # Общие фразы с контактом
    (r'(?:вот\s*)?(?:мой|моя|мои)\s*(?:контакт|данные|номер|почта)', "contact_provided", 0.9),
    (r'(?:записывай\w*|запиши\w*)\s*(?:мой\s*)?(?:номер|контакт|телефон)', "contact_provided", 0.9),

    # =================================================================
    # CALLBACK REQUEST (запрос обратного звонка) - ПОСЛЕ contact_provided
    # =================================================================
    (r'(?:перезвон|позвон)\w*\s*(?:мне|нам)', "callback_request", 0.95),
    (r'(?:можете|можно)\s*(?:перезвон|позвон)', "callback_request", 0.9),
    (r'(?:жду|ожидаю)\s*(?:звонк|вашего?\s*звонк)', "callback_request", 0.9),
    (r'(?:свяжитесь|связаться)\s*(?:со?\s*мной|с\s*нами)', "callback_request", 0.9),
    (r'(?:набери|наберите)\s*(?:меня|мне|нас)', "callback_request", 0.9),
    (r'вот\s*(?:мой\s*)?(?:номер|телефон|контакт)', "callback_request", 0.85),
    (r'(?:звони|звоните)\s*(?:на|по)\s*(?:этот|этому)', "callback_request", 0.85),
    # Дополнительные паттерны callback_request
    (r'(?:давайте|хочу)\s*(?:созвониться|созвонимся)', "callback_request", 0.9),
    (r'(?:лучше|удобнее)\s*(?:по\s*)?(?:телефон|голосом)', "callback_request", 0.85),
    (r'(?:когда|во\s*сколько)\s*(?:можете|удобно)\s*(?:позвонить|перезвонить)', "callback_request", 0.9),
    # "напиши в ватсап" без номера = callback_request
    (r'(?:напиши|напишите)\s*(?:в\s*)?(?:ватсап|вотсап|whatsapp|телеграм|тг)\s*$', "callback_request", 0.85),
    (r'(?:стукни|черкани|тукни)\s*(?:в\s*)?(?:личку|лс|pm)', "callback_request", 0.85),

    # =================================================================
    # DEMO REQUEST (запрос демо)
    # =================================================================
    (r'(?:хочу|хотим|нужн\w*|дайте|покажите)\s*демо', "demo_request", 0.95),
    (r'(?:можно|можете)\s*(?:показать|провести)\s*демо', "demo_request", 0.9),
    (r'демо\s*(?:версию?|доступ|период)', "demo_request", 0.9),
    (r'(?:запишите|запиши)\s*(?:на|меня\s*на)\s*демо', "demo_request", 0.95),
    (r'(?:хочу|хотим)\s*посмотреть\s*(?:как\s*работает|систему|продукт)', "demo_request", 0.85),
    (r'(?:покажите|покажи)\s*(?:как\s*работает|в\s*действии|на\s*примере)', "demo_request", 0.9),
    # КРИТИЧЕСКИЙ FIX: negative lookahead исключает НЕ-демо контексты
    (r'(?:можно|хочу)\s*(?:попробовать|потестить|потестировать)(?!\s+(?:сам|решить|документ|конкурент|вариант|друг))', "demo_request", 0.9),
    (r'(?:есть|дайте)\s*(?:пробн\w*|тестов\w*)\s*(?:период|версию?|доступ)', "demo_request", 0.9),
    (r'(?:trial|триал|тест\w*\s*драйв)', "demo_request", 0.9),
    (r'бесплатн\w*\s*(?:период|доступ|версию?)', "demo_request", 0.85),
    # Дополнительные паттерны demo_request
    (r'(?:хочу|хотим)\s*(?:пощупать|покрутить|поюзать|потыкать)', "demo_request", 0.9),
    (r'(?:дайте|давайте)\s*(?:тестовый|пробный)\s*(?:аккаунт|доступ)', "demo_request", 0.9),
    (r'(?:freemium|фримиум|free\s*trial|фри\s*триал)', "demo_request", 0.9),
    (r'(?:пилот|пилотный|poc)\s*(?:проект|запуск|внедрен)', "demo_request", 0.85),
    (r'(?:онлайн|личн\w*)\s*(?:показ|демонстрац|презентац)', "demo_request", 0.85),
    (r'(?:забукать|забронировать|назначить)\s*(?:демо|встречу|показ)', "demo_request", 0.9),

    # =================================================================
    # CONSULTATION REQUEST (запрос консультации)
    # =================================================================
    (r'(?:нужн\w*|хочу|хотим)\s*консультаци', "consultation_request", 0.9),
    (r'(?:можно|можете)\s*проконсультировать', "consultation_request", 0.9),
    (r'(?:хотел|хотела)\s*бы\s*(?:обсудить|поговорить|посоветоваться)', "consultation_request", 0.85),
    (r'(?:нужен|нужна)\s*(?:совет|помощь|консультант)', "consultation_request", 0.85),
    (r'(?:посоветуйте|порекомендуйте|подскажите)\s*(?:что|как|какой)', "consultation_request", 0.85),
    (r'(?:помогите|помоги)\s*(?:разобраться|понять|выбрать)', "consultation_request", 0.85),
    (r'(?:у\s*меня|есть)\s*(?:вопрос|вопросы)\s*(?:по|о|про)', "consultation_request", 0.8),
    # Дополнительные паттерны consultation_request
    (r'(?:объясните|объясни|разъясните)\s*(?:пожалуйста|как|что)', "consultation_request", 0.85),
    (r'(?:не\s*могу|не\s*получается)\s*(?:разобраться|понять|выбрать)', "consultation_request", 0.85),
    # Примечание: "хочу узнать больше" без "нет" — consultation_request, с "нет" — agreement (см. CLARIFICATION)
    (r'^(?:хочу|хотим)\s*(?:разобраться|понять|узнать)\s*(?:подробнее|больше|детальнее)', "consultation_request", 0.85),
    (r'(?:нужен|нужна)\s*(?:эксперт|специалист|менеджер)', "consultation_request", 0.85),
    (r'(?:поговорить|пообщаться)\s*(?:со\s*)?(?:специалист|менеджер|эксперт)', "consultation_request", 0.9),
    (r'(?:запутался|не\s*понимаю|сложно)\s*(?:в\s*)?(?:этом|выборе|вопросе)', "consultation_request", 0.8),

    # =================================================================
    # COMPARISON (сравнение с конкурентами)
    # =================================================================
    (r'(?:чем\s*)?(?:лучше|хуже|отличаетесь?)\s*(?:от|чем)\s*(?:\w+)', "comparison", 0.9),
    (r'(?:сравн\w*|разниц\w*)\s*(?:с|между|от)\s*(?:амо|битрикс|мегаплан)', "comparison", 0.9),
    (r'(?:почему|зачем)\s*(?:вы|вас|ваш\w*)\s*(?:а\s*не|вместо)', "comparison", 0.85),
    (r'(?:амо|битрикс|мегаплан|salesforce)\s*(?:или|vs|против)\s*(?:вы|вас|ваш)', "comparison", 0.9),
    (r'(?:вы|ваш\w*)\s*(?:или|vs|против)\s*(?:амо|битрикс|мегаплан)', "comparison", 0.9),
    (r'(?:преимуществ\w*|плюс\w*)\s*(?:перед|над|по\s*сравнению)', "comparison", 0.85),
    (r'(?:минус\w*|недостатк\w*)\s*(?:по\s*сравнению|относительно)', "comparison", 0.85),
    (r'(?:что\s*)?(?:есть|умеет)\s*(?:у\s*вас|ваш\w*)\s*(?:чего\s*нет|что\s*нет)\s*(?:у|в)', "comparison", 0.9),

    # =================================================================
    # PRICE QUESTION (короткие ценовые вопросы)
    # =================================================================
    (r'^(?:почём|почем|по\s*чём|по\s*чем)[?!.\s]*$', "price_question", 0.95),
    (r'^(?:цена|ценник|прайс|стоимость)[?!.\s]*$', "price_question", 0.95),
    (r'^(?:сколько|скока|скоко)[?!.\s]*$', "price_question", 0.9),

    # =================================================================
    # PRICING DETAILS (детали по ценообразованию)
    # =================================================================
    (r'(?:из\s*чего|как)\s*складывается\s*(?:цена|стоимость)', "pricing_details", 0.9),
    (r'(?:что\s*)?входит\s*в\s*(?:стоимость|цену|тариф|пакет)', "pricing_details", 0.9),
    (r'(?:есть|дайте)\s*(?:прайс|прайс-лист|расчёт|расчет)', "pricing_details", 0.9),
    (r'(?:скидк\w*|акци\w*)\s*(?:есть|какие|бывают)', "pricing_details", 0.85),
    (r'(?:минимальн\w*|базов\w*)\s*(?:пакет|тариф|цена|стоимость)', "pricing_details", 0.85),
    (r'(?:сколько|какая\s*цена)\s*(?:за|на)\s*(?:одного|одно|1)\s*(?:пользовател|рабочее\s*место|лицензи)', "pricing_details", 0.9),
    (r'(?:оплата|платёж)\s*(?:помесячн\w*|ежемесячн\w*|годов\w*|разов\w*)', "pricing_details", 0.85),
    (r'(?:рассрочк\w*|кредит\w*|отсрочк\w*)\s*(?:есть|возможн\w*|даёте)', "pricing_details", 0.85),
    (r'(?:условия|способ\w*)\s*оплат', "pricing_details", 0.8),

    # =================================================================
    # PRODUCT QUESTIONS (вопросы о продукте)
    # =================================================================
    (r'что\s+такое', "question_features", 0.9),
    (r'что\s+это\s+за', "question_features", 0.9),
    (r'что\s+за\s+\w+', "question_features", 0.85),
    (r'рас+каж\w*\s+(?:о|про|об)\b', "question_features", 0.9),
    (r'подробн\w*\s+(?:о|про|об)\b', "question_features", 0.85),
    (r'\w+\s+что\s+это', "question_features", 0.85),
    (r'хо[чт]\w*\s+узнать\s+(?:о|про|об)\b', "question_features", 0.85),
    (r'что\s+(?:вы\s+)?предлага', "question_features", 0.85),
    (r'чем\s+(?:вы\s+)?заним', "question_features", 0.9),
    (r'(?:ваша\s+)?компани[яю]\s+(?:делает|заним)', "question_features", 0.9),
    (r'чем\s+(?:вы\s+)?(?:делаете|занят)', "question_features", 0.9),
    # Вопросы о возможностях системы/программы
    (r'что\s+умеет\s+(?:ваш\w*\s+)?(?:программ\w*|систем\w*|продукт\w*|crm|црм)', "question_features", 0.95),
    (r'что\s+умеет\s+программ', "question_features", 0.95),  # "Что умеет программа?"
    (r'(?:программ\w*|систем\w*|продукт\w*)\s+(?:что\s+)?умеет', "question_features", 0.9),
    (r'расскаж\w*\s+о\s+(?:систем\w*|программ\w*|продукт\w*|сервис\w*)', "question_features", 0.95),
    (r'расскажите\s+о\s+систем', "question_features", 0.95),  # "Расскажите о системе"
    (r'что\s+(?:вы\s+)?предлага', "question_features", 0.95),  # "Что вы предлагаете?"
    # Дополнительные вопросы о продукте
    # ВАЖНО: Специфичные паттерны миграции/внедрения ПЕРЕД generic "как работает"
    (r'(?:как|каким\s*образом)\s*(?:это\s*)?работает\s*миграц', "question_data_migration", 0.95),
    (r'(?:как|каким\s*образом)\s*(?:это\s*)?работает\s*(?:перенос|импорт)', "question_data_migration", 0.95),
    (r'(?:как|каким\s*образом)\s*(?:это\s*)?работает\s*(?:внедрение|настройка|установка)', "question_implementation", 0.95),
    (r'(?:как|каким\s*образом)\s*(?:это\s*)?работает\s*автоматизац', "question_automation", 0.95),
    (r'(?:как|каким\s*образом)\s*(?:это\s*)?работает\s*(?:офлайн|оффлайн|offline)', "question_offline", 0.95),
    # Generic "как работает" (fallback)
    (r'(?:как|каким\s*образом)\s*(?:это\s*)?работает', "question_features", 0.85),
    (r'(?:какие|что\s*за)\s*(?:функци\w*|возможност\w*|фич\w*)', "question_features", 0.85),
    (r'(?:умеет|может|способн\w*)\s*(?:ли|ваш\w*)', "question_features", 0.8),
    (r'(?:для\s*чего|зачем)\s*(?:это|нужн\w*|использу)', "question_features", 0.85),
    (r'(?:кому|для\s*кого)\s*(?:подходит|предназначен|это)', "question_features", 0.85),
    # ВАЖНО: Специфичные паттерны внедрения/обучения ПЕРЕД generic "есть ли"
    (r'(?:есть\s*ли)\s*(?:обучение|тренинг|поддержка)\s*(?:при|во\s*время|после)\s*(?:внедрении|установке|настройке)', "question_implementation", 0.95),
    (r'(?:за\s*сколько|сколько\s*времени)\s*(?:можно\s*)?(?:внедрить|запустить|настроить|установить)', "question_implementation", 0.95),
    (r'(?:есть\s*ли|имеется?\s*ли)\s*\w+', "question_features", 0.8),
    (r'(?:поддержива\w*|работает\s*ли)\s*(?:с|на|в)\s*\w+', "question_features", 0.8),

    # =================================================================
    # QUESTION_INTEGRATIONS (вопросы об интеграциях)
    # =================================================================
    (r'(?:работает|подключ|интегр|связ)\w*\s*(?:с\s*)?(?:kaspi|каспи|каспий)', "question_integrations", 0.95),
    (r'(?:kaspi|каспи|каспий)\s*(?:работает|подключ|интегр|связ)', "question_integrations", 0.95),
    (r'(?:подключ|связ|интегр)\w*\s*(?:с\s*)?(?:банк|эквайринг)', "question_integrations", 0.9),
    (r'(?:банк|эквайринг)\w*\s*(?:подключ|связ|интегр)', "question_integrations", 0.9),
    (r'(?:работает|подключает|есть)\w*\s*(?:к\s*)?(?:банку|эквайрингу|терминал)', "question_integrations", 0.9),

    # =================================================================
    # QUESTION_OFFLINE (вопросы об офлайн-режиме) - ПЕРЕД no_problem!
    # ВАЖНО: "нет интернета" не должен совпадать с "нет проблем"
    # =================================================================
    (r'(?:работает|можно)\s*(?:ли\s*)?(?:без\s*)?(?:интернета|связи|сети)', "question_offline", 0.95),
    (r'(?:что\s*)?(?:если|когда)\s*(?:нет\s*)?(?:интернета|связи|сети)', "question_offline", 0.95),
    (r'(?:без\s*)?(?:интернета|связи|сети)\s*(?:работает|можно|будет)', "question_offline", 0.95),
    (r'(?:офлайн|оффлайн|offline)\s*(?:режим|работа|функционал)?', "question_offline", 0.9),
    (r'(?:нет\s*)?(?:интернета|связи|сети)[,.]?\s*(?:что|как)\s*(?:делать|будет)', "question_offline", 0.95),

    # =================================================================
    # OBJECTION_TIMING (возражение о сроках) - ВЫСОКИЙ ПРИОРИТЕТ!
    # NOTE: Перед objection_no_time чтобы ловить конкретные сроки
    # =================================================================
    (r'давайте\s*после\s*(?:нового\s*года|праздников|отпуска)', "objection_timing", 0.9),
    (r'(?:может|можно)\s*после\s*(?:нового\s*года|праздников|отпуска)', "objection_timing", 0.9),
    (r'после\s*(?:праздник\w*|нового\s*года)\s*(?:вернёмся|созвонимся|поговорим|обсудим)', "objection_timing", 0.9),
    (r'(?:перезвоните|напишите|свяжитесь)\s*через\s*(?:\d+\s*)?(?:месяц|недел)', "objection_timing", 0.9),
    (r'пока\s*рано\s*(?:об\s*этом|говорить|решать)', "objection_timing", 0.9),

    # =================================================================
    # OBJECTION_NO_NEED (развёрнутое возражение) - ПЕРЕД no_need!
    # =================================================================
    (r'справляемся\s*без\s*(?:crm|системы|автоматизац|этого)', "objection_no_need", 0.9),
    (r'(?:обойдёмся|справимся)\s*(?:своими\s*силами|без\s*вас)', "objection_no_need", 0.9),
    (r'(?:мы\s*)?(?:маленьк|небольш)\w*[,.]?\s*нам\s*(?:не\s*надо|не\s*нужно)', "objection_no_need", 0.9),
    (r'нам\s*не\s*(?:требуется|нужна)\s*(?:автоматизац|систем|crm)', "objection_no_need", 0.9),
    (r'нет\s*такой\s*(?:проблемы|необходимости|потребности)', "objection_no_need", 0.9),
    (r'не\s*вижу\s*смысла\s*(?:в\s*этом)?', "objection_no_need", 0.9),

    # =================================================================
    # SPIN: NO_PROBLEM (нет проблемы) - ПЕРЕД rejection!
    # =================================================================
    (r'(?:у\s*нас\s*)?(?:всё|все)\s*(?:хорошо|отлично|нормально|в\s*порядке)', "no_problem", 0.85),
    (r'(?:проблем\s*)?(?:нет|не\s*вижу|не\s*замеча\w*)', "no_problem", 0.85),
    (r'справляемся\s*сами', "no_problem", 0.85),
    (r'(?:нас\s*)?(?:всё|всё\s*это)\s*устраивает', "no_problem", 0.85),
    (r'(?:не\s*вижу|нет)\s*(?:проблем|трудност|сложност)', "no_problem", 0.85),
    (r'(?:работает\s*и\s*ладно|и\s*так\s*хорошо|и\s*так\s*норм)', "no_problem", 0.85),

    # =================================================================
    # SPIN: NO_NEED (нет потребности) - ПЕРЕД rejection!
    # =================================================================
    (r'(?:нам\s*)?(?:это\s*)?не\s*(?:нужно|надо|требуется)', "no_need", 0.85),
    (r'(?:обходимся|обойдёмся)\s*(?:без\s*этого)?', "no_need", 0.85),
    (r'не\s*вижу\s*необходимости', "no_need", 0.85),
    (r'справ\w*мся\s*(?:по-старому|как\s*раньше|без\s*этого)', "no_need", 0.85),
    (r'зачем\s*нам\s*это', "no_need", 0.85),

    # =================================================================
    # CLARIFICATION (уточнение — "нет" + позитивный контекст)
    # =================================================================
    (r'нет,?\s*кое[\s\-]?(?:что|чего)', "agreement", 0.9),
    (r'нет,?\s*(?:мне|нам)\s*(?:нужн|интересн|хоч)', "agreement", 0.9),
    (r'нет,?\s*я\s*хо[чт]', "agreement", 0.9),
    (r'нет,?\s*(?:я|мы)\s*хо[чт]\w*\s*(?:узнать|понять|разобраться)', "agreement", 0.95),
    (r'нет,?\s*но\s', "agreement", 0.85),
    (r'нет,?\s*не\s*вс[еёо]', "agreement", 0.85),
    (r'нет,?\s*(?:только|конкретн|именно|определ)', "agreement", 0.9),
    (r'нет,?\s*друг', "agreement", 0.85),
    (r'нет,?\s*(?:расскажите|покажите|объясните)', "agreement", 0.9),
    # Дополнительные уточнения
    (r'нет,?\s*(?:подожди|подождите|стоп|погоди)', "agreement", 0.85),
    (r'нет,?\s*(?:я\s*имел|имею)\s*в\s*виду', "agreement", 0.9),
    (r'нет,?\s*(?:не\s*так|не\s*то|не\s*это)', "agreement", 0.85),
    (r'нет,?\s*(?:вопрос\s*)?(?:в\s*другом|о\s*другом)', "agreement", 0.85),
    (r'нет,?\s*(?:а\s*)?(?:можно|можете)\s*\w+', "agreement", 0.85),

    # =================================================================
    # REJECTION (отказы с отрицанием)
    # FIX: Добавлены word boundaries (?:^|\s) чтобы "мне нужна" не матчилось как "не нужн"
    # =================================================================
    (r'(?:^|\s)не\s+интересн', "rejection", 0.9),
    (r'неинтересн', "rejection", 0.9),
    (r'(?:^|\s)не\s+нужн', "rejection", 0.9),
    (r'ненужн', "rejection", 0.9),
    # FIX: negative lookahead - "не надо объяснять/рассказывать" это не rejection
    # Учитываем опечатки: обяснять (без ъ), расказывать (одна с) и т.д.
    (r'(?:^|\s)не\s*надо(?!\s*(?:об[ъь]?ясн|рас+каз|повтор|долго|подробн|детал|ждать|торопи))', "rejection", 0.9),
    (r'^ненадо', "rejection", 0.9),
    (r'(?:^|\s)не\s+хо[чт]', "rejection", 0.85),
    (r'(?:^|\s)не\s+буд', "rejection", 0.85),
    (r'нет,?\s*спасибо', "rejection", 0.9),
    (r'спасибо,?\s*не\s*(?:надо|нужн)', "rejection", 0.9),
    # Дополнительные отказы
    (r'(?:это\s*)?(?:спам|реклама|развод)', "rejection", 0.95),
    (r'(?:отписать|удалить|исключить)\s*(?:меня|нас|мой)', "rejection", 0.95),
    (r'(?:больше\s*)?(?:не\s*пишите|не\s*звоните|не\s*беспокойте)', "rejection", 0.95),
    (r'(?:уберите|удалите)\s*(?:мой|меня|наш)', "rejection", 0.9),
    (r'(?:в\s*бан|заблокиру|блокиру)', "rejection", 0.95),
    (r'(?:отстань|отвали|отвяжи|достал|надоел)', "rejection", 0.95),
    (r'(?:прекрати|хватит|стоп)\s*(?:писать|звонить|спамить)', "rejection", 0.95),
    (r'(?:не\s*)?(?:актуальн\w*\s*)?(?:больше\s*)?не\s*(?:актуальн|релевантн)', "rejection", 0.85),
    (r'(?:мимо|не\s*по\s*адресу|не\s*туда)', "rejection", 0.85),
    (r'(?:вы\s*)?(?:ошиблись|не\s*тот|не\s*туда|не\s*ко\s*мне)', "rejection", 0.85),
    (r'у\s*(?:меня|нас)\s*(?:всё|все)\s*(?:есть|хорошо|норм)', "rejection", 0.8),
    (r'(?:справля|обход)\w*\s*(?:сами|без\s*вас|своими)', "rejection", 0.8),
    # Дополнительные паттерны rejection
    # FIX: \b и negative lookahead исключают "отказоустойчивость", "безотказный"
    # Добавлены формы: отказываемся (мы), отказался, отказалась, отказались
    (r'(?:категорическ\w*\s*)?\b(?:отказываюсь|отказываемся|отказал\w*|отказ)\b(?![оа-я])', "rejection", 0.9),
    (r'(?:категорическ\w*\s+нет)[.!?\s]*$', "rejection", 0.95),
    (r'(?:ни\s*за\s*что|никогда|ни\s*при\s*каких)', "rejection", 0.95),
    (r'(?:однозначн\w*|определённ\w*|точно)\s*нет[.!?\s]*$', "rejection", 0.95),
    (r'(?:пошли?\s*вы|идите\s*лесом|идите\s*нафиг)', "rejection", 0.95),
    (r'(?:сколько\s*можно|да\s*сколько\s*раз|опять\s*вы|снова\s*вы)', "rejection", 0.9),
    # FIX: word boundaries исключают "закрытие сделки", "закрытый канал"
    (r'\b(?:закрыты?|закрылись|закрываемся|банкроты?|ликвидируемся|ликвидирован\w*)\b', "rejection", 0.9),
    # FIX: "не" обязателен, иначе ловится просто "клиент" (ложные rejection)
    (r'(?:мы\s+)?не\s+(?:ваш\w*\s+)?(?:целевая\s+)?(?:аудитори?|клиент)', "rejection", 0.85),
    (r'(?:не\s*наш|не\s*для\s*нас|не\s*подходит)', "rejection", 0.85),
    (r'(?:пас|pass|пасс)[.!?\s]*$', "rejection", 0.85),

    # =================================================================
    # OBJECTION_PRICE (возражения по цене)
    # =================================================================
    # Одиночные слова "дорого", "дороговато"
    (r'^(?:дорого|дороговато|накладно)[.!?\s]*$', "objection_price", 0.95),
    (r'^(?:это\s+)?(?:дорого|дороговато)[.!?\s]*$', "objection_price", 0.95),
    # Бюджетные возражения
    (r'нет\s*бюджет', "objection_price", 0.9),
    (r'бюджет\w*\s*нет', "objection_price", 0.9),
    (r'без\s*бюджет', "objection_price", 0.85),
    (r'не\s*залож\w*\s*(?:в\s*)?бюджет', "objection_price", 0.85),
    (r'денег\s*нет', "objection_price", 0.9),
    (r'нет\s*денег', "objection_price", 0.9),
    # FIX: word boundary чтобы "мне потянет" не матчилось
    (r'(?:^|\s)не\s+потян', "objection_price", 0.85),
    # Дополнительные ценовые возражения
    (r'(?:слишком|очень|чересчур)\s*(?:дорого|дороговато)', "objection_price", 0.9),
    (r'(?:цена|ценник|прайс)\s*(?:кусается|кусачий|жирный|высокий)', "objection_price", 0.9),
    (r'(?:для\s*нас|нам)\s*(?:дорого|дороговато|накладно)', "objection_price", 0.9),
    (r'(?:не\s*)?по\s*карман', "objection_price", 0.85),
    (r'(?:финанс\w*|средств)\s*(?:нет|не\s*хватает|ограничен)', "objection_price", 0.85),
    (r'(?:урезали|сократили|нет)\s*(?:бюджет|финансирован)', "objection_price", 0.85),
    (r'(?:экономим|режем|сокращаем)\s*(?:расход|затрат|бюджет)', "objection_price", 0.85),
    (r'(?:у\s*конкурент|другие)\w*\s*дешевл', "objection_price", 0.85),
    (r'(?:видел|нашёл|есть)\s*(?:дешевл|подешевл)', "objection_price", 0.85),
    (r'(?:много|слишком)\s*(?:хотите|просите|берёте)', "objection_price", 0.85),
    (r'(?:неоправданн|завышенн)\w*\s*(?:цена|стоимость)', "objection_price", 0.85),
    (r'(?:не\s*)?(?:стоит|окуп\w*|отобь)\w*\s*(?:таких|этих|своих)\s*денег', "objection_price", 0.85),
    (r'(?:можно|можете|давайте)\s*(?:дешевл|скидк|подешевл)', "objection_price", 0.8),
    # Дополнительные паттерны objection_price
    (r'(?:грабёж|грабительск|космическ\w*|заоблачн\w*)\s*(?:цен|ценник)', "objection_price", 0.9),
    (r'(?:ценник|цена)\s*(?:лютый|конский|космос|нереальн)', "objection_price", 0.9),
    (r'(?:кризис|тяжёл\w*\s*времена|сложн\w*\s*период)', "objection_price", 0.85),
    (r'(?:касса\s*пуст\w*|оборотки?\s*нет|выручк\w*\s*упала)', "objection_price", 0.85),
    (r'(?:в\s*два\s*раза|вдвое|втрое)\s*дороже', "objection_price", 0.9),
    (r'(?:нашёл|нашли|видел)\s*(?:дешевле|за\s*меньше)', "objection_price", 0.85),
    (r'(?:торг|скидка|дисконт)\s*(?:возможен|уместен|есть)', "objection_price", 0.8),

    # =================================================================
    # OBJECTION_NO_TIME (возражения по времени)
    # =================================================================
    (r'нет\s*времен', "objection_no_time", 0.9),
    (r'сейчас\s*не\s*мог', "objection_no_time", 0.85),
    # Дополнительные временные возражения
    # FIX: Добавлен контекст чтобы исключить "занятие", "занятость" (существительные), "файл загружен"
    # Поддержка форм: занят/заняты/занята, загружен/загружены/загружена
    # Исключаем: занятость, занятие (negative lookahead на "ост" и "ие")
    (r'(?:я|мы|сейчас)\s*(?:очень\s*)?(?:занят(?:ы|а|о)?|загружен(?:ы|а|о)?)\b', "objection_no_time", 0.85),
    (r'\b(?:запара|завал|аврал)\b', "objection_no_time", 0.85),
    (r'(?:некогда|не\s*до\s*этого|не\s*до\s*вас)', "objection_no_time", 0.85),
    (r'(?:позвоните|напишите|свяжитесь)\s*(?:позже|потом|завтра|в\s*другой)', "objection_no_time", 0.85),
    (r'(?:позже|потом)\s*(?:свяж\w*|созвон\w*|напиш\w*|поговор\w*)', "objection_no_time", 0.9),
    (r'(?:давайте|может)\s*(?:позже|потом|в\s*другой|на\s*след)', "objection_no_time", 0.85),
    (r'(?:сейчас\s*)?(?:горят|горящ\w*)\s*(?:дедлайн|сроки|задачи)', "objection_no_time", 0.85),
    (r'(?:конец|начало)\s*(?:года|квартала|месяца|отчётност)', "objection_no_time", 0.8),
    (r'(?:после\s*)?(?:праздник|отпуск|выходн|нового\s*года)', "objection_no_time", 0.8),
    (r'(?:разгреб|освобож|выберу|найду)\w*\s*(?:время|момент|окно)', "objection_no_time", 0.8),
    (r'(?:сезон|высокий\s*сезон|пик\s*нагрузки)', "objection_no_time", 0.8),
    (r'(?:руки|голова)\s*(?:не\s*доход|забит)', "objection_no_time", 0.8),
    (r'(?:сейчас\s*)?(?:тяжёл\w*|сложн\w*)\s*(?:период|время|момент)', "objection_no_time", 0.8),
    # Дополнительные паттерны objection_no_time
    (r'(?:командировка|в\s*поездке|в\s*отъезде|в\s*разъездах)', "objection_no_time", 0.85),
    (r'(?:проект\s*горит|релиз|сдача\s*проекта)', "objection_no_time", 0.85),
    (r'(?:инвентаризац|ревизия|аудит)', "objection_no_time", 0.8),
    (r'(?:совещания|митинги|встречи)\s*(?:весь\s*день|расписан)', "objection_no_time", 0.85),
    (r'(?:давайте\s*)?(?:в\s*понедельник|во\s*вторник|на\s*след\w*\s*недел)', "objection_no_time", 0.8),
    (r'(?:щас|ща|сейчас)\s*(?:не\s*до\s*этого|не\s*могу|никак)', "objection_no_time", 0.85),
    (r'(?:времечка|минутки|секунды)\s*(?:нет|ни)', "objection_no_time", 0.85),
    (r'(?:загруз\w*|заваленн\w*)\s*(?:полный|полностью|по\s*горло)', "objection_no_time", 0.85),

    # =================================================================
    # OBJECTION_COMPETITOR (уже есть конкурент)
    # =================================================================
    # NOTE: Сравнение "чем лучше iiko/poster" уже в CRITICAL PATTERNS (строки 27-28)
    # Здесь только уникальные паттерны, не покрытые CRITICAL PATTERNS
    # Паттерны "почему не X" - уникальные (вопрос "почему не используете конкурента")
    (r'(?:почему|зачем)\s*(?:вы\s*)?(?:а\s*)?не\s*(?:1с|1c|iiko|iko|ийко|poster|постер)', "objection_competitor", 0.9),
    # "у iiko дешевле/лучше" - уникальный паттерн
    (r'(?:у\s*)?(?:iiko|iko|ийко|айко|poster|постер)\s*(?:дешевл|лучше)', "objection_competitor", 0.9),
    # POS и ресторанные системы
    (r'(?:уже\s*)?(?:есть|используем|работаем\s*в|сидим\s*на)\s*(?:iiko|iko|ийко|айко|poster|постер|r.keeper)', "objection_competitor", 0.9),
    # CRM системы
    (r'(?:уже\s*)?(?:есть|используем|работаем\s*в|сидим\s*на)\s*(?:crm|црм|система)', "objection_competitor", 0.85),
    (r'(?:уже\s*)?(?:есть|используем|работаем\s*в|сидим\s*на)\s*(?:амо|битрикс|мегаплан|salesforce|pipedrive)', "objection_competitor", 0.9),
    (r'(?:внедрили|подключили|купили|перешли\s*на)\s*(?:crm|црм|амо|битрикс|мегаплан)', "objection_competitor", 0.9),
    (r'(?:нас\s*)?устраивает\s*(?:текущ\w*|нынешн\w*|наш\w*)', "objection_competitor", 0.85),
    (r'(?:менять|переходить|мигрировать)\s*(?:не\s*)?(?:хотим|планируем|собираемся)', "objection_competitor", 0.85),
    (r'(?:уже\s*)?(?:вложили|потратили|заплатили)\s*(?:деньги|много|немало)', "objection_competitor", 0.85),
    (r'(?:команда|все|сотрудники)\s*(?:привыкли|обучены|знают)', "objection_competitor", 0.8),
    (r'(?:у\s*нас|есть)\s*(?:своя|собственн\w*|самописн\w*)', "objection_competitor", 0.85),
    # Дополнительные паттерны objection_competitor
    (r'(?:kommo|комо|коммо|roistat|ройстат|calltouch)', "objection_competitor", 0.85),
    (r'(?:юздеск|usedesk|омнидеск|omnidesk|helpdesk)', "objection_competitor", 0.85),
    (r'(?:всё\s*настроено|всё\s*налажено|система\s*работает)', "objection_competitor", 0.85),
    (r'(?:нет\s*смысла\s*менять|зачем\s*менять|не\s*вижу\s*смысла)', "objection_competitor", 0.85),
    (r'(?:переучив\w*|переобуч\w*|обучать\s*заново)', "objection_competitor", 0.85),
    (r'(?:только\s*внедрили|недавно\s*купили|договор\s*заключ)', "objection_competitor", 0.85),
    (r'(?:1с\s*бухгалтер|1с\s*предприят|1с\s*торговл)', "objection_competitor", 0.85),
    (r'(?:эвотор|evotor|дримкас|dreamkas|атол)', "objection_competitor", 0.85),

    # =================================================================
    # OBJECTION_THINK (надо подумать)
    # =================================================================
    (r'(?:надо|нужно|дайте)\s*(?:подумать|посовещаться|обсудить)', "objection_think", 0.85),
    (r'(?:должен|должны|нужно)\s*(?:обсудить|посоветоваться|согласовать)', "objection_think", 0.85),
    (r'(?:с\s*)?(?:руководств\w*|начальств\w*|директор\w*)\s*(?:обсуди|согласу|посовету)', "objection_think", 0.85),
    (r'(?:решение|вопрос)\s*(?:принима\w*|решае\w*)\s*(?:не\s*)?(?:я|мы)', "objection_think", 0.8),
    (r'(?:это\s*)?(?:не\s*)?(?:в\s*)?(?:моей|нашей)\s*(?:компетенции|власти)', "objection_think", 0.85),
    (r'(?:нужно\s*)?(?:время\s*)?(?:на\s*)?(?:раздум\w*|обдум\w*|размышлен)', "objection_think", 0.8),
    (r'(?:дайте|дай)\s*(?:подумать|время|пару\s*дней)', "objection_think", 0.85),
    (r'(?:перезвон|вернусь|свяжусь)\w*\s*(?:сам|позже|потом|когда\s*решу)', "objection_think", 0.8),
    (r'(?:пока\s*)?(?:не\s*готов|не\s*готовы)\s*(?:к|принять|дать)', "objection_think", 0.8),
    # Дополнительные паттерны objection_think
    (r'(?:спрошу|уточню|согласую)\s*(?:у\s*)?(?:шефа|директор|собственник|партнёр)', "objection_think", 0.85),
    (r'(?:покажу|обсужу)\s*(?:коллег\w*|команд\w*|партнёр\w*)', "objection_think", 0.85),
    (r'(?:это\s*)?(?:не\s*моё?\s*решен|выше\s*моего\s*уровня)', "objection_think", 0.85),
    (r'(?:взвесить|сравнить|обдумать)\s*(?:все\s*)?(?:за\s*и\s*против|вариант)', "objection_think", 0.85),
    (r'(?:переспать\s*с\s*мыслью|переварить\s*информац|осмыслить)', "objection_think", 0.85),
    (r'(?:пока\s*рано|ещё\s*не\s*созрел|нужно\s*дозреть)', "objection_think", 0.8),
    (r'(?:не\s*уполномоч\w*|не\s*имею\s*права|не\s*могу\s*решать)', "objection_think", 0.85),

    # =================================================================
    # AGREEMENT (согласие)
    # =================================================================
    (r'давай\w*\s*попробу', "agreement", 0.9),
    (r'хочу\s*попробо', "agreement", 0.9),
    (r'да,?\s*интересн', "agreement", 0.9),
    (r'да,?\s*давайте', "agreement", 0.9),
    (r'расскажите\s*подробн', "agreement", 0.85),
    (r'хо[чт]\w*\s*демо', "agreement", 0.9),
    # Дополнительные согласия
    (r'(?:^|\s)да[,!.\s]*$', "agreement", 0.8),  # просто "да"
    (r'(?:да|ага|угу),?\s*(?:конечно|разумеется|естественно)', "agreement", 0.9),
    (r'(?:звучит|выглядит)\s*(?:интересн|хорош|неплох|здорово)', "agreement", 0.85),
    (r'(?:заинтересова|заинтригова|любопытн)', "agreement", 0.85),
    (r'(?:хотел|хотела)\s*бы\s*(?:узнать|попробова|посмотре)', "agreement", 0.85),
    (r'(?:можно|можем|давайте)\s*(?:созвониться|пообщаться|обсудить)', "agreement", 0.85),
    (r'(?:когда\s*)?(?:можно|удобно)\s*(?:созвониться|встретиться|показать)', "agreement", 0.85),
    (r'(?:отлично|супер|класс|круто|здорово)[,!.\s]*(?:давайте|жду)', "agreement", 0.9),
    (r'(?:принял|понял|услышал)[,.\s]*(?:жду|давайте|запишите)', "agreement", 0.85),
    (r'(?:записывайте|записывай|пишите|пиши)[,.\s]*(?:меня|мой|нас)', "agreement", 0.9),
    (r'(?:бронируй|бронирую|бронируйте)\s*(?:время|слот|встречу)', "agreement", 0.9),
    (r'(?:готов|готовы|готова)\s*(?:посмотреть|попробовать|обсудить|слушать)', "agreement", 0.9),
    (r'(?:в\s*деле|погнали|поехали|(?:^|\s)го(?:\s|$|!)|погоди\s*вау)', "agreement", 0.85),
    (r'(?:почему\s*бы\s*и\s*нет|можно\s*попробовать|давай\s*попробуем)', "agreement", 0.85),
    # Заявки
    (r'оставлю\s*заявк', "agreement", 0.95),
    (r'(?:оставить|оформить|подать|отправить)\s*заявк', "agreement", 0.9),
    (r'заявк\w*\s*(?:оставлю|оформлю|подам|отправлю)', "agreement", 0.9),
    # Дополнительные паттерны agreement
    (r'(?:топ|огонь|бомба|зашибись|вау|wow|кайф|найс|nice)[!.\s]*$', "agreement", 0.85),
    (r'(?:выставляй|выставляйте|пришлите|присылайте)\s*(?:счёт|счет|договор)', "agreement", 0.95),
    (r'(?:берём|берем|оформляем|оформляй)\s*(?:это|систему|подписку)', "agreement", 0.95),
    (r'(?:это\s*то\s*что\s*нужно|именно\s*то\s*что\s*искали|под\s*нас\s*подходит)', "agreement", 0.9),
    (r'(?:нам\s*актуально|нам\s*релевантно|то\s*что\s*надо)', "agreement", 0.85),
    (r'(?:как\s*записаться|как\s*начать|как\s*подключиться|куда\s*платить)', "agreement", 0.9),
    (r'(?:какие\s*документы|что\s*нужно\s*для|как\s*оформить)', "agreement", 0.85),
    (r'(?:склоняюсь|больше\s*склон\w*|скорее\s*да|наверн\w*\s*да)', "agreement", 0.8),

    # =================================================================
    # GREETING (приветствия — с уточнением)
    # =================================================================
    (r'^(?:привет|здравствуй\w*|добрый\s*(?:день|утро|вечер)|доброе\s*утро|доброго\s*времени)[,!.\s]*$', "greeting", 0.95),
    (r'^(?:хай|хелло|здарова?|дарова|салют|приветик|ку)[,!.\s]*$', "greeting", 0.9),
    # Казахские/мусульманские приветствия
    (r'^(?:салам|ассалам\w*|салем|сәлем)[,!.\s]*$', "greeting", 0.95),

    # =================================================================
    # FAREWELL (прощания)
    # =================================================================
    # FIX: "пока" вынесен в отдельные паттерны с end-of-line контекстом
    # чтобы не матчить "пока используем excel", "пока изучаю вопрос"
    (r'(?:до\s*свидания|до\s*связи|до\s*встречи|всего\s*доброго|всего\s*хорошего)', "farewell", 0.9),
    # "пока" как прощание - только в конце предложения или с запятой перед другим прощанием
    (r'\bпока\b[,!.\s]*$', "farewell", 0.9),
    (r'(?:хорошего|удачного|отличного)\s*(?:дня|вечера|времени)', "farewell", 0.85),
    (r'(?:спасибо|благодарю)[,.\s]*(?:\bпока\b|до\s*свидания|до\s*связи)', "farewell", 0.9),
    (r'(?:бай|бб|покедова|покеда|чао|адьёс)', "farewell", 0.85),
    (r'(?:на\s*этом|на\s*сегодня|пока\s*что)\s*(?:всё|все|достаточно)', "farewell", 0.8),

    # =================================================================
    # GRATITUDE (благодарность)
    # =================================================================
    (r'^(?:спасибо|благодарю|спс|пасибо)[,!.\s]*$', "gratitude", 0.9),
    (r'(?:большое|огромное|искреннее)\s*спасибо', "gratitude", 0.9),
    (r'(?:спасибо|благодарю)\s*(?:за|вам|тебе)', "gratitude", 0.85),
    (r'(?:очень\s*)?(?:благодарен|благодарна|признателен|признательна)', "gratitude", 0.85),

    # =================================================================
    # SMALL TALK (болтовня — нужно перенаправить)
    # =================================================================
    (r'как\s*(?:дела|жизнь|настроение|сам|сама)', "small_talk", 0.85),
    (r'(?:что|как)\s*(?:нового|новенького|интересного)', "small_talk", 0.85),
    (r'(?:как\s*)?(?:погода|настроен\w*|выходн\w*|праздник\w*)', "small_talk", 0.7),

    # =================================================================
    # UNCLEAR (непонятные сообщения)
    # =================================================================
    (r'^[?!.]+$', "unclear", 0.9),  # только знаки препинания
    (r'^(?:что|ась|чего|а)[?]*$', "unclear", 0.85),  # короткие вопросы
    (r'^(?:не\s*понял|не\s*понятно|что\s*это)[?]*$', "unclear", 0.85),
    (r'^(?:\?\?\?|\.\.\.|\!\!\!)$', "unclear", 0.9),

    # CONTACT_PROVIDED теперь в начале файла (перед callback_request)

    # =================================================================
    # CORRECT_INFO (исправление информации)
    # =================================================================
    (r'(?:я\s*)?(?:ошибся|ошиблась|ошиблись|ошибка)', "correct_info", 0.9),
    (r'(?:не\s*так|неправильно|некорректно)\s*сказал', "correct_info", 0.9),
    (r'(?:поправ\w*|исправл\w*|уточн\w*)', "correct_info", 0.85),
    (r'(?:перепутал|спутал|попутал)\w*', "correct_info", 0.9),
    # FIX: требуем слово/пробел ПЕРЕД "не" чтобы не ловить "сомНЕваюсь"
    (r'(?:^|\s)не\s+\d+\s+а\s+\d+', "correct_info", 0.85),  # "не 10 а 15"
    (r'(?:^|\s)не\s+\w+\s+а\s+\w+', "correct_info", 0.85),  # "не то а это"
    # FIX: "на самом деле" только в контексте исправления, не "на самом деле интересно"
    (r'на\s*самом\s*деле(?!\s+(?:интересно|хорошо|круто|здорово|классно|отлично))', "correct_info", 0.85),
    (r'(?:вообще-то|точнее\s*говоря)', "correct_info", 0.85),
    (r'(?:исправлюсь|исправляюсь|давай\w*\s*заново)', "correct_info", 0.9),
    (r'(?:я\s*)?(?:имел|имела)\s*в\s*виду', "correct_info", 0.85),

    # =================================================================
    # GO_BACK (возврат назад)
    # =================================================================
    (r'(?:верн\w*мся?|вернитесь|вернись)\s*(?:назад|к\s*предыдущ)', "go_back", 0.9),
    (r'(?:давай\w*|хочу)\s*(?:к\s*)?(?:предыдущ|назад|обратно)', "go_back", 0.9),
    (r'(?:подожди\w*|стоп|погоди\w*)\s*(?:верн)', "go_back", 0.85),
    (r'(?:не\s*то|не\s*это)\s*(?:обсужда\w*|говор\w*|имел)', "go_back", 0.85),
    (r'(?:хочу\s*)?(?:уточнить|вернуться\s*к)\s*(?:предыдущ|прошл)', "go_back", 0.85),
    (r'(?:можно\s*)?(?:назад|обратно|к\s*началу)', "go_back", 0.8),
    (r'(?:шаг\s*назад|откатиться|вернёмся)', "go_back", 0.85),

    # =================================================================
    # SPIN: SITUATION_PROVIDED (предоставление информации о ситуации)
    # =================================================================
    # Размер команды/компании
    (r'(?:у\s*нас|в\s*команде|в\s*компании)\s*\d+\s*(?:человек|сотрудник|менеджер|продавец)', "situation_provided", 0.9),
    (r'\d+\s*(?:человек\w*|сотрудник\w*|менеджер\w*|точ\w+|филиал\w*|магазин\w*|ресторан\w*)', "situation_provided", 0.85),
    # Тип бизнеса
    (r'(?:мы\s*)?(?:ресторан|кафе|магазин|салон|клиника|отель|гостиница)', "situation_provided", 0.85),
    (r'(?:занимаемся|работаем\s*в\s*сфере)\s*(?:оптов|рознич|услуг|it|торговл)', "situation_provided", 0.85),
    # Обороты и метрики (с числами и словами)
    (r'(?:оборот|выручка)\s*(?:около|примерно|порядка)?\s*(?:\d+|миллион|тысяч|млн|тыс)', "situation_provided", 0.85),
    (r'(?:средний\s*чек|чек)\s*\d+', "situation_provided", 0.85),
    (r'(?:работаем|на\s*рынке)\s*\d+\s*(?:лет|год|месяц)', "situation_provided", 0.85),
    # Сегмент
    (r'(?:b2b|b2c|б2б|б2с)\s*(?:сегмент|направлен|клиент)?', "situation_provided", 0.85),
    (r'(?:стартап|startup|малый\s*бизнес|небольш\w*\s*компани)', "situation_provided", 0.85),

    # =================================================================
    # SPIN: PROBLEM_REVEALED (раскрытие проблемы)
    # =================================================================
    (r'(?:теряем|уходят|уплывают)\s*(?:клиент|заказ|сделк|деньг)', "problem_revealed", 0.9),
    (r'(?:менеджеры?|сотрудники?)\s*(?:забыва\w*|не\s*успева\w*|путают)', "problem_revealed", 0.85),
    (r'(?:нет|отсутству\w*)\s*(?:контрол|учёт|учет|аналитик|порядк)', "problem_revealed", 0.85),
    (r'нет\s+аналитик', "problem_revealed", 0.85),  # "нет аналитики"
    (r'(?:не\s*вид\w*|не\s*поним\w*)\s*(?:воронк|статус|откуда)', "problem_revealed", 0.85),
    (r'(?:хаос|бардак|беспорядок)\s*(?:в\s*)?(?:задач|дел|работ)?', "problem_revealed", 0.85),
    (r'(?:клиенты?\s*)?(?:жалуются|недовольн|уходят\s*к\s*конкурент)', "problem_revealed", 0.85),
    (r'(?:долго|медленно)\s*(?:обрабатыва\w*|отвеча\w*|реагиру\w*)', "problem_revealed", 0.85),
    (r'(?:теряем|тратим)\s*(?:деньги|время)\s*(?:на\s*)?(?:ошибк|рутин|этом)?', "problem_revealed", 0.85),
    (r'(?:сделки|заказы|лиды)\s*(?:уходят|теряются|пропадают)', "problem_revealed", 0.85),
    (r'(?:данные|контакты|заявки)\s*(?:дублируются|теряются|пропадают)', "problem_revealed", 0.85),

    # =================================================================
    # SPIN: IMPLICATION_ACKNOWLEDGED (признание последствий)
    # NOTE: Перед problem_revealed для фраз о последствиях
    # =================================================================
    (r'(?:да|это)\s*(?:серьёзн\w*|важн\w*|критичн\w*)\s*(?:проблем)?', "implication_acknowledged", 0.85),
    (r'из[-\s]за\s*этого\s*(?:теряем|страдает|падает|мы)', "implication_acknowledged", 0.9),
    (r'(?:поэтому|потому)\s*(?:теряем|страдает|падает)', "implication_acknowledged", 0.85),
    (r'(?:понимаю|осознаю|вижу)\s*(?:что\s*)?(?:надо|нужно|пора)\s*(?:решать|менять)', "implication_acknowledged", 0.9),
    (r'(?:это\s*)?(?:влияет|сказывается|отражается)\s*(?:на\s*)?(?:прибыл|доход|выручк)', "implication_acknowledged", 0.85),
    (r'клиенты?\s*уходят\s*к\s*конкурент', "implication_acknowledged", 0.9),
    (r'(?:клиенты?\s*)?(?:выбирают\s*друг)', "implication_acknowledged", 0.85),
    (r'(?:репутация|имидж)\s*(?:страдает|портится|под\s*угроз)', "implication_acknowledged", 0.85),
    (r'(?:команда|сотрудники)\s*(?:демотивирован|выгорают|уходят)', "implication_acknowledged", 0.85),
    (r'это\s*(?:стоит|обходится)\s*(?:нам\s*)?(?:дорого|денег|недёшево)', "implication_acknowledged", 0.9),

    # =================================================================
    # SPIN: NEED_EXPRESSED (выражение потребности)
    # =================================================================
    (r'(?:нам\s*)?(?:нужн\w*|необходим\w*)\s*(?:автоматизац|систем|crm|контроль|порядок)', "need_expressed", 0.9),
    (r'(?:хотим|хочу|надо)\s*(?:контролировать|отслеживать|видеть|понимать)', "need_expressed", 0.85),
    (r'(?:нужн\w*|хотим)\s*(?:прозрачност|аналитик|отчёт|статистик)', "need_expressed", 0.85),
    (r'(?:хотим|планируем|собираемся)\s*(?:расти|масштабировать|развивать)', "need_expressed", 0.85),
    (r'(?:нужно|пора|надо)\s*(?:навести\s*порядок|систематизировать|структурировать)', "need_expressed", 0.85),
    (r'(?:нужна\s*)?система\s*(?:для\s*)?(?:масштабирован|роста|управлен)', "need_expressed", 0.85),
    (r'(?:хотим|надо)\s*(?:улучшить|повысить|оптимизировать)\s*(?:сервис|работу|процесс)', "need_expressed", 0.85),
    (r'(?:ищем|нужен)\s*(?:инструмент|решение|способ)\s*(?:для|чтобы)', "need_expressed", 0.85),

    # NO_PROBLEM и NO_NEED теперь в начале файла (перед rejection)

    # =================================================================
    # SPIN: INFO_PROVIDED (предоставление бизнес-информации)
    # NOTE: Этот интент ловится в основном через DataExtractor,
    # паттерны здесь как backup для явных фраз
    # =================================================================
    (r'(?:мы\s*)?(?:занимаемся|работаем\s*в\s*сфере)\s*\w+', "info_provided", 0.8),
    (r'(?:у\s*нас\s*)?\d+\s*(?:менеджер|продавец|оператор|сотрудник)', "info_provided", 0.8),
    (r'(?:работаем\s*с|обслуживаем)\s*(?:корпоративн|частн|юридическ|физическ)', "info_provided", 0.8),
    (r'(?:основной\s*)?(?:канал|источник)\s*[-—]\s*(?:сайт|звонки|реклама)', "info_provided", 0.8),
    (r'(?:продаём|продаем|предлагаем)\s*(?:товар|услуг|продукц)', "info_provided", 0.8),

    # =================================================================
    # QUESTION_DATA_MIGRATION (вопросы о миграции/переносе данных)
    # ВАЖНО: Должны быть ПЕРЕД objection_complexity!
    # Отличие от возражения: вопрос (как? можно? поможете?) vs жалоба (надо...)
    # =================================================================
    # Прямые вопросы о переносе данных
    (r'(?:как|каким\s*образом)\s*(?:вы\s*)?(?:перенес[её]те|переносите|мигрируете)\s*(?:данные|базу)?', "question_data_migration", 0.95),
    (r'(?:как|каким\s*образом)\s*(?:происходит|работает)\s*(?:перенос|миграция)\s*(?:данных|базы)?', "question_data_migration", 0.95),
    (r'(?:можно|можете)\s*(?:ли\s*)?(?:перенести|мигрировать)\s*(?:данные|базу|номенклатуру)?', "question_data_migration", 0.95),
    (r'(?:поможете|помогаете)\s*(?:ли\s*)?(?:с\s*)?(?:переносом|миграцией)\s*(?:данных|базы)?', "question_data_migration", 0.95),
    (r'(?:что\s*)?(?:насчёт|насчет|по\s*поводу)\s*(?:переноса|миграции)\s*(?:данных|базы)?', "question_data_migration", 0.95),
    # Вопросы о процессе миграции
    (r'(?:как)\s*(?:работает|происходит|устроена?)\s*миграц', "question_data_migration", 0.95),  # "как работает миграция"
    (r'(?:как\s*)?(?:долго|быстро)\s*(?:идёт|занимает)\s*(?:перенос|миграция)', "question_data_migration", 0.9),
    (r'(?:сколько)\s*(?:займёт|занимает)\s*(?:перенос|миграция)', "question_data_migration", 0.9),
    (r'(?:кто)\s*(?:будет\s*)?(?:переносить|мигрировать|делать\s*перенос)', "question_data_migration", 0.9),
    # Вопросы об импорте
    (r'(?:можно|можете|как)\s*(?:импортировать|загрузить|выгрузить)\s*(?:данные|из)', "question_data_migration", 0.9),
    (r'(?:как\s*)?(?:перенести|импортировать)\s*(?:из\s*)?(?:excel|эксел|1с|битрикс|амо)', "question_data_migration", 0.9),
    (r'(?:поддерживается|есть)\s*(?:ли\s*)?(?:импорт|экспорт)\s*(?:из|в)', "question_data_migration", 0.9),
    # Вопросительные формы с "данные"
    (r'(?:а\s*)?данные\s*(?:как\s*)?(?:перенести|перенесёте|переносите)[?]?', "question_data_migration", 0.95),
    (r'(?:что\s*с\s*)?(?:нашими\s*)?данными[?]?\s*(?:как|куда)', "question_data_migration", 0.9),

    # =================================================================
    # QUESTION_IMPLEMENTATION (вопросы о процессе внедрения)
    # ВАЖНО: Должны быть ПЕРЕД objection_complexity!
    # =================================================================
    # Прямые вопросы о внедрении
    (r'(?:как|каким\s*образом)\s*(?:происходит|проходит|идёт)\s*(?:внедрение|настройка|установка)', "question_implementation", 0.95),
    (r'(?:как)\s*(?:вы\s*)?(?:внедряете|настраиваете|устанавливаете)', "question_implementation", 0.95),
    (r'(?:сколько)\s*(?:времени\s*)?(?:займёт|занимает)\s*(?:внедрение|настройка|запуск)', "question_implementation", 0.95),
    (r'(?:какие)\s*(?:этапы|шаги)\s*(?:внедрения|настройки|установки)', "question_implementation", 0.9),
    # Вопросы о поддержке при внедрении
    (r'(?:помогаете|поможете)\s*(?:ли\s*)?(?:с\s*)?(?:внедрением|настройкой|запуском)', "question_implementation", 0.95),
    (r'(?:есть\s*ли|включено\s*ли)\s*(?:обучение|поддержка)\s*(?:при\s*)?(?:внедрении)?', "question_implementation", 0.9),
    (r'(?:кто)\s*(?:будет\s*)?(?:внедрять|настраивать|обучать)', "question_implementation", 0.9),
    # Вопросы о сроках
    (r'(?:как\s*быстро|за\s*сколько)\s*(?:можно\s*)?(?:внедрить|запустить|начать)', "question_implementation", 0.9),
    (r'(?:сроки|дедлайн)\s*(?:внедрения|запуска)', "question_implementation", 0.9),

    # =================================================================
    # QUESTION_UPDATES (вопросы об обновлениях)
    # =================================================================
    (r'(?:как\s*)?(?:часто)\s*(?:выходят|бывают)\s*(?:обновления|апдейты)', "question_updates", 0.9),
    (r'(?:обновления)\s*(?:автоматические|платные|бесплатные)', "question_updates", 0.9),
    (r'(?:нужно\s*ли|как)\s*(?:обновлять|обновляться)', "question_updates", 0.9),

    # =================================================================
    # QUESTION_OFFLINE (вопросы об офлайн-режиме)
    # =================================================================
    (r'(?:работает\s*ли|можно\s*ли)\s*(?:без\s*)?(?:интернета|оффлайн|offline)', "question_offline", 0.9),
    (r'(?:что\s*)?(?:если|когда)\s*(?:нет\s*)?(?:интернета|связи|сети)', "question_offline", 0.9),
    (r'(?:офлайн|оффлайн|offline)\s*(?:режим|работа|функционал)', "question_offline", 0.9),

    # =================================================================
    # QUESTION_CUSTOMIZATION (вопросы о кастомизации)
    # =================================================================
    (r'(?:можно\s*ли|как)\s*(?:настроить|кастомизировать|адаптировать)', "question_customization", 0.9),
    (r'(?:есть\s*ли)\s*(?:гибкость|возможность)\s*(?:настройки|кастомизации)', "question_customization", 0.9),
    (r'(?:можно\s*ли|как)\s*(?:добавить|создать)\s*(?:свои|кастомные)\s*(?:поля|процессы)', "question_customization", 0.9),

    # =================================================================
    # QUESTION_AUTOMATION (вопросы об автоматизации)
    # =================================================================
    (r'(?:какие|есть\s*ли)\s*(?:автоматизации|автоматические\s*действия|триггеры)', "question_automation", 0.9),
    (r'(?:можно\s*ли)\s*(?:автоматизировать|настроить\s*автоматически)', "question_automation", 0.9),
    (r'(?:как\s*работает)\s*(?:автоматизация|автоматические\s*действия)', "question_automation", 0.9),

    # =================================================================
    # QUESTION_SCALABILITY (вопросы о масштабируемости)
    # =================================================================
    (r'(?:как)\s*(?:система\s*)?(?:справляется|работает)\s*(?:с\s*)?(?:ростом|нагрузкой)', "question_scalability", 0.9),
    (r'(?:можно\s*ли|как)\s*(?:масштабировать|расширять)', "question_scalability", 0.9),
    (r'(?:есть\s*ли)\s*(?:ограничения|лимиты)\s*(?:по|на)', "question_scalability", 0.9),

    # =================================================================
    # OBJECTION_COMPLEXITY (возражение о сложности внедрения)
    # ВАЖНО: Это ВОЗРАЖЕНИЯ (утверждения с негативом), не вопросы!
    # =================================================================
    (r'(?:слишком\s*)?(?:сложно|трудно|долго)\s*(?:внедр\w*|настра\w*|переход)', "objection_complexity", 0.9),
    (r'(?:много\s*)?(?:работы|возни|мороки)\s*(?:с\s*)?(?:переход|внедрен|настройк)', "objection_complexity", 0.85),
    (r'(?:придётся|нужно|надо)\s*переучив\w*', "objection_complexity", 0.85),
    (r'переучив\w*\s*(?:команд|сотрудник|персонал)', "objection_complexity", 0.85),
    (r'(?:интеграция|внедрение|переход)\s*(?:займёт|потребует|затянется)', "objection_complexity", 0.85),
    (r'(?:нет\s*)?(?:ресурсов?|сил|возможност)\s*(?:на\s*)?(?:внедрен|переход|это)', "objection_complexity", 0.85),
    (r'(?:процесс\s*)?миграц\w*\s*(?:пугает|сложн|долг)', "objection_complexity", 0.85),
    (r'(?:боюсь|опасаюсь)\s*(?:что\s*)?(?:сломается|не\s*заработает|всё\s*встанет|всё\s*сломается)', "objection_complexity", 0.85),
    (r'(?:переход|внедрение)\s*(?:будет\s*)?(?:болезненн|сложн|долг)', "objection_complexity", 0.85),
    (r'(?:надо|нужно|придётся)\s*(?:переносить|мигрировать)\s*(?:данные|базу)', "objection_complexity", 0.85),
    (r'(?:сотрудники|команда|люди)\s*(?:будут\s*)?(?:сопротивл|против|не\s*захот)', "objection_complexity", 0.85),
    (r'(?:нет\s*времени|некогда)\s*(?:на\s*)?(?:обучен|разбират)', "objection_complexity", 0.85),
    (r'(?:слишком\s*)?(?:много\s*возни|геморро|головня)', "objection_complexity", 0.85),

    # =================================================================
    # OBJECTION_NO_NEED (возражение "нам не нужно" — развёрнутое)
    # NOTE: Отличается от no_need — это возражение с аргументами
    # =================================================================
    (r'справляемся\s*без\s*(?:crm|системы|автоматизац|этого)', "objection_no_need", 0.85),
    (r'(?:и\s*так|и\s*без\s*этого)\s*(?:всё\s*)?(?:работает|хорошо|норм)', "objection_no_need", 0.85),
    (r'(?:обойдёмся|справимся)\s*(?:своими\s*силами|без\s*вас|сами)', "objection_no_need", 0.85),
    (r'нет\s*такой\s*(?:проблемы|необходимости|потребности)', "objection_no_need", 0.85),
    (r'не\s*вижу\s*(?:смысла|необходимости|толку)\s*(?:в\s*этом)?', "objection_no_need", 0.85),
    (r'(?:нам\s*)?не\s*(?:требуется|нужна)\s*(?:автоматизац|систем|crm)', "objection_no_need", 0.85),
    (r'(?:мы\s*)?(?:маленьк|небольш)\w*[,.]?\s*(?:нам\s*)?(?:не\s*надо|не\s*нужно)', "objection_no_need", 0.85),
    (r'(?:хватает|достаточно)\s*(?:текущ|нынешн|того\s*что\s*есть)', "objection_no_need", 0.85),
    (r'(?:excel|эксель?|таблиц|блокнот)\s*(?:нас\s*)?(?:устраива|хватает)', "objection_no_need", 0.85),
    (r'(?:ведём|ведем)\s*(?:всё|все)\s*(?:в\s*)?(?:excel|таблиц|блокнот)', "objection_no_need", 0.85),
    (r'(?:зачем\s*)?(?:нам\s*)?(?:это\s*)?(?:нужно|надо)\s*[,.]?\s*(?:и\s*так|справля)', "objection_no_need", 0.85),
    (r'(?:лишняя\s*)?(?:трата|расход)\s*(?:ресурсов|времени|денег)', "objection_no_need", 0.85),

    # =================================================================
    # OBJECTION_TIMING (возражение о сроках — отложить на конкретное время)
    # NOTE: Отличается от objection_no_time — здесь конкретные сроки
    # =================================================================
    (r'давайте\s*после\s*(?:нового\s*года|праздников|отпуска)', "objection_timing", 0.85),
    (r'(?:может|можно)\s*после\s*(?:нового\s*года|праздников|отпуска)', "objection_timing", 0.85),
    (r'(?:перезвоните|напишите|свяжитесь)\s*через\s*(?:\d+\s*)?(?:месяц|недел)', "objection_timing", 0.85),
    (r'(?:в\s*)?(?:следующ\w*)\s*(?:квартал|месяц|году|недел)', "objection_timing", 0.85),
    (r'после\s*(?:праздник\w*|отпуск\w*|выходн\w*|каникул)', "objection_timing", 0.85),
    (r'(?:сейчас\s*)?(?:не\s*)?(?:лучшее|подходящее|удачное)\s*время', "objection_timing", 0.85),
    (r'(?:подожд\w*|погод\w*)\s*(?:до\s*)?(?:весны|лета|осени|зимы|января)', "objection_timing", 0.85),
    (r'(?:может\s*быть|возможно)\s*(?:в\s*)?(?:следующ\w*\s*году|новом\s*году)', "objection_timing", 0.85),
    (r'пока\s*рано\s*(?:об\s*этом|говорить|решать)', "objection_timing", 0.85),
    (r'(?:через\s*)(?:полгода|год|пару\s*месяцев)\s*(?:напомн\w*|свяж\w*)', "objection_timing", 0.85),
    (r'(?:ближе\s*к)\s*(?:концу|началу)\s*(?:года|квартала|месяца)', "objection_timing", 0.85),
    (r'(?:когда\s*)?(?:бюджет|финансирование)\s*(?:сформируем|утвердим|будет)', "objection_timing", 0.85),
    (r'(?:после\s*)?(?:закрытия|завершения|сдачи)\s*(?:проекта|отчёта|квартала)', "objection_timing", 0.85),

    # =================================================================
    # OBJECTION_TRUST (возражение о доверии)
    # =================================================================
    (r'не\s*уверен\s*(?:что\s*)?(?:это\s*)?(?:работает|поможет|нужно)', "objection_trust", 0.85),
    (r'сомневаюсь\s*(?:в\s*)?(?:результат|эффект|пользе)', "objection_trust", 0.85),
    (r'(?:а\s*)?(?:есть\s*)?(?:гарант\w*|гарантия)', "objection_trust", 0.85),
    (r'(?:кто\s*)?(?:ещё\s*)?(?:пользуется|использует)\s*(?:ваш\w*|вашей|вами)', "objection_trust", 0.85),
    (r'(?:покажите|дайте|есть)\s*(?:отзыв|референс|кейс|пример\w*\s*клиент)', "objection_trust", 0.9),
    (r'(?:откуда\s*)?(?:мне\s*)?(?:знать|уверен)\s*(?:что\s*)?(?:не\s*)?(?:обман|развод)', "objection_trust", 0.85),
    (r'звучит\s*слишком\s*хорошо', "objection_trust", 0.85),
    (r'(?:выглядит|звучит)\s*(?:слишком\s*)?(?:хорошо|красиво)\s*(?:чтобы|для)', "objection_trust", 0.85),
    (r'(?:не\s*верю|не\s*верится)\s*(?:в\s*)?(?:такие\s*)?(?:обещани|результат)', "objection_trust", 0.85),
    (r'(?:какие\s*)?(?:есть\s*)?(?:доказательств|подтвержден)', "objection_trust", 0.85),
    (r'(?:а\s*)?(?:что\s*)?(?:если|вдруг)\s*(?:не\s*)?(?:поможет|сработает|подойдёт)', "objection_trust", 0.85),
    (r'(?:можете\s*)?(?:подтвердить|доказать|показать)\s*(?:результат|эффект)', "objection_trust", 0.85),
    (r'(?:хочу\s*)?(?:увидеть|посмотреть)\s*(?:референс|отзыв|кейс)', "objection_trust", 0.9),
    (r'(?:кейсы?|примеры?)\s*(?:из\s*)?(?:нашей\s*)?(?:отрасл|сфер|ниш)', "objection_trust", 0.9),
    (r'(?:почему\s*)?(?:должен|должны)\s*(?:вам\s*)?(?:доверять|верить)', "objection_trust", 0.85),
    (r'(?:сколько\s*)?(?:лет|давно)\s*(?:на\s*рынке|работаете|существуете)', "objection_trust", 0.8),
]

# Компилируем паттерны для производительности
COMPILED_PRIORITY_PATTERNS = [(re.compile(p, re.IGNORECASE), intent, conf)
                               for p, intent, conf in PRIORITY_PATTERNS]
