#!/usr/bin/env python3
"""
Четвёртый альтернативный тест записей 201-250 с короткими запросами.
Проверяет что записи находятся по кратким телеграм-стиля вопросам.

Запуск: python3 scripts/test_entries_201_250_v4.py
"""

import sys
sys.path.insert(0, 'src')

from src.knowledge.retriever import KnowledgeRetriever
from src.knowledge.data import WIPON_KNOWLEDGE


# Альтернативные тестовые случаи для записей 201-250 (v4 - краткие)
# Формат: (topic, запрос, ожидаемые слова в ответе)
TEST_CASES_V4 = [
    # 201 - Уведомление от налоговой
    ("tis_tax_notification_201",
     "налоговая прислала превышение ндс",
     ["регистрационную карту", "автоматически"]),

    # 202 - Превышаю пороги ТИС
    ("tis_exceeding_limits_202",
     "превышаю лимиты тис варианты",
     ["Wipon Розница", "СНР"]),

    # 203 - Стоимость подключения ТИС
    ("pricing_tis_connection_203",
     "цена тис подключения",
     ["220 000", "80 000"]),

    # 204 - Разовая или абонентская оплата
    ("pricing_tis_payment_type_204",
     "тис разово или абонентка",
     ["Годовая абонентская"]),

    # 205 - Стоимость второй точки
    ("pricing_tis_second_point_205",
     "вторая точка тис цена",
     ["80 000", "300 000"]),

    # 206 - Способы оплаты
    ("pricing_payment_methods_206",
     "оплатить каспи халык",
     ["Kaspi", "Halyk"]),

    # 207 - Закрыть ИП и открыть новое
    ("tis_ip_transfer_207",
     "закрываю ип тис перенести",
     ["перенесём", "заявление"]),

    # 208 - Дополнительные расходы
    ("pricing_tis_additional_costs_208",
     "доп расходы офд",
     ["ОФД", "1 400"]),

    # 209 - Что получаю с ТИС
    ("tis_features_209",
     "что входит в тис",
     ["Wipon", "онлайн касс", "POS"]),

    # 210 - С какими программами интегрируется
    ("tis_integrations_210",
     "интеграции тис 1с",
     ["1С", "iiko", "Poster"]),

    # 211 - Kaspi магазин и Halyk Market
    ("tis_kaspi_halyk_211",
     "каспи магазин автоматом",
     ["автоматически", "ручного ввода"]),

    # 212 - Подключить свой POS-терминал
    ("tis_pos_terminal_212",
     "подключить пос терминал банка",
     ["POS терминал подключим", "Эквайринг"]),

    # 213 - Интеграция с 1С, iiko
    ("tis_1c_iiko_213",
     "синхронизация 1с автомат",
     ["синхронизируются", "Двойного ввода"]),

    # 214 - Нужно ли оборудование
    ("tis_equipment_required_214",
     "работать без железа с ноута",
     ["компьютера", "POS терминал"]),

    # 215 - Продажа в минус или в долг
    ("tis_sales_restrictions_215",
     "продажа в долг тис",
     ["Нет", "фактическим остаткам"]),

    # 216 - Клиент хочет в рассрочку
    ("tis_credit_sales_216",
     "рассрочка каспи ред лимиты",
     ["Да", "Kaspi", "учитываются в лимитах"]),

    # 217 - Wildberries/Ozon входят в ТИС
    ("tis_wildberries_ozon_217",
     "вб озон маркетплейсы тис",
     ["Нет", "не входят"]),

    # 218 - Оплаты перечислением
    ("tis_bank_transfers_218",
     "безнал перечисления лимит",
     ["не идут в лимит", "Подключить можно"]),

    # 219 - Как быстро подключиться
    ("tis_connection_speed_219",
     "сроки подключения тис",
     ["тот же день", "несколько часов"]),

    # 220 - Кто настраивает систему
    ("tis_setup_220",
     "настройка тис кто делает",
     ["Настройку делаем мы", "обучим"]),

    # 221 - Обучение и поддержка
    ("tis_training_support_221",
     "обучение поддержка тис",
     ["обучение", "поддержку"]),

    # 222 - Какие документы нужны
    ("tis_documents_222",
     "документы для тис эцп",
     ["ЭЦП", "POS терминал"]),

    # 223 - Приезжаете устанавливать
    ("tis_installation_223",
     "выезд установка тис цена",
     ["удалённо", "30 000"]),

    # 224 - Точки в разных городах
    ("tis_multiple_cities_224",
     "разные города точки тис",
     ["одном городе", "не подключается"]),

    # 225 - На каком налоговом режиме остаюсь
    ("tis_tax_regime_225",
     "режим налога при тис",
     ["упрощёнке", "Отчёты формирует"]),

    # 226 - Будет ли ТИС в 2026 году
    ("tis_2026_226",
     "тис 2026 будет работать",
     ["продолжит работу", "Налоговый кодекс"]),

    # 227 - Видит ли налоговая учёт товаров
    ("tis_inventory_visibility_227",
     "налоговая видит товары склад",
     ["Нет", "только вам"]),

    # 228 - Можно не подключать кассу
    ("tis_own_cash_register_228",
     "своя касса без вашей",
     ["Нет", "касса из комплекта", "задвоения"]),

    # 229 - Можно не фискализировать
    ("tis_fiscalization_229",
     "без фискализации чеков",
     ["Нельзя", "Фискализация обязательна"]),

    # 230 - ТОО не могу подключить ТИС
    ("tis_too_alternative_230",
     "тоо нельзя тис что делать",
     ["Wipon Розница", "розничного налога"]),

    # 231 - Не подходит ни розничный ни ТИС
    ("tis_consultation_231",
     "консультация ничего не подходит",
     ["специалистам", "Позвонят"]),

    # 232 - ТОО может на ТИС 2026
    ("tis_too_2026_232",
     "тоо на тис 2026 разрешат",
     ["уточняется", "правила опубликуют"]),

    # 233 - Список запрещённых ОКЭДов
    ("tis_forbidden_okeds_233",
     "запрещённые окэд тис список",
     ["не опубликован", "ОКЭД"]),

    # 234 - Открыть точку в другом городе
    ("tis_new_city_point_234",
     "новая точка другой город",
     ["одном городе", "правила изменятся"]),

    # 235 - Больше 30 сотрудников
    ("tis_employees_limit_235",
     "лимит сотрудников 30 человек",
     ["снять ограничение", "сотрудников"]),

    # 236 - Бухучёт при доходе от 500 млн
    ("tis_accounting_500m_236",
     "доход 500 млн бухучёт",
     ["500 млн", "бухучёт обязателен"]),

    # 237 - Откуда ставка 2-6%
    ("tis_tax_rate_237",
     "ставка 2 6 процентов акимат",
     ["акимат", "региона"]),

    # 238 - Что такое розничный налог
    ("retail_tax_definition_238",
     "розничный налог определение суть",
     ["специальный режим", "фиксированной ставкой"]),

    # 239 - Какие ставки в моём городе
    ("retail_tax_rates_region_239",
     "ставка розничного астана алматы",
     ["Астане 3", "4 процента"]),

    # 240 - Подходит ли мой вид деятельности
    ("retail_tax_oked_check_240",
     "окэд проверить розничный",
     ["ОКЭД", "перечн"]),

    # 241 - Объект налогообложения
    ("retail_tax_object_241",
     "база налога розничного доход",
     ["Налогооблагаемый доход", "совокупно"]),

    # 242 - На какой срок введён
    ("retail_tax_duration_242",
     "срок розничного бессрочно",
     ["без ограничения", "сколько выгодно"]),

    # 243 - Выгодно ли для ИП
    ("retail_tax_profitable_243",
     "розничный ип выгода расчёт",
     ["Зависит от оборота", "2–4%"]),

    # 244 - Агрегаторы Wolt/Yandex
    ("retail_tax_aggregators_244",
     "вольт яндекс доставка процент",
     ["Физлица", "Юрлица 8%"]),

    # 245 - Как узнать перешёл ли я
    ("retail_tax_transition_status_245",
     "статус заявки переход режим",
     ["уведомление", "кабинете налогоплательщика"]),

    # 246 - С какой даты применяется
    ("retail_tax_start_date_246",
     "дата начала применения режима",
     ["1 числа месяца", "регистрации"]),

    # 247 - Каким организациям выгодно
    ("retail_tax_who_benefits_247",
     "кому выгоден розничный b2c",
     ["ОКЭД", "B2C оборот"]),

    # 248 - Как оптимизировать налоги
    ("retail_tax_optimization_248",
     "раздельный учёт оптимизация",
     ["раздельный учёт", "4%", "8%"]),

    # 249 - Требования для СНР
    ("retail_tax_requirements_249",
     "требования снр 600000 мрп",
     ["600 000 МРП", "200 сотрудников"]),

    # 250 - ТОО и ИП одновременно
    ("retail_tax_too_and_ip_250",
     "тоо и ип одновременно розничный",
     ["Да", "ТОО не мешает"]),
]


def run_tests():
    """Запуск альтернативных тестов v4 для записей 201-250"""
    print("=" * 70)
    print("АЛЬТЕРНАТИВНЫЙ ТЕСТ ЗАПИСЕЙ 201-250 (v4 - краткие)")
    print("=" * 70)
    print()

    # Проверяем что все topic существуют
    print("\U0001F4CB Проверка наличия секций...")
    all_topics = [s.topic for s in WIPON_KNOWLEDGE.sections]
    missing_topics = []
    for topic, _, _ in TEST_CASES_V4:
        if topic not in all_topics:
            missing_topics.append(topic)

    if missing_topics:
        print(f"\u274C ОШИБКА: Отсутствуют секции: {missing_topics}")
        return
    else:
        print(f"\u2713 Все 50 секций найдены в базе знаний")
    print()

    # Инициализация retriever (без эмбеддингов для скорости)
    print("\U0001F504 Инициализация retriever...")
    retriever = KnowledgeRetriever(use_embeddings=False)
    print()

    # Запуск тестов
    print("\U0001F9EA Запуск альтернативных тестов v4...")
    print("-" * 70)

    passed = 0
    failed = 0
    failed_tests = []

    for topic, query, expected_words in TEST_CASES_V4:
        facts = retriever.retrieve(query, top_k=3)
        facts_lower = facts.lower()

        # Проверяем что хотя бы одно ожидаемое слово найдено
        found_words = [w for w in expected_words if w.lower() in facts_lower]
        success = len(found_words) > 0

        entry_num = topic.split('_')[-1]

        if success:
            passed += 1
            print(f"\u2713 [{entry_num}] {topic[:40]}")
        else:
            failed += 1
            failed_tests.append((topic, query, expected_words, facts[:200]))
            print(f"\u2717 [{entry_num}] {topic[:40]}")

    print("-" * 70)
    print()

    # Итоги
    total = passed + failed
    percentage = (passed / total * 100) if total > 0 else 0

    print("=" * 70)
    print("ИТОГИ АЛЬТЕРНАТИВНОГО ТЕСТИРОВАНИЯ (v4)")
    print("=" * 70)
    print(f"Пройдено:  {passed}/{total}")
    print(f"Провалено: {failed}/{total}")
    print(f"Покрытие:  {percentage:.1f}%")
    print()

    if failed_tests:
        print("\u274C ПРОВАЛЁННЫЕ ТЕСТЫ:")
        print("-" * 70)
        for topic, query, expected, result in failed_tests:
            print(f"\nTopic: {topic}")
            print(f"Запрос: {query}")
            print(f"Ожидалось: {expected}")
            print(f"Получено: {result}...")
    else:
        print("\U0001F389 ВСЕ АЛЬТЕРНАТИВНЫЕ ТЕСТЫ v4 ПРОЙДЕНЫ!")

    return failed == 0


if __name__ == "__main__":
    success = run_tests()
    sys.exit(0 if success else 1)
