#!/usr/bin/env python3
"""
E2E тест точности CategoryRouter.

400 разнообразных запросов с опечатками, казахским языком, сленгом.

Запуск: python3 check_category_router_accuracy.py
"""

import sys
import os
import time
import requests
from typing import List, Tuple
from dataclasses import dataclass

sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))
from src.knowledge.category_router import CategoryRouter

# =============================================================================
# 400 тестовых запросов
# =============================================================================

TEST_QUERIES: List[Tuple[str, str, str]] = [
    # ==========================================================================
    # REGIONS (30 запросов)
    # ==========================================================================
    ("Работаете ли вы в Караганде?", "regions", "караганда"),
    ("Можно ли подключиться в Актау?", "regions", "актау"),
    ("Есть ли доставка в Павлодар?", "regions", "павлодар"),
    ("Wipon работает в Костанае?", "regions", "костанай"),
    ("Доставите в село?", "regions", "село"),
    ("в астане есть офис?", "regions", "астана офис"),
    ("работаите в шымкенте?", "regions", "шымкент опечатка"),
    ("доставка в уральск сколько дней?", "regions", "уральск"),
    ("атырау доставляите?", "regions", "атырау опечатка"),
    ("по всему казахстану работаете?", "regions", "весь казахстан"),
    ("актобе можно подключить?", "regions", "актобе"),
    ("в семей доставка есть?", "regions", "семей"),
    ("тараз подключаете?", "regions", "тараз"),
    ("в петропавловске работаете?", "regions", "петропавловск"),
    ("кызылорда доставка оборудования", "regions", "кызылорда"),
    ("туркестанға жеткізу бар ма?", "regions", "туркестан казахский"),
    ("оскемен доставка", "regions", "усть-каменогорск"),
    ("талдыкорган работаете?", "regions", "талдыкорган"),
    ("экибастуз подключение", "regions", "экибастуз"),
    ("темиртау доставите?", "regions", "темиртау"),
    ("рудный город работаете?", "regions", "рудный"),
    ("жезказган есть доставка?", "regions", "жезказган"),
    ("балхаш подключаете?", "regions", "балхаш"),
    ("степногорск доставка", "regions", "степногорск"),
    ("сатпаев wipon", "regions", "сатпаев"),
    ("в аул доставите оборудование?", "regions", "аул"),
    ("қарағандыға жеткізу", "regions", "караганда казахский"),
    ("алматыға жеткізесіздер ме?", "regions", "алматы казахский"),
    ("где ваш офис находится?", "regions", "офис"),
    ("адрес офиса в астане", "regions", "адрес астана"),

    # ==========================================================================
    # SUPPORT (35 запросов)
    # ==========================================================================
    ("Помогите настроить программу", "support", "настройка"),
    ("Как перейти с Umag на Wipon?", "support", "миграция umag"),
    ("Переходим с Бексар, поможете?", "support", "миграция бексар"),
    ("Сколько времени занимает миграция?", "support", "время миграции"),
    ("Как обучить кассира работе с программой?", "support", "обучение кассира"),
    ("нужна помощь с настройкой", "support", "помощь"),
    ("как связатся с поддержкой?", "support", "связь опечатка"),
    ("не могу разобраться с программой", "support", "проблема"),
    ("можно онлайн настроить?", "support", "онлайн настройка"),
    ("сколько времени подключение занимает?", "support", "время подключения"),
    ("есть ли обучение для персонала?", "support", "обучение персонала"),
    ("помагите пожалуйста", "support", "помощь опечатка"),
    ("как зарегистрировать кассу?", "support", "регистрация кассы"),
    ("нужен ли ЭЦП для подключения?", "support", "ЭЦП"),
    ("переехали с x2pos помогите", "support", "миграция x2pos"),
    ("как перенести данные из мойсклад?", "support", "миграция мойсклад"),
    ("техподдержка работает ночью?", "support", "ночная поддержка"),
    ("есть казахский язык в программе?", "support", "казахский язык"),
    ("после оплаты когда начнём работать?", "support", "старт после оплаты"),
    ("как экспортировать данные из юмаг?", "support", "экспорт umag"),
    ("қолдау көрсету қызметі", "support", "поддержка казахский"),
    ("не работает программа что делать", "support", "не работает"),
    ("ошибка при запуске", "support", "ошибка"),
    ("как обновить программу?", "support", "обновление"),
    ("забыл пароль что делать", "support", "пароль"),
    ("как сбросить настройки?", "support", "сброс"),
    ("программа зависает", "support", "зависание"),
    ("как удалить товар?", "support", "удаление"),
    ("не печатает чек помогите", "support", "проблема чек"),
    ("сканер не работает", "support", "проблема сканер"),
    ("менеджер не отвечает", "support", "менеджер"),
    ("перезвоните пожалуйста", "support", "перезвонить"),
    ("нужна консультация", "support", "консультация"),
    ("выезд специалиста возможен?", "support", "выезд"),
    ("удалённая настройка", "support", "удалённая"),

    # ==========================================================================
    # PRODUCTS (40 запросов)
    # ==========================================================================
    ("Нужна программа для учёта бизнеса", "products", "программа учёта"),
    ("Чем отличаются ваши продукты?", "products", "отличия продуктов"),
    ("Что посоветуете для маленького магазина?", "products", "маленький магазин"),
    ("У меня сеть магазинов, что подойдёт?", "products", "сеть магазинов"),
    ("Можно ли попробовать демо версию?", "products", "демо"),
    ("что такое wipon desktop?", "products", "wipon desktop"),
    ("расскажите про wipon kassa", "products", "wipon kassa"),
    ("какие продукты у вас есть?", "products", "список продуктов"),
    ("что выбрать для бутика?", "products", "бутик"),
    ("нужна программа под франшизу", "products", "франшиза"),
    ("wipon работает на mac?", "products", "mac"),
    ("подойдёт для фастфуда?", "products", "фастфуд"),
    ("для стройматериалов подойдёт?", "products", "стройматериалы"),
    ("что для рынка посоветуете?", "products", "рынок"),
    ("нужна касса под ключ", "products", "под ключ"),
    ("випон что это?", "products", "что это опечатка"),
    ("программа для продаж и закупок", "products", "продажи закупки"),
    ("можно без бухгалтера работать?", "products", "без бухгалтера"),
    ("какая программа лучше для алматы?", "products", "для алматы"),
    ("wipon pro это что?", "products", "wipon pro"),
    ("для кофейни что подойдёт?", "products", "кофейня"),
    ("программа для аптеки", "products", "аптека"),
    ("для салона красоты", "products", "салон красоты"),
    ("автозапчасти учёт", "products", "автозапчасти"),
    ("для ресторана что выбрать?", "products", "ресторан"),
    ("пекарня автоматизация", "products", "пекарня"),
    ("цветочный магазин", "products", "цветы"),
    ("зоомагазин программа", "products", "зоомагазин"),
    ("для ломбарда подойдёт?", "products", "ломбард"),
    ("магазин электроники", "products", "электроника"),
    ("хозтовары учёт", "products", "хозтовары"),
    ("детский магазин", "products", "детский"),
    ("спортивные товары", "products", "спорт"),
    ("мебельный магазин", "products", "мебель"),
    ("ювелирный магазин", "products", "ювелирка"),
    ("для супермаркета", "products", "супермаркет"),
    ("мини-маркет программа", "products", "мини-маркет"),
    ("для оптовой базы", "products", "опт"),
    ("wipon cashback что это?", "products", "cashback"),
    ("система лояльности wipon", "products", "лояльность"),

    # ==========================================================================
    # EQUIPMENT (40 запросов)
    # ==========================================================================
    ("Какой стартовый комплект оборудования нужен?", "equipment", "стартовый комплект"),
    ("Есть ли счётчик банкнот?", "equipment", "счётчик банкнот"),
    ("Какие готовые комплекты есть?", "equipment", "готовые комплекты"),
    ("Нужны весы для овощей", "equipment", "весы овощи"),
    ("Можно ли арендовать оборудование?", "equipment", "аренда"),
    ("какой сканер штрихкодов лучше?", "equipment", "сканер"),
    ("принтер чеков какой выбрать?", "equipment", "принтер чеков"),
    ("нужен денежный ящик", "equipment", "денежный ящик"),
    ("есть терминал для карт?", "equipment", "терминал карт"),
    ("какие весы для магазина?", "equipment", "весы магазин"),
    ("экран для покупателя есть?", "equipment", "экран покупателя"),
    ("оборудование для холодного склада", "equipment", "холодный склад"),
    ("тихий принтер есть?", "equipment", "тихий принтер"),
    ("скинер штрихкода какой?", "equipment", "сканер опечатка"),
    ("какое оборудование популярное?", "equipment", "популярное"),
    ("комплект для продуктового", "equipment", "продуктовый"),
    ("оборудывание для кафе", "equipment", "кафе опечатка"),
    ("pos терминал нужен", "equipment", "pos терминал"),
    ("весы с печатью этикеток", "equipment", "весы этикетки"),
    ("какой принтер для кухни?", "equipment", "принтер кухня"),
    ("беспроводной сканер", "equipment", "беспроводной"),
    ("bluetooth сканер", "equipment", "bluetooth"),
    ("usb сканер штрихкода", "equipment", "usb"),
    ("2d сканер нужен", "equipment", "2d"),
    ("qr сканер есть?", "equipment", "qr"),
    ("термопринтер 80мм", "equipment", "термопринтер"),
    ("принтер 58мм", "equipment", "58мм"),
    ("этикет принтер", "equipment", "этикет"),
    ("кассовый аппарат", "equipment", "кассовый аппарат"),
    ("онлайн касса оборудование", "equipment", "онлайн касса"),
    ("планшет для кассы", "equipment", "планшет"),
    ("монитор для кассира", "equipment", "монитор"),
    ("дисплей покупателя", "equipment", "дисплей"),
    ("сканер для алкоголя", "equipment", "сканер алкоголь"),
    ("весы настольные", "equipment", "весы настольные"),
    ("весы напольные", "equipment", "весы напольные"),
    ("весы торговые", "equipment", "весы торговые"),
    ("ТСД терминал сбора данных", "equipment", "ТСД"),
    ("мобильный принтер", "equipment", "мобильный принтер"),
    ("чековая лента", "equipment", "лента"),

    # ==========================================================================
    # INTEGRATIONS (30 запросов)
    # ==========================================================================
    ("Как подключить Kaspi магазин?", "integrations", "kaspi магазин"),
    ("Работает ли с Halyk POS?", "integrations", "halyk pos"),
    ("Можно ли продавать на маркетплейсах?", "integrations", "маркетплейсы"),
    ("Как подключить интернет-магазин?", "integrations", "интернет-магазин"),
    ("Есть ли API для интеграции?", "integrations", "API"),
    ("kaspi red поддерживается?", "integrations", "kaspi red"),
    ("можно несколько терминалов подключить?", "integrations", "несколько терминалов"),
    ("интеграция с 1с есть?", "integrations", "1с"),
    ("каспи как подключить?", "integrations", "kaspi транслит"),
    ("работает с халык банком?", "integrations", "halyk"),
    ("можно на wildberries продавать?", "integrations", "wildberries"),
    ("подключение к ozon", "integrations", "ozon"),
    ("интиграция с банками", "integrations", "банки опечатка"),
    ("несколько эквайрингов можно?", "integrations", "мульти эквайринг"),
    ("вебхуки есть?", "integrations", "вебхуки"),
    ("jusan bank интеграция", "integrations", "jusan"),
    ("forte bank подключить", "integrations", "forte"),
    ("kaspi qr оплата", "integrations", "kaspi qr"),
    ("синхронизация с сайтом", "integrations", "сайт"),
    ("woocommerce интеграция", "integrations", "woocommerce"),
    ("bitrix интеграция", "integrations", "bitrix"),
    ("telegram бот подключить", "integrations", "telegram"),
    ("whatsapp интеграция", "integrations", "whatsapp"),
    ("instagram магазин", "integrations", "instagram"),
    ("satu.kz интеграция", "integrations", "satu"),
    ("olx подключить", "integrations", "olx"),
    ("flip.kz интеграция", "integrations", "flip"),
    ("маркировка товаров", "integrations", "маркировка"),
    ("честный знак", "integrations", "честный знак"),
    ("эквайринг беркут", "integrations", "беркут"),

    # ==========================================================================
    # PRICING (30 запросов)
    # ==========================================================================
    ("Какой тариф выбрать?", "pricing", "выбор тарифа"),
    ("Есть ли рассрочка на программу?", "pricing", "рассрочка"),
    ("Программа бесплатная?", "pricing", "бесплатно"),
    ("сколько стоит wipon?", "pricing", "стоимость"),
    ("какие тарифы есть?", "pricing", "тарифы"),
    ("цена за месяц?", "pricing", "цена месяц"),
    ("годовая подписка дешевле?", "pricing", "годовая"),
    ("скидка есть?", "pricing", "скидка"),
    ("сколко стоит подключение?", "pricing", "подключение опечатка"),
    ("оплата помесячно?", "pricing", "помесячно"),
    ("lite тариф что включает?", "pricing", "lite"),
    ("standard vs pro отличия по цене", "pricing", "standard vs pro"),
    ("есть пробный период?", "pricing", "пробный период"),
    ("касса бесплатная?", "pricing", "касса бесплатно"),
    ("прайс на оборудование", "pricing", "прайс оборудование"),
    ("mini тариф подойдёт?", "pricing", "mini"),
    ("pro тариф что даёт?", "pricing", "pro"),
    ("сколько стоит сканер?", "pricing", "цена сканер"),
    ("принтер цена", "pricing", "цена принтер"),
    ("весы стоимость", "pricing", "цена весы"),
    ("комплект оборудования цена", "pricing", "цена комплект"),
    ("ежемесячная оплата", "pricing", "ежемесячная"),
    ("единоразовая оплата есть?", "pricing", "единоразовая"),
    ("қанша тұрады?", "pricing", "казахский сколько"),
    ("бағасы қанша?", "pricing", "казахский цена"),
    ("акции на оборудование", "pricing", "акции"),
    ("black friday скидки", "pricing", "black friday"),
    ("новогодние скидки", "pricing", "новогодние"),
    ("партнёрская скидка", "pricing", "партнёрская"),
    ("оптовая цена", "pricing", "оптовая"),

    # ==========================================================================
    # TIS (25 запросов)
    # ==========================================================================
    ("Что такое ТИС?", "tis", "что такое тис"),
    ("нужен ли мне тис?", "tis", "нужен ли"),
    ("как подключить тис?", "tis", "подключение"),
    ("тис для ип обязателен?", "tis", "ип"),
    ("упрощёнка и тис", "tis", "упрощёнка"),
    ("тис в разных городах можно?", "tis", "разные города"),
    ("тіс қалай қосамын?", "tis", "казахский"),
    ("розничный налог автоматом?", "tis", "розничный налог"),
    ("тис для нескольких точек", "tis", "несколько точек"),
    ("налоговый режим тис", "tis", "налоговый режим"),
    ("лимит по тис какой?", "tis", "лимит"),
    ("тис и ндс", "tis", "ндс"),
    ("превысил лимит тис что делать?", "tis", "превышение"),
    ("тис сертификация", "tis", "сертификация"),
    ("тис для магазина одежды", "tis", "магазин одежды"),
    ("тис кафе подойдёт?", "tis", "тис кафе"),
    ("тис парикмахерская", "tis", "парикмахерская"),
    ("тис для услуг", "tis", "услуги"),
    ("тис оборот какой?", "tis", "оборот"),
    ("когда нужен тис?", "tis", "когда нужен"),
    ("тис обязательно или нет?", "tis", "обязательно"),
    ("тис отменили?", "tis", "отменили"),
    ("тис новые правила", "tis", "новые правила"),
    ("тис 2024 изменения", "tis", "изменения"),
    ("штраф за отсутствие тис", "tis", "штраф"),

    # ==========================================================================
    # INVENTORY (25 запросов)
    # ==========================================================================
    ("Как посмотреть остатки товаров?", "inventory", "остатки"),
    ("сколько товаров можно добавить?", "inventory", "лимит товаров"),
    ("учёт партий и сроков годности", "inventory", "партии сроки"),
    ("оповещение о низких остатках", "inventory", "низкие остатки"),
    ("серийные номера imei учёт", "inventory", "серийные номера"),
    ("как вести склад?", "inventory", "склад"),
    ("инвентаризация как делать?", "inventory", "инвентаризация"),
    ("приход товара как оформить?", "inventory", "приход"),
    ("списание товаров", "inventory", "списание"),
    ("перемещение между складами", "inventory", "перемещение"),
    ("возврат товара поставщику", "inventory", "возврат поставщику"),
    ("приёмка товара", "inventory", "приёмка"),
    ("накладная на приход", "inventory", "накладная"),
    ("штрихкоды товаров", "inventory", "штрихкоды"),
    ("загрузить товары из excel", "inventory", "excel"),
    ("импорт товаров", "inventory", "импорт"),
    ("экспорт остатков", "inventory", "экспорт"),
    ("категории товаров", "inventory", "категории"),
    ("группы товаров", "inventory", "группы"),
    ("модификации товаров", "inventory", "модификации"),
    ("размеры товаров", "inventory", "размеры"),
    ("цвета товаров", "inventory", "цвета"),
    ("себестоимость товара", "inventory", "себестоимость"),
    ("наценка на товар", "inventory", "наценка"),
    ("минимальный остаток", "inventory", "минимальный"),

    # ==========================================================================
    # FISCAL (20 запросов)
    # ==========================================================================
    ("Как зарегистрироваться в налоговой?", "fiscal", "налоговая регистрация"),
    ("чеки автоматом в офд?", "fiscal", "офд автомат"),
    ("фискальный чек как печатать?", "fiscal", "фискальный чек"),
    ("офд подключение", "fiscal", "офд"),
    ("z-отчёт как сделать?", "fiscal", "z-отчёт"),
    ("фискализация кассы", "fiscal", "фискализация"),
    ("чек коррекции", "fiscal", "коррекция"),
    ("електронный чек", "fiscal", "электронный опечатка"),
    ("возврат чека", "fiscal", "возврат чека"),
    ("копия чека", "fiscal", "копия"),
    ("дубликат чека", "fiscal", "дубликат"),
    ("отмена чека", "fiscal", "отмена"),
    ("x-отчёт", "fiscal", "x-отчёт"),
    ("закрытие смены", "fiscal", "закрытие смены"),
    ("открытие смены", "fiscal", "открытие смены"),
    ("фискальный признак", "fiscal", "признак"),
    ("чек на email", "fiscal", "email"),
    ("чек по whatsapp", "fiscal", "whatsapp чек"),
    ("qr код на чеке", "fiscal", "qr чек"),
    ("налоговый вычет чек", "fiscal", "вычет"),

    # ==========================================================================
    # ANALYTICS (20 запросов)
    # ==========================================================================
    ("Как посмотреть аналитику продаж?", "analytics", "аналитика продаж"),
    ("отчёт по выручке", "analytics", "выручка"),
    ("топ продаваемых товаров", "analytics", "топ товаров"),
    ("убыточные товары как найти?", "analytics", "убыточные"),
    ("статистика за месяц", "analytics", "статистика"),
    ("графики продаж есть?", "analytics", "графики"),
    ("abc анализ товаров", "analytics", "abc анализ"),
    ("отчёт по прибыли", "analytics", "прибыль"),
    ("маржинальность товаров", "analytics", "маржинальность"),
    ("динамика продаж", "analytics", "динамика"),
    ("сравнение периодов", "analytics", "сравнение"),
    ("отчёт по категориям", "analytics", "по категориям"),
    ("средний чек", "analytics", "средний чек"),
    ("количество чеков", "analytics", "количество чеков"),
    ("конверсия продаж", "analytics", "конверсия"),
    ("отчёт по дням недели", "analytics", "по дням"),
    ("почасовой отчёт", "analytics", "почасовой"),
    ("сезонность продаж", "analytics", "сезонность"),
    ("прогноз продаж", "analytics", "прогноз"),
    ("дашборд аналитики", "analytics", "дашборд"),

    # ==========================================================================
    # EMPLOYEES (20 запросов)
    # ==========================================================================
    ("Как контролировать смены сотрудников?", "employees", "смены"),
    ("ограничить права кассира", "employees", "права кассира"),
    ("уровни доступа для сотрудников", "employees", "уровни доступа"),
    ("заблокировать пользователя", "employees", "блокировка"),
    ("учёт рабочего времени", "employees", "рабочее время"),
    ("добавить кассира", "employees", "добавить кассира"),
    ("удалить сотрудника", "employees", "удалить"),
    ("сменить пароль кассиру", "employees", "пароль кассира"),
    ("история действий сотрудника", "employees", "история"),
    ("кто продал товар?", "employees", "кто продал"),
    ("отчёт по кассиру", "employees", "отчёт кассира"),
    ("выручка по сотрудникам", "employees", "выручка сотрудники"),
    ("кто отменил чек?", "employees", "кто отменил"),
    ("журнал действий", "employees", "журнал"),
    ("PIN код кассира", "employees", "PIN"),
    ("несколько кассиров одна касса", "employees", "несколько кассиров"),
    ("роли пользователей", "employees", "роли"),
    ("администратор и кассир", "employees", "администратор"),
    ("владелец магазина доступ", "employees", "владелец"),
    ("менеджер магазина права", "employees", "менеджер"),

    # ==========================================================================
    # MOBILE (15 запросов)
    # ==========================================================================
    ("Можно ли работать только с телефона?", "mobile", "только телефон"),
    ("приложение на айфон есть?", "mobile", "iphone"),
    ("андроид приложение", "mobile", "android"),
    ("мобильное приложение wipon", "mobile", "мобильное"),
    ("с планшета можно работать?", "mobile", "планшет"),
    ("скачать приложение", "mobile", "скачать"),
    ("app store wipon", "mobile", "app store"),
    ("google play wipon", "mobile", "google play"),
    ("push уведомления", "mobile", "push"),
    ("оповещения на телефон", "mobile", "оповещения"),
    ("удалённый доступ с телефона", "mobile", "удалённый телефон"),
    ("смотреть продажи с телефона", "mobile", "продажи телефон"),
    ("остатки на телефоне", "mobile", "остатки телефон"),
    ("мобильная касса", "mobile", "мобильная касса"),
    ("телефон как касса", "mobile", "телефон касса"),

    # ==========================================================================
    # FEATURES (25 запросов)
    # ==========================================================================
    ("Есть ли доставка в программе?", "features", "доставка"),
    ("печать ценников", "features", "ценники"),
    ("логотип на чеке", "features", "логотип"),
    ("две валюты в программе", "features", "валюты"),
    ("работа в нескольких валютах", "features", "мультивалюта"),
    ("учёт в долларах", "features", "доллары"),
    ("учёт в рублях", "features", "рубли"),
    ("конвертация валют", "features", "конвертация"),
    ("курс валют", "features", "курс"),
    ("продажа в долг", "features", "в долг"),
    ("кредит покупателю", "features", "кредит"),
    ("отложенный платёж", "features", "отложенный"),
    ("частичная оплата", "features", "частичная"),
    ("смешанная оплата", "features", "смешанная"),
    ("безналичный расчёт", "features", "безналичный"),
    ("оплата картой", "features", "картой"),
    ("оплата наличными", "features", "наличными"),
    ("предзаказ товара", "features", "предзаказ"),
    ("бронирование товара", "features", "бронирование"),
    ("возврат товара покупателю", "features", "возврат покупателю"),
    ("обмен товара", "features", "обмен"),
    ("подарочный сертификат", "features", "сертификат"),
    ("программа лояльности", "features", "лояльность программа"),
    ("накопительная скидка", "features", "накопительная"),
    ("штрихкодирование", "features", "штрихкодирование"),

    # ==========================================================================
    # STABILITY (15 запросов)
    # ==========================================================================
    ("Что если интернет пропадёт?", "stability", "без интернета"),
    ("программа работает офлайн?", "stability", "офлайн"),
    ("слабый интернет потянет?", "stability", "слабый интернет"),
    ("данные не потеряются?", "stability", "потеря данных"),
    ("резервное копирование", "stability", "бекап"),
    ("восстановление данных", "stability", "восстановление"),
    ("синхронизация после офлайн", "stability", "синхронизация"),
    ("облачное хранение", "stability", "облако"),
    ("где хранятся данные?", "stability", "хранение"),
    ("безопасность данных", "stability", "безопасность"),
    ("шифрование данных", "stability", "шифрование"),
    ("сервера wipon", "stability", "сервера"),
    ("uptime системы", "stability", "uptime"),
    ("SLA поддержки", "stability", "SLA"),
    ("GDPR соответствие", "stability", "GDPR"),

    # ==========================================================================
    # PROMOTIONS (15 запросов)
    # ==========================================================================
    ("автоматические скидки настроить", "promotions", "автоскидки"),
    ("акции и бонусы для клиентов", "promotions", "акции бонусы"),
    ("скидка на день рождения", "promotions", "день рождения"),
    ("happy hour скидки", "promotions", "happy hour"),
    ("скидка по времени", "promotions", "по времени"),
    ("скидка выходного дня", "promotions", "выходные"),
    ("скидка на категорию", "promotions", "на категорию"),
    ("скидка на товар", "promotions", "на товар"),
    ("накопительные бонусы", "promotions", "накопительные"),
    ("кэшбэк покупателям", "promotions", "кэшбэк"),
    ("бонусная карта", "promotions", "бонусная карта"),
    ("купон на скидку", "promotions", "купон"),
    ("промокод", "promotions", "промокод"),
    ("реферальная программа", "promotions", "реферальная"),
    ("скидка постоянному клиенту", "promotions", "постоянный клиент"),

    # ==========================================================================
    # OTHER / FAQ (10 запросов)
    # ==========================================================================
    ("Почему wipon лучше конкурентов?", "other", "конкуренты"),
    ("преимущества wipon", "other", "преимущества"),
    ("wipon vs iiko", "other", "vs iiko"),
    ("wipon vs poster", "other", "vs poster"),
    ("кому подходит wipon?", "other", "кому подходит"),
    ("история компании wipon", "other", "история"),
    ("сколько клиентов у wipon?", "other", "клиенты"),
    ("отзывы о wipon", "other", "отзывы"),
    ("награды wipon", "other", "награды"),
    ("сертификаты wipon", "other", "сертификаты компании"),
]


# =============================================================================
# LLM клиент
# =============================================================================

class OllamaLLM:
    def __init__(self, model: str = "qwen3:8b"):
        self.model = model
        self.base_url = "http://localhost:11434/api/generate"

    def generate(self, prompt: str) -> str:
        response = requests.post(
            self.base_url,
            json={
                "model": self.model,
                "prompt": prompt,
                "stream": False,
                "think": False,
                "options": {"temperature": 0.0, "num_predict": 100}
            },
            timeout=60
        )
        if response.status_code == 200:
            return response.json().get("response", "")
        raise RuntimeError(f"Ollama error: {response.status_code}")


def is_ollama_available() -> bool:
    try:
        return requests.get("http://localhost:11434/api/tags", timeout=2).status_code == 200
    except:
        return False


def get_available_model() -> str:
    try:
        response = requests.get("http://localhost:11434/api/tags", timeout=2)
        if response.status_code == 200:
            models = [m["name"] for m in response.json().get("models", [])]
            for preferred in ["qwen3:8b-fast", "qwen3:8b", "qwen3:1.7b"]:
                if preferred in models:
                    return preferred
            return models[0] if models else "qwen3:8b"
    except:
        return "qwen3:8b"


@dataclass
class TestResult:
    query: str
    expected_category: str
    description: str
    predicted_categories: List[str]
    is_correct: bool
    latency_ms: float


def run_tests() -> List[TestResult]:
    if not is_ollama_available():
        print("ERROR: Ollama не доступен. Запустите: ollama serve")
        sys.exit(1)

    model = get_available_model()
    print(f"Модель: {model}")
    print(f"Всего тестов: {len(TEST_QUERIES)}")
    print("=" * 100)

    llm = OllamaLLM(model)
    router = CategoryRouter(llm, top_k=3)

    results: List[TestResult] = []
    start_total = time.perf_counter()

    for i, (query, expected_category, description) in enumerate(TEST_QUERIES, 1):
        print(f"[{i:3d}/{len(TEST_QUERIES)}] {query[:50]:<50}", end=" ")

        start = time.perf_counter()
        try:
            predicted = router.route(query)
        except Exception as e:
            print(f"ERROR: {e}")
            predicted = []
        latency = (time.perf_counter() - start) * 1000

        is_correct = expected_category in predicted
        results.append(TestResult(query, expected_category, description, predicted, is_correct, latency))

        status = "OK" if is_correct else "FAIL"
        print(f"[{status}] {expected_category:12} -> {str(predicted)[:40]} ({latency:.0f}ms)")

    print(f"\nОбщее время: {time.perf_counter() - start_total:.1f}s")
    return results


def print_summary(results: List[TestResult]):
    print("\n" + "=" * 100)
    print("ИТОГИ")
    print("=" * 100)

    correct = sum(1 for r in results if r.is_correct)
    total = len(results)
    accuracy = correct / total * 100

    print(f"\nОбщая точность: {correct}/{total} ({accuracy:.1f}%)")
    print(f"Средняя латентность: {sum(r.latency_ms for r in results) / len(results):.0f}ms")

    print("\nТочность по категориям:")
    print("-" * 60)

    categories = {}
    for r in results:
        cat = r.expected_category
        if cat not in categories:
            categories[cat] = {"correct": 0, "total": 0}
        categories[cat]["total"] += 1
        if r.is_correct:
            categories[cat]["correct"] += 1

    for cat, stats in sorted(categories.items(), key=lambda x: -x[1]["total"]):
        cat_accuracy = stats["correct"] / stats["total"] * 100
        bar = "█" * int(cat_accuracy / 10) + "░" * (10 - int(cat_accuracy / 10))
        status = "OK" if cat_accuracy >= 80 else "LOW"
        print(f"  {cat:12s}: {stats['correct']:2d}/{stats['total']:2d} ({cat_accuracy:5.1f}%) {bar} [{status}]")

    failures = [r for r in results if not r.is_correct]
    if failures:
        print(f"\n{'=' * 100}")
        print(f"ОШИБКИ ({len(failures)}):")
        print("-" * 100)
        for i, r in enumerate(failures[:20], 1):  # Показываем первые 20
            print(f"{i:2d}. {r.query[:60]}")
            print(f"    Ожидал: {r.expected_category} | Получил: {r.predicted_categories}")
        if len(failures) > 20:
            print(f"    ... и ещё {len(failures) - 20} ошибок")

    # Статистика по типам запросов
    typo_results = [r for r in results if "опечатка" in r.description]
    kazakh_results = [r for r in results if "казахский" in r.description]

    print(f"\nЗапросы с опечатками: {sum(1 for r in typo_results if r.is_correct)}/{len(typo_results)}")
    print(f"Запросы на казахском: {sum(1 for r in kazakh_results if r.is_correct)}/{len(kazakh_results)}")


def main():
    print("=" * 100)
    print("E2E ТЕСТ ТОЧНОСТИ CategoryRouter (400 запросов)")
    print("=" * 100)

    results = run_tests()
    print_summary(results)

    accuracy = sum(1 for r in results if r.is_correct) / len(results) * 100
    print(f"\nРезультат: {'PASSED' if accuracy >= 80 else 'FAILED'} ({accuracy:.1f}%)")
    sys.exit(0 if accuracy >= 80 else 1)


if __name__ == "__main__":
    main()
