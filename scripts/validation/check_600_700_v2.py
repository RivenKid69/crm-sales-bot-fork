#!/usr/bin/env python3
"""Тест retrieval для секций 600-700 - v2 с новыми клиентскими запросами"""
import sys
sys.path.insert(0, 'src')
from knowledge.retriever import CascadeRetriever

retriever = CascadeRetriever(use_embeddings=False)

TEST_CASES = [
    # === SUPPORT (9 секций) ===
    {'topic': 'support_quick_connect_601', 'queries': [
        'сколько дней надо ждать подключения?',
        'быстро ли вы всё настроите?',
        'хочу подключиться побыстрее, реально?'
    ]},
    {'topic': 'support_send_to_manager_603', 'queries': [
        'позовите менеджера пожалуйста',
        'мне нужен живой человек для разговора',
        'можете перезвонить мне?'
    ]},
    {'topic': 'support_training_626', 'queries': [
        'научите пользоваться кассой?',
        'мои сотрудники не умеют, обучите?',
        'есть видео как работать в программе?'
    ]},
    {'topic': 'support_broken_equipment_629', 'queries': [
        'касса сломалась что делать??',
        'у меня сдох моноблок',
        'оборудование перестало работать'
    ]},
    {'topic': 'support_phone_call_635', 'queries': [
        'можно с вами созвониться?',
        'дайте номер телефона поддержки',
        'хочу поговорить а не переписываться'
    ]},
    {'topic': 'support_first_store_636', 'queries': [
        'только планирую открыть магазин, посоветуете?',
        'я новичок в бизнесе совсем',
        'первый раз буду торговать'
    ]},
    {'topic': 'support_ofd_registration_681', 'queries': [
        'поможете подключить кассу к офд?',
        'где регистрировать кассу?',
        'фискализация кассы как сделать?'
    ]},
    {'topic': 'support_printer_broken_685', 'queries': [
        'принтер не хочет печатать чеки',
        'перестали выходить чеки из принтера',
        'касса есть а чеки не идут'
    ]},
    {'topic': 'support_start_wipon_694', 'queries': [
        'как начать пользоваться виопон?',
        'что делать после регистрации?',
        'первые шаги в программе какие?'
    ]},

    # === PRODUCTS (17 секций) ===
    {'topic': 'products_wipon_duo_602', 'queries': [
        'что за касса с двумя мониторами?',
        'дуо это касса с экраном для клиента?',
        'моноблок где покупатель видит сумму'
    ]},
    {'topic': 'products_monoblock_accounting_604', 'queries': [
        'на моноблоке можно товары учитывать?',
        'это касса со складом в одном?',
        'учёт и касса в моноблоке есть?'
    ]},
    {'topic': 'products_standard_kit_village_607', 'queries': [
        'у нас село работать будет?',
        'в ауле инет плохой подойдёт?',
        'оборудование для деревни нормальное?'
    ]},
    {'topic': 'products_culinary_608', 'queries': [
        'пеку торты на продажу подойдёт?',
        'для выпечки ваша система норм?',
        'кондитерка маленькая нужна касса'
    ]},
    {'topic': 'products_what_is_wipon_609', 'queries': [
        'випон это вообще что?',
        'объясните простыми словами что за программа',
        'зачем вообще нужен ваш wipon?'
    ]},
    {'topic': 'products_small_store_612', 'queries': [
        'магазинчик маленький у меня',
        'точка небольшая потянет?',
        'мало товаров у меня норм?'
    ]},
    {'topic': 'products_cafe_621', 'queries': [
        'кафешка маленькая подойдёт?',
        'для общепита годится?',
        'столовку открываю нужна касса'
    ]},
    {'topic': 'products_pharmacy_638', 'queries': [
        'аптеку открываю подойдёт?',
        'для лекарств ваша система норм?',
        'аптечный магазин кассу ищу'
    ]},
    {'topic': 'products_retail_chain_651', 'queries': [
        'у меня 5 магазинов подойдёт?',
        'сетка розничная потянете?',
        'много точек в одной системе можно?'
    ]},
    {'topic': 'products_minimarket_655', 'queries': [
        'мини-маркет подключить можно?',
        'маленький продуктовый магазин',
        'небольшой магазин продуктов'
    ]},
    {'topic': 'products_construction_661', 'queries': [
        'строймаг подойдёт?',
        'стройматериалы продаю',
        'магазин строительный нужна система'
    ]},
    {'topic': 'products_cosmetics_664', 'queries': [
        'магазин косметики подойдёт?',
        'бьюти шоп открываю',
        'парфюмерию продаю подойдёт?'
    ]},
    {'topic': 'products_pharmacy_chain_676', 'queries': [
        'сетка аптек подойдёт?',
        'несколько аптек объединить в одну систему',
        'три аптеки хочу вести вместе'
    ]},
    {'topic': 'products_autoparts_680', 'queries': [
        'магаз автозапчастей потянет?',
        'запчасти для авто продаю',
        'автомагазин открываю'
    ]},
    {'topic': 'products_electronics_684', 'queries': [
        'магазин техники подойдёт?',
        'электроника телефоны продаю',
        'бытовую технику продаём'
    ]},
    {'topic': 'products_flowers_689', 'queries': [
        'цветочный магазин подойдёт?',
        'флористика у меня',
        'цветы продаю нужна касса'
    ]},
    {'topic': 'products_kids_store_692', 'queries': [
        'детский магазин подойдёт?',
        'игрушки продаю кассу ищу',
        'детские вещи магазин'
    ]},

    # === PRICING (8 секций) ===
    {'topic': 'pricing_standard_kit_606', 'queries': [
        'стандартный набор почём?',
        'комплект стандарт сколько денег?',
        'цена стандартного оборудования'
    ]},
    {'topic': 'pricing_minimal_tariff_610', 'queries': [
        'самый дешёвый вариант какой?',
        'минималка сколько стоит?',
        'базовый тариф почём?'
    ]},
    {'topic': 'pricing_starter_kit_614', 'queries': [
        'что купить чтобы начать?',
        'стартовый набор какой взять?',
        'для начала что надо?'
    ]},
    {'topic': 'pricing_installment_628', 'queries': [
        'можно в рассрочку взять?',
        'рассрочка через каспи есть?',
        'частями оплатить можно?'
    ]},
    {'topic': 'pricing_pro_tariff_648', 'queries': [
        'про тариф что там есть?',
        'профессиональный пакет расскажите',
        'тариф про сколько и что включено?'
    ]},
    {'topic': 'pricing_pro_kit_659', 'queries': [
        'комплект про почём?',
        'профессиональный набор цена',
        'кассовый комплект про сколько?'
    ]},
    {'topic': 'pricing_simple_cash_687', 'queries': [
        'недорогую кассу посоветуйте',
        'бюджетный вариант есть?',
        'что-то дешёвенькое для старта'
    ]},
    {'topic': 'pricing_wholesale_retail_691', 'queries': [
        'разные цены для опта можно?',
        'оптовикам отдельный прайс',
        'опт и розница разные цены'
    ]},

    # === FEATURES (13 секций) ===
    {'topic': 'features_system_functions_605', 'queries': [
        'что вообще умеет виопон?',
        'какие фишки есть в программе?',
        'перечислите возможности'
    ]},
    {'topic': 'features_accounting_without_cash_617', 'queries': [
        'склад вести без кассы можно?',
        'только товары учитывать хочу',
        'нужен учёт а касса не нужна'
    ]},
    {'topic': 'features_documents_623', 'queries': [
        'документы какие можно делать?',
        'снт и эсф выписывает?',
        'накладные формирует?'
    ]},
    {'topic': 'features_multi_locations_639', 'queries': [
        'несколько магазинов объединить можно?',
        'три точки в одной системе',
        'для сети магазинов подойдёт?'
    ]},
    {'topic': 'features_currencies_647', 'queries': [
        'в долларах можно работать?',
        'разные валюты поддерживает?',
        'евро рубли доллары'
    ]},
    {'topic': 'features_languages_656', 'queries': [
        'на казахском есть интерфейс?',
        'казақша бар ма?',
        'языки какие поддерживаете?'
    ]},
    {'topic': 'features_product_limit_658', 'queries': [
        'товаров много можно добавить?',
        'ограничение по позициям есть?',
        'хватит на 10000 товаров?'
    ]},
    {'topic': 'features_web_version_662', 'queries': [
        'в браузере работает?',
        'веб версия без установки',
        'через интернет можно зайти?'
    ]},
    {'topic': 'features_wholesale_clients_666', 'queries': [
        'оптом продаю подойдёт?',
        'оптовая торговля поддерживается?',
        'для оптовиков годится?'
    ]},
    {'topic': 'features_alcohol_excise_670', 'queries': [
        'алкоголь продаю можно?',
        'спиртное через вас продавать',
        'акцизки проверяет?'
    ]},
    {'topic': 'features_multiple_business_686', 'queries': [
        'два ип можно в одном?',
        'разные бизнесы вести',
        'несколько компаний одна программа'
    ]},
    {'topic': 'features_cloud_work_690', 'queries': [
        'в облаке данные хранятся?',
        'это облачный сервис?',
        'данные где лежат?'
    ]},
    {'topic': 'features_second_location_696', 'queries': [
        'вторую точку добавить как?',
        'открываю новый магазин',
        'расширяюсь на новую точку'
    ]},

    # === INTEGRATIONS (7 секций) ===
    {'topic': 'integrations_bank_terminal_611', 'queries': [
        'терминал банка подключается?',
        'эквайринг работает?',
        'карты принимать через терминал'
    ]},
    {'topic': 'integrations_marking_618', 'queries': [
        'маркировка поддерживается?',
        'с исмет работает?',
        'маркированные товары продавать'
    ]},
    {'topic': 'integrations_online_store_631', 'queries': [
        'каспи магазин подключить',
        'интернет магазин синхронизировать',
        'онлайн заказы принимать'
    ]},
    {'topic': 'integrations_supported_banks_640', 'queries': [
        'какие банки поддерживаете?',
        'форте халык работает?',
        'терминал какого банка подключить'
    ]},
    {'topic': 'integrations_cashless_657', 'queries': [
        'безнал принимать можно?',
        'карточкой оплатить у вас',
        'картой платить через кассу'
    ]},
    {'topic': 'integrations_esf_668', 'queries': [
        'эсф выписывать можно?',
        'электронные счета-фактуры',
        'счёт-фактуру выставить'
    ]},
    {'topic': 'integrations_multiple_terminals_674', 'queries': [
        'два терминала на кассу можно?',
        'несколько терминалов подключить',
        'много pos терминалов'
    ]},

    # === ANALYTICS (5 секций) ===
    {'topic': 'analytics_reports_613', 'queries': [
        'какие отчёты есть?',
        'аналитику продаж посмотреть',
        'статистику где смотреть?'
    ]},
    {'topic': 'analytics_receivables_649', 'queries': [
        'кто должен мне видно?',
        'дебиторка где смотреть?',
        'учёт долгов клиентов'
    ]},
    {'topic': 'analytics_monthly_profit_653', 'queries': [
        'прибыль за месяц где?',
        'заработок посмотреть хочу',
        'доход мой какой?'
    ]},
    {'topic': 'analytics_expenses_663', 'queries': [
        'расходы учитывать можно?',
        'траты магазина где вводить?',
        'затраты фиксировать'
    ]},
    {'topic': 'analytics_holiday_sales_693', 'queries': [
        'продажи сравнить за периоды',
        'сезонность посмотреть',
        'праздники как влияют на продажи'
    ]},

    # === TIS (4 секции) ===
    {'topic': 'tis_connection_615', 'queries': [
        'тис как подключить?',
        'трёхкомпонентку настроить',
        'подключение к тис сколько времени?'
    ]},
    {'topic': 'tis_cost_622', 'queries': [
        'тис сколько стоит в год?',
        'цена трёхкомпонентки',
        'тариф на тис какой?'
    ]},
    {'topic': 'tis_two_years_643', 'queries': [
        'на 2 года сразу оплатить тис',
        'скидка если за несколько лет?',
        'тис оплата за два года'
    ]},
    {'topic': 'tis_retail_tax_646', 'queries': [
        'розничный налог это что?',
        'снр розничного что это?',
        'на розничный перейти'
    ]},

    # === EMPLOYEES (7 секций) ===
    {'topic': 'employees_hr_accounting_619', 'queries': [
        'сотрудников учитывать можно?',
        'персонал вести в программе',
        'кадровый учёт есть?'
    ]},
    {'topic': 'employees_count_634', 'queries': [
        'работников сколько добавить?',
        'лимит на кассиров есть?',
        'много сотрудников потянет?'
    ]},
    {'topic': 'employees_profit_by_staff_669', 'queries': [
        'продажи по сотруднику посмотреть',
        'кто больше продал?',
        'отчёт по продавцам'
    ]},
    {'topic': 'employees_access_limit_671', 'queries': [
        'кассиру всё показывать не хочу',
        'права ограничить сотруднику',
        'закрыть доступ к отчётам'
    ]},
    {'topic': 'employees_access_restrict_677', 'queries': [
        'скрыть прибыль от кассира',
        'чтобы продавец не видел доход',
        'ограничить информацию для работников'
    ]},
    {'topic': 'employees_multiple_users_688', 'queries': [
        'разные логины для сотрудников',
        'каждому свой вход',
        'несколько пользователей'
    ]},
    {'topic': 'employees_cashier_control_697', 'queries': [
        'проверить что делал кассир',
        'контроль продавца',
        'действия сотрудника посмотреть'
    ]},

    # === INVENTORY (7 секций) ===
    {'topic': 'inventory_suppliers_620', 'queries': [
        'поставщиков учитывать можно?',
        'контрагенты где ведутся?',
        'база поставщиков есть?'
    ]},
    {'topic': 'inventory_stock_control_627', 'queries': [
        'когда товар кончается уведомляет?',
        'остатки мало предупредит?',
        'сигнал когда товар заканчивается'
    ]},
    {'topic': 'inventory_multiple_warehouses_637', 'queries': [
        'много складов в системе',
        'несколько складов вести',
        'перемещать между складами'
    ]},
    {'topic': 'inventory_returns_660', 'queries': [
        'возврат товара как оформить?',
        'клиент вернул товар',
        'обратная продажа как?'
    ]},
    {'topic': 'inventory_import_products_667', 'queries': [
        'из экселя товары загрузить',
        'импорт позиций сразу много',
        'добавить товары списком'
    ]},
    {'topic': 'inventory_revision_673', 'queries': [
        'инвентаризацию как провести?',
        'ревизию сделать',
        'пересчёт товара в программе'
    ]},
    {'topic': 'inventory_upload_catalog_678', 'queries': [
        'каталог целиком загрузить',
        'импортировать базу товаров',
        'с другой программы перенести товары'
    ]},

    # === MOBILE (3 секции) ===
    {'topic': 'mobile_work_phone_624', 'queries': [
        'с телефона можно управлять?',
        'на смартфоне работает?',
        'мобильное приложение есть?'
    ]},
    {'topic': 'mobile_remote_control_641', 'queries': [
        'издалека магазин контролировать',
        'из дома за продажами следить',
        'не в магазине видеть что происходит'
    ]},
    {'topic': 'mobile_tablet_672', 'queries': [
        'на планшете запустить можно?',
        'андроид планшет подойдёт?',
        'таблет как касса'
    ]},

    # === FISCAL (5 секций) ===
    {'topic': 'fiscal_ofd_charge_625', 'queries': [
        'офд помесячно сколько?',
        'за офд платить сколько?',
        'стоимость офд в месяц'
    ]},
    {'topic': 'fiscal_tax_reporting_633', 'queries': [
        'форму 910 программа делает?',
        'налоговые отчёты автоматом?',
        'для налоговой что формирует?'
    ]},
    {'topic': 'fiscal_terminal_only_644', 'queries': [
        'терминал без кассы использовать',
        'только пос терминал можно?',
        'без онлайн кассы работать'
    ]},
    {'topic': 'fiscal_tax_reports_682', 'queries': [
        'какие формы для налоговой?',
        '910 913 200 делает?',
        'налоговая отчётность автоматически'
    ]},
    {'topic': 'fiscal_tax_audit_699', 'queries': [
        'при проверке всё покажет?',
        'налоговая придёт данные готовы?',
        'для инспекции всё есть?'
    ]},

    # === STABILITY (4 секции) ===
    {'topic': 'stability_internet_needed_616', 'queries': [
        'интернет обязательно нужен?',
        'без инета работает?',
        'инет пропал что будет?'
    ]},
    {'topic': 'stability_village_work_632', 'queries': [
        'в ауле работает?',
        'в селе пойдёт?',
        'сельская местность подходит?'
    ]},
    {'topic': 'stability_no_internet_675', 'queries': [
        'интернет отрубился что делать?',
        'связь пропала продолжит работать?',
        'без сети касса работает?'
    ]},
    {'topic': 'stability_weak_internet_695', 'queries': [
        'плохой интернет подойдёт?',
        'слабый инет норм?',
        'связь нестабильная справится?'
    ]},

    # === REGIONS (1 секция) ===
    {'topic': 'regions_new_branch_630', 'queries': [
        'в другом городе филиал открыть',
        'точка в караганде добавить',
        'расширяюсь в другой город'
    ]},

    # === PROMOTIONS (3 секции) ===
    {'topic': 'promotions_loyalty_642', 'queries': [
        'бонусы клиентам начислять',
        'лояльность покупателей программа',
        'кешбэк для постоянных'
    ]},
    {'topic': 'promotions_discounts_652', 'queries': [
        'скидки настроить как?',
        'акции запустить',
        'распродажу сделать'
    ]},
    {'topic': 'promotions_bonuses_698', 'queries': [
        'бонусы копятся у клиентов?',
        'накопительная система',
        'постоянным покупателям бонусы'
    ]},
]

def run_tests():
    failures = []
    success = 0
    total = 0

    for tc in TEST_CASES:
        for q in tc['queries']:
            total += 1
            results = retriever.search(q, top_k=3)
            got = results[0].section.topic if results else 'NO RESULTS'
            if got == tc['topic']:
                success += 1
            else:
                top3_topics = [r.section.topic for r in results[:3]] if results else []
                if tc['topic'] in top3_topics:
                    pos = top3_topics.index(tc['topic']) + 1
                    failures.append((tc['topic'], q, got, f"in top3 at #{pos}"))
                else:
                    failures.append((tc['topic'], q, got, "NOT in top3"))

    accuracy = success / total * 100
    print(f'Accuracy: {success}/{total} = {accuracy:.1f}%')
    print(f'Failures (not #1): {len(failures)}')
    print()

    # Группируем ошибки по топикам
    by_topic = {}
    for expected, query, got, note in failures:
        if expected not in by_topic:
            by_topic[expected] = []
        by_topic[expected].append((query, got, note))

    for topic, errs in sorted(by_topic.items()):
        print(f'=== {topic} ===')
        for query, got, note in errs:
            print(f'  Query: {query}')
            print(f'  Got: {got} ({note})')
            print()

    return accuracy, failures

if __name__ == '__main__':
    accuracy, failures = run_tests()
