#!/usr/bin/env python3
import sys
sys.path.insert(0, 'src')
from src.knowledge.retriever import CascadeRetriever

retriever = CascadeRetriever(use_embeddings=False)

TEST_CASES = [
    {'topic': 'products_alcohol_wipon_pro_451', 'queries': ['Я торгую алкоголем, подходит ваша система?', 'Есть ли у вас модуль для акцизной продукции?', 'Нужна программа для продажи спиртного']},
    {'topic': 'products_few_items_458', 'queries': ['У меня всего 20 товаров, подойдёт программа?', 'Мало товаров в магазине, нужна ли мне ваша система?', 'Ограничение по количеству товаров есть?']},
    {'topic': 'products_wipon_kassa_definition_460', 'queries': ['Что такое Wipon Kassa?', 'Расскажите про вашу кассу Wipon', 'Wipon касса что это за продукт?']},
    {'topic': 'products_quick_connection_462', 'queries': ['Сколько времени занимает подключение кассы?', 'Как быстро можно начать работать после регистрации?', 'Долго настраивается ваша касса?']},
    {'topic': 'products_multiple_stores_466', 'queries': ['У меня несколько торговых точек, подойдёт?', 'Можно управлять сетью магазинов из одного аккаунта?', 'Wipon Kassa для сети точек подходит?']},
    {'topic': 'products_wipon_ofd_469', 'queries': ['Что такое Wipon ОФД?', 'Как работает ваш оператор фискальных данных?', 'Есть личный кабинет ОФД?']},
    {'topic': 'products_small_business_kassa_470', 'queries': ['Подходит ли Wipon Kassa для малого бизнеса?', 'Ваша касса простая для небольшого магазина?', 'Нужна доступная касса без больших вложений']},
    {'topic': 'products_wipon_small_business_490', 'queries': ['Подойдёт ли WIPON для малого бизнеса?', 'Система охватывает основные процессы от продажи до прибыли?', 'Простая система для небольшого бизнеса нужна']},
    {'topic': 'inventory_suppliers_contacts_452', 'queries': ['Можно хранить контакты поставщиков в системе?', 'У меня несколько поставщиков, есть база контрагентов?', 'Где вести историю закупок по поставщикам?']},
    {'topic': 'inventory_warehouse_benefits_471', 'queries': ['Что даёт складской учёт в WIPON?', 'Зачем нужен учёт товаров от поступления до продажи?', 'Как узнать что в наличии и где товар?']},
    {'topic': 'inventory_multiple_warehouses_472', 'queries': ['Подходит ли WIPON для нескольких складов?', 'Можно работать с несколькими складами одновременно?', 'Синхронизация складов и торговых точек есть?']},
    {'topic': 'inventory_view_stock_473', 'queries': ['Как посмотреть остатки товаров в системе?', 'Где в карточке товара видно количество?', 'Остатки обновляются автоматически при продаже?']},
    {'topic': 'inventory_stocktaking_474', 'queries': ['Можно делать инвентаризацию в WIPON?', 'Как сверить фактические остатки с учётными?', 'Система помогает избежать недостач?']},
    {'topic': 'inventory_documents_475', 'queries': ['Какие документы можно оформлять в WIPON?', 'Есть поступления, списания и возвраты?', 'Перемещения между складами оформляются?']},
    {'topic': 'inventory_add_products_476', 'queries': ['Как добавлять новые товары в систему?', 'Можно создать карточку товара с характеристиками?', 'Легко редактировать товары?']},
    {'topic': 'inventory_warehouse_analytics_477', 'queries': ['Есть ли аналитика по складу?', 'Какие отчёты по остаткам формируются?', 'Где увидеть недостачи и оборот склада?']},
    {'topic': 'inventory_beginner_480', 'queries': ['Подойдёт если раньше не вёл складской учёт?', 'Программа для новичка в учёте подойдёт?', 'Простой интерфейс для начинающего?']},
    {'topic': 'inventory_procurement_purpose_491', 'queries': ['Для чего нужен учёт закупок в WIPON?', 'Как фиксировать поступления товаров?', 'Контроль закупок без ручного ввода возможен?']},
    {'topic': 'inventory_create_purchase_492', 'queries': ['Как оформить закупку в системе?', 'Создать приходную накладную как?', 'Указать поставщика и способ оплаты при закупке?']},
    {'topic': 'inventory_auto_stock_update_493', 'queries': ['Обновляются ли остатки после закупки?', 'Поступление автоматически отражается на складе?', 'Остатки обновляются автоматически?']},
    {'topic': 'inventory_purchase_history_494', 'queries': ['Можно видеть историю закупок?', 'Какие товары закупались и у кого?', 'Посмотреть историю поставок возможно?']},
    {'topic': 'inventory_supplier_comparison_495', 'queries': ['Как система помогает выбирать поставщиков?', 'Можно сравнить поставщиков по условиям?', 'Кто из поставщиков самый выгодный?']},
    {'topic': 'inventory_low_stock_alert_496', 'queries': ['Предупредит ли система если товар заканчивается?', 'Есть уведомление о дефиците?', 'Напоминание заказать товар при низких остатках?']},
    {'topic': 'inventory_supplier_payments_497', 'queries': ['Можно учитывать оплату поставщикам?', 'Есть учёт задолженности поставщику?', 'Отчёты по расчётам с поставщиками?']},
    {'topic': 'inventory_procurement_analytics_498', 'queries': ['Есть ли аналитика по закупкам?', 'Сумма закупок и оборачиваемость товаров?', 'Оптимизация закупочной стратегии?']},
    {'topic': 'inventory_supplier_returns_499', 'queries': ['Можно оформить возврат поставщику?', 'Документ возврата товара поставщику?', 'Вернуть товар поставщику через систему?']},
    {'topic': 'inventory_cost_savings_500', 'queries': ['Как учёт закупок помогает экономить?', 'Система выявляет неэффективные закупки?', 'Контроль цен и снижение затрат?']},
    {'topic': 'analytics_sales_view_456', 'queries': ['Можно смотреть аналитику по продажам?', 'Выручка по дням и месяцам отображается?', 'Динамика продаж и показатели есть?']},
    {'topic': 'analytics_sales_module_481', 'queries': ['Для чего нужен модуль учёта продаж?', 'Как фиксируются продажи и контролируется выручка?', 'Анализ эффективности бизнеса через продажи?']},
    {'topic': 'analytics_sales_recording_482', 'queries': ['Как в системе фиксируются продажи?', 'Продажа, возврат и скидка автоматически сохраняются?', 'Каждая операция записывается в системе?']},
    {'topic': 'analytics_realtime_484', 'queries': ['Есть аналитика в реальном времени?', 'По чекам и продавцам аналитика?', 'Статистика по кассам и товарам онлайн?']},
    {'topic': 'analytics_sales_benefits_486', 'queries': ['Какие преимущества даёт учёт продаж?', 'Прозрачность и контроль операций есть?', 'Интеграция учёта продаж со складом и закупками?']},
    {'topic': 'analytics_sales_drop_alert_488', 'queries': ['Получу уведомления о снижении продаж?', 'Система показывает падение продаж?', 'Мониторинг продаж и позиции которые упали?']},
    {'topic': 'fiscal_documents_457', 'queries': ['Документы тоже через Wipon можно вести?', 'ЭСФ и СНТ оформляются в системе?', 'Электронные накладные прямо в программе?']},
    {'topic': 'fiscal_return_process_463', 'queries': ['Как работает возврат товара в Wipon Kassa?', 'Оформить возврат и чек возврата?', 'Модуль возврата по требованиям ОФД?']},
    {'topic': 'fiscal_receipt_history_464', 'queries': ['Где посмотреть все пробитые чеки?', 'История чеков с датой и суммой?', 'Вкладка история с фискальным признаком?']},
    {'topic': 'fiscal_send_receipt_465', 'queries': ['Можно отправить чек клиенту онлайн?', 'Чек в WhatsApp или на email?', 'Электронный чек клиенту отправить?']},
    {'topic': 'fiscal_branded_receipt_468', 'queries': ['Можно брендировать чек?', 'Добавить рекламный текст на чек?', 'Свой дизайн и логотип на чеке?']},
    {'topic': 'tis_ip_taxes_454', 'queries': ['Какие налоги платить ИП на упрощёнке?', '3 процента или 1 процент от дохода?', 'Социальные отчисления для ИП рассчитывает?']},
    {'topic': 'tis_form_910_submit_455', 'queries': ['Как сдавать форму 910 через Wipon?', 'Заполнение и отправка 910 автоматически?', '910 через личный кабинет КГД с ЭЦП?']},
    {'topic': 'mobile_kassa_devices_459', 'queries': ['Могу работать с Wipon Kassa с телефона?', 'Касса работает через веб и мобильное приложение?', 'Синхронизация между телефоном и компьютером?']},
    {'topic': 'mobile_warehouse_478', 'queries': ['Могу вести складской учёт с телефона?', 'Мобильное приложение для склада?', 'Приёмка и остатки с телефона?']},
    {'topic': 'features_quick_receipt_453', 'queries': ['Можно пробить чек быстро без выбора товара?', 'Режим быстрого чека без детализации?', 'Просто пробить сумму без товаров?']},
    {'topic': 'features_add_product_sale_467', 'queries': ['Можно добавить товар прямо в момент продажи?', 'Товара нет в базе, создать на кассе?', 'Новый товар при продаже на лету?']},
    {'topic': 'employees_cashier_workflow_483', 'queries': ['Как организована работа кассиров?', 'У каждого кассира свой логин?', 'Действия кассира записываются под его аккаунтом?']},
    {'topic': 'employees_efficiency_487', 'queries': ['Можно анализировать эффективность сотрудников?', 'Продажи и средний чек по кассиру?', 'Фиксируются ошибки и отмены кассиров?']},
    {'topic': 'equipment_wipon_kassa_461', 'queries': ['Какое оборудование нужно для Wipon Kassa?', 'Можно работать с любого устройства?', 'Сканеры и принтеры подключаются?']},
    {'topic': 'promotions_discounts_wipon_485', 'queries': ['Есть поддержка скидок и акций в WIPON?', 'Можно задавать скидки для групп товаров?', 'Акции по времени и по торговым точкам?']},
    {'topic': 'integrations_modules_489', 'queries': ['Интегрируется ли учёт продаж с другими модулями?', 'Склад, финансы и закупки работают вместе?', 'Единая картина бизнеса из всех модулей?']},
    {'topic': 'security_data_protection_479', 'queries': ['Как защищены мои данные в WIPON?', 'Данные в защищённом облаке хранятся?', 'Резервное копирование и конфиденциальность?']},
]

failures = []
for tc in TEST_CASES:
    for q in tc['queries']:
        results = retriever.search(q, top_k=1)
        got = results[0].section.topic if results else 'NO RESULTS'
        if got != tc['topic']:
            failures.append((tc['topic'], q, got))

print(f'Total failures: {len(failures)}/150')
print()
for expected, query, got in failures:
    print(f'{expected}')
    print(f'  Q: {query}')
    print(f'  Got: {got}')
    print()
