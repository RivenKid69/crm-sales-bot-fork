#!/usr/bin/env python3
"""
Тест v3: Новые разнообразные запросы для секций 551-600.
По 3 уникальных запроса на каждую секцию.
"""

import sys
sys.path.insert(0, 'src')

from src.knowledge.retriever import CascadeRetriever

# Инициализация retriever без эмбеддингов (только keywords)
retriever = CascadeRetriever(use_embeddings=False)

# Новые тестовые запросы v3 (отличаются от v1 и v2)
TEST_CASES = {
    # equipment.yaml (551-557, 600)
    'equipment_label_printing_551': [
        'Где распечатать ценник на товар?',
        'Хочу наклейки на продукцию сделать',
        'Этикетирование товаров в системе',
    ],
    'equipment_label_content_552': [
        'Какие данные печатаются на ценнике?',
        'Что показывает наклейка на товаре?',
        'Информация на ярлыке товара',
    ],
    'equipment_label_format_553': [
        'Какого размера печатаются ценники?',
        'Можно изменить вид этикетки?',
        'Настройка формата ценника',
    ],
    'equipment_label_printers_554': [
        'Какое оборудование нужно для ценников?',
        'Принтер для печати ярлыков',
        'Совместимость с принтером этикеток',
    ],
    'equipment_label_bulk_555': [
        'Печать ценников на всю партию',
        'Массовая печать ярлыков',
        'Много наклеек за один раз',
    ],
    'equipment_label_preview_556': [
        'Можно посмотреть ценник до печати?',
        'Предварительный вид этикетки',
        'Превью ярлыка перед печатью',
    ],
    'equipment_label_convenience_557': [
        'Преимущества системы этикетирования',
        'Почему удобно печатать ценники здесь?',
        'Плюсы автоматических этикеток',
    ],
    'equipment_scales_spices_600': [
        'Весы для продажи чая и кофе на развес',
        'Оборудование для взвешивания сыпучих',
        'Точные весы для мелких товаров',
    ],

    # inventory.yaml (558-564)
    'inventory_supplier_database_558': [
        'Как сохранить контакты поставщика?',
        'База контрагентов в системе',
        'Реквизиты поставщиков где хранятся?',
    ],
    'inventory_supplier_select_559': [
        'Автоподстановка данных поставщика',
        'Выбор контрагента при закупке',
        'Поставщик подтягивается автоматически',
    ],
    'inventory_supplier_return_560': [
        'Возврат брака поставщику оформить',
        'Документ на возврат закупки',
        'Отправить товар обратно поставщику',
    ],
    'inventory_supplier_payment_561': [
        'Сколько должны поставщику?',
        'Контроль долгов по закупкам',
        'Неоплаченные поставки где видно?',
    ],
    'inventory_supplier_history_562': [
        'История закупок по контрагенту',
        'Что покупали у этого поставщика?',
        'Журнал операций с поставщиком',
    ],
    'inventory_supplier_export_563': [
        'Скачать таблицу закупок',
        'Экспорт базы контрагентов',
        'Выгрузка данных поставщиков',
    ],
    'inventory_supplier_benefits_564': [
        'Зачем вести учёт контрагентов?',
        'Польза от базы поставщиков',
        'Чем помогает учёт закупок?',
    ],

    # mobile.yaml (565-572)
    'mobile_app_exists_565': [
        'Wipon работает на смартфоне?',
        'Есть версия для Android/iOS?',
        'Мобильная версия программы',
    ],
    'mobile_app_features_566': [
        'Функционал мобильного приложения',
        'Что доступно в приложении на телефоне?',
        'Возможности мобильной версии',
    ],
    'mobile_app_prices_567': [
        'Разные цены в разных магазинах через телефон',
        'Прайсы по точкам в приложении',
        'Ценообразование в мобильном',
    ],
    'mobile_app_for_ip_568': [
        'Приложение для индивидуального предпринимателя',
        'Подойдёт для розничного магазина?',
        'Мобильное решение для ИП',
    ],
    'mobile_app_contractors_569': [
        'Контрагенты в мобильном приложении',
        'Работа с клиентами через телефон',
        'База покупателей в приложении',
    ],
    'mobile_app_analytics_570': [
        'Отчёты в мобильном приложении',
        'Статистика продаж на смартфоне',
        'Аналитика через телефон',
    ],
    'mobile_app_history_571': [
        'Журнал продаж в приложении',
        'История чеков на телефоне',
        'Операции в мобильном за период',
    ],
    'mobile_app_convenience_572': [
        'Почему удобно управлять через телефон?',
        'Плюсы мобильного управления',
        'Преимущества приложения Wipon',
    ],

    # features.yaml (573-579)
    'features_pricelists_what_573': [
        'Что такое система прайсов?',
        'Функция ценовых категорий',
        'Несколько прайсов на товар',
    ],
    'features_pricelists_select_574': [
        'Как переключать прайсы на кассе?',
        'Смена ценовой категории при продаже',
        'Применить другой прайс',
    ],
    'features_pricelists_purpose_575': [
        'Прайсы для оптовых покупателей',
        'Разные цены для опта и розницы',
        'Ценовые категории зачем?',
    ],
    'features_pricelists_settings_576': [
        'Настройка ценовых категорий',
        'Как создать новый прайс?',
        'Привязка прайса к клиенту',
    ],
    'features_pricelists_tariffs_577': [
        'Сколько прайсов в тарифе Pro?',
        'Ограничения по прайсам в Standart',
        'Лимит ценовых категорий',
    ],
    'features_pricelists_location_578': [
        'Где в меню настроить прайсы?',
        'Раздел с ценовыми категориями',
        'Настройки прайслистов где?',
    ],
    'features_pricelists_promo_579': [
        'Скидочные цены быстро применить',
        'Прайс для акции',
        'Распродажа через ценовую категорию',
    ],

    # support.yaml (580-587, 598)
    'support_wipon_consulting_580': [
        'Аутсорсинг бухгалтерии Wipon',
        'Бухгалтерские услуги от Wipon',
        'Consulting что за сервис?',
    ],
    'support_consulting_services_581': [
        'Какие бухгалтерские услуги оказываете?',
        'Что входит в бухгалтерское обслуживание?',
        'Перечень услуг Consulting',
    ],
    'support_consulting_910_582': [
        'Сдача налоговой декларации',
        'Помощь с формой 910',
        'Отчётность в налоговую за меня',
    ],
    'support_consulting_esf_snt_583': [
        'Помощь с электронными накладными',
        'Формирование ЭСФ',
        'СНТ кто оформляет?',
    ],
    'support_consulting_for_whom_584': [
        'Бухгалтерия для ТОО с сотрудниками',
        'Подходит для интернет-магазина?',
        'Кому нужен Consulting?',
    ],
    'support_consulting_benefits_585': [
        'Чем хорош аутсорсинг бухгалтерии?',
        'Преимущества Consulting',
        'Плюсы бухгалтерии на аутсорсе',
    ],
    'support_consulting_no_accountant_586': [
        'Можно работать без своего бухгалтера?',
        'Заменяет штатного бухгалтера?',
        'Не нужен бухгалтер в штат',
    ],
    'support_consulting_reports_587': [
        'Какие отчёты получаю от Consulting?',
        'Отчётность от бухгалтерии Wipon',
        'Что буду видеть по финансам?',
    ],
    'support_working_hours_598': [
        'Часы работы офиса Wipon',
        'Когда можно позвонить менеджеру?',
        'До которого часа работаете?',
    ],

    # tis.yaml (588-596)
    'tis_wipon_what_588': [
        'Расшифровка ТИС Wipon',
        'Трёхкомпонентка что это?',
        'ТИС простыми словами',
    ],
    'tis_benefits_589': [
        'Преимущества трёхкомпонентной системы',
        'Что даёт подключение ТИС?',
        'Выгоды от ТИС',
    ],
    'tis_components_590': [
        'Из каких модулей состоит ТИС?',
        'Компоненты трёхкомпонентки',
        'Что объединяет ТИС?',
    ],
    'tis_functions_591': [
        'Возможности ТИС Wipon',
        'Что можно делать через ТИС?',
        'Функционал трёхкомпонентки',
    ],
    'tis_why_connect_592': [
        'Зачем подключать трёхкомпонентку?',
        'Причины выбора ТИС',
        'Для чего нужна ТИС?',
    ],
    'tis_price_593': [
        'Стоимость ТИС в год',
        'Тариф на трёхкомпонентку',
        'Сколько платить за ТИС?',
    ],
    'tis_official_594': [
        'ТИС Wipon в госреестре?',
        'Официальный статус ТИС',
        'Законность трёхкомпонентки',
    ],
    'tis_threshold_duration_595': [
        'До когда действуют льготы ТИС?',
        'Срок действия порогов',
        'Когда закончатся лимиты ТИС?',
    ],
    'tis_to_too_596': [
        'ТИС при открытии ТОО',
        'Переход с ИП на ТОО и ТИС',
        'ТОО может использовать ТИС?',
    ],

    # pricing.yaml (597)
    'pricing_wipon_mini_program_597': [
        'Тариф Mini что в него входит?',
        'Базовый тариф Wipon',
        'Описание программы Mini',
    ],

    # regions.yaml (599)
    'regions_shymkent_branch_599': [
        'Офис Wipon в Шымкенте',
        'Точка продаж в Шымкенте',
        'Адрес представительства Шымкент',
    ],
}

def run_test():
    total = 0
    correct = 0
    failures = []

    for expected_topic, queries in TEST_CASES.items():
        for query in queries:
            total += 1
            results = retriever.search(query, top_k=3)

            if results:
                top_topic = results[0].section.topic
                top3_topics = [r.section.topic for r in results[:3]]

                if top_topic == expected_topic:
                    correct += 1
                elif expected_topic in top3_topics:
                    # В top-3, но не первый
                    position = top3_topics.index(expected_topic) + 1
                    failures.append({
                        'expected': expected_topic,
                        'query': query,
                        'got': top_topic,
                        'in_top3': position
                    })
                else:
                    failures.append({
                        'expected': expected_topic,
                        'query': query,
                        'got': top_topic,
                        'in_top3': None
                    })
            else:
                failures.append({
                    'expected': expected_topic,
                    'query': query,
                    'got': 'NO RESULTS',
                    'in_top3': None
                })

    accuracy = correct / total * 100
    print(f"Accuracy: {correct}/{total} = {accuracy:.1f}%")
    print(f"Failures: {len(failures)}")

    if failures:
        print()
        for f in failures:
            print(f"Expected: {f['expected']}")
            print(f"  Query: {f['query']}")
            if f['in_top3']:
                print(f"  Got: {f['got']} (in top3 at {f['in_top3']})")
            else:
                print(f"  Got: {f['got']} (NOT in top3)")
            print()

if __name__ == '__main__':
    run_test()
