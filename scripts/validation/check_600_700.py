#!/usr/bin/env python3
"""Тест retrieval для секций 600-700 с разнообразными клиентскими запросами"""
import sys
sys.path.insert(0, 'src')
from src.knowledge.retriever import CascadeRetriever

retriever = CascadeRetriever(use_embeddings=False)

TEST_CASES = [
    # === SUPPORT (9 секций) ===
    {'topic': 'support_quick_connect_601', 'queries': [
        'Как быстро вы подключаете?',
        'За сколько дней настроите систему?',
        'Сроки подключения Wipon?'
    ]},
    {'topic': 'support_send_to_manager_603', 'queries': [
        'Хочу чтобы мне перезвонил менеджер',
        'Как связаться с вашим менеджером?',
        'Оставлю номер для обратного звонка'
    ]},
    {'topic': 'support_training_626', 'queries': [
        'Вы обучаете работе с программой?',
        'Как научиться пользоваться Wipon?',
        'Есть ли обучение для сотрудников?'
    ]},
    {'topic': 'support_broken_equipment_629', 'queries': [
        'Что делать если касса сломалась?',
        'Моноблок перестал работать',
        'Куда обращаться при поломке оборудования?'
    ]},
    {'topic': 'support_phone_call_635', 'queries': [
        'Можно ли позвонить в поддержку?',
        'Есть телефон для консультации?',
        'Хочу поговорить голосом с поддержкой'
    ]},
    {'topic': 'support_first_store_636', 'queries': [
        'Я впервые открываю магазин, поможете?',
        'Начинающий предприниматель, с чего начать?',
        'Никогда не было бизнеса, разберусь ли?'
    ]},
    {'topic': 'support_ofd_registration_681', 'queries': [
        'Поможете настроить ОФД?',
        'Как зарегистрировать кассу в ОФД?',
        'Нужна помощь с подключением к ОФД'
    ]},
    {'topic': 'support_printer_broken_685', 'queries': [
        'Принтер чеков перестал работать',
        'Чеки не печатаются, что делать?',
        'Сломался принтер чеков'
    ]},
    {'topic': 'support_start_wipon_694', 'queries': [
        'С чего начать работу с Wipon?',
        'Как подключиться к вашей системе?',
        'Первые шаги для начала работы'
    ]},

    # === PRODUCTS (17 секций) ===
    {'topic': 'products_wipon_duo_602', 'queries': [
        'Расскажите про моноблок Wipon Duo',
        'Что такое Duo с двумя экранами?',
        'Кассовый аппарат с экраном для покупателя'
    ]},
    {'topic': 'products_monoblock_accounting_604', 'queries': [
        'Моноблок ведёт учёт товаров?',
        'Можно ли на моноблоке вести складской учёт?',
        'Касса с функцией учёта товаров'
    ]},
    {'topic': 'products_standard_kit_village_607', 'queries': [
        'Комплект Стандарт подойдёт для аула?',
        'В деревне будет работать ваше оборудование?',
        'Есть ли офлайн режим для села?'
    ]},
    {'topic': 'products_culinary_608', 'queries': [
        'Подходит ли Wipon для пекарни?',
        'Для кондитерской ваша система подойдёт?',
        'Учёт в кулинарии через Wipon'
    ]},
    {'topic': 'products_what_is_wipon_609', 'queries': [
        'Что вообще такое Wipon?',
        'Для чего нужна программа Wipon?',
        'Wipon это касса или учёт?'
    ]},
    {'topic': 'products_small_store_612', 'queries': [
        'У меня маленький магазинчик, подойдёт?',
        'Wipon для небольшой точки',
        'Система для мини-магазина'
    ]},
    {'topic': 'products_cafe_621', 'queries': [
        'Для кафе Wipon подходит?',
        'Касса для точки общепита',
        'Учёт в столовой через Wipon'
    ]},
    {'topic': 'products_pharmacy_638', 'queries': [
        'Подходит ли Wipon для аптеки?',
        'Касса для аптечного бизнеса',
        'Учёт лекарств в Wipon'
    ]},
    {'topic': 'products_retail_chain_651', 'queries': [
        'У меня сеть магазинов, подойдёт?',
        'Wipon для розничной сети',
        'Централизованное управление несколькими магазинами'
    ]},
    {'topic': 'products_minimarket_655', 'queries': [
        'Wipon подойдёт для минимаркета?',
        'Касса для небольшого продуктового',
        'Программа для мини-маркета'
    ]},
    {'topic': 'products_construction_661', 'queries': [
        'Подойдёт для магазина стройматериалов?',
        'Учёт в строймаге через Wipon',
        'Касса для строительного магазина'
    ]},
    {'topic': 'products_cosmetics_664', 'queries': [
        'Для магазина косметики подходит?',
        'Учёт в бьюти-магазине',
        'Wipon для парфюмерии'
    ]},
    {'topic': 'products_pharmacy_chain_676', 'queries': [
        'Wipon для сети аптек подойдёт?',
        'Несколько аптечных киосков в одной системе',
        'Централизованный учёт в аптечной сети'
    ]},
    {'topic': 'products_autoparts_680', 'queries': [
        'Подходит для магазина автозапчастей?',
        'Учёт запчастей в Wipon',
        'Касса для авто-магазина'
    ]},
    {'topic': 'products_electronics_684', 'queries': [
        'Wipon подходит для магазина техники?',
        'Учёт электроники и гаджетов',
        'Касса для магазина бытовой техники'
    ]},
    {'topic': 'products_flowers_689', 'queries': [
        'Для цветочного магазина подойдёт?',
        'Wipon для флористики',
        'Касса для магазина цветов'
    ]},
    {'topic': 'products_kids_store_692', 'queries': [
        'Подходит для магазина детских товаров?',
        'Учёт игрушек и детской одежды',
        'Wipon для детского магазина'
    ]},

    # === PRICING (8 секций) ===
    {'topic': 'pricing_standard_kit_606', 'queries': [
        'Сколько стоит комплект Стандарт?',
        'Цена набора Standard',
        'Стоимость стандартного комплекта оборудования'
    ]},
    {'topic': 'pricing_minimal_tariff_610', 'queries': [
        'Какой самый дешёвый тариф?',
        'Минимальная цена за месяц?',
        'Начальный тариф сколько стоит?'
    ]},
    {'topic': 'pricing_starter_kit_614', 'queries': [
        'Что нужно купить для начала работы?',
        'Комплект для старта бизнеса',
        'С чего начать по оборудованию?'
    ]},
    {'topic': 'pricing_installment_628', 'queries': [
        'Есть ли рассрочка на оборудование?',
        'Можно купить кассу в рассрочку?',
        'Оплата частями через Kaspi'
    ]},
    {'topic': 'pricing_pro_tariff_648', 'queries': [
        'Что входит в тариф Pro?',
        'Расскажите про профессиональный тариф',
        'Сколько стоит тариф Про?'
    ]},
    {'topic': 'pricing_pro_kit_659', 'queries': [
        'Цена кассового комплекта PRO',
        'Сколько стоит набор Pro?',
        'Полный комплект Pro стоимость'
    ]},
    {'topic': 'pricing_simple_cash_687', 'queries': [
        'Есть ли недорогая касса?',
        'Бюджетное кассовое решение',
        'Простая касса для начинающих'
    ]},
    {'topic': 'pricing_wholesale_retail_691', 'queries': [
        'Можно разные цены для опта и розницы?',
        'Как настроить оптовые и розничные цены?',
        'Отдельный прайс для оптовиков'
    ]},

    # === FEATURES (13 секций) ===
    {'topic': 'features_system_functions_605', 'queries': [
        'Какие функции есть в Wipon?',
        'Что умеет ваша система?',
        'Полный функционал программы'
    ]},
    {'topic': 'features_accounting_without_cash_617', 'queries': [
        'Можно вести только учёт без кассы?',
        'Товарный учёт отдельно от кассы',
        'Использовать только складской учёт'
    ]},
    {'topic': 'features_documents_623', 'queries': [
        'Какие документы можно вести?',
        'ЭСФ и СНТ в программе',
        'Документооборот в Wipon'
    ]},
    {'topic': 'features_multi_locations_639', 'queries': [
        'Можно работать с несколькими точками?',
        'Управление сетью магазинов',
        'У меня несколько магазинов'
    ]},
    {'topic': 'features_currencies_647', 'queries': [
        'Можно работать в долларах?',
        'Поддержка разных валют',
        'Мультивалютный учёт'
    ]},
    {'topic': 'features_languages_656', 'queries': [
        'Есть казахский язык?',
        'На каких языках интерфейс?',
        'Можно переключить на қазақша?'
    ]},
    {'topic': 'features_product_limit_658', 'queries': [
        'Сколько товаров можно добавить?',
        'Есть ограничение по количеству товаров?',
        'Лимит товаров в базе'
    ]},
    {'topic': 'features_web_version_662', 'queries': [
        'Есть веб-версия Wipon?',
        'Можно работать через браузер?',
        'Онлайн версия без установки'
    ]},
    {'topic': 'features_wholesale_clients_666', 'queries': [
        'Можно работать с оптовыми клиентами?',
        'Поддержка оптовой торговли',
        'Wipon для опта'
    ]},
    {'topic': 'features_alcohol_excise_670', 'queries': [
        'Wipon работает с алкоголем?',
        'Проверка акцизных марок',
        'Продажа спиртного через Wipon'
    ]},
    {'topic': 'features_multiple_business_686', 'queries': [
        'Можно вести несколько бизнесов?',
        'Два ИП в одной системе',
        'Разные компании в Wipon'
    ]},
    {'topic': 'features_cloud_work_690', 'queries': [
        'Данные хранятся в облаке?',
        'Это облачная система?',
        'Cloud решение для учёта'
    ]},
    {'topic': 'features_second_location_696', 'queries': [
        'Как добавить вторую точку?',
        'Открываю ещё один магазин',
        'Расширение сети на новую точку'
    ]},

    # === INTEGRATIONS (7 секций) ===
    {'topic': 'integrations_bank_terminal_611', 'queries': [
        'Как подключить банковский терминал?',
        'POS терминал работает с Wipon?',
        'Интеграция с эквайрингом'
    ]},
    {'topic': 'integrations_marking_618', 'queries': [
        'Wipon работает с маркировкой?',
        'Интеграция с ISMET',
        'Обязательная маркировка товаров'
    ]},
    {'topic': 'integrations_online_store_631', 'queries': [
        'Можно подключить интернет-магазин?',
        'Интеграция с Kaspi Магазин',
        'Синхронизация с онлайн-продажами'
    ]},
    {'topic': 'integrations_supported_banks_640', 'queries': [
        'С какими банками работаете?',
        'Терминалы каких банков поддерживаются?',
        'Список поддерживаемых банков'
    ]},
    {'topic': 'integrations_cashless_657', 'queries': [
        'Можно принимать карты?',
        'Безналичная оплата в Wipon',
        'Приём карточных платежей'
    ]},
    {'topic': 'integrations_esf_668', 'queries': [
        'Можно выписывать ЭСФ из Wipon?',
        'Интеграция с электронными счетами-фактурами',
        'Формирование ESF'
    ]},
    {'topic': 'integrations_multiple_terminals_674', 'queries': [
        'Можно подключить несколько терминалов?',
        'Два POS терминала на одну кассу',
        'Много терминалов в системе'
    ]},

    # === ANALYTICS (5 секций) ===
    {'topic': 'analytics_reports_613', 'queries': [
        'Какая аналитика есть в Wipon?',
        'Отчёты по продажам',
        'Статистика магазина'
    ]},
    {'topic': 'analytics_receivables_649', 'queries': [
        'Учёт дебиторской задолженности',
        'Где видно кто должен?',
        'Отчёт по долгам клиентов'
    ]},
    {'topic': 'analytics_monthly_profit_653', 'queries': [
        'Как посмотреть прибыль за месяц?',
        'Отчёт по прибыли',
        'Сколько заработал в этом месяце?'
    ]},
    {'topic': 'analytics_expenses_663', 'queries': [
        'Можно вести учёт расходов?',
        'Как фиксировать затраты?',
        'Расходы магазина в программе'
    ]},
    {'topic': 'analytics_holiday_sales_693', 'queries': [
        'Как сравнить продажи за разные периоды?',
        'Аналитика по праздничным дням',
        'Сезонность продаж в отчётах'
    ]},

    # === TIS (4 секции) ===
    {'topic': 'tis_connection_615', 'queries': [
        'Как подключить ТИС?',
        'Сколько времени занимает подключение к ТИС?',
        'Регистрация в трёхкомпонентной системе'
    ]},
    {'topic': 'tis_cost_622', 'queries': [
        'Какая цена на ТИС?',
        'Стоимость ТИС в год',
        'Тариф на трёхкомпонентку'
    ]},
    {'topic': 'tis_two_years_643', 'queries': [
        'Можно оплатить ТИС сразу на 2 года?',
        'Есть скидка за несколько лет?',
        'Стоимость ТИС на два года'
    ]},
    {'topic': 'tis_retail_tax_646', 'queries': [
        'Что такое розничный налог?',
        'СНР розничного налога в Wipon',
        'Переход на розничный налог'
    ]},

    # === EMPLOYEES (7 секций) ===
    {'topic': 'employees_hr_accounting_619', 'queries': [
        'Есть ли кадровый учёт?',
        'Ведение сотрудников в Wipon',
        'Учёт персонала в программе'
    ]},
    {'topic': 'employees_count_634', 'queries': [
        'Сколько сотрудников можно добавить?',
        'Лимит на количество кассиров?',
        'Ограничение по работникам'
    ]},
    {'topic': 'employees_profit_by_staff_669', 'queries': [
        'Можно видеть продажи каждого сотрудника?',
        'Отчёт по прибыли по кассирам',
        'Кто сколько продал?'
    ]},
    {'topic': 'employees_access_limit_671', 'queries': [
        'Можно ограничить права сотрудников?',
        'Закрыть доступ кассиру к отчётам',
        'Настройка прав доступа'
    ]},
    {'topic': 'employees_access_restrict_677', 'queries': [
        'Как скрыть данные от сотрудников?',
        'Разграничение доступа к информации',
        'Закрыть прибыль от кассиров'
    ]},
    {'topic': 'employees_multiple_users_688', 'queries': [
        'Можно создать несколько логинов?',
        'Разные пользователи для сотрудников',
        'Учётные записи для кассиров'
    ]},
    {'topic': 'employees_cashier_control_697', 'queries': [
        'Как контролировать действия кассира?',
        'Проверить что делал продавец',
        'Следить за работой кассиров'
    ]},

    # === INVENTORY (7 секций) ===
    {'topic': 'inventory_suppliers_620', 'queries': [
        'Есть учёт поставщиков?',
        'База контрагентов в Wipon',
        'Работа с поставщиками'
    ]},
    {'topic': 'inventory_stock_control_627', 'queries': [
        'Есть уведомления когда товар заканчивается?',
        'Контроль остатков на складе',
        'Предупреждение о низких остатках'
    ]},
    {'topic': 'inventory_multiple_warehouses_637', 'queries': [
        'Можно работать с несколькими складами?',
        'Учёт по разным складам',
        'Перемещение между складами'
    ]},
    {'topic': 'inventory_returns_660', 'queries': [
        'Как оформить возврат товара?',
        'Учёт возвратов от покупателей',
        'Покупатель вернул товар'
    ]},
    {'topic': 'inventory_import_products_667', 'queries': [
        'Можно загрузить товары из Excel?',
        'Массовый импорт товаров',
        'Добавить много товаров сразу'
    ]},
    {'topic': 'inventory_revision_673', 'queries': [
        'Как провести ревизию?',
        'Инвентаризация в Wipon',
        'Пересчёт товаров на складе'
    ]},
    {'topic': 'inventory_upload_catalog_678', 'queries': [
        'Можно загрузить каталог товаров сразу?',
        'Импорт базы товаров',
        'Перенести товары из другой программы'
    ]},

    # === MOBILE (3 секции) ===
    {'topic': 'mobile_work_phone_624', 'queries': [
        'Можно работать с телефона?',
        'Управление бизнесом через смартфон',
        'Всё с телефона делать'
    ]},
    {'topic': 'mobile_remote_control_641', 'queries': [
        'Можно контролировать магазин удалённо?',
        'Следить за продажами издалека',
        'Удалённый контроль бизнеса'
    ]},
    {'topic': 'mobile_tablet_672', 'queries': [
        'Wipon работает на планшете?',
        'Касса на планшете Android',
        'Можно использовать планшет?'
    ]},

    # === FISCAL (5 секций) ===
    {'topic': 'fiscal_ofd_charge_625', 'queries': [
        'Сколько стоит ОФД в месяц?',
        'Когда списывается оплата ОФД?',
        'Стоимость оператора фискальных данных'
    ]},
    {'topic': 'fiscal_tax_reporting_633', 'queries': [
        'Wipon формирует налоговую отчётность?',
        'Форма 910 в программе',
        'Отчёты для налоговой'
    ]},
    {'topic': 'fiscal_terminal_only_644', 'queries': [
        'Можно работать только с терминалом без кассы?',
        'Нужна ли касса если есть POS терминал?',
        'Терминал без онлайн-кассы'
    ]},
    {'topic': 'fiscal_tax_reports_682', 'queries': [
        'Какие налоговые формы формирует Wipon?',
        'Автоматические отчёты для налоговой',
        'Выгрузка 910, 913, 200 форм'
    ]},
    {'topic': 'fiscal_tax_audit_699', 'queries': [
        'Готов ли Wipon к проверке налоговой?',
        'Данные для налоговой инспекции',
        'Wipon при проверке'
    ]},

    # === STABILITY (4 секции) ===
    {'topic': 'stability_internet_needed_616', 'queries': [
        'Нужен ли интернет для работы?',
        'Wipon требует постоянного интернета?',
        'Работает ли без интернета?'
    ]},
    {'topic': 'stability_village_work_632', 'queries': [
        'Wipon работает в сельской местности?',
        'Касса для аула',
        'В деревне можно использовать?'
    ]},
    {'topic': 'stability_no_internet_675', 'queries': [
        'Что будет если пропадёт интернет?',
        'Wipon без связи',
        'Интернет отключился, что делать?'
    ]},
    {'topic': 'stability_weak_internet_695', 'queries': [
        'Работает при плохом интернете?',
        'Медленный интернет в ауле',
        'Нестабильный интернет подойдёт?'
    ]},

    # === REGIONS (1 секция) ===
    {'topic': 'regions_new_branch_630', 'queries': [
        'Хочу открыть филиал в другом городе',
        'Можно расшириться на другой город?',
        'Новая точка в Шымкенте'
    ]},

    # === PROMOTIONS (3 секции) ===
    {'topic': 'promotions_loyalty_642', 'queries': [
        'Есть ли система лояльности?',
        'Бонусная программа для клиентов',
        'Cashback для покупателей'
    ]},
    {'topic': 'promotions_discounts_652', 'queries': [
        'Как настроить скидки в Wipon?',
        'Можно запустить акцию?',
        'Скидка на категорию товаров'
    ]},
    {'topic': 'promotions_bonuses_698', 'queries': [
        'Клиенты могут копить бонусы?',
        'Программа лояльности с накоплением',
        'Кэшбэк для постоянных покупателей'
    ]},
]

def run_tests():
    failures = []
    success = 0
    total = 0

    for tc in TEST_CASES:
        for q in tc['queries']:
            total += 1
            results = retriever.search(q, top_k=3)
            got = results[0].section.topic if results else 'NO RESULTS'
            if got == tc['topic']:
                success += 1
            else:
                top3_topics = [r.section.topic for r in results[:3]] if results else []
                if tc['topic'] in top3_topics:
                    pos = top3_topics.index(tc['topic']) + 1
                    failures.append((tc['topic'], q, got, f"in top3 at #{pos}"))
                else:
                    failures.append((tc['topic'], q, got, "NOT in top3"))

    accuracy = success / total * 100
    print(f'Accuracy: {success}/{total} = {accuracy:.1f}%')
    print(f'Failures (not #1): {len(failures)}')
    print()

    # Группируем ошибки по топикам
    by_topic = {}
    for expected, query, got, note in failures:
        if expected not in by_topic:
            by_topic[expected] = []
        by_topic[expected].append((query, got, note))

    for topic, errs in sorted(by_topic.items()):
        print(f'=== {topic} ===')
        for query, got, note in errs:
            print(f'  Query: {query}')
            print(f'  Got: {got} ({note})')
            print()

    return accuracy, failures

if __name__ == '__main__':
    accuracy, failures = run_tests()
