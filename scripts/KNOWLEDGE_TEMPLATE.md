# Шаблон для расширения базы знаний Wipon

## Как добавить новую секцию

База знаний хранится в YAML файлах в `src/knowledge/data/`. Каждая категория — отдельный файл.

**Шаг 1:** Выберите подходящий файл категории (или создайте новый):
```
src/knowledge/data/
├── equipment.yaml     # Оборудование (316 секций)
├── pricing.yaml       # Тарифы (286 секций)
├── products.yaml      # Продукты (273 секции)
├── support.yaml       # Техподдержка (201 секция)
├── tis.yaml           # ТИС (191 секция)
├── regions.yaml       # Регионы (130 секций)
├── inventory.yaml     # Складской учёт (93 секции)
├── features.yaml      # Функции (90 секций)
├── integrations.yaml  # Интеграции (86 секций)
├── fiscal.yaml        # Фискализация (68 секций)
├── analytics.yaml     # Аналитика (63 секции)
├── employees.yaml     # Управление персоналом (55 секций)
├── stability.yaml     # Стабильность (45 секций)
├── mobile.yaml        # Мобильное приложение (35 секций)
├── promotions.yaml    # Акции и скидки (26 секций)
├── competitors.yaml   # Конкуренты (7 секций)
├── faq.yaml           # FAQ (4 секции)
└── _meta.yaml         # Метаданные
```

**Шаг 2:** Добавьте секцию в YAML файл:
```yaml
- topic: unique_topic_id       # Уникальный идентификатор темы
  priority: 5                  # 1-10 (выше = важнее)
  keywords:                    # Ключевые слова для поиска
  - ключевое слово 1
  - ключевое слово 2
  - опечатка ключевого слова   # Можно добавлять опечатки
  facts: |                     # Факты (многострочный текст)
    Информация о теме.

    • Список пунктов
    • Ещё пункт

    | Столбец 1 | Столбец 2 |
    |-----------|-----------|
    | Значение  | Значение  |
```

**Шаг 3:** Обновите метаданные в `_meta.yaml`:
```yaml
stats:
  total_sections: 1970  # Увеличить на 1
  last_updated: '2026-01-13'
  categories:
  - name: <категория>
    count: <новое_количество>  # Увеличить на 1
```

**Шаг 4:** Проверьте валидность:
```bash
python scripts/validate_knowledge_yaml.py
```

**Шаг 5:** Запустите тесты:
```bash
pytest tests/test_knowledge_yaml.py -v
pytest tests/test_cascade_retriever.py -v
```

---

## Категории

| Категория | Файл | Описание |
|-----------|------|----------|
| `equipment` | equipment.yaml | Оборудование (кассы, принтеры, сканеры) |
| `pricing` | pricing.yaml | Тарифы и цены |
| `products` | products.yaml | Продукты Wipon (Kassa, Desktop, Pro, etc.) |
| `support` | support.yaml | Техподдержка и обслуживание |
| `tis` | tis.yaml | Товарно-информационная система |
| `regions` | regions.yaml | Регионы Казахстана |
| `inventory` | inventory.yaml | Складской учёт |
| `features` | features.yaml | Функции системы |
| `integrations` | integrations.yaml | Интеграции (1С, Kaspi, Telegram) |
| `fiscal` | fiscal.yaml | Фискализация |
| `analytics` | analytics.yaml | Аналитика и отчёты |
| `employees` | employees.yaml | Управление персоналом |
| `stability` | stability.yaml | Стабильность и надёжность |
| `mobile` | mobile.yaml | Мобильное приложение |
| `promotions` | promotions.yaml | Акции и скидки |
| `competitors` | competitors.yaml | Сравнение с конкурентами |
| `faq` | faq.yaml | Часто задаваемые вопросы |

---

## Правила написания фактов

### Хорошо:
- Конкретные цифры: "12,000 тг/год", "50,000+ клиентов"
- Списки с буллетами: "• Функция 1\n• Функция 2"
- Таблицы для сравнений (markdown)
- Краткие предложения

### Плохо:
- Размытые формулировки: "хорошая система", "удобный интерфейс"
- Слишком длинные тексты (LLM обрежет)
- Информация без источника
- Устаревшие данные

---

## Правила для keywords

1. **Включайте все формы слова**: `["касса", "кассу", "кассы", "кассой"]`
2. **Добавляйте синонимы**: `["цена", "стоимость", "прайс", "тариф"]`
3. **Учитывайте опечатки**: `["каспи", "kaspi", "касби"]`
4. **Добавляйте разговорные варианты**: `["сколько стоит", "почём"]`

---

## Пример добавления новой секции

### Задача: Добавить информацию о системе лояльности

**Шаг 1:** Открываем `src/knowledge/data/features.yaml`

**Шаг 2:** Добавляем секцию в конец файла:
```yaml
- topic: loyalty_program
  priority: 7
  keywords:
  - лояльность
  - бонус
  - бонусы
  - скидка
  - скидки
  - cashback
  - кэшбэк
  - кешбэк
  - постоянный клиент
  - программа лояльности
  - накопительная
  - баллы
  facts: |
    Программа лояльности Wipon Cashback:

    • Начисление бонусов за каждую покупку (настраиваемый %)
    • Клиенты оплачивают бонусами до 100% покупки
    • Автоматическая идентификация по номеру телефона
    • Статистика по постоянным клиентам
    • SMS-уведомления о бонусах (опционально)

    Результаты внедрения:
    - Рост повторных покупок на 25-40%
    - Увеличение среднего чека на 15%

    Входит в тарифы Standard и Pro.
```

**Шаг 3:** Обновляем `_meta.yaml`:
```yaml
stats:
  total_sections: 1970  # было 1969
  categories:
  - name: features
    count: 91  # было 90
```

**Шаг 4:** Проверяем:
```bash
python scripts/validate_knowledge_yaml.py
pytest tests/test_cascade_retriever.py -v -k "лояльность"
```

---

## Чеклист перед добавлением

- [ ] Topic ID уникален
- [ ] Keywords включают все формы слов и синонимы
- [ ] Факты содержат конкретные цифры
- [ ] Информация актуальна (проверена на сайте)
- [ ] Priority установлен корректно (1-10)
- [ ] Обновлены метаданные в _meta.yaml
- [ ] Пройдена валидация YAML
- [ ] Протестировано через pytest

---

## CascadeRetriever — как работает поиск

```
Запрос пользователя
         │
         ▼
┌────────────────────┐
│  1. Exact Match    │  keyword как подстрока в запросе
│  (score >= 1.0)    │
└────────┬───────────┘
         │ не найдено
         ▼
┌────────────────────┐
│  2. Lemma Match    │  пересечение лемматизированных множеств
│  (score >= 0.15)   │
└────────┬───────────┘
         │ не найдено
         ▼
┌────────────────────┐
│  3. Semantic Match │  cosine similarity эмбеддингов
│  (score >= 0.5)    │  ai-forever/ru-en-RoSBERTa
└────────┬───────────┘
         │ низкий score
         ▼
┌────────────────────┐
│  4. CategoryRouter │  LLM-классификация категорий
│  (fallback)        │  vLLM + Outlines
└────────────────────┘
```

Добавляйте хорошие keywords — это улучшит Exact Match и Lemma Match!
