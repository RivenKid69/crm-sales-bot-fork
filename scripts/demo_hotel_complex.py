#!/usr/bin/env python3
"""
Демо: 5 длинных и сложных диалогов — Hotel-Staff Politeness.
Персоны: скептик, ценовик, казахоязычная (Айгерим), готов купить (Петров), агрессивный.
"""

import sys, os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from src.llm import OllamaClient
from src.bot import SalesBot

SEP  = "─" * 70
SEP2 = "═" * 70


def warmup(llm):
    import requests
    from src.settings import settings
    url = f"{settings.llm.base_url.rstrip('/')}/api/chat"
    for _ in range(5):
        try:
            r = requests.post(url, json={
                "model": settings.llm.model,
                "messages": [{"role": "user", "content": "привет"}],
                "stream": False, "options": {"num_predict": 5}
            }, timeout=90)
            if r.status_code == 200:
                return True
        except Exception:
            import time; time.sleep(2)
    return False


def run_dialog(llm, title: str, persona_key: str, turns: list[str]):
    print()
    print(SEP2)
    print(f"  {title}")
    print(SEP2)
    bot = SalesBot(llm, flow_name="autonomous", persona=persona_key)
    for i, client_msg in enumerate(turns, 1):
        result    = bot.process(client_msg)
        response  = result.get("response", "").strip()
        state     = result.get("state", "?")
        collected = result.get("collected_data", {})
        cname     = collected.get("contact_name") or collected.get("client_name") or "—"
        print()
        print(f"  ХОД {i}")
        print(f"  КЛИЕНТ : {client_msg}")
        print(f"  БОТ    : {response}")
        print(f"  ↳ state={state}  name={cname}")
        print(f"  {SEP}")


def main():
    print()
    print(SEP2)
    print("  DEMO: 5 сложных диалогов — Hotel-Staff Politeness")
    print(SEP2)
    print("\nПодключение к Ollama...")
    llm = OllamaClient()
    if not warmup(llm):
        print("ОШИБКА: Ollama недоступна"); sys.exit(1)
    print("OK\n")

    # ── 1. СКЕПТИК — много возражений, имя называет поздно ───────────────────
    run_dialog(llm, "ДИАЛОГ 1 — СКЕПТИК (имя «Марат Сейткали» появляется на ходу 4)",
               "skeptic", [
        "Добрый день. Смотрю разные системы, честно говоря — все одинаковые",
        "Ну и чем Wipon лучше Kaspi Kassa? Та вообще бесплатная",
        "Это всё красивые слова. Сколько реально стоит и что входит?",
        "Кстати, меня зовут Марат Сейткали. Значит 15 000 в месяц — это только аренда ПО?",
        "Хорошо, господин... ладно. А поддержка по-казахски есть? И как быстро подключают?",
        "Допустим, меня заинтересовало. Что дальше, какие шаги?",
    ])

    # ── 2. ЦЕНОВИК — давит на скидку, торгуется ─────────────────────────────
    run_dialog(llm, "ДИАЛОГ 2 — ЦЕНОВИК (анонимный, торгуется на каждом ходу)",
               "price_focused", [
        "Здравствуйте, нас интересует система автоматизации. Сразу — сколько стоит?",
        "15 000 дороговато. У конкурентов видел за 8 000. Скидку дадите?",
        "А если сразу на год — будет дешевле? Или промокод какой-то?",
        "Ладно, допустим базовый тариф. А установка и настройка отдельно платятся?",
        "Хорошо. Нам три кассы нужно. Три × 15 000 = 45 000 в месяц? Это много",
        "Есть ли рассрочка? У нас сейчас не весь бюджет сразу",
        "Ладно, давайте договоримся. Как оформить заявку?",
    ])

    # ── 3. КАЗАХОЯЗЫЧНАЯ АЙГЕРИМ — тест на повторный вопрос об имени ─────────
    run_dialog(llm, "ДИАЛОГ 3 — КАЗАХОЯЗЫЧНАЯ АЙГЕРИМ (тест: не спрашивать имя дважды)",
               "kazakh_speaker", [
        "Сәлем! Айгерим есімім, Алматыда киім дүкенім бар",           # «Меня зовут Айгерим, магазин одежды»
        "Үш касса бар, Kaspi-мен интеграция керек",                    # «Три кассы, нужна интеграция с Kaspi»
        "Жарайды, бағасы қанша? Айына неше теңге?",                   # «Хорошо, сколько стоит в месяц?»
        "Рассрочка бар ма? Бірден төлеу қиын",                         # «Есть рассрочка? Сразу платить сложно»
        "Болды, сізбен келісімге дайынмын. Не істеу керек?",           # «Ладно, готова договориться, что делать?»
    ])

    # ── 4. ГОТОВ КУПИТЬ — Дмитрий Ли, переход в closing ─────────────────────
    run_dialog(llm, "ДИАЛОГ 4 — ГОТОВ КУПИТЬ «Дмитрий Ли» (closing: сбор kaspi_phone + ИИН)",
               "ready_buyer", [
        "Привет, меня зовут Дмитрий Ли. Уже смотрел ваш сайт — хочу оформить",
        "Мне нужен тариф Pro, две кассы, продуктовый магазин в Нур-Султане",
        "Отлично. Как оплатить через Kaspi? Мой номер 87012345678",
        "ИИН мой — 880512300145. Что дальше?",
        "Когда придёт счёт? И сколько времени на подключение?",
    ])

    # ── 5. АГРЕССИВНЫЙ — давит, грубит, бот держит отельный тон ─────────────
    run_dialog(llm, "ДИАЛОГ 5 — АГРЕССИВНЫЙ (бот сохраняет достоинство под давлением)",
               "aggressive", [
        "Слушайте, у меня нет времени. Что за система, зачем она мне, кратко!",
        "Это я уже слышал сто раз. Конкретно: сколько стоит и когда подключат?",
        "45 000 в месяц?! Это грабёж. Вы вообще с кем работаете, с миллионерами?",
        "Ладно, ладно. А бесплатный период есть? Хочу сначала попробовать",
        "Две недели мало. Месяц дадите? Без этого разговора нет",
        "Хорошо, пусть две недели. Как подключиться, что надо от меня?",
    ])

    print()
    print(SEP2)
    print("  DEMO завершён")
    print(SEP2)
    print()


if __name__ == "__main__":
    main()
