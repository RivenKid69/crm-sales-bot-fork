#!/usr/bin/env python3
"""
Альтернативный тест покрытия секций 151-200 базы знаний.
Использует другие формулировки запросов для проверки устойчивости поиска.
"""

import sys
sys.path.insert(0, 'src')

from src.knowledge.retriever import KnowledgeRetriever
from src.knowledge.data import WIPON_KNOWLEDGE


def test_sections_alt():
    """Альтернативный тест покрытия секций 151-200"""
    print("=" * 70)
    print("АЛЬТЕРНАТИВНЫЙ ТЕСТ ПОКРЫТИЯ СЕКЦИЙ 151-200")
    print("=" * 70)
    print()

    retriever = KnowledgeRetriever(use_embeddings=False)

    # Альтернативные запросы для секций 151-200
    test_cases = [
        # 151 - подставка под сканер
        (151, "цена подставки для сканера zebra", ["3 000", "10 000"]),

        # 152 - комплекты
        (152, "готовый комплект standard что входит", ["168 000", "219 000"]),

        # 153 - ТСД
        (153, "терминал сбора данных pocket scanner цена", ["25 000", "30 000"]),

        # 154 - отключение света
        (154, "работа без электричества бесперебойник", ["ИБП", "сети"]),

        # 155 - интернет
        (155, "как подключить интернет вайфай или кабель", ["Wi-Fi", "LAN"]),

        # 156 - сим-карта
        (156, "есть ли слот для симки 4g", ["Сим-карта", "роутер"]),

        # 157 - другая программа
        (157, "совместимость с другим ПО", ["совместим", "Wipon"]),

        # 158 - программа встроена
        (158, "софт уже установлен на моноблоке", ["предустановлен", "готов"]),

        # 159 - весы без программы
        (159, "хочу купить только весы отдельно", ["можно", "вручную"]),

        # 160 - умные весы печатают
        (160, "умные весы печатают этикетки штрихкод", ["не печата", "Rongta"]),

        # 161 - настройка оборудования
        (161, "удалённая настройка anydesk", ["AnyDesk", "удалённо"]),

        # 162 - выезд
        (162, "нужен ли вызов мастера на место", ["Выезд не требуется", "удалённо"]),

        # 163 - клавиатура и мышь
        (163, "usb порты для периферии клавиатура", ["USB", "сенсорн"]),

        # 164 - цвета моноблоков
        (164, "есть ли белый моноблок pos i5", ["чёрн", "бел"]),

        # 165 - характеристики моноблоков
        (165, "процессор память ssd в pos i3", ["i3", "SSD", "RAM"]),

        # 166 - характеристики сканеров
        (166, "скорость сканирования 1d 2d коды", ["скан/сек", "1D", "2D"]),

        # 167 - характеристики принтеров
        (167, "принтер чеков x-printer dpi скорость", ["dpi", "мм/сек"]),

        # 168 - размер бумаги для чеков
        (168, "какая термолента нужна 58 или 80 мм", ["58 мм", "80 мм"]),

        # 169 - размер бумаги для этикеток
        (169, "ширина термоленты для принтера этикеток", ["80 мм", "85 мм"]),

        # 170 - bluetooth принтер
        (170, "подключить принтер по блютуз беспроводной", ["Bluetooth", "USB"]),

        # 171 - гарантия
        (171, "гарантийный срок на моноблок сканер zebra", ["1 год", "5 лет"]),

        # 172 - аренда
        (172, "можно ли арендовать оборудование напрокат", ["Аренды нет", "рассрочк"]),

        # 173 - доставка
        (173, "отправка по казахстану indriver астана", ["InDriver", "Астан"]),

        # 174 - возврат
        (174, "условия возврата товара 14 дней", ["14", "дней"]),

        # 175 - отличия моноблоков
        (175, "сравнение pos duo и premium второй экран", ["DUO", "Premium"]),

        # 176 - моноблок для бизнеса
        (176, "какой моноблок подходит для кафе магазина", ["Подбер", "формат"]),

        # 177 - что входит в 5 в 1
        (177, "комплектация wipon 5 в 1 встроенный сканер", ["сканер", "принтер"]),

        # 178 - как работают весы
        (178, "весы передают вес в кассу автоматически", ["кассу", "Показания"]),

        # 179 - второй экран сенсорный
        (179, "экран покупателя клиента сенсорный ли", ["Нет", "клиент"]),

        # 180 - что такое ТИС
        (180, "тис трёхкомпонентная система для ип упрощёнка", ["ИП", "упрощёнк"]),

        # 181 - как работает ТИС
        (181, "принцип работы тис учёт касса терминал", ["учёт", "касс"]),

        # 182 - ТИС vs обычная касса
        (182, "преимущества тис перед обычной кассой", ["государств", "лимит"]),

        # 183 - ТИС при малых оборотах
        (183, "стоит ли подключать тис при маленьком обороте", ["рост", "оборот"]),

        # 184 - ТИС для нового ИП
        (184, "начинающий ип только открыл тис с нуля", ["сразу", "лимит"]),

        # 185 - ТИС для ТОО
        (185, "тис для юридического лица тоо ооо", ["Нет", "ИП"]),

        # 186 - ТИС законно
        (186, "тис официально законно реестр цифровых решений", ["реестр", "2021"]),

        # 187 - консультация
        (187, "хочу обсудить другие варианты со специалистом", ["специалист", "свяж"]),

        # 188 - ТИС и порог НДС
        (188, "превысил ндс за год можно ли тис", ["НДС", "полугод"]),

        # 189 - опасность общего режима
        (189, "риски перехода на общую систему налогообложения", ["налогов", "бухгалтер"]),

        # 190 - кому подходит ТИС
        (190, "могу ли я подключить тис требования", ["ИП", "упрощёнк"]),

        # 191 - ТИС при больших оборотах
        (191, "большие обороты как избежать ндс с тис", ["лимит", "НДС"]),

        # 192 - ТИС для услуг
        (192, "тис для сферы услуг сервисный бизнес", ["Можно", "касс"]),

        # 193 - какие ОКЭД
        (193, "ограничения по окэд виды деятельности тис", ["Любые", "ограничен"]),

        # 194 - ресторан и IIKO
        (194, "тис для ресторана интеграция с айко iiko", ["IIKO", "поддержив"]),

        # 195 - Kaspi касса
        (195, "как снять каспи кассу для подключения тис", ["снять", "задвоен"]),

        # 196 - альтернатива для ТОО
        (196, "wipon розница эсф снт для тоо", ["Розниц", "ЭСФ"]),

        # 197 - ТИС увеличивает порог
        (197, "на сколько повышается порог по ндс с тис", ["НДС", "повышает"]),

        # 198 - сколько можно зарабатывать
        (198, "порог дохода максимальный заработок тис", ["лимит", "порог"]),

        # 199 - налоговые преимущества
        (199, "тис налоговые выгоды экономия на налогах", ["упрощёнк", "оборот"]),

        # 200 - увеличить прибыль
        (200, "тис снижает налоговую нагрузку увеличить прибыль", ["налогов", "прибыль"]),
    ]

    passed = 0
    failed = 0
    failed_cases = []

    for num, query, expected_words in test_cases:
        facts = retriever.retrieve(query, top_k=3)
        facts_lower = facts.lower()

        found_count = sum(1 for word in expected_words if word.lower() in facts_lower)
        # Считаем успехом если найдено хотя бы половина ожидаемых слов
        min_required = max(1, len(expected_words) // 2)
        found = found_count >= min_required

        if found:
            passed += 1
            status = "✓"
        else:
            failed += 1
            status = "✗"
            failed_cases.append((num, query, expected_words, facts[:200]))

        print(f"{status} [{num}] '{query[:50]}...' ({found_count}/{len(expected_words)} слов)")

    print()
    print("=" * 70)
    print(f"РЕЗУЛЬТАТ: {passed}/{passed+failed} тестов пройдено")
    print(f"ПОКРЫТИЕ: {passed/(passed+failed)*100:.1f}%")
    print("=" * 70)

    if failed_cases:
        print()
        print("ПРОВАЛЕННЫЕ ТЕСТЫ:")
        print("-" * 70)
        for num, query, expected, facts in failed_cases:
            print(f"\n[{num}] {query}")
            print(f"  Ожидалось: {expected}")
            print(f"  Получено: {facts}...")

    return passed, failed


if __name__ == "__main__":
    passed, failed = test_sections_alt()
    sys.exit(0 if failed == 0 else 1)
