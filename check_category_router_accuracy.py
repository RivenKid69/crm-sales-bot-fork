#!/usr/bin/env python3
"""
E2E тест точности CategoryRouter.

Проверяем как точно LLM определяет категории для реальных запросов из базы знаний.
150 запросов с разными формулировками, включая опечатки.

Запуск: python3 check_category_router_accuracy.py
"""

import sys
import os
import time
import requests
from typing import List, Dict, Tuple
from dataclasses import dataclass

# Добавляем путь к src
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

from knowledge.category_router import CategoryRouter


# =============================================================================
# 150 тестовых запросов (включая опечатки)
# =============================================================================

# Формат: (запрос_клиента, ожидаемая_категория, описание)
TEST_QUERIES: List[Tuple[str, str, str]] = [
    # ==========================================================================
    # REGIONS (15 запросов)
    # ==========================================================================
    ("Работаете ли вы в Караганде?", "regions", "караганда"),
    ("Можно ли подключиться в Актау?", "regions", "актау"),
    ("Есть ли доставка в Павлодар?", "regions", "павлодар"),
    ("Wipon работает в Костанае?", "regions", "костанай"),
    ("Доставите в село?", "regions", "село"),
    ("в астане есть офис?", "regions", "астана офис"),
    ("работаите в шымкенте?", "regions", "шымкент + опечатка"),  # опечатка
    ("доставка в уральск сколько дней?", "regions", "уральск доставка"),
    ("атырау доставляите?", "regions", "атырау + опечатка"),  # опечатка
    ("по всему казахстану работаете?", "regions", "весь казахстан"),
    ("актобе можно подключить?", "regions", "актобе"),
    ("в семей доставка есть?", "regions", "семей"),
    ("тараз подключаете?", "regions", "тараз"),
    ("в петропавловске работаете?", "regions", "петропавловск"),
    ("кызылорда доставка оборудования", "regions", "кызылорда"),

    # ==========================================================================
    # SUPPORT (20 запросов)
    # ==========================================================================
    ("Помогите настроить программу", "support", "настройка"),
    ("Как перейти с Umag на Wipon?", "support", "миграция umag"),
    ("Переходим с Бексар, поможете?", "support", "миграция бексар"),
    ("Сколько времени занимает миграция?", "support", "время миграции"),
    ("Как обучить кассира работе с программой?", "support", "обучение кассира"),
    ("нужна помощь с настройкой", "support", "помощь"),
    ("как связатся с поддержкой?", "support", "связь + опечатка"),  # опечатка
    ("не могу разобраться с программой", "support", "проблема"),
    ("можно онлайн настроить?", "support", "онлайн настройка"),
    ("сколько времени подключение занимает?", "support", "время подключения"),
    ("есть ли обучение для персонала?", "support", "обучение персонала"),
    ("помагите пожалуйста", "support", "помощь + опечатка"),  # опечатка
    ("как зарегистрировать кассу?", "support", "регистрация кассы"),
    ("нужен ли ЭЦП для подключения?", "support", "ЭЦП"),
    ("переехали с x2pos помогите", "support", "миграция x2pos"),
    ("как перенести данные из мойсклад?", "support", "миграция мойсклад"),
    ("техподдержка работает ночью?", "support", "ночная поддержка"),
    ("есть казахский язык в программе?", "support", "казахский язык"),
    ("после оплаты когда начнём работать?", "support", "старт после оплаты"),
    ("как экспортировать данные из юмаг?", "support", "экспорт umag"),

    # ==========================================================================
    # PRODUCTS (20 запросов)
    # ==========================================================================
    ("Нужна программа для учёта бизнеса", "products", "программа учёта"),
    ("Чем отличаются ваши продукты?", "products", "отличия продуктов"),
    ("Что посоветуете для маленького магазина?", "products", "маленький магазин"),
    ("У меня сеть магазинов, что подойдёт?", "products", "сеть магазинов"),
    ("Можно ли попробовать демо версию?", "products", "демо"),
    ("что такое wipon desktop?", "products", "wipon desktop"),
    ("расскажите про wipon kassa", "products", "wipon kassa"),
    ("какие продукты у вас есть?", "products", "список продуктов"),
    ("что выбрать для бутика?", "products", "бутик"),
    ("нужна программа под франшизу", "products", "франшиза"),
    ("wipon работает на mac?", "products", "mac"),
    ("подойдёт для фастфуда?", "products", "фастфуд"),
    ("для стройматериалов подойдёт?", "products", "стройматериалы"),
    ("что для рынка посоветуете?", "products", "рынок"),
    ("нужна касса под ключ", "products", "под ключ"),
    ("випон что это?", "products", "что такое + опечатка"),  # опечатка
    ("программа для продаж и закупок", "products", "продажи закупки"),
    ("можно без бухгалтера работать?", "products", "без бухгалтера"),
    ("какая программа лучше для алматы?", "products", "для алматы"),
    ("wipon pro это что?", "products", "wipon pro"),

    # ==========================================================================
    # EQUIPMENT (20 запросов)
    # ==========================================================================
    ("Какой стартовый комплект оборудования нужен?", "equipment", "стартовый комплект"),
    ("Есть ли счётчик банкнот?", "equipment", "счётчик банкнот"),
    ("Какие готовые комплекты есть?", "equipment", "готовые комплекты"),
    ("Нужны весы для овощей", "equipment", "весы овощи"),
    ("Можно ли арендовать оборудование?", "equipment", "аренда"),
    ("какой сканер штрихкодов лучше?", "equipment", "сканер"),
    ("принтер чеков какой выбрать?", "equipment", "принтер чеков"),
    ("нужен денежный ящик", "equipment", "денежный ящик"),
    ("есть терминал для карт?", "equipment", "терминал"),
    ("какие весы для магазина?", "equipment", "весы"),
    ("экран для покупателя есть?", "equipment", "экран покупателя"),
    ("оборудование для холодного склада", "equipment", "холодный склад"),
    ("тихий принтер есть?", "equipment", "тихий принтер"),
    ("скинер штрихкода какой?", "equipment", "сканер + опечатка"),  # опечатка
    ("какое оборудование популярное?", "equipment", "популярное"),
    ("комплект для продуктового", "equipment", "продуктовый"),
    ("оборудывание для кафе", "equipment", "кафе + опечатка"),  # опечатка
    ("pos терминал нужен", "equipment", "pos терминал"),
    ("весы с печатью этикеток", "equipment", "весы этикетки"),
    ("какой принтер для кухни?", "equipment", "принтер кухня"),

    # ==========================================================================
    # INTEGRATIONS (15 запросов)
    # ==========================================================================
    ("Как подключить Kaspi магазин?", "integrations", "kaspi магазин"),
    ("Работает ли с Halyk POS?", "integrations", "halyk pos"),
    ("Можно ли продавать на маркетплейсах?", "integrations", "маркетплейсы"),
    ("Как подключить интернет-магазин?", "integrations", "интернет-магазин"),
    ("Есть ли API для интеграции?", "integrations", "API"),
    ("kaspi red поддерживается?", "integrations", "kaspi red"),
    ("можно несколько терминалов подключить?", "integrations", "несколько терминалов"),
    ("интеграция с 1с есть?", "integrations", "1с"),
    ("каспи как подключить?", "integrations", "kaspi + транслит"),
    ("работает с халык банком?", "integrations", "halyk"),
    ("можно на wildberries продавать?", "integrations", "wildberries"),
    ("подключение к ozon", "integrations", "ozon"),
    ("интиграция с банками", "integrations", "банки + опечатка"),  # опечатка
    ("несколько эквайрингов можно?", "integrations", "мульти эквайринг"),
    ("вебхуки есть?", "integrations", "вебхуки"),

    # ==========================================================================
    # PRICING (15 запросов)
    # ==========================================================================
    ("Какой тариф выбрать?", "pricing", "выбор тарифа"),
    ("Есть ли рассрочка на программу?", "pricing", "рассрочка"),
    ("Программа бесплатная?", "pricing", "бесплатно"),
    ("сколько стоит wipon?", "pricing", "стоимость"),
    ("какие тарифы есть?", "pricing", "тарифы"),
    ("цена за месяц?", "pricing", "цена месяц"),
    ("годовая подписка дешевле?", "pricing", "годовая"),
    ("скидка есть?", "pricing", "скидка"),
    ("сколко стоит подключение?", "pricing", "подключение + опечатка"),  # опечатка
    ("оплата помесячно?", "pricing", "помесячно"),
    ("lite тариф что включает?", "pricing", "lite"),
    ("standard vs pro отличия по цене", "pricing", "standard vs pro"),
    ("есть пробный период?", "pricing", "пробный период"),
    ("касса бесплатная?", "pricing", "касса бесплатно"),
    ("прайс на оборудование", "pricing", "прайс оборудование"),

    # ==========================================================================
    # TIS (10 запросов)
    # ==========================================================================
    ("Что такое ТИС?", "tis", "что такое тис"),
    ("нужен ли мне тис?", "tis", "нужен ли"),
    ("как подключить тис?", "tis", "подключение"),
    ("тис для ип обязателен?", "tis", "ип"),
    ("упрощёнка и тис", "tis", "упрощёнка"),
    ("тис в разных городах можно?", "tis", "разные города"),
    ("тіс қалай қосамын?", "tis", "казахский"),
    ("розничный налог автоматом?", "tis", "розничный налог"),
    ("тис для нескольких точек", "tis", "несколько точек"),
    ("налоговый режим тис", "tis", "налоговый режим"),

    # ==========================================================================
    # INVENTORY (10 запросов)
    # ==========================================================================
    ("Как посмотреть остатки товаров?", "inventory", "остатки"),
    ("сколько товаров можно добавить?", "inventory", "лимит товаров"),
    ("учёт партий и сроков годности", "inventory", "партии сроки"),
    ("оповещение о низких остатках", "inventory", "низкие остатки"),
    ("серийные номера imei учёт", "inventory", "серийные номера"),
    ("как вести склад?", "inventory", "склад"),
    ("инвентаризация как делать?", "inventory", "инвентаризация"),
    ("приход товара как оформить?", "inventory", "приход"),
    ("списание товаров", "inventory", "списание"),
    ("перемещение между складами", "inventory", "перемещение"),

    # ==========================================================================
    # FISCAL (8 запросов)
    # ==========================================================================
    ("Как зарегистрироваться в налоговой?", "fiscal", "налоговая регистрация"),
    ("чеки автоматом в офд?", "fiscal", "офд автомат"),
    ("фискальный чек как печатать?", "fiscal", "фискальный чек"),
    ("офд подключение", "fiscal", "офд"),
    ("z-отчёт как сделать?", "fiscal", "z-отчёт"),
    ("фискализация кассы", "fiscal", "фискализация"),
    ("чек коррекции", "fiscal", "коррекция"),
    ("електронный чек", "fiscal", "электронный + опечатка"),  # опечатка

    # ==========================================================================
    # ANALYTICS (7 запросов)
    # ==========================================================================
    ("Как посмотреть аналитику продаж?", "analytics", "аналитика продаж"),
    ("отчёт по выручке", "analytics", "выручка"),
    ("топ продаваемых товаров", "analytics", "топ товаров"),
    ("убыточные товары как найти?", "analytics", "убыточные"),
    ("статистика за месяц", "analytics", "статистика"),
    ("графики продаж есть?", "analytics", "графики"),
    ("abc анализ товаров", "analytics", "abc анализ"),

    # ==========================================================================
    # EMPLOYEES (5 запросов)
    # ==========================================================================
    ("Как контролировать смены сотрудников?", "employees", "смены"),
    ("ограничить права кассира", "employees", "права кассира"),
    ("уровни доступа для сотрудников", "employees", "уровни доступа"),
    ("заблокировать пользователя", "employees", "блокировка"),
    ("учёт рабочего времени", "employees", "рабочее время"),

    # ==========================================================================
    # MOBILE (5 запросов)
    # ==========================================================================
    ("Можно ли работать только с телефона?", "mobile", "только телефон"),
    ("приложение на айфон есть?", "mobile", "iphone"),
    ("андроид приложение", "mobile", "android"),
    ("мобильное приложение wipon", "mobile", "мобильное"),
    ("с планшета можно работать?", "mobile", "планшет"),

    # ==========================================================================
    # FEATURES (5 запросов)
    # ==========================================================================
    ("Есть ли доставка в программе?", "features", "доставка"),
    ("печать ценников", "features", "ценники"),
    ("логотип на чеке", "features", "логотип"),
    ("две валюты в программе", "features", "валюты"),
    ("работа в нескольких валютах", "features", "мультивалюта"),

    # ==========================================================================
    # STABILITY (3 запроса)
    # ==========================================================================
    ("Что если интернет пропадёт?", "stability", "без интернета"),
    ("программа работает офлайн?", "stability", "офлайн"),
    ("слабый интернет потянет?", "stability", "слабый интернет"),

    # ==========================================================================
    # PROMOTIONS (2 запроса)
    # ==========================================================================
    ("автоматические скидки настроить", "promotions", "автоскидки"),
    ("акции и бонусы для клиентов", "promotions", "акции бонусы"),
]


# =============================================================================
# LLM клиент
# =============================================================================

class OllamaLLM:
    """Ollama LLM клиент."""

    def __init__(self, model: str = "qwen3:8b"):
        self.model = model
        self.base_url = "http://localhost:11434/api/generate"

    def generate(self, prompt: str) -> str:
        response = requests.post(
            self.base_url,
            json={
                "model": self.model,
                "prompt": prompt,
                "stream": False,
                "think": False,
                "options": {
                    "temperature": 0.0,
                    "num_predict": 100,
                }
            },
            timeout=60
        )

        if response.status_code == 200:
            return response.json().get("response", "")
        else:
            raise RuntimeError(f"Ollama error: {response.status_code}")


def is_ollama_available() -> bool:
    """Проверить доступность Ollama."""
    try:
        response = requests.get("http://localhost:11434/api/tags", timeout=2)
        return response.status_code == 200
    except:
        return False


def get_available_model() -> str:
    """Получить доступную модель."""
    try:
        response = requests.get("http://localhost:11434/api/tags", timeout=2)
        if response.status_code == 200:
            models = [m["name"] for m in response.json().get("models", [])]
            for preferred in ["qwen3:8b-fast", "qwen3:8b", "qwen3:1.7b"]:
                if preferred in models:
                    return preferred
            if models:
                return models[0]
    except:
        pass
    return "qwen3:8b"


# =============================================================================
# Тестирование
# =============================================================================

@dataclass
class TestResult:
    query: str
    expected_category: str
    description: str
    predicted_categories: List[str]
    is_correct: bool
    latency_ms: float


def run_tests() -> List[TestResult]:
    """Запустить все тесты."""

    if not is_ollama_available():
        print("ERROR: Ollama не доступен. Запустите: ollama serve")
        sys.exit(1)

    model = get_available_model()
    print(f"Модель: {model}")
    print(f"Всего тестов: {len(TEST_QUERIES)}")
    print("=" * 80)

    llm = OllamaLLM(model)
    router = CategoryRouter(llm, top_k=3)

    results: List[TestResult] = []
    start_total = time.perf_counter()

    for i, (query, expected_category, description) in enumerate(TEST_QUERIES, 1):
        # Короткий вывод для большого числа тестов
        print(f"[{i:3d}/{len(TEST_QUERIES)}] {query[:45]:<45}", end=" ")

        start = time.perf_counter()
        try:
            predicted = router.route(query)
        except Exception as e:
            print(f"ERROR: {e}")
            predicted = []
        latency = (time.perf_counter() - start) * 1000

        is_correct = expected_category in predicted

        result = TestResult(
            query=query,
            expected_category=expected_category,
            description=description,
            predicted_categories=predicted,
            is_correct=is_correct,
            latency_ms=latency
        )
        results.append(result)

        status = "OK" if is_correct else "FAIL"
        print(f"[{status}] {expected_category:12} -> {predicted} ({latency:.0f}ms)")

    total_time = time.perf_counter() - start_total
    print(f"\nОбщее время: {total_time:.1f}s")

    return results


def print_summary(results: List[TestResult]):
    """Вывести итоговую статистику."""

    print("\n" + "=" * 80)
    print("ИТОГИ")
    print("=" * 80)

    # Общая точность
    correct = sum(1 for r in results if r.is_correct)
    total = len(results)
    accuracy = correct / total * 100 if total > 0 else 0

    print(f"\nОбщая точность: {correct}/{total} ({accuracy:.1f}%)")

    # Средняя латентность
    avg_latency = sum(r.latency_ms for r in results) / len(results)
    print(f"Средняя латентность: {avg_latency:.0f}ms")

    # Точность по категориям
    print("\nТочность по категориям:")
    print("-" * 50)

    categories = {}
    for r in results:
        cat = r.expected_category
        if cat not in categories:
            categories[cat] = {"correct": 0, "total": 0}
        categories[cat]["total"] += 1
        if r.is_correct:
            categories[cat]["correct"] += 1

    for cat, stats in sorted(categories.items(), key=lambda x: -x[1]["total"]):
        cat_accuracy = stats["correct"] / stats["total"] * 100
        bar = "█" * int(cat_accuracy / 10) + "░" * (10 - int(cat_accuracy / 10))
        status = "OK" if cat_accuracy >= 80 else "LOW"
        print(f"  {cat:12s}: {stats['correct']:2d}/{stats['total']:2d} ({cat_accuracy:5.1f}%) {bar} [{status}]")

    # Ошибки
    failures = [r for r in results if not r.is_correct]
    if failures:
        print(f"\n{'=' * 80}")
        print(f"ОШИБКИ ({len(failures)}):")
        print("-" * 80)
        for i, r in enumerate(failures, 1):
            print(f"{i:2d}. Query: {r.query}")
            print(f"    Ожидал: {r.expected_category} ({r.description})")
            print(f"    Получил: {r.predicted_categories}")
            print()

    # Статистика по опечаткам
    typo_results = [r for r in results if "опечатка" in r.description]
    if typo_results:
        typo_correct = sum(1 for r in typo_results if r.is_correct)
        print(f"Запросы с опечатками: {typo_correct}/{len(typo_results)} ({typo_correct/len(typo_results)*100:.1f}%)")


def main():
    print("=" * 80)
    print("E2E ТЕСТ ТОЧНОСТИ CategoryRouter (150 запросов)")
    print("=" * 80)

    results = run_tests()
    print_summary(results)

    # Exit code
    correct = sum(1 for r in results if r.is_correct)
    accuracy = correct / len(results) * 100

    if accuracy >= 80:
        print(f"\nРезультат: PASSED (accuracy >= 80%)")
        sys.exit(0)
    else:
        print(f"\nРезультат: FAILED (accuracy < 80%)")
        sys.exit(1)


if __name__ == "__main__":
    main()
